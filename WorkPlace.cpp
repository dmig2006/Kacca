/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
#include <qgroupbox.h>
#include <qheader.h>
#include <qlabel.h>
#include <qlistview.h>
#include <qlayout.h>
#include <qvariant.h>
#include <qtooltip.h>
#include <qwhatsthis.h>
#include <qmessagebox.h>
#include <qapplication.h>
#include <qprogressbar.h>
#include <qcheckbox.h>
#include <qcombobox.h>
#include <qinputdialog.h>
#include <qfile.h>

#include <qpainter.h>
#include <qtimer.h>
#include <qimage.h>
//#include <qmovie.h>

#include <algorithm>
#include <math.h>
#include <xbase/xbase.h>
#include <pthread.h>

#include "WorkPlace.h"
#include "Display.h"
#include "Scale.h"
#include "Fiscal.h"
#include "Guard.h"
//#include "Actsiz.h"
#include "PriceSel.h"
#include "SectionSel.h"
#include "Calc.h"
#include "Utils.h"
#include "Search.h"
#include "FreeSum.h"
#include "BankBonus.h"
#include "ScreenSaver.h"
#include "Cash.h"
#include "DbfTable.h"
//#include "Threads.h"
#include "Payment.h"
#include "PaymentType.h"
#include "Ping.h"
#include "Sum.h"
#include "ExtControls.h"
#include "Message.h"
#include "Display.h"
#include "Certificate.h"

FILE *storenum, *keepstate;

const char
			*INFO="»Õ‘Œ",
			*SEARCHBYCODE="œŒ»—  œŒ  Œƒ”",//names of commands
			*SEARCHBYBARCODE="œŒ»—  œŒ ÿ“–»’- Œƒ”",
			*SEARCHBYPRICE="œŒ»—  œŒ ÷≈Õ≈",
			*SEARCHBYPROPERTIES="œŒ»—  œŒ –≈ ¬»«»“¿Ã",
			*SEARCHBYGROUP="œŒ»—  œŒ √–”œœ≈",
			*SCALEGOODS="¬«¬≈—»“‹",
			*ENTERERROR="Œÿ»¡ ¿",
			*AMOUNT="¬¬Œƒ  ŒÀ»◊≈—“¬¿",
			*DELETEFROMCHECK="”ƒ¿À≈Õ»≈ œŒ ”œ » »« ◊≈ ¿",
			*ANNUL="¿HH”À»–Œ¬¿“‹ ◊≈ ",
			*OPENDRAWER="Œ“ –€“‹ ﬂŸ» ",
			*FINALIZE="–¿—◊≈“",
			*CALCULATOR=" ¿À‹ ”Àﬂ“Œ–",
			*GROUPCODE=" Œƒ √–”œœ€ ",
			*DISCOUNT="— »ƒ ¿",
			*MESSAGE="—ŒŒ¡Ÿ≈Õ»≈",
			*LASTCHECK="LASTCHECK",
			*PRECHECK="PRECHECK",
			*FRSOUND="FRSOUND",//
			*KEEP="Œ“ÀŒ∆»“‹ ◊≈ ",
			*CERTIFICATE="—≈–“»‘» ¿“",
			*FREESUMMA="—¬Œ¡ŒƒÕ¿ﬂ —”ÃÃ¿",
			*SCREENSAVER="SCREENSAVER",
            *ALTFINALIZE="¡≈«Õ¿À",
            *SEND="œ≈–≈—À¿“‹ ◊≈ ",
            *CHANGEBONUSCARD="«¿Ã≈Õ¿",
            *SEARCHBYPHONE="— »ƒ ¿ œŒ “≈À≈‘ŒÕ”";

char frSound = 0;

const char *BarcodePrefix[]={"EAN8","EAN13","UPCE","UPCA","CODE39","CODE93","CODE128",
							 "CODABAR","INTERLEAVE25","MSI","DISCOUNTCARD","GASTRONOMCARD","EMPLOYEE"};
const int BarcodePrefixLen=13;

const char *CardPrefix="98";
const char *SPPPrefix="981";
string EmpPrefix="982"; // Employee`s prefix (SBARCODE)
const char *GastronomPrefix="993";
const char *CardPrefixN="922";
const char *ManagerPrefix="222";

//cheque visible properties:number,code,name,price,count,sum
enum {ListNo=0,ListCode,ListName,ListPrice,ListCount,ListSum,ListDscnt};

extern unsigned short RecodeTable[RecodeTableSize][2];
extern int revision;

GoodsInfo CurGoods;
QPainter painter;

static char * statefn = "tmp/state.dat";
static char * sendstatefn = "tmp/sendstate.dat";


//static LProc* WPCX;


/*
 *  Constructs a WorkPlace which is a child of 'parent', with the
 *  name 'name' and widget flags set to 'f'
 *
 *  The dialog will by default be modeless, unless you set 'modal' to
 *  TRUE to construct a modal dialog.
 */
WorkPlace::WorkPlace( QWidget* parent )  : QDialog( parent, "WorkPlace", true )
{

/* 	//============================
 * 	// œË Á‡„ÛÁÍÂ Í‡ÒÒÓ‚Ó„Ó œŒ ‚˚ÔÓÎÌˇÂÚÒˇ cÓÁ‰‡ÌËÂ Ë ËÌËˆË‡ÎËÁ‡ˆËˇ Ó·˙ÂÍÚ‡ PCX
 * 	// Œ·˙ÂÍÚ ‰ÓÎÊÂÌ ÊËÚ¸ ‰Ó Á‡‚Â¯ÂÌËˇ ‡·ÓÚ˚ Í‡ÒÒÓ‚Ó„Ó œŒ
 * 	// —ÓÁ‰‡ÌËˇ Ë ËÌËˆË‡ÎËÁ‡ˆËË Ó·˙ÂÍÚ‡ Ì‡ Í‡Ê‰ÓÏ Á‡ÔÓÒÂ ÌÂ ‰ÓÎÊÌÓ ·˚Ú¸
 *
 *
 *     Log(" INIT PCX... ");
 * 	try {
 *
 * 	    WPCX = new LProc();
 * 	    WPCX->Init();
 *         Log("  ..SUCCESS ");
 * 	} catch(exception& ex) {
 * 		// Ó·‡·ÓÚÍ‡ Ó¯Ë·ÍË ÒÓÁ‰‡ÌËˇ Ó·˙ÂÍÚ‡ PCX
 * 		Log("  ..ERROR: ");
 * 		Log((char*)ex.what());
 * 	}
 */

    /* slair+ */
    dont_print_paper_check = false;
    /* slair- */

	int BaseSkip,xRes,yRes;
	int BottomLineHeight=12;

	FindInDB = false;

	ActionShowMsg=true;
    CustomerByPhone=false;

    CurrentActiveBonus=0;
    StatusBonusCard ="";
    SummaBonusAction = 0;

    MilkActsiz.clear();

#ifdef ALCO_VES
    AlcoVesActsiz.clear();
#endif

#ifdef BLOCK_CIGAR
    BlockCigarActsiz.clear();
#endif

	//bool BW;

    for(int i=0;i<MAXDISCOUNTLEN;i++) DefaultDiscountType+="X";

	CashReg = (CashRegister*)parent;

	switch (CashReg->ResolutionType)
	{
		case res640x400Color:
		    BW=false;
		case res640x400BW:
		    xRes = 640;
		    yRes = 400;
		    BaseSkip=0;
		    break;
		case res640x480Color:
		    BW=false;
		case res640x480BW:
		    xRes = 640;
		    yRes = 480;
		    BaseSkip=8;
		    break;
		case res800x600Color:
		    BW=false;
		case res800x600BW:
		    xRes = 800;
		    yRes = 600;
		    BaseSkip=8;
		    break;
		case res1024x768Color:
		    BW=false;
		case res1024x768BW:
		    xRes = 1024;
		    yRes = 768;
		    BaseSkip=8;
		    break;
		default: BaseSkip=8;break;
	}

	QColor SumColor;
	QColor CentralFieldColor;
	QColor TitleColor;
	QColor DiscColor;

	if (BW)
	{
		SumColor=black;
		CentralFieldColor=black;
		TitleColor=black;
		DiscColor=black;
	}
	else
	{
		SumColor=blue;
		CentralFieldColor=darkGreen ;
		TitleColor = darkGreen;
		DiscColor = darkBlue;
	}

	vector<BarcodeInfo*> tmpBarcodeTable;

	CashReg->LoadCodesFromDB(&Codes);
	CashReg->LoadBarcodeTableFromDB(&tmpBarcodeTable);

	char a;
	unsigned int i;

	string PreFX="PREFIX_",PostFX="POSTFIX_";
	for (a='1';a<='4';a++)
		for (i=0;i<tmpBarcodeTable.size();i++)
		{
			if ((tmpBarcodeTable[i]->CodeName==PreFX+a)&&(!tmpBarcodeTable[i]->CodeID.empty()))
				PrefixSeq.insert(PrefixSeq.begin(),QString(tmpBarcodeTable[i]->CodeID.c_str()).toInt(NULL,16));
			if ((tmpBarcodeTable[i]->CodeName==PostFX+a)&&(!tmpBarcodeTable[i]->CodeID.empty()))
				PostfixSeq.insert(PostfixSeq.begin(),QString(tmpBarcodeTable[i]->CodeID.c_str()).toInt(NULL,16));
		}

	for (i=0;i<tmpBarcodeTable.size();i++)
	{
		int k;

		string WP="W_PREFIX2"; //read weight prefices in the range [20..29]
		string WPNum;

		for (a='0';a<='9';a++)
			if ((tmpBarcodeTable[i]->CodeName==WP+a)&&(!tmpBarcodeTable[i]->CodeID.empty()))
                    WeightPrefices.insert(WeightPrefices.end(),atoi(tmpBarcodeTable[i]->CodeID.c_str()));

		W_Code_Length=6;  //weight code consists of four parts (prefix,goods code,
		if (tmpBarcodeTable[i]->CodeName=="W_CODE_LENGTH")//weight,checking number).
		{												//Here we read length of the goods code
			W_Code_Length=atoi(tmpBarcodeTable[i]->CodeID.c_str());
			if (W_Code_Length==0)
				W_Code_Length=6;
		}

		for (k=0;k<BarcodePrefixLen;k++)
			if ((tmpBarcodeTable[i]->CodeName==BarcodePrefix[k])&&(!tmpBarcodeTable[i]->CodeID.empty()))
			{
				BarcodeInfo *tmpInfo=new BarcodeInfo;
				tmpInfo->CodeID=tmpBarcodeTable[i]->CodeID;
				tmpInfo->CodeName=tmpBarcodeTable[i]->CodeName;

				BarcodeID.insert(BarcodeID.end(),tmpInfo);
;;Log((char*)tmpBarcodeTable[i]->CodeName.c_str());
			}

		delete tmpBarcodeTable[i];
	}



	setName( "WorkPlace" );
	setFixedSize(CashReg->size());
	move(0,0);

	//ÒÔËÒÓÍ ÚÓ‚‡Ó‚ ˜ÂÍ‡
	ChequeList = new SelQListView( this, "ChequeList" );
	ChequeList->addColumn( W2U( "No" ),25 );
	ChequeList->header()->setClickEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->header()->setResizeEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->addColumn( W2U( " Œƒ" ),55);
	ChequeList->header()->setClickEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->header()->setResizeEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->addColumn( W2U( "Õ¿»Ã≈ÕŒ¬¿Õ»≈" ),xRes-ChequeList->verticalScrollBar()->width()-75-60-75-75);
	ChequeList->header()->setClickEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->header()->setResizeEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->addColumn( W2U( "÷≈Õ¿" ),75 );
	ChequeList->header()->setClickEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->header()->setResizeEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->addColumn( W2U( " ŒÀ-¬Œ" ),60 );
	ChequeList->header()->setClickEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->header()->setResizeEnabled( false, ChequeList->header()->count() - 1 );

	ChequeList->addColumn( W2U( "—”ÃÃ¿" ),75 );
	ChequeList->header()->setClickEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->header()->setResizeEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->addColumn( W2U( "— »ƒ ¿" ),75 );
	ChequeList->header()->setClickEnabled( false, ChequeList->header()->count() - 1 );
	ChequeList->header()->setResizeEnabled( false, ChequeList->header()->count() - 1 );

	//ChequeList->setGeometry( QRect( 0, 0, width(), height()-70-70-BottomLineHeight-53) );
	ChequeList->setGeometry( QRect( 0, 0, width(), height()-70-70-BottomLineHeight-83) );
	QFont ChequeList_font(  ChequeList->font() );

	ChequeList_font.setPointSize( 11 );//10
	ChequeList_font.setBold(true);
	ChequeList->setFont( ChequeList_font );
	ChequeList->setProperty( "selectionMode", (int)QListView::Single );
	ChequeList->setProperty( "allColumnsShowFocus", QVariant( true, 0 ) );
	ChequeList->setSorting(-1);
	ChequeList->setShowSortIndicator(false);
	ChequeList->setHScrollBarMode(QListView::AlwaysOff);
	ChequeList->setVScrollBarMode(QListView::AlwaysOn);
	ChequeList->move( 0, 70);

	QFont TextLabel_font( font() );
	TextLabel_font.setPointSize(7);


	TextLabel_font.setBold( true );

    //Actsiz
    int CurPos = height()-70-BottomLineHeight-82;

	MActsizLabel = new QColorLabel(this, "MActsizLabel", red );
	MActsizLabel->setFixedSize(width(), 20);//(175, 25);
	MActsizLabel->move( 0, CurPos);
	QFont MActsizLabel_font( font() );
	MActsizLabel_font.setPointSize( 10 );
	MActsizLabel_font.setBold(true);
	MActsizLabel->setFont( MActsizLabel_font );
	MActsizLabel->setProperty( "frameShape", (int)QLabel::Panel );
	MActsizLabel->setProperty( "frameShadow", (int)QLabel::Sunken );
	MActsizLabel->setProperty( "text", tr( "" ) );
	MActsizLabel->setProperty( "alignment", int( QLabel::AlignCenter ) );

	MActsizLabel->setProperty( "echoMode", (int)QLineEdit::Password );


	DiscInfoBox = new QGroupBox(this,"DiscInfoBox");
	DiscInfoBox->setFixedSize(xRes,52);
	DiscInfoBox->move(0,height()-70-53-BottomLineHeight);

    CurPos = 10;

// Label discount card
	lbDiscCard = new QColorLabel(DiscInfoBox, "TextLabelDCard", DiscColor);
	lbDiscCard->setFixedSize(100,10);//(175,10);
	lbDiscCard->move( CurPos, 8);
	lbDiscCard->setFont( TextLabel_font );
	lbDiscCard->setProperty( "text", W2U( "ƒËÒÍÓÌÚÌ‡ˇ Í‡Ú‡:" ) );
	lbDiscCard->setProperty( "alignment", int( QLabel::AlignCenter ) );


	lbBonusCard = new QColorLabel(DiscInfoBox, "TextLabelDCard", DiscColor);
	lbBonusCard->setFixedSize(100,10);//(175,10);
	lbBonusCard->move( CurPos, 8);
	lbBonusCard->setFont( TextLabel_font );
	lbBonusCard->setProperty( "text", W2U( "¡ŒÕ”—Õ¿ﬂ  ¿–“¿:" ) );
	lbBonusCard->setProperty( "alignment", int( QLabel::AlignCenter ) );
    lbBonusCard->hide();

// Label discount card
	lbHandDiscCard = new QColorLabel(DiscInfoBox, "TextLabelHandDiscountCard", red);
	lbHandDiscCard->setFixedSize(100,10);//(175,10);
	lbHandDiscCard->move( CurPos, 18);
	lbHandDiscCard->setFont( TextLabel_font );
	lbHandDiscCard->setProperty( "text", W2U( "" ) );
	lbHandDiscCard->setProperty( "alignment", int( QLabel::AlignLeft ) );

// Label add-on discount card
	lbAddonDiscCard = new QColorLabel(DiscInfoBox, "TextLabelAddonDCard", DiscColor);
	lbAddonDiscCard->setFixedSize(100,10);//(175,10);
	lbAddonDiscCard->move( CurPos, 32);
	lbAddonDiscCard->setFont( TextLabel_font );
	//lbAddonDiscCard->setProperty( "text", W2U( "¡‡Î‡ÌÒ ·ÓÌÛÒÓ‚:" ) );
	lbAddonDiscCard->setProperty( "text", W2U( "ƒÓÔ. Í‡Ú‡:" ) );
	lbAddonDiscCard->setProperty( "alignment", int( QLabel::AlignCenter ) );

    CurPos+= lbDiscCard->width() + 13;

// Edit current discount card number
	MDiscCard = new QColorLabel(DiscInfoBox, "MDiscCard", DiscColor );
	MDiscCard->setFixedSize(180, 22);//(175, 25);
	MDiscCard->move( CurPos, 3);
	QFont MDiscCard_font( font() );
	MDiscCard_font.setPointSize( 14 );
	//MDiscCard_font.setBold(true);
	MDiscCard->setFont( MDiscCard_font );
	MDiscCard->setProperty( "frameShape", (int)QLabel::Panel );
	MDiscCard->setProperty( "frameShadow", (int)QLabel::Sunken );
	MDiscCard->setProperty( "text", tr( "" ) );
	MDiscCard->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Edit current add-on discount card number
	MAddonDiscCard = new QColorLabel(DiscInfoBox, "MAddonDiscCard", Qt::darkMagenta );
	MAddonDiscCard->setFixedSize(180, 22);//(175, 25);
	MAddonDiscCard->move( CurPos, 26);
	QFont MAddonDiscCard_font( font() );
	MAddonDiscCard_font.setPointSize( 14 );
	//MDiscCard_font.setBold(true);
	MAddonDiscCard->setFont( MAddonDiscCard_font );
	MAddonDiscCard->setProperty( "frameShape", (int)QLabel::Panel );
	MAddonDiscCard->setProperty( "frameShadow", (int)QLabel::Sunken );
	MAddonDiscCard->setProperty( "text", tr( "" ) );
	MAddonDiscCard->setProperty( "alignment", int( QLabel::AlignCenter ) );

    CurPos+= MDiscCard->width() + 7;

// Label certificate
	lbCertCard = new QColorLabel(DiscInfoBox, "TextLabelCertCard", DiscColor);
	lbCertCard->setFixedSize(110,10);//(175,10);
	lbCertCard->move( CurPos , 8);
	lbCertCard->setFont( TextLabel_font );
	lbCertCard->setProperty( "text", W2U( "—ÂÚËÙËÍ‡Ú˚:" ) );
	lbCertCard->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Label need issue certificate
	lbNeedCert = new QColorLabel(DiscInfoBox, "TextLabelNeedcert", DiscColor);
	lbNeedCert->setFixedSize(100,10);//(175,10);
	lbNeedCert->move( CurPos, 18);
	lbNeedCert->setFont( TextLabel_font );
	lbNeedCert->setProperty( "text", W2U( "" ) );
	lbNeedCert->setProperty( "alignment", int( QLabel::AlignLeft ) );

    int CurPosBankBonus = CurPos;

    CurPos+= lbCertCard->width() + 5;

// Edit certificate numbers
	MCertCard = new QColorLabel(DiscInfoBox, "MCertCard", DiscColor );
	MCertCard->setFixedSize(130, 22);//(175, 25);
	MCertCard->move( CurPos, 3);
	MCertCard->setFont( MDiscCard_font );
	MCertCard->setProperty( "frameShape", (int)QLabel::Panel );
	MCertCard->setProperty( "frameShadow", (int)QLabel::Sunken );
	MCertCard->setProperty( "text", tr( "" ) );
	MCertCard->setProperty( "alignment", int( QLabel::AlignCenter ) );

    CurPos+= MCertCard->width();

// Edit certificate discount summa
    MCertDiscount = new QColorLabel(DiscInfoBox, "MCertDiscount", DiscColor );
	MCertDiscount->setFixedSize(120 , 22);//(175, 25);
	MCertDiscount->move( CurPos , 3);
	MCertDiscount->setFont( MDiscCard_font );
	MCertDiscount->setProperty( "frameShape", (int)QLabel::Panel );
	MCertDiscount->setProperty( "frameShadow", (int)QLabel::Sunken );
	MCertDiscount->setProperty( "text", tr( "" ) );
	MCertDiscount->setProperty( "alignment", int( QLabel::AlignCenter ) );

    CurPos+= MCertDiscount->width();

    MCertPrePay = new QColorLabel(DiscInfoBox, "MCertPrePay", Qt::darkMagenta );
	MCertPrePay->setFixedSize(width() - CurPos , 22);//(175, 25);
	MCertPrePay->move( CurPos , 3);
	MCertPrePay->setFont( MDiscCard_font );
	MCertPrePay->setProperty( "frameShape", (int)QLabel::Panel );
	MCertPrePay->setProperty( "frameShadow", (int)QLabel::Sunken );
	MCertPrePay->setProperty( "text", tr( "" ) );
	MCertPrePay->setProperty( "alignment", int( QLabel::AlignCenter ) );

    CurPos+= lbDiscCard->width() + 5;

	InfoCLPay = new QColorLabel(DiscInfoBox, "TextLabelInfoCLPay", Qt::darkMagenta);
	InfoCLPay->setFixedSize(200,20);//(175,10);
	InfoCLPay->move(width()-200 , 28);

	QFont InfoCLPay_font( font() );
	InfoCLPay_font.setPointSize( 12 );
	InfoCLPay_font.setBold(true);

	InfoCLPay->setFont( InfoCLPay_font );
	InfoCLPay->setProperty( "text", tr( "" ) );
	InfoCLPay->setProperty( "alignment", int( QLabel::AlignRight ) );


// Label bank bonus
	lbBankBonus = new QColorLabel(DiscInfoBox, "TextbBankBonus", DiscColor);
	lbBankBonus->setFixedSize(110,10);//(175,10);
	lbBankBonus->move( CurPosBankBonus ,32);
	lbBankBonus->setFont( TextLabel_font );
	lbBankBonus->setProperty( "text", W2U( "¡ÓÌÛÒ˚ :" ) );
	lbBankBonus->setProperty( "alignment", int( QLabel::AlignCenter ) );

    CurPosBankBonus+=lbBankBonus->width() + 5;

// Edit bank bonus card numbers
	MBankBonusCard = new QColorLabel(DiscInfoBox, "MBankBonusCard", DiscColor );
	MBankBonusCard->setFixedSize(130, 22);//(175, 25);
	MBankBonusCard->move( CurPosBankBonus, 26);
	MBankBonusCard->setFont( MDiscCard_font );
	MBankBonusCard->setProperty( "frameShape", (int)QLabel::Panel );
	MBankBonusCard->setProperty( "frameShadow", (int)QLabel::Sunken );
	MBankBonusCard->setProperty( "text", tr( "" ) );
	MBankBonusCard->setProperty( "alignment", int( QLabel::AlignCenter ) );

    CurPosBankBonus+= MBankBonusCard->width();

// Edit bank bonus discount summa
    MBankBonusDiscount = new QColorLabel(DiscInfoBox, "MCertDiscount", DiscColor );
	MBankBonusDiscount->setFixedSize(120 , 22);
	MBankBonusDiscount->move( CurPosBankBonus , 26);
	MBankBonusDiscount->setFont( MDiscCard_font );
	MBankBonusDiscount->setProperty( "frameShape", (int)QLabel::Panel );
	MBankBonusDiscount->setProperty( "frameShadow", (int)QLabel::Sunken );
	MBankBonusDiscount->setProperty( "text", tr( "" ) );
	MBankBonusDiscount->setProperty( "alignment", int( QLabel::AlignCenter ) );


// Goods info Box

	GoodsInfoBox = new QGroupBox(this,"GoodsInfoBox");
	GoodsInfoBox->setFixedSize(xRes,72);
	GoodsInfoBox->move(0,height()-72-BottomLineHeight);

// Label Code

	lbCode = new QColorLabel(GoodsInfoBox, "TextLabel1", TitleColor);
	lbCode->setFixedSize(100,7);//(175,10);
	lbCode->move( 0, 2);
	lbCode->setFont( TextLabel_font );
	lbCode->setProperty( "text", W2U( " Ó‰" ) );// W2U( ";ljkasf" ) );//
	lbCode->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Edit Code
	MItemCode = new QColorLabel(GoodsInfoBox, "MItemCode", CentralFieldColor );
	MItemCode->setFixedSize(100, 25);//(175, 25);
	MItemCode->move( 0, 10);
	QFont MItemCode_font( font() );
	MItemCode_font.setPointSize( 18 );
	MItemCode_font.setBold(true);
	MItemCode->setFont( MItemCode_font );
	MItemCode->setProperty( "frameShape", (int)QLabel::Panel );
	MItemCode->setProperty( "frameShadow", (int)QLabel::Sunken );
	MItemCode->setProperty( "text", tr( "" ) );
	MItemCode->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Label Name

	TextLabel2 = new QColorLabel(GoodsInfoBox, "TextLabel2", TitleColor );
	TextLabel2->setFixedSize(width()-MItemCode->width()-100,7);//(width()-MItemCode->width()-160,10);
	TextLabel2->move(MItemCode->width(), 2);

	TextLabel2->setFont( TextLabel_font );
	TextLabel2->setProperty( "text", W2U( "Õ‡ËÏÂÌÓ‚‡ÌËÂ" ) );
	TextLabel2->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Edit Name
	MItemName = new QColorLabel(GoodsInfoBox, "MItemName", CentralFieldColor );
	//MItemName->setFixedSize(ChequeList->width()-MItemCode->width()-197,25);
	MItemName->setFixedSize(ChequeList->width()-MItemCode->width()-195,25);
	MItemName->move( MItemCode->width(), 10 );
	QFont MItemName_font( font() );
	MItemName_font.setPointSize( 12 );//(18);

	MItemName_font.setBold(true);
	MItemName->setFont( MItemName_font );
	MItemName->setProperty( "frameShape", (int)QLabel::Panel );
	MItemName->setProperty( "frameShadow", (int)QLabel::Sunken );
	MItemName->setProperty( "text", "" );


// Label Num

	TextLabel3 = new QColorLabel(GoodsInfoBox, "TextLabel3", TitleColor );
	TextLabel3->setFixedSize(40, 10);
	TextLabel3->move( 0, 35);
	TextLabel3->setFont( TextLabel_font );
	TextLabel3->setProperty( "text", W2U( "No" ) );
	TextLabel3->setProperty( "alignment", int( QLabel::AlignCenter ) );

//Edit Num
	MItemNumber = new QColorLabel(GoodsInfoBox, "MItemNumber", CentralFieldColor );
	MItemNumber->setFixedSize(50, 25);
	MItemNumber->move( 0, 45);
	QFont MItemNumber_font( font() );
	MItemNumber_font.setPointSize( 18 );
	MItemNumber_font.setBold(true);
	MItemNumber->setFont( MItemNumber_font );
	MItemNumber->setProperty( "frameShape", (int)QLabel::Panel );
	MItemNumber->setProperty( "frameShadow", (int)QLabel::Sunken );
	MItemNumber->setProperty( "text", tr( "" ) );
	MItemNumber->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Label Kol-vo

	TextLabel4 = new QColorLabel(GoodsInfoBox, "TextLabel4", TitleColor );
	TextLabel4->setFixedSize(80, 10);
	TextLabel4->move(50+ MItemNumber->width(), 35 );
	TextLabel4->setFont( TextLabel_font );
	TextLabel4->setProperty( "text", W2U( " ÓÎË˜ÂÒÚ‚Ó" ) );
	TextLabel4->setProperty( "alignment", int( QLabel::AlignCenter ) );

//Edit Kol-vo
	MItemCount = new QColorLabel(GoodsInfoBox, "MItemCount", CentralFieldColor );
	MItemCount->setFixedSize(100, 25);
	MItemCount->move(50+MItemNumber->width(), 45);
	QFont MItemCount_font( font() );
	MItemCount_font.setPointSize( 18 );
	MItemCount_font.setBold(true);
	MItemCount->setFont( MItemCount_font );
	MItemCount->setProperty( "frameShape", (int)QLabel::Panel );
	MItemCount->setProperty( "frameShadow", (int)QLabel::Sunken );
	MItemCount->setProperty( "text", tr( "" ) );
	MItemCount->setProperty( "alignment", int( QLabel::AlignCenter ) );


// Label Price

	TextLabel5 = new QColorLabel(GoodsInfoBox, "TextLabel5", TitleColor );
	TextLabel5->setFixedSize(100, 7);
	TextLabel5->move( MItemCode->width() + MItemName->width(),2 );
	TextLabel5->setFont( TextLabel_font );
	TextLabel5->setProperty( "text", W2U( "÷ÂÌ‡" ) );
	TextLabel5->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Edit Price
	MItemPrice = new QColorLabel(GoodsInfoBox, "MItemPrice", CentralFieldColor );
	MItemPrice->setFixedSize(100, 25);
	MItemPrice->move( MItemCode->width() + MItemName->width(),10);
	QFont MItemPrice_font( font() );
	MItemPrice_font.setBold(true);
	MItemPrice_font.setPointSize( 18 );
	MItemPrice->setFont( MItemPrice_font );
	MItemPrice->setProperty( "frameShape", (int)QLabel::Panel );
	MItemPrice->setProperty( "frameShadow", (int)QLabel::Sunken );
	MItemPrice->setProperty( "text", tr( "" ) );
	MItemPrice->setProperty( "alignment", int( QLabel::AlignCenter ) );


// Label Disc

	TextLabel7 = new QColorLabel(GoodsInfoBox, "TextLabel7", TitleColor );
	TextLabel7->setFixedSize(125, 10);
	TextLabel7->move( 50+MItemNumber->width()+MItemCount->width(), 35 );
	TextLabel7->setFont( TextLabel_font );
	TextLabel7->setProperty( "text", W2U( "—ÍË‰Í‡" ) );
	TextLabel7->setProperty( "alignment", int( QLabel::AlignCenter ) );

//Edit Disc
	MItemDiscount = new QColorLabel(GoodsInfoBox, "MItemDiscount", CentralFieldColor );
	MItemDiscount->setFixedSize(145, 25);
	MItemDiscount->move( 50+MItemNumber->width()+MItemCount->width(), 45);
	QFont MItemDiscount_font( font() );
	MItemDiscount_font.setPointSize( 18 );
	MItemDiscount_font.setBold(true);
	MItemDiscount->setFont( MItemDiscount_font );
	MItemDiscount->setProperty( "frameShape", (int)QLabel::Panel );
	MItemDiscount->setProperty( "frameShadow", (int)QLabel::Sunken );
	MItemDiscount->setProperty( "text","");
	MItemDiscount->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Label Sum //—ÛÏÏ‡ ÔÓ ÚÓ‚‡Û

	lbSum = new QColorLabel(GoodsInfoBox, "lbSum", TitleColor );
	lbSum->setFixedSize(130, 10);
	lbSum->move( 50+MItemNumber->width()+MItemCount->width()+MItemDiscount->width(), 35);
	lbSum->setFont( TextLabel_font );
	lbSum->setProperty( "text", W2U( "—ÛÏÏ‡" ) );
	lbSum->setProperty( "alignment", int( QLabel::AlignCenter ) );

//Edit Sum //ÒÛÏÏ‡ ÔÓ ÚÓ‚‡Û

	QFont MItemSum_font( font() );
	MItemSum_font.setPointSize( 18 );
	MItemSum_font.setBold(true);

	MItemSum = new QColorLabel(GoodsInfoBox, "MItemSum", CentralFieldColor );
	MItemSum->setFixedSize(130, 25);
	MItemSum->move(  50+MItemNumber->width()+MItemCount->width()+MItemDiscount->width(), 45 );
	MItemSum->setFont( MItemSum_font );
	MItemSum->setProperty( "frameShape", (int)QLabel::Panel );
	MItemSum->setProperty( "frameShadow", (int)QLabel::Sunken );
	MItemSum->setProperty( "text","");
	MItemSum->setProperty( "alignment", int( QLabel::AlignCenter ) );




// Edit Sbarcode
	MItemSBarcode = new QColorLabel(GoodsInfoBox, "MItemSbarcode", Qt::darkMagenta );
	MItemSBarcode->setFixedSize(50+MItemNumber->width()+MItemCount->width()+MItemDiscount->width()+MItemSum->width()-100,25);
	MItemSBarcode->move( 50+MItemNumber->width()+MItemCount->width()+MItemDiscount->width()+MItemSum->width(), 45 );
	QFont MItemSBarcode_font( font() );
	MItemSBarcode_font.setPointSize( 10 );//(18);

	//MItemSBarcode_font.setBold(true);
	MItemSBarcode->setFont( MItemSBarcode_font );
	MItemSBarcode->setProperty( "frameShape", (int)QLabel::Panel );
	MItemSBarcode->setProperty( "frameShadow", (int)QLabel::Sunken );
	MItemSBarcode->setProperty( "text", "" );

// Label Time


	QFont fntTime( font() );
	fntTime.setPointSize( 18 );
	fntTime.setBold(true);

	lbTime = new QColorLabel(GoodsInfoBox, "lbTime", CentralFieldColor );
	//lbTime = new QColorLabel(GoodsInfoBox, "lbTime", Qt::darkBlue );
	lbTime->setFont(fntTime);
	lbTime->setFixedSize(120, 30);
	lbTime->move( xRes-212, 39);
	lbTime->setProperty( "text", W2U( "¬–≈Ãﬂ" ));
	lbTime->setProperty( "alignment", int( QLabel::AlignCenter ) );
// END GoodsInfoBox

// Label Kassir

	lbSaleman = new QColorLabel(this, "lbSaleman", CentralFieldColor );
	lbSaleman->setFixedSize(xRes/4,10);
	lbSaleman->move(0,0);
	lbSaleman->setFont( TextLabel_font );
	lbSaleman->setProperty( "text", W2U( "¬‡Ò Ó·ÒÎÛÊË‚‡ÂÚ" ) );
	lbSaleman->setProperty( "alignment", int( QLabel::AlignCenter ) );

//Edit Kassir

	Saleman = new QColorLabel(this, "Saleman", darkGray );
	Saleman->setFixedSize(int(xRes/3.5),25);
	Saleman->move(0,10);
	//;;Saleman->setProperty( "frameShape", (int)QLabel::Panel );
	//;;Saleman->setProperty( "frameShadow", (int)QLabel::Sunken );
	Saleman->setProperty( "text", tr( "" ) );
	Saleman->setProperty( "alignment", int( QLabel::AlignLeft ) );

// Label Input Line
//	Log("lbEdit");
//	lbEdit = new QColorLabel( this, "TextLabel10",  CentralFieldColor );
//	lbEdit->setFixedSize(xRes/2, 10);
//	lbEdit->move( 0, 35);
//	lbEdit->setFont( TextLabel_font );
//	lbEdit->setProperty( "text", W2U("¬‚Ó‰ ÁÌ‡˜ÂÌËÈ" ) );
//	lbEdit->setProperty( "alignment", int( QLabel::AlignCenter ) );


//Edit Input Line

	EditLine = new ExtQLineEdit( this, "EditLine", Codes, PrefixSeq, PostfixSeq );
	QFont EditLine_font(  EditLine->font() );
	EditLine_font.setPointSize( 10 );

	EditLine->setFixedSize(xRes/2, 25);
	EditLine->move(  0,45);
	EditLine->setFont( EditLine_font );

	EditLine->setFocus();

// Label Total Disc

	lbTotalDiscount = new QColorLabel( this, "lbTotalDiscount",  CentralFieldColor );
	lbTotalDiscount->setFixedSize(xRes/4, 10);
	lbTotalDiscount->move( xRes/4, 0);
	lbTotalDiscount->setFont( TextLabel_font );
	lbTotalDiscount->setProperty( "text", W2U( "—ÍË‰Í‡ ÔÓ ˜ÂÍÛ" ) );
	lbTotalDiscount->setProperty( "alignment", int( QLabel::AlignCenter ) );
	lbTotalDiscount->hide();

//Edit Total Disc

	QFont fntTotalDiscount(  font() );
	fntTotalDiscount.setPointSize( 18 );
	fntTotalDiscount.setBold(true);

	eTotalDiscount = new QColorLabel( this, "eTotalDiscount", SumColor );
	eTotalDiscount->setFixedSize(xRes/4,25);
	eTotalDiscount->move(xRes/4,10);
	eTotalDiscount->setFont(fntTotalDiscount);
	eTotalDiscount->setProperty( "text","0,00");
	eTotalDiscount->setProperty( "alignment", int( QLabel::AlignCenter ) );
	eTotalDiscount->hide();

// Label Total SUM

	lbTotalSum = new QColorLabel( this, "lbTotalSum",  CentralFieldColor );
	lbTotalSum->setFixedSize(xRes/2, 10);
	lbTotalSum->move(xRes/2,0);
	lbTotalSum->setFont( TextLabel_font );
	lbTotalSum->setProperty( "text", W2U( "CÛÏÏ‡ ˜ÂÍ‡" ) );
	lbTotalSum->setProperty( "alignment", int( QLabel::AlignCenter ) );

// Label Total Change

	lbTotalChange = new QColorLabel( this, "lbTotalChange",  CentralFieldColor );
	lbTotalChange->setFixedSize(xRes/2, 10);
	lbTotalChange->move(xRes/2,0);
	lbTotalChange->setFont( TextLabel_font );
	lbTotalChange->setProperty( "text", W2U( "—‰‡˜‡" ) );
	lbTotalChange->setProperty( "alignment", int( QLabel::AlignCenter ) );

//Edit Total SUM

	QFont MTotalSum_font(  font() );
	MTotalSum_font.setPointSize( 48 );

	MTotalSum = new QColorLabel( this, "MTotalSum", SumColor );
	MTotalSum->setFixedSize(xRes/2,60);
	MTotalSum->move(xRes/2,lbTotalSum->height());
	MTotalSum->setFont( MTotalSum_font );
	MTotalSum->setProperty( "frameShape", (int)QLabel::Panel );
	MTotalSum->setProperty( "frameShadow", (int)QLabel::Sunken );
	MTotalSum->setProperty( "text","0,00");
	MTotalSum->setProperty( "alignment", int( QLabel::AlignCenter ) );

//Edit Total Change

	QFont MTotalChange_font(  font() );
	MTotalChange_font.setPointSize( 48 );

	MTotalChange = new QColorLabel( this, "MTotalChange", SumColor );
	MTotalChange->setFixedSize(xRes/2,60);
	MTotalChange->move(xRes/2,lbTotalChange->height());
	MTotalChange->setFont( MTotalChange_font );
	MTotalChange->setProperty( "frameShape", (int)QLabel::Panel );
	MTotalChange->setProperty( "frameShadow", (int)QLabel::Sunken );
	MTotalChange->setProperty( "text","0,00");
	MTotalChange->setProperty( "alignment", int( QLabel::AlignCenter ) );


	QFont ButtonFont(font());//GUI elements initialization
	ButtonFont.setPointSize(8);

	InfoBar = new QProgressBar(this);
	InfoBar->setFixedSize(135,BottomLineHeight);
	InfoBar->move(0,height()-InfoBar->height());

	InfoMessage = new QLabel(W2U("*"),this);
	InfoMessage->setFixedSize(265 - (CashReg->CheckMillenium?15:0),BottomLineHeight);
	InfoMessage->move(InfoBar->width(),height()-InfoMessage->height());
	InfoMessage->setFrameShape( QLabel::Panel );
	InfoMessage->setFrameShadow( QLabel::Sunken );
	InfoMessage->setFont(ButtonFont);

	if(CashReg->CheckMillenium){
		ActionInfo = new QLabel(W2U("A"),this);
		ActionInfo->setFixedSize(15,BottomLineHeight);
		ActionInfo->move(InfoBar->width()+InfoMessage->width(),height()-ActionInfo->height());
		ActionInfo->setFrameShape( QLabel::Panel );
		ActionInfo->setFrameShadow( QLabel::Sunken );
		ActionInfo->setFont(ButtonFont);
	}else{
		ActionInfo = NULL;
	}

	KeepCheckInfo = new QColorLabel(this, "KeepCheck",SumColor);
	KeepCheckInfo->setFixedSize(30,BottomLineHeight);
	KeepCheckInfo->move(InfoBar->width()+InfoMessage->width(),height()-KeepCheckInfo->height());
	QFont KeepCheckInfo_font( font() );
	KeepCheckInfo_font.setPointSize( 8 );
	KeepCheckInfo_font.setBold(true);
	//KeepCheckInfo_font.setStrikeOut(true);
	KeepCheckInfo->setFont( KeepCheckInfo_font );
	KeepCheckInfo->setProperty( "frameShape", (int)QLabel::Panel );
	KeepCheckInfo->setProperty( "frameShadow", (int)QLabel::Sunken );
	if(keepstate=fopen("tmp/keepstate.dat","r")){//
		fclose(keepstate);
		KeepCheckInfo->setProperty( "text",W2U("Œ.◊."));
//		KeepCheckInfo->setProperty( "StrikeOut",true);
	}
	else
		KeepCheckInfo->setProperty( "text","");
	KeepCheckInfo->setProperty( "alignment", int( QLabel::AlignCenter ) );

    string stEgais = (CashReg->EgaisSettings.ModePrintQRCode>-1)?"≈√¿»—":"Œÿ»¡ ¿";
    Bar1 = new QColorLabel(this, "Bar1",Qt::red);
	//Bar1 = new QLabel(W2U(""),this);
	QFont Bar1_font( font() );
	Bar1_font.setPointSize( 8 );
	Bar1_font.setBold(true);
	Bar1->setFont( Bar1_font );

    Bar1->setProperty( "text",W2U(stEgais));

	Bar1->setFixedSize(70,BottomLineHeight);
	Bar1->move(InfoBar->width()+InfoMessage->width()+KeepCheckInfo->width(),height()-Bar1->height());
	Bar1->setFrameShape( QLabel::Panel );
	Bar1->setFrameShadow( QLabel::Sunken );
	//ButtonFont.setStrikeOut(CashReg->Bar1->font().strikeOut());
	Bar1->setFont(ButtonFont);

	Bar2 = new QLabel(W2U(""),this);
	Bar2->setFixedSize(30,BottomLineHeight);
	Bar2->move(InfoBar->width()+InfoMessage->width()+KeepCheckInfo->width()+Bar1->width(),height()-Bar2->height());
	Bar2->setFrameShape( QLabel::Panel );
	Bar2->setFrameShadow( QLabel::Sunken );
	//ButtonFont.setStrikeOut(CashReg->Bar2->font().strikeOut());
	Bar2->setFont(ButtonFont);

	Bar3 = new QLabel(W2U(""),this);
	Bar3->setFixedSize(30,BottomLineHeight);
	Bar3->move(InfoBar->width()+InfoMessage->width()+KeepCheckInfo->width()+Bar1->width()+Bar2->width(),height()-Bar3->height());
	Bar3->setFrameShape( QLabel::Panel );
	Bar3->setFrameShadow( QLabel::Sunken );
	//ButtonFont.setStrikeOut(CashReg->Bar3->font().strikeOut());
	Bar3->setFont(ButtonFont);

	BankInfo = new QLabel(W2U(CashReg->TryBankConnect?"¡‡ÌÍ":""),this);
	BankInfo->setFixedSize(40,BottomLineHeight);
	BankInfo->move(InfoBar->width()+InfoMessage->width()+KeepCheckInfo->width()+Bar1->width()+Bar2->width()+Bar3->width(),height()-BankInfo->height());
	BankInfo->setFrameShape( QLabel::Panel );
	BankInfo->setFrameShadow( QLabel::Sunken );

//	QFont tmpFont=ButtonFont;
//	tmpFont.setStrikeOut(CashReg->BankInfo->font().strikeOut());

//	BankInfo->setFont(tmpFont);
	//ButtonFont.setStrikeOut(CashReg->BankInfo->font().strikeOut());
	BankInfo->setFont(ButtonFont);
    UpdateBankStatus();

	ServerInfo = new QLabel(W2U("¡¿«¿"),this);
	ServerInfo->setFixedSize(50,BottomLineHeight);
	ServerInfo->move(InfoBar->width()+KeepCheckInfo->width()+InfoMessage->width()+(CashReg->CheckMillenium?15:0)
		+Bar1->width()+Bar2->width()+Bar3->width()+BankInfo->width(),height()-ServerInfo->height());
	ServerInfo->setFrameShape( QLabel::Panel );
	ServerInfo->setFrameShadow( QLabel::Sunken );
	//ButtonFont.setStrikeOut(CashReg->ServerInfo->font().strikeOut());
	ServerInfo->setFont(ButtonFont);

	RegisterInfo = new QLabel(W2U("‘–"),this);
	RegisterInfo->setFixedSize(30,BottomLineHeight);
	RegisterInfo->move(InfoBar->width()+KeepCheckInfo->width()+InfoMessage->width()+ServerInfo->width()+(CashReg->CheckMillenium?15:0)
		+Bar1->width()+Bar2->width()+Bar3->width()+BankInfo->width(),height()-RegisterInfo->height());
	RegisterInfo->setFrameShape( QLabel::Panel );
	RegisterInfo->setFrameShadow( QLabel::Sunken );
	//ButtonFont.setStrikeOut(CashReg->RegisterInfo->font().strikeOut());
	RegisterInfo->setFont(ButtonFont);

	Timer = new QTimer(this);//start clock
//	Timer2 = new QTimer(this);
	QTimer::singleShot(100, this, SLOT(CheckCheque()));//
//	if (!Cheque->GetCount()) QTimer::singleShot(100, this, SLOT(AutoRestoreKeepedCheque()));

	//PriceChecker = new PriceCheck(this);

//*
// + dms ===== New Year 2011 =====\

	LabelImage = new QLabel(this, "LabelImage");
	LabelImage->move(width()-80, height()-80);

	LabelImage->setFixedSize(70, 70);
	LabelImage->setProperty( "alignment", int( QLabel::AlignCenter ) );
	LabelImage->setBackgroundColor(Qt::lightGray);
    LabelImage->setMargin(1);

    QPixmap pic;

    QImage img("./logo2.gif");
    if (!pic.convertFromImage( img ))
    {
       QImage img_logo("./logo.jpg");
       pic.convertFromImage( img_logo );

    }

    LabelImage->setPixmap(pic);

    //QMovie *mv = new QMovie("./Xmas.gif");
    //LabelImage->setMovie(*mv);

    LabelImage->setScaledContents(true);

// - dms =====/
//*/

	connect( Timer, SIGNAL(timeout()), this, SLOT(timerDone()));
	connect( EditLine, SIGNAL(keyPressed(int)), this, SLOT(ProcessKey(int)));
	connect( EditLine, SIGNAL(barcodeFound()), this, SLOT(ProcessBarcode()));


	Timer->start(1000);

    // bank connection test timer
	TimerBank = new QTimer(this);//start clock
	connect( TimerBank, SIGNAL(timeout()), this, SLOT(TimerBankAction()));
//! ‚˚ÍÎ.
//!	TimerBank->start(3*60*1000);  // ‚ ÏËÎËÒÂÍÛÌ‰‡ı

    HandBarcode = false;

	bPriceCheck=false;
	PriceChecker=NULL;

	//bFreeSum=false;
	FreeSum=NULL;
    ScreenSaver=NULL;
    Messager=NULL;

    PictureNumber =0 ;
    //!ShowScreenSaver =true;
    ShowScreenSaver =false;
	TimerScreenSaver = new QTimer(this);//start ScreenSaver  timer
	connect( TimerScreenSaver, SIGNAL(timeout()), this, SLOT(StartScreenSaver()));

    //!TimerScreenSaver->start(WAITTIMESS);


	char* KEYNAME[0xffff];

	for(i=0;i<0xffff;i++)
		KEYNAME[i]="";

	KEYNAME[Key_F1]="F1";KEYNAME[Key_F2]="F2";KEYNAME[Key_F3]="F3";
	KEYNAME[Key_F4]="F4";KEYNAME[Key_F5]="F5";KEYNAME[Key_F6]="F6";
	KEYNAME[Key_F7]="F7";KEYNAME[Key_F8]="F8";KEYNAME[Key_F9]="F9";
	KEYNAME[Key_F10]="F10";KEYNAME[Key_F11]="F11";KEYNAME[Key_F12]="F12";
	KEYNAME[Key_Plus]="+";KEYNAME[Key_Return]=KEYNAME[Key_Enter]="¬¬Œƒ";
	KEYNAME[Key_Delete]="DEL";KEYNAME[Key_End]="END";
	KEYNAME[Key_Space]="œ–Œ¡≈À";KEYNAME[Key_Minus]="--";
	KEYNAME[Key_Slash]=" /"; //key hints
	KEYNAME[Key_Asterisk]="*";

	CashReg->LoadFRSoundFromDB(&frSound,FRSOUND);

	try
	{
		IsCurrentGoodsEmpty=true;   //init workplace
		CurrentGoods = &CurGoods;//new GoodsInfo;
		Cheque = new FiscalCheque;

		Saleman->setText(W2U(CashReg->CurrentSaleman->Name));

		PaymentKeyPress=0;

		CashReg->DbfMutex->lock();

		switch (CashReg->DisplayType)//init driver of the customer's display
		{
			case EmptyDisplayType:CustomerDisplay=/*(AbstractDisplay*)*/new EmptyDisplay(0,0);break;
			case DatecsDisplayType:	CustomerDisplay=/*(AbstractDisplay*)*/new DatecsDisplay(
									CashReg->ConfigTable->GetLongField("DISPLPORT"),
									CashReg->ConfigTable->GetLongField("DISPLBAUD"));
									break;
			case VSComDisplayType:	CustomerDisplay=/*(AbstractDisplay*)*/new VSComDisplay(
									CashReg->ConfigTable->GetLongField("DISPLPORT"),
									CashReg->ConfigTable->GetLongField("DISPLBAUD"));
									break;
		}

		switch (CashReg->ScaleType)
		{
			case EmptyScaleType:
				Scales=/*(AbstractScales*)*/new EmptyScales(0,0,0);
				break;
			case MassaKScaleType:
				Scales=/*(AbstractScales*)*/new MassaKScales(//init scale's driver
					CashReg->ConfigTable->GetLongField("SCALEPORT"),
					CashReg->ConfigTable->GetLongField("SCALEBAUD"),
					CashReg->ConfigTable->GetLongField("SCALE_WAIT"));
				break;
			case MassaKPType:
				Scales=new MassaKP(//init scale's driver
					CashReg->ConfigTable->GetLongField("SCALEPORT"),
					CashReg->ConfigTable->GetLongField("SCALEBAUD"),
					CashReg->ConfigTable->GetLongField("SCALE_WAIT"));
				break;
		}

		Scanner = new ComPortScan(CashReg
					    ,CashReg->ConfigTable->GetLongField("SCANPORT")
					    ,CashReg->ConfigTable->GetLongField("SCANBAUD")
					    );//init scanner's driver

		//Scanner = CashReg->Scanner;

		MaxAmount=CashReg->ConfigTable->GetLongField("MAXAMOUNT");//limits of the
		if(MaxAmount < .001) MaxAmount = 100000;
		MaxSum=CashReg->ConfigTable->GetLongField("MAXSUM");//saleman's activity

		CashReg->DbfMutex->unlock();
	}
	catch(cash_error& er)
	{
		CashReg->DbfMutex->unlock();
		CashReg->LoggingError(er);
	}

	IsChequeInProgress=false;

	InitWorkPlace();
	BarcodeCard=NULL;
	CashReg->ActsizCard=NULL;

	timerDone();

}

/*
 *  Destroys the object and frees any allocated resources
 */
WorkPlace::~WorkPlace()
{
//    WPCX->~LProc();
    // no need to delete child widgets, Qt does it all for us
}

void WorkPlace::CloseWorkPlace(void)
{
	int GuardRes=NotCorrect;

	//if we have opened check then try to annul it
	if (((Cheque->GetSize()>0)&&(!CashReg->CurrentSaleman->Annul))||
			((!IsCurrentGoodsEmpty)&&(!CashReg->CurrentSaleman->CurrentGoods)))
		while(!CheckGuardCode(GuardRes));


	if (Cheque->GetCount()>0)
	{
		CashReg->ShowErrorCode(FiscalReg->Cancel());
		CashReg->AnnulCheck(Cheque,GuardRes);
	}
	keepstate=fopen("tmp/keepstate.dat","r");
	if(keepstate)
	{
		if(fclose(keepstate)){
			ShowMessage("Œ¯Ë·Í‡ Á‡Í˚ÚËˇ Ù‡ÈÎ‡!\n—ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!");
			return;
		}
		if (!Cheque->GetSize())
		{//‚ÓÒÒÚ‡ÌÓ‚ËÚ¸ ÓÚÎÓÊÂÌÌ˚È ˜ÂÍ
			RestoreKeepedCheque();
			ShowMessage("ŒÚÎÓÊÂÌÌ˚È ˜ÂÍ ‚ÓÒÒÚ‡ÌÓ‚ÎÂÌ ‰Îˇ ‡ÌÌÛÎËÓ‚‡ÌËˇ!");
		}
		GuardRes=NotCorrect;
		//if we have opened check then try to annul it
		if (((Cheque->GetSize()>0)&&(!CashReg->CurrentSaleman->Annul))||
				((!IsCurrentGoodsEmpty)&&(!CashReg->CurrentSaleman->CurrentGoods)))
			while(!CheckGuardCode(GuardRes));
		if (!IsCurrentGoodsEmpty)
			CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CURRENTGOODS,
				CurrentGoods->ItemSum,CashReg->CurrentSaleman->Id,GuardRes);
		if (Cheque->GetCount()>0)
		{
			CashReg->ShowErrorCode(FiscalReg->Cancel());
			CashReg->AnnulCheck(Cheque,GuardRes);
		}
	}

	delete CustomerDisplay;
	delete Scales;

	delete Scanner;//destroy scanner's driver

	//delete CurrentGoods;
	delete Cheque;
	delete Timer;
	delete TimerBank;
    delete TimerScreenSaver;

	for (unsigned int i=0;i<BarcodeID.size();i++)
		delete BarcodeID[i];
}

void WorkPlace::ShowMessage(string str)
{
	::ShowMessage(thisApp->focusWidget(),str);
}

bool WorkPlace::ShowQuestion(string str,bool IsYesDefault)
{
	return ::ShowQuestion(thisApp->focusWidget(),str,IsYesDefault);
}

void WorkPlace::timerDone(void)
{
	//setCaption(W2U("¿–Ã  ¿——»–¿")+W2U(CashReg->CurrentSaleman->Name)+" "+(CashReg->GetCurDate()+" "+CashReg->GetCurTime()).c_str());
    /* slair+ */
//    QString status_check;
//    if (dont_print_paper_check) {
//        status_check = W2U(" ¡ÂÁ ·ÛÏ‡ÊÌÓ„Ó ˜ÂÍ‡");
//    } else {
//        status_check = W2U(" — ·ÛÏ‡ÊÌ˚Ï ˜ÂÍÓÏ");
//    }
//    setCaption(W2U("APM KACCA rev.")+W2U(Int2Str(revision))+W2U(" ")+(CashReg->GetCurDate()).c_str()+status_check);
    /* slair- */
    setCaption(W2U("APM KACCA rev.")+W2U(Int2Str(revision))+W2U(" ")+(CashReg->GetCurDate()).c_str());
	lbTime->setProperty( "text",CashReg->GetCurTime().c_str());
}

void WorkPlace::ShowSpecLabel(QLabel* CurLabel,char **KeyCode)
//show key hint
//if key is not active we disable it
{
/*
	CashReg->DbfMutex->lock();

	int Key=CashReg->KeyboardTable->GetLongField("KEYCODE");

	CashReg->DbfMutex->unlock();

	if (Key>0)
	{

		CurLabel->setText(CurLabel->text()+W2U(KeyCode[Key]));
		CurLabel->show();
	}
*/
}

void WorkPlace::ShowGoodsInfo(void)
{
    //;;Log("[FUNC] ShowGoodsInfo [START]");

	if((PriceChecker!=NULL) || (FreeSum!=NULL))
		return;

	if (Cheque->GetSize()==0)
	{
		ChequeList->clear();
		InfoMessage->setText(W2U("*"));
        RestartTimerSS(true);
	}
	else
	{
	    InfoMessage->setText(W2U(""));
        RestartTimerSS(false);
    }

    // ÔÂÂÒ˜ÂÚ ÒÍË‰ÓÍ
	ProcessDiscount(Cheque);

	if (!IsCurrentGoodsEmpty)  //show properties of the current goods
	{
//;;Log("[FUNC] ShowGoodsInfo [+1]");
  		MItemCode->setNum(CurrentGoods->ItemCode);
		MItemName->setText(W2U(CurrentGoods->ItemName));
//;;Log("[FUNC] ShowGoodsInfo [+1.1]");
        if (CurrentGoods->ItemSecondBarcode.length()<=21)
            MItemSBarcode->setText(W2U(CurrentGoods->ItemSecondBarcode.substr(0, 21)));
        else
            MItemSBarcode->setText(tr(""));
//;;Log("[FUNC] ShowGoodsInfo [+1.2]");
		MItemNumber->setNum(CurrentGoods->ItemNumber);

		MItemCount->setText(GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
		MItemPrice->setText(GetRounded(CurrentGoods->ItemPrice,0.01).c_str());
		MItemSum->setText(GetRounded(CurrentGoods->ItemSum,0.01).c_str());
		MItemDiscount->setText(GetRounded(CurrentGoods->ItemCalcSum-CurrentGoods->ItemSum,0.01).c_str());

		//MActsizLabel->setText(W2U(CurrentGoods->ItemActsizBarcode));
//;;Log("[FUNC] ShowGoodsInfo [+2]");
        //int cntActsiz = CurrentGoods->Actsiz.size();
        //if (cntActsiz>0) MActsizLabel->setText(W2U(Int2Str(cntActsiz)+" - "+ CurrentGoods->Actsiz[cntActsiz-1]));
        //if (cntActsiz>0) MActsizLabel->setText(W2U("¿ÍˆËÁÓ‚: "+Int2Str(cntActsiz)));

        if (IsGoods18())
        {
            MActsizLabel->setText(W2U("—œ–Œ—»“≈ ”ƒŒ—“Œ¬≈–≈Õ»≈ À»◊ÕŒ—“» !"));
        } else
        {
            MActsizLabel->clear();
        }

//;;Log("[FUNC] ShowGoodsInfo [+3]");
	}
	else
	{
//	    ;;Log("[FUNC] ShowGoodsInfo [+4]");
		MItemCode->clear();
		MItemName->clear();
		MItemNumber->clear();
        MItemSBarcode->clear();
		MItemCount->clear();

		MItemPrice->clear();
		MItemSum->clear();
		MItemDiscount->clear();

		MDiscCard->clear();

		MActsizLabel->clear();

		MCertCard->clear();
		MCertDiscount->clear();
		MCertPrePay->clear();
	}
//;;Log("[FUNC] ShowGoodsInfo [+5]");
    if (CurrentCustomer!=0)
    {
        //string CardStr = LLong2Str(CurrentCustomer);
        string CardStr = Card2Str(CurrentCustomer);
        if (IsHandDiscounts())
        {
             CardStr="* "+CardStr;
             lbHandDiscCard->setText(W2U ("* Ì‡ÒÚÓÂÌÌ˚Â ÒÍË‰ÍË"));
        }
        else
        {
            lbHandDiscCard->setText(tr(""));
        }

        MDiscCard->setText( CardStr.c_str() );


        if (NeedCert)
        {
            lbDiscCard->hide();
            lbBonusCard->show();

            lbNeedCert->setText(W2U ("* ·ÓÌÛÒÌ‡ˇ Í‡Ú‡"));
        }
        else
        {
            lbBonusCard->hide();
            lbDiscCard->show();

            lbNeedCert->setText(tr(""));
        }

    }
    else
    {
        MDiscCard->setText(tr( "" ));
        lbHandDiscCard->setText(tr(""));
        lbNeedCert->setText(tr(""));
    }
//;;Log("[FUNC] ShowGoodsInfo [+6]");
    if (CurrentAddonCustomer!=0)
        MAddonDiscCard->setText( LLong2Str(CurrentAddonCustomer).substr(6).c_str() );
    else
        MAddonDiscCard->setText(tr( "" ));


// ¡‡Î‡ÌÒ ÚÂÍÛ˘ÂÈ ·ÓÌÛÒÌÓÈ Í‡Ú˚
/*    if (CurrentBonusBalans!=0)
        MAddonDiscCard->setText( GetRounded(CurrentBonusBalans,0.01).c_str() );
    else
        MAddonDiscCard->setText(tr( "" ));
*/
    if (Cheque->CertificateSumm!=0)
        MCertDiscount->setText( GetRounded(Cheque->CertificateSumm,0.01).c_str() );
    else
        MCertDiscount->setText(tr( "" ));

    if (Cheque->PrePayCertificateSumm!=0)
        MCertPrePay->setText( GetRounded(Cheque->PrePayCertificateSumm,0.01).c_str() );
    else
        MCertPrePay->setText(tr( "" ));

    if (Cheque->BankBonusSumm!=0)
        MBankBonusDiscount->setText( GetRounded(Cheque->BankBonusSumm,0.01).c_str() );
    else
        MBankBonusDiscount->setText(tr( "" ));

    // ¡ÓÌÛÒ˚
    if (Cheque->BonusSumm!=0)
        MBankBonusDiscount->setText( GetRounded(Cheque->BonusSumm,0.01).c_str() );
    else
        MBankBonusDiscount->setText(tr( "" ));


    //MBankBonusCard->setText( (Cheque->BankBonusString).c_str() );
    MBankBonusCard->setText( GetRounded(Cheque->GetSumBonusAdd(),0.01).c_str() );

    MCertCard->setText( W2U(Cheque->CertificateString) );


//;;Log("[FUNC] ShowGoodsInfo [+7]");

	MTotalSum->setText(GetTotalSum().c_str());

	eTotalDiscount->setText(GetRounded(Cheque->GetDiscountSum(),0.01).c_str());

	if (fabs(Cheque->GetDiscountSum())>epsilon)
	{
	    eTotalDiscount->show();
	    lbTotalDiscount->show();
	}
	else
	{
	    eTotalDiscount->hide();
	    lbTotalDiscount->hide();
	}

	if (fabs(Cheque->GetSum())>epsilon)
	{
		if (!IsCurrentGoodsEmpty)
			CustomerDisplay->DisplayLines(CurrentGoods->ItemName.c_str(),
														("Œ·˘‡ˇ ÒÛÏÏ‡ "+GetTotalSum()).c_str());
		else
			CustomerDisplay->DisplayLines("",("Œ·˘‡ˇ ÒÛÏÏ‡ "+GetTotalSum()).c_str());
	}
	else
	{
		if (!IsCurrentGoodsEmpty)
			CustomerDisplay->DisplayLines(CurrentGoods->ItemName.c_str(),"");
		else
			CustomerDisplay->DisplayLines("ƒÓ·Ó ÔÓÊ‡ÎÓ‚‡Ú¸!","");
	}

	InfoCLPay->setText(tr( "" ));
	//;;Log("[FUNC] ShowGoodsInfo [END]");
}

string WorkPlace::GetTotalSum(void)
{
	return GetRounded(Cheque->GetSumToPay(),0.01);//get cheque sum+current goods sum
}

void WorkPlace::InitWorkPlace(bool clear)//erase cashman's workplace
{
    //;;Log("[FUNC] InitWorkPlace [START]");

	CashReg->GetNewGoods();
	if (!IsChequeInProgress)
	{
	    Log("InitWorkPlace");
		ChequeList->clear();
		CashReg->ClearCurrentCheck();
		Cheque->Clear();
		EditLine->clear();
		CashReg->ClearPayment();

		//
		CurrentGoods = &CurGoods;
		CurGoods.ItemCount = 1;

		IsCurrentGoodsEmpty=true;

        MDiscCard->setText(tr( "" ));

		MTotalSum->setText("0,00");
		lbTotalSum->show();
		MTotalSum->show();

		lbTotalChange->hide();
		MTotalChange->hide();
		MTotalChange->setText("0,00");

        SumRestoreBankBonus=0;
		PaymentKeyPress=0;
		IsChequeInProgress=true;
		GoodsWeightChecked=false;
		CurrentCustomer=0;
		CurrentCertificate=0;
		CurrentAddonCustomer=0;

		CurrentBonusBalans = 0;

		NeedCert=0;
		NeedActionVTB = false;

		//KeepCustomer=0;// 07/09/07
		DiscountType="";
		DiscountTypeCustomer="";
		CashReg->LoadDiscountTypeFromDB(CurrentCustomer,&DiscountType);
		DiscountTypeCustomer=DiscountType;
		BarcodeCard=NULL;

        bonus_pay_id="";
        CurrentActiveBonus=0;
        SummaBonusAction = 0;
        StatusBonusCard ="";

		ShowGoodsInfo();

//Log("++ InitWorkPlace PCX->InitResult()");
		CashReg->WPCX->InitResult();
//Log("-- InitWorkPlace PCX->InitResult()");

        FindInDB = false;

        ActionShowMsg=true;

        CustomerByPhone=false;

        NeedChangeCard2VIP = false;
        NeedChangeCard2SuperVIP = false;

	}
	else
    {
        //+dms
        if (clear) // ÔÓÒÚÓ Ó˜ËÒÚËÏ Ì‡‰ÔËÒË Ì‡ ÙÓÏÂ
        {

            ShowGoodsInfo();

//            MDiscCard->setText(tr( "" ));
//            MCertCard->setText(tr( "" ));
//            MCertDiscount->setText(tr( "" ));
//
//            MTotalSum->setText("0,00");
//            lbTotalSum->show();
//            MTotalSum->show();
//
//            lbTotalChange->hide();
//            MTotalChange->hide();
//            MTotalChange->setText("0,00");

        }
        //-dms
    }
    //;;Log("[FUNC] InitWorkPlace [END]");
}

bool WorkPlace::AddGoods(int code)
{
	int ret;
	if (b_uncorrectend) //
		return false; //
	if (!EditLineCheck(""))
		return false;

	ret=CashReg->AddGoods(&CurGoods,code);
	if (ret == 1 )//ÌÂÔ‡‚ËÎ¸Ì‡ˇ ˆÂÌ‡ ÚÓ‚‡‡
	{
		ShowMessage("ÕÂÔ‡‚ËÎ¸Ì‡ˇ ˆÂÌ‡ ÚÓ‚‡‡! —ÓÓ·˘ËÚÂ ÚÓ‚‡Ó‚Â‰Û!");
		return false;
	}

	if (ret==0)
	{
		try
		{

            string resCheckSugar = "";
			if(CheckSugar(&resCheckSugar, CurGoods.ItemCode, CurGoods.ItemCount))
			{
                bool oldscanersuspend = Scanner->suspend;
                Scanner->suspend = true;
			    ShowMessage("“Œ¬¿– Õ≈ ƒŒ¡¿¬À≈Õ\n\n"+resCheckSugar);
			    Scanner->suspend = oldscanersuspend;
			    return false;
            }


            long long CertNumber = 0;
            string strLock = CurGoods.Lock;
		    if (CashReg->GoodsLock(strLock, GL_Manager) == GL_Manager)
            { // ÔÓ‰‡Ê‡ Ò Á‡ÔÓÒÓÏ ÿ  ÏÂÌÂ‰ÊÂ‡

              CertNumber = NotCorrect;
              do{
                  CertNumber = CheckBarcode(Manager, "œÓ‰‡Ê‡ ÚÓ‚‡‡ Ò ÍÓ‰ÓÏ ÏÂÌÂ‰ÊÂ‡ \n\n"+Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName+"\n\n¬‚Â‰ËÚÂ ÿ  ÏÂÌÂ‰ÊÂ‡!");

                  ;;Log((char*)("CertNumber="+LLong2Str(CertNumber)).c_str());

                  if (CertNumber==PressEscape) {
                      ;;Log("ŒÚÏÂÌ‡ ‚‚Ó‰‡ ÿ  ÏÂÌÂ‰ÊÂ‡");
                      return false;
                  }


              }
              while ((CertNumber==NotCorrect) || (CertNumber==NoPasswd));
            }


            // + EGAIS
            int TextileCnt = 0;
            int MilkCnt = 0;
            int AlcoCnt = 0;
#ifdef ALCO_VES
            int PivoRazlivCnt = 0;
#endif
            string ActsizBarcode = "";
            strLock = CurGoods.Lock;

            vector<string> ListActsizBarcodes;
            ListActsizBarcodes.clear();

// ¬ÓÁÏÓÊÌÓÒÚ¸ ÓÚ·ËÚËˇ ·ÂÁ ‡ÍˆËÁ‡ ‚‚Ó‰ËÎ‡Ò¸ Ì‡ ÔÂÂıÓ‰Ì˚È ÔÂËÓ‰
// —ÂÈ˜‡Ò ‚ÒÂ ‡ÎÍÓ-ÚÓ‚‡˚ ÔÓıÓ‰ˇÚ ÔÓ ≈√¿»— ÒÓ Ò˜ËÚ˚‚‡ÂÏ ‡ÍˆËÁ‡
// œÓ‚ÂÍÛ ÓÚÍÎ˛˜‡˛
//            if (CashReg->EgaisSettings.ModePrintQRCode>-1)
            {
                if (CashReg->GoodsLock(strLock, GL_AlcoEGAIS) == GL_AlcoEGAIS)
                { // œÓ‰‡Ê‡ ‡ÎÍÓ„ÓÎ¸ÌÓÈ ÔÓ‰ÛÍˆËË

                    AlcoCnt = (CurGoods.ItemAlco>0)?CurGoods.ItemAlco:1;
                    int errAct=0;

                    for (int j=0;j<AlcoCnt;j++)
                    {
                      errAct=0;

                      ActsizBarcode = "";

                      errAct = CashReg->CheckActsizBarcode(&ActsizBarcode, "œÓÁËˆËˇ # "+Int2Str(j+1)+" ËÁ "+Int2Str(AlcoCnt)+" \n\n"+ Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque, ListActsizBarcodes);

                      if (errAct) return false;

                      ListActsizBarcodes.insert(ListActsizBarcodes.end(), ActsizBarcode);

                    }

                    //int errAct = CashReg->CheckActsizBarcode(&ActsizBarcode, Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque);
                    //
                }

                 else {
                     if (CashReg->GoodsLock(strLock, GL_TextileEGAIS) == GL_TextileEGAIS)
                        {

                              ActsizBarcode = "";

                              Scanner->allsymbols = true;
                              int errAct = CashReg->CheckActsizBarcodeDataMatrix(&ActsizBarcode, "œÓÁËˆËˇ # 1 ËÁ 1 \n\n"+ Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque, ListActsizBarcodes, AT_TEXTILE);
                              Scanner->allsymbols = false;

                              if (errAct) return false;

                              ListActsizBarcodes.insert(ListActsizBarcodes.end(), ActsizBarcode);

                              TextileCnt = 1;

                        }
                     else {
                         if (CashReg->GoodsLock(strLock, GL_MilkEGAIS) == GL_MilkEGAIS)
                            {

                             Log("Milk Datamatruks");

                                  ActsizBarcode = "";

                                  Scanner->allsymbols = true;
                                  int errAct = CashReg->CheckActsizBarcodeDataMatrix(&ActsizBarcode, "œÓÁËˆËˇ # 1 ËÁ 1 \n\n"+ Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque, ListActsizBarcodes, AT_MILK);
                                  Scanner->allsymbols = false;

                                  if (errAct) return false;

                                  ListActsizBarcodes.insert(ListActsizBarcodes.end(), ActsizBarcode);

                                  MilkCnt = 1;

                            }
#ifdef ALCO_VES
                          else{
                             if (CashReg->GoodsLock(strLock,GL_BeerEGAIS) == GL_BeerEGAIS)
                             {

                                 Log("ALCOVES Datamatruks");

                                 ActsizBarcode = "";

                                 Scanner->allsymbols = true;
                                 int errAct = CashReg->CheckActsizBarcodeDataMatrix(&ActsizBarcode, "œÓÁËˆËˇ # 1 ËÁ 1 \n\n"+ Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque, ListActsizBarcodes, AT_PIVO_RAZLIV);
                                 Scanner->allsymbols = false;

                                 if (errAct) return false;

                                 ListActsizBarcodes.insert(ListActsizBarcodes.end(), ActsizBarcode);

                                 PivoRazlivCnt = 1;
                             }
                         }
#endif
                    }
                }
            }
            // - EGAIS

			CurrentGoods=&CurGoods;
            CurrentGoods->ItemSecondBarcode = CertNumber>0?LLong2Str(CertNumber):"";
			CurrentGoods->ItemDepartment	=CashReg->ConfigTable->GetLongField("DEPARTMENT");
			CurrentGoods->ItemNumber=Cheque->GetSize()+1;
	    		CurrentGoods->ItemFlag=SL;
			CurrentGoods->GuardCode=-1;
			CurrentGoods->PaymentType=CashPayment;
			time(&(CurrentGoods->tTime));

			CurrentGoods->KKMNo=0;
			CurrentGoods->KKMSmena=0;
			CurrentGoods->KKMTime=0;

            // + EGAIS
			//CurrentGoods->ItemAlco = isAclo;
			//CurrentGoods->ItemActsizBarcode = ActsizBarcode;

            CurrentGoods->ItemAlco = AlcoCnt;
            CurrentGoods->ItemTextile = TextileCnt;
            CurrentGoods->ItemMilk = MilkCnt;
#ifdef ALCO_VES
            CurrentGoods->ItemPivoRazliv = PivoRazlivCnt;
#endif
            CurrentGoods->Actsiz.clear();
            for (int j=0;j<ListActsizBarcodes.size();j++)
                CurrentGoods->Actsiz.insert(CurrentGoods->Actsiz.end(), ListActsizBarcodes[j]);

			CurrentGoods->ItemQRBarcode = "";
            // - EGAIS

			//CurrentGoods->Section=CashReg->GetSection(CurrentGoods->Lock);

			if(!Cheque->GetCount())
				CashReg->m_vem.StartDoc(1, CashReg->GetLastCheckNum()+1);

			if ((PriceChecker==NULL) && (FreeSum==NULL))
				IsCurrentGoodsEmpty=false;

            AppendRecord2Check();

			CashReg->m_vem.AddGoods(CurrentGoods->ItemNumber,CurrentGoods,Cheque->GetCalcSum(),CurGoods.InputType);

            //CashReg->LogAddGoods(CurrentGoods);

			return true;
		}
		catch(cash_error& er)
		{
			CashReg->LoggingError(er);
			return false;
		}
	}
}

void WorkPlace::ProcessDiscount(GoodsInfo *CurGoods,double CheckSum,double CheckSum_WithoutAction)
{
	CashReg->ProcessDiscount(CurGoods,CheckSum,CurrentCustomer,DiscountType, CurrentAddonCustomer, CheckSum_WithoutAction);
}

void WorkPlace::ProcessDiscount(FiscalCheque* CurCheque)
{
//;;Log("[Func] ProcessDiscount [Begin]");

	if (!CurCheque)
		CurCheque = Cheque;
	if (!CurCheque) return;



    SummaBonusAction=0;

    // + dms ===== 2014-11-14 =====  œÂÂÒ˜ÂÚ ÒÛÏÏÓ‚ÓÈ ÒÍË‰ÍË =======
    CurCheque->DiscountSumm = 0;
    CurCheque->DiscountSummNotAction = 0;
    // + dms ===== 2014-11-14 =====

	FiscalCheque *tmpCheque;
	tmpCheque = new FiscalCheque;
	try
	{


/*
// ====== ============================== =======
// ====== ¿ ÷»ﬂ «¿¬≈–ÿ»À¿—‹ (2014-11-20) =======
// ====== ============================== =======

            // ¿ÍˆËˇ : ÔË ÔÓÍÛÔÍÂ 6 ·ÛÚ˚ÎÓÍ ÔË‚‡ ( ÍÓ‰˚ ÒÏ. ÌËÊÂ)....
            // ÒÛÏÍ‡-ıÓÎÓ‰ËÎ¸ÌËÍ ‚ ÔÓ‰‡ÓÍ

            bool BUD=false;

//;;Log("= START DISC =");

                FiscalCheque *tmpCheque2;
                tmpCheque2 = new FiscalCheque;

                    //ÍÓÔËÛÂÏ ‚ ÔÓÏÂÊÛÚÓ˜Ì˚È ˜ÂÍ ‰Îˇ ‡Ò˜ÂÚ‡ ÒÍË‰ÓÍ Ì‡ ÔÂ‚˚¯ÂÌËÂ ÔÓ ‚ÂÒÓ‚ÓÏÛ ÚÓ‚‡Û
                    for (int i=0;i<CurCheque->GetCount();i++)
                    {
                        tmpCheque2->Insert((*CurCheque)[i]);
                    }
                    tmpCheque2->ReductionByCode(CashReg->KKMNo,CashReg->KKMSmena,CashReg->KKMTime,true);

                    //‡Ò˜ËÚ˚‚‡ÂÏ ÒÍË‰ÍË ÔÓ Í‡Ê‰ÓÈ ÔÓÁËˆËË ÚÓ‚‡‡ ‚ ÔÓÏÂÊÛÚÓ˜ÌÓÏ ˜ÂÍÂ
                    for (int i=0;i<tmpCheque2->GetCount();i++)
                    {
                        GoodsInfo g1=(*tmpCheque2)[i];

                        if (
                        (
                        (g1.ItemCode==789158)
                        ||
                        (g1.ItemCode==789159)
                        ||
                        (g1.ItemCode==778701)
                        ||
                        (g1.ItemCode==789161)
                        )

                        && (g1.ItemCount>=6)

                        && (g1.ItemFlag==SL)

                        )
                        {
                            ;;Log("= BUD =");
                             BUD=true;
                        }

                    }

            if ((ActionShowMsg)&&(BUD))
            {
               ShowMessage("            ¬ ˜ÂÒÚ¸ Ô‡Á‰ÌÓ‚‡ÌËˇ ŒÍÚÓ·ÂÙÂÒÚ‡\n\
      ÔË ÔÓÍÛÔÍÂ 6 Â‰ËÌËˆ ÔË‚‡ ‘‡ÌˆËÒÍ‡ÌÂ \n\
      ËÎË ÿÔ‡ÚÂÌ Ã˛ÌıÂÌ ¬˚ ÔÓÎÛ˜‡ÂÚÂ\n\n\
              —”Ã ”-’ŒÀŒƒ»À‹Õ»  ¡¿ƒ \n\n\
                        ¬ œŒƒ¿–Œ !!!");

                   ActionShowMsg = false;
            }

// ====== ============================== =======
//  ŒÕ≈÷.¿ ÷»ﬂ  —”Ã ¿-’ŒÀŒƒ»À‹Õ» 
// ====== ============================== =======
*/

/* ¿ÍˆËˇ Á‡‚Â¯ÂÌ‡
            // ¿ÍˆËˇ : ÔË ÔÓÍÛÔÍÂ ¯ÔËÍ‡
            //  - ÿÔËÍ œŒ-¬≈Õ√≈–— » ŒŒŒ √‡ÒÚÓÌÓÏ
            //  - ÿÔËÍ œŒ-ƒŒÃ¿ÿÕ≈Ã” ŒŒŒ √‡ÒÚÓÌÓÏ
            //  - —Ï‡ÎÂˆ Ò Í‡ÒÌ˚Ï ÔÂˆÂÏ ŒŒŒ √‡ÒÚÓÌÓÏ
            //  - —Ï‡ÎÂˆ Ò ˜ÂÌ˚Ï ÔÂˆÂÏ ŒŒŒ √‡ÒÚÓÌÓÏ

            //  ¬Ó‰Í‡  ¿À¿ÿÕ» Œ¬ 3 Á‚ÂÁ‰˚ 40% 0,7 (124986)
            //  Ò˜ËÚ˚‚‡ÂÚÒˇ ÒÓ ÒÔÂˆË‡Î¸ÌÓÈ ˆÂÌÓÈ (ÒÔÂˆ. ¯ÚËı-ÍÓ‰ Ì‡ Í‡ÒÒÂ)

            bool shpik=false;
            bool vodka=false;



            if  (vodka)
            {
                ;;Log("=5.1=");

                for (int i=0;i<CurCheque->GetCount();i++)
                {
                    GoodsInfo g1=(*CurCheque)[i];

                    Log((char*)("["+g1.ItemBarcode+"]").c_str());
                    if (shpik)
                    {
                        if ((g1.ItemCode==124986)
                        && (g1.ItemBarcode.substr(0,8) != "27084274"))
                       // && (g1.ItemBarcode.substr(0,12) == "460703219338"))
                        {

                          g1.ItemBarcode="27084274";
                          CurCheque->SetAt(i,g1);

                            string LogStr;
                            LogStr = "¿ ÷»ﬂ ÿœ»  + ¬Œƒ ¿  ¿À¿ÿÕ» Œ¬ = —œ≈÷. ÷≈Õ¿";
                            Log((char*)LogStr.c_str());

                          //  ;;ShowMessage("¿ ÷»ﬂ ÿœ»  + ¬Œƒ ¿  ¿À¿ÿÕ» Œ¬ = —œ≈÷. ÷≈Õ¿");

                        }
                    }
                    else
                    {
                        if ((g1.ItemCode==124986)
                        && (g1.ItemBarcode.substr(0,8) == "27084274"))
                        {
                            Log("= ”ƒ¿À≈Õ “Œ¬¿– »« ¿ ÷»» ÿœ» +¬Œƒ ¿=");
                          g1.ItemBarcode="4607032193388";
                          CurCheque->SetAt(i,g1);
                        }
                    }
                }


            }
*/
//;;Log("= END =");



/* ¿ ÷»ﬂ «¿¬≈–ÿ≈Õ¿ 2014-09-24
            // ¿ÍˆËˇ : ÔË ÔÓÍÛÔÍÂ 2x ÚÓ‚‡Ó‚ P&G ‚˚‰‡Ú¸ ÒÓÓ·˘ÂÌËÂ Ó ÔÓ‰‡ÍÂ
            //  œÓ‰‡ÓÍ: ‚Ó‰‡ ()

            bool voda=false;
            bool InAaction=false;

//;;Log("= START DISC =");

                FiscalCheque *tmpCheque1;
                tmpCheque1 = new FiscalCheque;

                    //ÍÓÔËÛÂÏ ‚ ÔÓÏÂÊÛÚÓ˜Ì˚È ˜ÂÍ ‰Îˇ ‡Ò˜ÂÚ‡ ÒÍË‰ÓÍ Ì‡ ÔÂ‚˚¯ÂÌËÂ ÔÓ ‚ÂÒÓ‚ÓÏÛ ÚÓ‚‡Û
                    for (int i=0;i<CurCheque->GetCount();i++)
                    {
                        tmpCheque1->Insert((*CurCheque)[i]);
                    }

                    string ActCodes = "[762635][768571][768572][745410][745409][720208][736926][785099][785098][765912][765916][765911][765919][765910][765915][765918][765914][765921][765917][765913][765920][776546][776695][776696][776697][776698][776699][776700][776701][776702][776703][776704][776705][743558][743559][743560][743561][743562][743563][743564][743565][743566][743567][743568][743569][743570][743571][743572][743573][743574][55588][55589][55583][55584][50560][50565][50566][50567][55593][55596][768570][55597][84093][711266][711265][50563][50562][55592][43849][43743][110612][43647][43697][43653][43859][43661][142415][43829][43758][43676][43789][43739][43618][43608][43628][24007][743582][743188][745421][738465][738467][738470][123249][115341][139441][127046][125424][118734][104345][36890][33788][36887][36888][745414][706954][745422][738466][738471][774868][123248][118737][127047][36895][104346][745413][36894][706953][743580][118720][43984][55564][55551][768576][96475][104338][757753][774865][743548][121088][774848][782333][143336][143335][760858][760859][143337][774866][774869][743174][706950][743170][55540][743550][745420][757759][780876][780856][760862][760863][762634][118719][43968][55561][80343][55552][80351][96473][104336][118713][743169][757755][757754][774864][743549][50576][743555][743553][55529][743554][54455][706949][121086][706951][774849][782332][745415][776710][762633][738461][743176][738475][143332][757782][743576][743175][143331][760860][760861][743177][745419][143330][774867][774870][768577][743556][762629][743166][743167][743171][768573][774861][774862][774863][782334][757781][743425][706961][774846][96470][44186][776709][776708][139396][782335][147877][757780][745411][61252][768574][774854][774858][774850][774859][774851][774855][774852][774856][774853][774857][774860][757767][757762][768575][118743][782336][776706][776707][743229][743231][743228][743546][743227][743230][89909][706958][706957][706956][706959][774847][743224][743232][743233][706955][738483][738484][738490][738491][738492][738494]";

                    int CntPG=0;
                    //‡Ò˜ËÚ˚‚‡ÂÏ ÒÍË‰ÍË ÔÓ Í‡Ê‰ÓÈ ÔÓÁËˆËË ÚÓ‚‡‡ ‚ ÔÓÏÂÊÛÚÓ˜ÌÓÏ ˜ÂÍÂ
                    for (int i=0;i<tmpCheque1->GetCount();i++)
                    {
                        GoodsInfo g1=(*tmpCheque1)[i];

                        if (g1.ItemFlag!=SL) continue;

                        string ItemStr = "["+Int2Str(g1.ItemCode)+"]";

                        string::size_type pos_found = ActCodes.find(ItemStr);

                        if(pos_found!=string::npos)
                        {
                            ;;Log((char*)Int2Str(pos_found).c_str());
                            CntPG+=g1.ItemCount;
                        }

                        if (CntPG>=2)
                        {
//                            ;;Log("= NEED VODA =");
                            InAaction=true;
                        }

                      if (

                         (g1.ItemCode==797549)

                         && (g1.ItemFlag==SL)

                         )
                        {
                            ;;Log("= VODA =");
                            voda = true;
                        }

                    }


            if ((InAaction) && (!voda))
            {
                ;;Log("= NEED VODA =");
                ShowMessage("¬€ƒ¿“‹ œŒƒ¿–Œ  AQUA MINERALE");
            }
//;;Log("= END =");
*/



// ====== ============================== =======
// ¿ ÷»ﬂ œË ÔÓÍÛÔÍÂ 2-ı ‡ÁÌ˚ı ÚÓ‚‡Ó‚ ‚ ˜ÂÍÂ - ‡ÍˆËÓÌÌ‡ˇ ˆÂÌ‡ Ì‡ Ó·‡ ÚÓ‚‡‡
// ====== ============================== =======

///* ¿ÍˆËˇ
            // ¿ÍˆËˇ :
//> œË Â‰ËÌÓ‚ÂÏÂÌÌÓÈ ÔÓÍÛÔÍÂ (‚ Ó‰ÌÓÏ ˜ÂÍÂ) ÚÓ‚‡Ó‚:
//> 826578  ¿ÔÂËÚË‚  ¿œ≈–ŒÀ‹  11%  0,7Î  Ò/· ƒ‡‚Ë‰Â  ‡ÏÔ‡Ë-ÃËÎ‡ÌÓ »“¿À»ﬂ
//> (Â„ÛÎˇÌ‡ˇ ˆÂÌ‡ 1599, ‡ÍˆËÓÌÌ‡ˇ ˆÂÌ‡ 1199)
//> 731558  ¬ËÌÓ  Ã¿–“»Õ» œ–Œ—≈ Œ Ë„ËÒÚÓÂ ÒÛıÓÂ ·ÂÎÓÂ 0,75Î Ò/· MARTINI &
//> ROSSI S.P.A. »“¿À»ﬂ (Â„ÛÎˇÌ‡ˇ ˆÂÌ‡ 1499, ‡ÍˆËÓÌÌ‡ˇ ˆÂÌ‡ 999,9)
//
//> ÔÓÍÛÔ‡ÚÂÎ¸  ÔÓÎÛ˜‡ÂÚ  ÒÍË‰ÍÛ ‰Ó ˆÂÌ 999,9 Ë 799,9 ÒÓÓÚ‚ÂÚÒÚ‚ÂÌÌÓ, Ú.Â.
//> Ó·˘‡ˇ ˆÂÌ‡ Ì‡·Ó‡ 1799,9 ‚ÏÂÒÚÓ 3099
//
// “Ó‚‡ Ò˜ËÚ˚‚‡ÂÚÒˇ ÒÓ ÒÔÂˆË‡Î¸ÌÓÈ ˆÂÌÓÈ (ÒÔÂˆ. ¯ÚËı-ÍÓ‰ Ì‡ Í‡ÒÒÂ)
//826578 ¿ÔÂËÚË‚ ¿œ≈–ŒÀ‹ 11% 0,7Î Ò/· ƒ‡‚Ë‰Â  ‡ÏÔ‡Ë-ÃËÎ‡ÌÓ »“¿À»ﬂ - ‰Ó·‡‚ËÎË ¯Í 27209875  (8002230000302)
//731558 ¬ËÌÓ Ã¿–“»Õ» œ–Œ—≈ Œ Ë„ËÒÚÓÂ ÒÛıÓÂ ·ÂÎÓÂ 0,75Î Ò/· MARTINI & ROSSI S.P.A. »“¿À»ﬂ - ‰Ó·‡‚ËÎË ¯Í 27209882  (8000570552505)
            bool action_aperol = true;

            int aperol=0;
            int martini=0;

            if  (action_aperol)
            {

                for (int i=0;i<CurCheque->GetCount();i++)
                {
                    GoodsInfo g1=(*CurCheque)[i];

                    if ((g1.ItemFlag!=SL) && (g1.ItemFlag!=RT)) continue;

                    if (g1.ItemCode==826578)
                    {
                        aperol++;
                    }

                    if (g1.ItemCode==731558)
                    {
                        martini++;
                    }
                }

                aperol = min(aperol, martini);
                martini = min(aperol, martini);

                for (int i=0;i<CurCheque->GetCount();i++)
                {
                    GoodsInfo g1=(*CurCheque)[i];

                    if ((g1.ItemFlag!=SL) && (g1.ItemFlag!=RT)) continue;

                    if (g1.ItemCode==826578)
                    {
                        if (aperol > 0)
                        {

                            if (g1.ItemBarcode.substr(0,8) != "27209875")
                            {
                                Log("= ƒŒ¡¿¬À≈Õ “Œ¬¿– ¿œ≈–ŒÀ‹ ¬ ¿ ÷»ﬁ ¿œ≈–ŒÀ‹+Ã¿–“»Õ» =");

                                g1.ItemBarcode="27209875";
                                CurCheque->SetAt(i,g1);
                            }

                            aperol--;

                        }
                        else
                        {

                            if (g1.ItemBarcode.substr(0,8) == "27209875")
                            {
                                Log("= ”ƒ¿À≈Õ “Œ¬¿– ¿œ≈–ŒÀ‹ »« ¿ ÷»» ¿œ≈–ŒÀ‹+Ã¿–“»Õ» =");

                                g1.ItemBarcode="8002230000302";
                                CurCheque->SetAt(i,g1);
                            }

                        }
                    }

// Ï‡ÚËÌË
                    if (g1.ItemCode==731558)
                    {
                        if (martini > 0)
                        {

                            if (g1.ItemBarcode.substr(0,8) != "27209882")
                            {
                                Log("= ƒŒ¡¿¬À≈Õ “Œ¬¿– Ã¿–“»Õ» ¬ ¿ ÷»ﬁ ¿œ≈–ŒÀ‹+Ã¿–“»Õ» =");

                                g1.ItemBarcode="27209882";
                                CurCheque->SetAt(i,g1);
                            }

                            martini--;

                        }
                        else
                        {

                            if (g1.ItemBarcode.substr(0,8) == "27209882")
                            {
                                Log("= ”ƒ¿À≈Õ “Œ¬¿– Ã¿–“»Õ» »« ¿ ÷»» ¿œ≈–ŒÀ‹+Ã¿–“»Õ» =");

                                g1.ItemBarcode="8000570552505";
                                CurCheque->SetAt(i,g1);
                            }

                        }
                    }
                }



            }

// slair
/*
            bool action_IONOS = true;

            int IONOS_white=0;
            int IONOS_pink=0;

            if  (action_IONOS)
            {

                for (int i=0;i<CurCheque->GetCount();i++)
                {
                    GoodsInfo g1=(*CurCheque)[i];

                    if ((g1.ItemFlag!=SL) && (g1.ItemFlag!=RT)) continue;

                    if (g1.ItemCode==893831)
                    {
                        IONOS_white++;
                    }

                    if (g1.ItemCode==893833)
                    {
                        IONOS_pink++;
                    }
                }

                IONOS_white = min(IONOS_white, IONOS_pink);
                IONOS_pink = min(IONOS_white, IONOS_pink);

                for (int i=0;i<CurCheque->GetCount();i++)
                {
                    GoodsInfo g1=(*CurCheque)[i];

                    if ((g1.ItemFlag!=SL) && (g1.ItemFlag!=RT)) continue;

                    if (g1.ItemCode==893831)
                    {
                        if (IONOS_white > 0)
                        {

                            if (g1.ItemBarcode.substr(0, 13) != "7201015011547")
                            {
                                Log("= ƒŒ¡¿¬À≈Õ “Œ¬¿– IONOS_white("
                                    + g1.ItemBarcode.substr(0, 13)
                                    + ") ¬ ¿ ÷»ﬁ action_IONOS =");

                                g1.ItemBarcode="7201015011547";
                                CurCheque->SetAt(i,g1);
                            }

                            IONOS_white--;

                        }
                        else
                        {

                            if (g1.ItemBarcode.substr(0, 13) == "7201015011547")
                            {
                                Log("= ”ƒ¿À≈Õ “Œ¬¿– IONOS_white("
                                    + g1.ItemBarcode.substr(0, 13)
                                    + ") »« ¿ ÷»» action_IONOS =");

                                g1.ItemBarcode="5201015011547";
                                CurCheque->SetAt(i,g1);
                            }

                        }
                    }

// IONOS_pink
                    if (g1.ItemCode==893833)
                    {
                        if (IONOS_pink > 0)
                        {

                            if (g1.ItemBarcode.substr(0, 13) != "7201015011585")
                            {
                                Log("= ƒŒ¡¿¬À≈Õ “Œ¬¿– IONOS_pink("
                                    + g1.ItemBarcode.substr(0, 13)
                                    + ") ¬ ¿ ÷»ﬁ action_IONOS =");

                                g1.ItemBarcode="7201015011585";
                                CurCheque->SetAt(i,g1);
                            }

                            IONOS_pink--;

                        }
                        else
                        {

                            if (g1.ItemBarcode.substr(0, 13) == "7201015011585")
                            {
                                Log("= ”ƒ¿À≈Õ “Œ¬¿– IONOS_pink("
                                    + g1.ItemBarcode.substr(0, 13)
                                    + ") »« ¿ ÷»» action_IONOS =");

                                g1.ItemBarcode="5201015011585";
                                CurCheque->SetAt(i,g1);
                            }

                        }
                    }
                }



            }
*/
//;;Log("= END =");


// ====== ============================== =======
// ¿ ÷»ﬂ œË ÔÓÍÛÔÍÂ 1-„Ó ÚÓ‚‡‡ - ‡ÍˆËÓÌÌ‡ˇ ˆÂÌ‡ Ì‡ ‰Û„ÓÈ ÚÓ‚‡
// ====== ============================== =======

///* ¿ÍˆËˇ
            // ¿ÍˆËˇ :
//>> ÌÂÓ·ıÓ‰ËÏÓ ÔÓ„ÛÁËÚ¸ ‡ÍˆË˛: ÔË ÔÓÍÛÔÍÂ  114521 ¬ËÒÍË ‘≈…ÃŒ— √–¿”«
//>> 0,7Î Ò/· Ã˝Ú¸˛ √ÎÓ„ ›Ì‰ —‡ÌÚ À“ƒ, ¬≈À» Œ¡–»“¿Õ»ﬂ
//>> ÒÓÍ  024979  —ÓÍ –»◊ ˇ·ÎÓ˜Ì˚È ÓÒ‚ÂÚÎ. Ú/Ô 1Î ÃÛÎÚÓÌ Rich Á‡ 1 –”¡


//ÿ  Ò„ÂÌÂËÓ‚‡Î‡ 27214503
//Œ·˚˜Ì˚È ÿ  (4607042439216) ˆÂÌ‡ 99.90
            bool action_wiski_sok = true;

            int wiski=0;
            int sok=0;

            if  (action_wiski_sok)
            {

                for (int i=0;i<CurCheque->GetCount();i++)
                {
                    GoodsInfo g1=(*CurCheque)[i];

                    if ((g1.ItemFlag!=SL) && (g1.ItemFlag!=RT)) continue;

                    if (g1.ItemCode==114521)
                    {
                        wiski++;
                    }

                    if (g1.ItemCode==24979)
                    {
                        sok++;
                    }
                }

                wiski = min(wiski, sok);
                sok = min(wiski, sok);

                for (int i=0;i<CurCheque->GetCount();i++)
                {
                    GoodsInfo g1=(*CurCheque)[i];

                    if ((g1.ItemFlag!=SL) && (g1.ItemFlag!=RT)) continue;

                    if (g1.ItemCode==24979)
                    {
                        if (wiski > 0)
                        {

                            if (g1.ItemBarcode.substr(0,8) != "27214503")
                            {
                                Log("= ƒŒ¡¿¬À≈Õ “Œ¬¿– —Œ  ¬ ¿ ÷»ﬁ ¬»— »+—Œ  =");

                                g1.ItemBarcode="27214503";
                                CurCheque->SetAt(i,g1);
                            }

                            wiski--;

                        }
                        else
                        {

                            if (g1.ItemBarcode.substr(0,8) == "27214503")
                            {
                                Log("= ”ƒ¿À≈Õ “Œ¬¿– —Œ  »« ¿ ÷»» ¬»— »+—Œ  =");

                                g1.ItemBarcode="4607042439216";
                                CurCheque->SetAt(i,g1);
                            }

                        }
                    }
                }
            }

//;;Log("= END =");




		//ÍÓÔËÛÂÏ ‚ ÔÓÏÂÊÛÚÓ˜Ì˚È ˜ÂÍ ‰Îˇ ‡Ò˜ÂÚ‡ ÒÍË‰ÓÍ Ì‡ ÔÂ‚˚¯ÂÌËÂ ÔÓ ‚ÂÒÓ‚ÓÏÛ ÚÓ‚‡Û
		for (int i=0;i<CurCheque->GetCount();i++)
		{
			tmpCheque->Insert((*CurCheque)[i]);
		}
		tmpCheque->Reduction(CashReg->KKMNo,CashReg->KKMSmena,CashReg->KKMTime,true,true);

		CashReg->ProcessPayment();

        double CheckSum_WithoutAction = CurCheque->GetCalcSum_NotAction9();
        if (CheckSum_WithoutAction<0) CheckSum_WithoutAction=0;


		//‡Ò˜ËÚ˚‚‡ÂÏ ÒÍË‰ÍË ÔÓ Í‡Ê‰ÓÈ ÔÓÁËˆËË ÚÓ‚‡‡ ‚ ÔÓÏÂÊÛÚÓ˜ÌÓÏ ˜ÂÍÂ
		for (int i=0;i<tmpCheque->GetCount();i++)
		{
			GoodsInfo g=(*tmpCheque)[i];
			g.ItemExcessPrice = g.ItemFullPrice;
			g.ItemCalcPrice   = g.ItemFullPrice;
			g.ActionGoods     = 0;
			g.DiscExcessFlag  = false; // ÙÎ‡„ ÒÍË‰ÍË ÔÓ ÔÂ‚˚¯ÂÌË˛

// «‡‰‡˜‡: ‡ÍˆËˇ - ÔË ˆÂÌ‡ 59,9 ÔË ÔÓÍÛÔÍÂ Àﬁ¡€’ 3-ı Ì‡ËÏÂÌÓ‚‡ÌËÈ ËÁ Á‡‰‡ÌÌÓ„Ó ÒÔËÒÍ‡ ÚÓ‚‡Ó‚
//  ÓÎË˜ÂÒÚ‚Ó Ò˜ËÚ‡ÂÏ Ó·˘ÂÂ ÔÓ „ÛÔÔÂ, Ì‡ÔËÏÂ, ÂÒÎË ‚ ÁÌ‡ÍÂ ÒÍË‰ÍË 16 (P0Q0) ÒÚÓËÚ ˆËÙ‡
// ÚÓ ItemCount = ÒÛÏÏ‡ÌÓÂ ÍÓÎË˜ÂÒÚ‚Ó ‚ÒÂı ÚÓ‚‡Ó‚ ‚ ˜ÂÍÂ Ò Ú‡ÍÓÈ ÊÂ ˆËÙÓÈ
//Ì‡ÔËÏÂ, “Ó‚‡π1 = 1, “Ó‚‡π2 = 2. ¬ ItemCount Á‡ÔË¯ÂÏ = 3, ˜ÚÓ·˚ Ò‡·ÓÚ‡Î‡ ÒÍË‰Í‡ ÔÓ ÔÂ‚˚¯ÂÌË˛
            g.ItemCount       = CashReg->GetItemCountP0Q0(&g, CurCheque, 16);

			double lCheckSumma = tmpCheque->GetCalcSum() - tmpCheque->DiscountSumm - tmpCheque->DiscountSummNotAction - tmpCheque->CertificateSumm - tmpCheque->BankBonusSumm  - tmpCheque->BonusSumm;

			ProcessDiscount(&g,lCheckSumma>0?lCheckSumma:0, CheckSum_WithoutAction);
			tmpCheque->SetAt(i,g);
		}

/*
    Log("tmpCheque begin\n");
    for (int i=0;i<tmpCheque->GetCount();i++)
    {
        GoodsInfo g=(*tmpCheque)[i];
        char tmpStr[1024];
        sprintf(tmpStr,"--- %d --- Code=%d Count=%.2f FullPrice=%8.2f ExcessPrice=%8.2f Price=%8.2f   Action = %d",i,g.ItemCode,g.ItemCount,g.ItemFullPrice,g.ItemExcessPrice,g.ItemPrice,g.ActionGoods );
        Log(tmpStr);
    }
    Log("tmpCheque end\n");
*/
		//ÔËÒ‚‡Ë‚‡ÂÏ ˆÂÌÛ ÔÓ ÔÂ‚˚¯ÂÌË˛ ËÁ ÔÓÏÂÊÛÚÓ˜ÌÓ„Ó ˜ÂÍ‡
		//for (int i=0;i<CurCheque->GetCount();i++)
		for (int i=CurCheque->GetCount()-1;i>=0;i--)
		{
          GoodsInfo gi=(*CurCheque)[i];

          GoodsInfo gj;
          gi.ItemExcessPrice	=gi.ItemFullPrice;
          gi.ItemCalcPrice	    =gi.ItemFullPrice;

//if (gi.ItemName.substr(0,1)=="@"){
//;;Log((char*)("!!!TEST STEP _ 1 !!!  Code="+Int2Str(gi.ItemCode)+". Cnt="+ Double2Str(gi.ItemCount)).c_str());
//}

          // + dms === 2010-03-30 =====\ ÒÔÂˆ. ÍÓ‰ ÔÓÔÛÒÍ‡ÂÏ
          if (gi.ItemCode != FreeSumCode)
		  {

			for(int j=0;j<tmpCheque->GetCount();j++)
			{
				gj=(*tmpCheque)[j];

				// ÒÚÓÌÓ ÔÓÔÛÒÍ‡ÂÏ!
				if(
                    gj.DiscExcessFlag
                    &&
                    (gi.ItemCode == gj.ItemCode)
                    &&
                    (
                        (gi.ItemBarcode == gj.ItemBarcode)
                        ||
                        ((gi.ItemPrecision<1) && (gi.ItemBarcode.substr(0,8) == gj.ItemBarcode.substr(0,8)))
                    )
                    &&
                    (gj.ItemFlag!=ST)
                  )
				{

//if (gi.ItemName.substr(0,1)=="@"){
//;;Log((char*)("!!!TEST STEP _ 2 !!!  Code="+Int2Str(gi.ItemCode)+". Cnt="+ Double2Str(gi.ItemCount)+". ActCnt="+ Double2Str(gj.Action_ItemCnt)).c_str());
//}

				if (
				(gi.ItemFlag!=ST)
				&&
				(gj.Action_ItemPrice>0)
				&&
				(gj.Action_ItemCnt>0)
				&&
				(gj.Action_ItemCnt>=gi.ItemCount)
				)
				{
//;;Log("B1");
//;;Log((char*)("!!!IN ACTION!!! Code="+Int2Str(gi.ItemCode)+". Cnt="+ Double2Str(gi.ItemCount)+". ActCnt="+ Double2Str(gj.Action_ItemCnt)).c_str());

                    //gi.ItemCalcPrice	= gj.Action_ItemPrice;

                    // œËÁÌ‡Í ‡ÍˆËË —“Œœ-÷≈Õ¿
                    gi.Action_ItemPrice	= gj.Action_ItemPrice;

                    gi.ItemExcessPrice	= gj.Action_ItemPrice;

                    gj.Action_ItemCnt   -= gi.ItemCount;

                    tmpCheque->SetAt(j, gj);

//;;Log("E2");
                }
                else
                {

                    gi.ItemCalcPrice	= gj.ItemCalcPrice;
                    gi.ItemExcessPrice	= gj.ItemExcessPrice;

                    // Í‡Ê‰˚È n-È ·ÂÒÔÎ‡ÚÌÓ!!!
					if ((gj.ActionGoods>0) && (gi.ItemFlag!=ST))
                    {
                        int CntAction       = min(gj.ActionGoods, Double2Int(gi.ItemCount));
                        // ÔÂÂÒ˜ËÚ˚‚‡ÂÏ ˆÂÌÛ Á‡ ‚˚˜ÂÚÓÏ ÍÓÎ-‚‡ ‡ÍˆËÓÌÌÓ„Ó (·ÂÒÔÎ‡ÚÌÓ„Ó) ÚÓ‚‡‡
                        //gi.ItemExcessPrice *= (gi.ItemCount-CntAction)/gi.ItemCount;
                        gi.ItemExcessPrice = RoundToNearest(gi.ItemExcessPrice*(gi.ItemCount-CntAction)/gi.ItemCount, 0.01);

                        gi.ItemCalcPrice    = gi.ItemExcessPrice;
                        gi.ActionGoods      = CntAction;

                        gj.ActionGoods     -= CntAction;
                        if (gj.ActionGoods==0) gj.ActionGoods=-1;

                        tmpCheque->SetAt(j, gj);

                    }
                    else //ÓÚÏÂÚËÏ Í‡Í ‡ÍˆËÓÌÌ˚È
                        if (gj.ActionGoods<0)
                            gi.ActionGoods = gj.ActionGoods;
                }
				} //if
			 } // for

	  	   } // ÂÒÎË ÌÂ ÒÔÂˆ. ÍÓ‰

			CurCheque->SetAt(i,gi);
		}

        CurCheque->Lock = false;

/*
    Log("CurCheque --- begin\n");
    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];
        char tmpStr[1024];
        sprintf(tmpStr,"--- %d --- Code=%d Count=%.2f FullPrice=%8.2f ExcessPrice=%8.2f Price=%8.2f   Action = %d",i,g.ItemCode,g.ItemCount,g.ItemFullPrice,g.ItemExcessPrice,g.ItemPrice,g.ActionGoods );
        Log(tmpStr);
    }
    Log("CurCheque --- end\n");
*/

		//‡Ò˜ËÚ˚‚‡ÂÏ ÒÍË‰ÍË ÔÓ Í‡Ê‰ÓÈ ÔÓÁËˆËË ÚÓ‚‡‡
		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo g=(*CurCheque)[i];
			//ProcessDiscount(&g,(CurCheque->GetCalcSum()-CurCheque->DiscountSumm-CurCheque->CertificateSumm)>0?(CurCheque->GetCalcSum()-CurCheque->DiscountSumm-CurCheque->CertificateSumm):0);

            // ! —ÍË‰Í‡ ·ÂÁ Û˜ÂÚ‡ ÒÂÚËÙËÍ‡Ú‡ ! //

            double CheckSum_Full = CurCheque->GetCalcSum()-CurCheque->DiscountSumm- min(CurCheque->DiscountSummNotAction, CurCheque->GetSumNotAction_New());
            if (CheckSum_Full<0) CheckSum_Full=0;

            double CheckSum_WithoutAction = CheckSum_Full - CurCheque->GetCalcSum_Action9();
            if (CheckSum_WithoutAction<0) CheckSum_WithoutAction=0;
			//ProcessDiscount(&g,	(CurCheque->GetCalcSum()-CurCheque->DiscountSumm)>0?(CurCheque->GetCalcSum()-CurCheque->DiscountSumm):0	);

            ProcessDiscount(&g,	CheckSum_Full, CheckSum_WithoutAction);

			CurCheque->SetAt(i,g);
		}
//

/*
    Log("CurCheque +++ begin\n");
    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];
        char tmpStr[1024];
        sprintf(tmpStr,"--- %d --- Code=%d Count=%.2f FullPrice=%8.2f ExcessPrice=%8.2f Price=%8.2f   Action = %d",i,g.ItemCode,g.ItemCount,g.ItemFullPrice,g.ItemExcessPrice,g.ItemPrice,g.ActionGoods );
        Log(tmpStr);
    }
    Log("CurCheque +++ end\n");
*/

// + dms ===== »ÒÔ‡‚ÎÂÌËÂ ‡ÒÔÂ‰ÂÎÂÌËˇ ÒÛÏÏ˚ ÒÍË‰ÍË ÔÓ ÔÓÁËˆËˇÏ ˜ÂÍ‡ =====
/// {¡˚ÎÓ}
//		//‡ÁÏ‡Á˚‚‡ÂÏ ÒÍË‰ÍË Ì‡ ‚ÂÒ¸ ˜ÂÍ ÔÓ ÚÓ‚‡‡Ï
//		double crDiscountSumm = CurCheque->DiscountSumm + CurCheque->CertificateSumm;
//		for (int i=0;i<CurCheque->GetCount();i++)
//		{
//			double crGoodsDiscountSumm;
//
//			GoodsInfo crGoods = (*CurCheque)[i];
//
//			crGoodsDiscountSumm = RoundToNearest(crGoods.ItemCalcSum*(CurCheque->DiscountSumm+CurCheque->CertificateSumm)/CurCheque->GetCalcSum(),0.01);
//			if (crGoods.ItemSum > crGoodsDiscountSumm)
//			{
//				crGoods.ItemSum	-= crGoodsDiscountSumm;
//				crDiscountSumm 	-= crGoodsDiscountSumm;
//			}
//			else
//			{
//				crGoods.ItemSum	 = 0;
//				crDiscountSumm	-= crGoods.ItemSum;
//			}
//			CurCheque->SetAt(i,crGoods);
//		}

/// {—Ú‡ÎÓ}


// + dms ====================/



// ¡ŒÕ”—€

    bool isBonusCard = CashReg->BonusMode(CurrentCustomer);
    {
        double Sum=0;
        for (int i=0;i<CurCheque->GetCount();i++)
        {

            GoodsInfo crGoods = (*CurCheque)[i];
            crGoods.ItemBonusAdd = 0;

            if (isBonusCard)
            {
                Sum = 0;

                if
                (
                    (
                    (crGoods.ItemFlag==SL)||(crGoods.ItemFlag==RT)
                    )
                    &&
                    (
                    (crGoods.ItemCalcPrice - crGoods.ItemPrice > .015)
                    ||
                    (crGoods.ItemCalcSum   - crGoods.ItemSum   > .005)
                    )
                    &&
                    !(crGoods.ItemFullPrice - crGoods.ItemExcessPrice>.005)  // ‡ÍˆËˇ ÔÓ ÔÂ‚˚¯ÂÌË˛
                )
                {
                    crGoods.ItemBonusAdd = crGoods.ItemCalcSum - crGoods.ItemSum;

                    crGoods.ItemPrice = crGoods.ItemCalcPrice;
                    crGoods.ItemSum   = crGoods.ItemCalcSum;
                }
            }

            CurCheque->SetAt(i,crGoods);

        }
    }



//! —”ÃÃŒ¬¿ﬂ — »ƒ ¿ Õ¿ ◊≈ ,  –ŒÃ≈ ¿ ÷»ŒÕÕ€’ “Œ¬¿–Œ¬
		//‡ÒÔÂ‰ÂÎˇÂÏ ÒÛÏÏÓ‚Û˛ ÒÍË‰ÍÛ Ì‡ ‚ÂÒ¸ ˜ÂÍ, ÍÓÏÂ ‡ÍˆËÓÌÌ˚ı ÚÓ‚‡Ó‚
		// Ì‡ ‡ÍˆËÓÌÌ˚Â ÚÓ‚‡˚ ÒÍË‰Í‡ ÌÂ ‡ÒÔÓÒÚ‡ÌˇÂÚÒˇ

//		;;Log((char*)("CurCheque->DiscountSumm = "+Int2Str(CurCheque->DiscountSumm)).c_str());
{
		double BaseDiscountSum  = CurCheque->DiscountSummNotAction;
		double BaseCheckSum     = CurCheque->GetSumNotAction_New();

		double AllocDiscountSum = 0;
		double AllocCheckSum    = 0;
		double CurDiscount      = 0;

		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo crGoods = (*CurCheque)[i];

//;;Log((char*)crGoods.ItemName.c_str());

            if (
            ((crGoods.ItemFlag!=SL) && (crGoods.ItemFlag!=RT))
            || (crGoods.ItemCode==TRUNC)
            || (crGoods.ItemCode==EXCESS_PREPAY)
            || (CurCheque->GoodInActionByName(crGoods.ItemName))
            )
                continue; // Ì‡ ‡ÍˆËÓÌÌ˚Â ÚÓ‚‡˚ ÒÍË‰Í‡ ÌÂ ‡ÒÔÓÒÚ‡ÌˇÂÚÒˇ

            //;;Log((char*)crGoods.ItemName.c_str());


            if (BaseCheckSum - AllocCheckSum > 0)
                CurDiscount = RoundToNearest((BaseDiscountSum - AllocDiscountSum)/(BaseCheckSum - AllocCheckSum)*crGoods.ItemSum, 0.01);
            else
                CurDiscount = 0;

//;;Log((char*)Int2Str(CurDiscount).c_str());

            AllocCheckSum += crGoods.ItemSum;

            if (crGoods.ItemSum	> CurDiscount)
            {
                crGoods.ItemSum	-= CurDiscount;
                //+ dms ===== ÒÛÏÏ‡ ÒÍË‰ÍË ÔÓ ·ÓÌÛÒ‡Ï Ò·Â·‡ÌÍ‡
                //crGoods.ItemBankBonusDisc = CurDiscount;
                //- dms =====/
            }
            else
            {
                CurDiscount = crGoods.ItemSum;
                crGoods.ItemSum	= 0;

                //+ dms ===== ÒÛÏÏ‡ ÒÍË‰ÍË ÔÓ ·ÓÌÛÒ‡Ï Ò·Â·‡ÌÍ‡
                //crGoods.ItemBankBonusDisc = CurDiscount;
                //- dms =====/
            }

            AllocDiscountSum += CurDiscount;

			CurCheque->SetAt(i,crGoods);
		}
}
// - dms ====================/


// + dms ====================/

// —”ÃÃŒ¬¿ﬂ — »ƒ ¿ Õ¿ ¬≈—‹ ◊≈ , ¬ Àﬁ◊¿ﬂ ¿ ÷»ŒÕÕ€≈ “Œ¬¿–€
		//‡ÒÔÂ‰ÂÎˇÂÏ ÒÛÏÏÓ‚Û˛ ÒÍË‰ÍÛ Ì‡ ‚ÂÒ¸ ˜ÂÍ

//		;;Log((char*)("CurCheque->DiscountSumm = "+Int2Str(CurCheque->DiscountSumm)).c_str());

		double BaseDiscountSum  = CurCheque->DiscountSumm;
		// + dms ===== 2014-11-14 ===== —ÍË‰ÍÛ ‡ÒÔÓÒÚ‡ÌˇÚ¸ Ì‡ ‚ÂÒ¸ ÚÓ‚‡, ‚ÍÎ˛˜‡ˇ ‡ÍˆËÓÌÌ˚È
		// ¡˚ÎÓ:
		//double BaseCheckSum     = CurCheque->GetSumNotAction();
		// —Ú‡ÎÓ:
        double BaseCheckSum     = CurCheque->GetSum();
		// - dms ===== 2014-11-14 ===== —ÍË‰ÍÛ ‡ÒÔÓÒÚ‡ÌˇÚ¸ Ì‡ ‚ÂÒ¸ ÚÓ‚‡, ‚ÍÎ˛˜‡ˇ ‡ÍˆËÓÌÌ˚È
		double AllocDiscountSum = 0;
		double AllocCheckSum    = 0;
		double CurDiscount      = 0;

		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo crGoods = (*CurCheque)[i];

//;;Log((char*)crGoods.ItemName.c_str());

            if (
            ((crGoods.ItemFlag!=SL) && (crGoods.ItemFlag!=RT))
            || (crGoods.ItemCode==TRUNC)
            || (crGoods.ItemCode==EXCESS_PREPAY)

            // + dms ===== 2014-11-14 ===== —ÍË‰ÍÛ ‡ÒÔÓÒÚ‡ÌˇÚ¸ Ì‡ ‚ÂÒ¸ ÚÓ‚‡, ‚ÍÎ˛˜‡ˇ ‡ÍˆËÓÌÌ˚È
            // ¡˚ÎÓ:
            //|| ((crGoods.ItemName.substr(0,1)=="*"))
            // - dms ===== 2014-11-14 ===== —ÍË‰ÍÛ ‡ÒÔÓÒÚ‡ÌˇÚ¸ Ì‡ ‚ÂÒ¸ ÚÓ‚‡, ‚ÍÎ˛˜‡ˇ ‡ÍˆËÓÌÌ˚È
            )
                continue;

            //;;Log((char*)crGoods.ItemName.c_str());


            if (BaseCheckSum - AllocCheckSum > 0)
                CurDiscount = RoundToNearest((BaseDiscountSum - AllocDiscountSum)/(BaseCheckSum - AllocCheckSum)*crGoods.ItemSum, 0.01);
            else
                CurDiscount = 0;

//;;Log((char*)Int2Str(CurDiscount).c_str());

            AllocCheckSum += crGoods.ItemSum;

            if (crGoods.ItemSum	> CurDiscount)
            {
                crGoods.ItemSum	-= CurDiscount;
                //+ dms ===== ÒÛÏÏ‡ ÒÍË‰ÍË ÔÓ ·ÓÌÛÒ‡Ï Ò·Â·‡ÌÍ‡
                //crGoods.ItemBankBonusDisc = CurDiscount;
                //- dms =====/
            }
            else
            {
                CurDiscount = crGoods.ItemSum;
                crGoods.ItemSum	= 0;

                //+ dms ===== ÒÛÏÏ‡ ÒÍË‰ÍË ÔÓ ·ÓÌÛÒ‡Ï Ò·Â·‡ÌÍ‡
                //crGoods.ItemBankBonusDisc = CurDiscount;
                //- dms =====/
            }

            AllocDiscountSum += CurDiscount;

			CurCheque->SetAt(i,crGoods);
		}
// - dms ====================/

// + dms ====================/
		//‡ÒÔÂ‰ÂÎˇÂÏ ÒÛÏÏÓ‚Û˛ ÒÍË‰ÍÛ ·ÓÌÛÒÓ‚ —·Â·‡ÌÍ‡
		BaseDiscountSum  = CurCheque->BankBonusSumm;
		BaseCheckSum     = CurCheque->GetSum();
		AllocDiscountSum = 0;
		AllocCheckSum    = 0;
		CurDiscount      = 0;

		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo crGoods = (*CurCheque)[i];

            if (((crGoods.ItemFlag!=SL) && (crGoods.ItemFlag!=RT)) || (crGoods.ItemCode==TRUNC) || (crGoods.ItemCode==EXCESS_PREPAY)) continue;

            if (BaseCheckSum - AllocCheckSum > 0)
                CurDiscount = RoundToNearest((BaseDiscountSum - AllocDiscountSum)/(BaseCheckSum - AllocCheckSum)*crGoods.ItemSum, 0.01);
            else
                CurDiscount = 0;

            AllocCheckSum += crGoods.ItemSum;

            if (crGoods.ItemSum	> CurDiscount)
            {
                crGoods.ItemSum	-= CurDiscount;
                //+ dms ===== ÒÛÏÏ‡ ÒÍË‰ÍË ÔÓ ·ÓÌÛÒ‡Ï Ò·Â·‡ÌÍ‡
                crGoods.ItemBankBonusDisc = CurDiscount;
                //- dms =====/
            }
            else
            {
                CurDiscount = crGoods.ItemSum;
                crGoods.ItemSum	= 0;

                //+ dms ===== ÒÛÏÏ‡ ÒÍË‰ÍË ÔÓ ·ÓÌÛÒ‡Ï Ò·Â·‡ÌÍ‡
                crGoods.ItemBankBonusDisc = CurDiscount;
                //- dms =====/
            }

            AllocDiscountSum += CurDiscount;

			CurCheque->SetAt(i,crGoods);
		}
// - dms ====================/

		//‡ÒÔÂ‰ÂÎˇÂÏ ÒÛÏÏÓ‚Û˛ ÒÍË‰ÍÛ Ë ÒÍË‰ÍÛ ÔÓ ÒÂÚËÙËÍ‡Ú‡Ï ÔÓ ‚ÒÂÏÛ ˜ÂÍÛ
		BaseDiscountSum  = CurCheque->CertificateSumm;
		BaseCheckSum     = CurCheque->GetSum();
		AllocDiscountSum = 0;
		AllocCheckSum    = 0;
		CurDiscount      = 0;

		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo crGoods = (*CurCheque)[i];

            if (((crGoods.ItemFlag!=SL) && (crGoods.ItemFlag!=RT)) || (crGoods.ItemCode==TRUNC) || (crGoods.ItemCode==EXCESS_PREPAY)) continue;

            if (BaseCheckSum - AllocCheckSum > 0)
                CurDiscount = RoundToNearest((BaseDiscountSum - AllocDiscountSum)/(BaseCheckSum - AllocCheckSum)*crGoods.ItemSum, 0.01);
            else
                CurDiscount = 0;

            //+ dms ===== ÒÛÏÏ‡ ·ÂÁ Û˜ÂÚ‡ ÒÍË‰ÍË ÔÓ ÒÂÚËÙËÍ‡ÚÛ
            crGoods.ItemFullDiscSum = crGoods.ItemSum;
			//crGoods.ItemFullDiscPrice=RoundToNearest(crGoods.ItemFullDiscSum/crGoods.ItemCount,0.01);
            //- dms =====/

            AllocCheckSum += crGoods.ItemSum;

            if (crGoods.ItemSum	> CurDiscount)
                crGoods.ItemSum	-= CurDiscount;
            else
            {
                CurDiscount = crGoods.ItemSum;
                crGoods.ItemSum	= 0;
            }

            AllocDiscountSum += CurDiscount;

			CurCheque->SetAt(i,crGoods);
		}
// - dms ====================/


// + dms ====================/
		//‡ÒÔÂ‰ÂÎˇÂÏ ÒÛÏÏÓ‚Û˛ ÒÍË‰ÍÛ ·ÓÌÛÒÓ‚
		BaseDiscountSum  = CurCheque->BonusSumm;
		
#ifndef BONUS_LOG_SKIDKA 
		//;;Log("********************************************************************");
		//;;Log("Summa skidki bonus BaseDiscountSum=" + Double2Str(BaseDiscountSum));
		BaseDiscountSum = 306.0;
		isBonusCard = true;
		//;;Log(" BaseCheckSum=" + Double2Str(CurCheque->GetSum()));
		//;;Log("********************************************************************");
#endif
		
		BaseCheckSum     = GetMaxBonusToPay(CurCheque);
		
#ifndef BONUS_LOG_SKIDKA //œ–Ó‚ÂÍ‡ ÒÛÏÏ˚ Ò ·ÓÌÛÒ‡ÏË
        ;;Log("********************************************************************");
        ;;Log("BaseCheckSum=" + Double2Str(BaseCheckSum));
        ;;Log("********************************************************************");
        BaseCheckSum     = CurCheque->GetSum();
		double deltaSumBonusPoditog = 0.0;
		deltaSumBonusPoditog = (CurCheque->GetSum())*100 - BaseDiscountSum*100;
        ;;Log("BaseCheckSum new=" + Double2Str(BaseCheckSum));
		;;Log("delta Poditog checka-BonusSumm=" + Double2Str(deltaSumBonusPoditog));
		int deltaX = Double2Int(deltaSumBonusPoditog) % 100;
		;;Log("deltaX=" + Int2Str(deltaX));
        ;;Log("------------------------------------------------");
#endif
		
		//BaseCheckSum     = CurCheque->GetSum();
		AllocDiscountSum = 0;
		AllocCheckSum    = 0;
		CurDiscount      = 0;

		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo crGoods = (*CurCheque)[i];

            if (((crGoods.ItemFlag!=SL) && (crGoods.ItemFlag!=RT)) || (crGoods.ItemCode==TRUNC) || (crGoods.ItemCode==EXCESS_PREPAY)) continue;

            string strLock = crGoods.Lock;
            if (CashReg->GoodsLock(strLock, GL_NoBonus) == GL_NoBonus) continue;

            double curItemSum = crGoods.ItemSum;
            if(crGoods.ItemMinimumPrice>0)
            {
                curItemSum -= crGoods.ItemCount * crGoods.ItemMinimumPrice;
                if (curItemSum<=0) continue;
            }

            if (BaseCheckSum - AllocCheckSum > 0)
                //CurDiscount = RoundToNearest((BaseDiscountSum - AllocDiscountSum)/(BaseCheckSum - AllocCheckSum)*crGoods.ItemSum, 0.01);
                CurDiscount = RoundToNearest((BaseDiscountSum - AllocDiscountSum)/(BaseCheckSum - AllocCheckSum)*curItemSum, 0.01);
            else
                CurDiscount = 0;

            AllocCheckSum += curItemSum;

            if (crGoods.ItemSum	> CurDiscount)
            {
                crGoods.ItemSum	-= CurDiscount;
                //+ dms ===== ÒÛÏÏ‡ ÒÍË‰ÍË ÔÓ ·ÓÌÛÒ‡Ï
                crGoods.ItemBonusDisc = CurDiscount;
                //- dms =====/
            }
            else
            {
                CurDiscount = crGoods.ItemSum;
                crGoods.ItemSum	= 0;
                //+ dms ===== ÒÛÏÏ‡ ÒÍË‰ÍË ÔÓ ·ÓÌÛÒ‡Ï
                crGoods.ItemBonusDisc = CurDiscount;
                //- dms =====/
            }

            // ÛÏÂÌ¸¯‡ÂÏ ÒÛÏÏÛ Ì‡˜ËÒÎÂÌÌ˚ı ·ÓÌÛÒÓ‚ Ò Û˜ÂÚÓÏ ÒÛÏÏ˚ ÒÔËÒ‡ÌÌ˚ı ‚ Ò˜ÂÚ ÓÔÎ‡Ú˚
            if ((fabs(CurDiscount)>0.01) && (fabs(crGoods.ItemCalcSum)>0.01))
            {
                double newCalcSum = crGoods.ItemCalcSum-CurDiscount;
                if (newCalcSum<0) newCalcSum = 0;
                crGoods.ItemBonusAdd = RoundToNearest(crGoods.ItemBonusAdd * (newCalcSum / crGoods.ItemCalcSum), 0.01);
            }

            AllocDiscountSum += CurDiscount;

			CurCheque->SetAt(i,crGoods);
		}
// - dms ====================/

#ifndef BONUS_LOG_SKIDKA 
		;;Log("********************************************************************");
		//;;Log("Summa skidki bonus BaseDiscountSum=" + Double2Str(BaseDiscountSum));
		//BaseDiscountSum = 306.0;
		;;Log(" BaseCheckSum=" + Double2Str(CurCheque->GetSum()));
		;;Log("********************************************************************");
#endif

		//ÔÂÂÒ˜ËÚ˚‚‡ÂÏ ˆÂÌÛ ÚÓ‚‡Ó‚ Ò Û˜ÂÚÓÏ ÒÍË‰ÓÍ ˜ÚÓ·˚ ‚ ˜ÂÍÂ ‚ÒÂ ‚˚„Îˇ‰ÂÎÓ Í‡ÒË‚Ó
		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo g=(*CurCheque)[i];
			g.ItemPrice=RoundToNearest(g.ItemSum/g.ItemCount,0.01);
			if(fabs(g.ItemPrice-g.ItemCalcPrice)>0.015)
				CurCheque->SetAt(i,g);
		}
		

		// ÓÍÛ„ÎÂÌËÂ
		if( (FiscalCheque::trunc > .01)
            && (!FiscalCheque::PayBank) )
		{
		    int mag = Str2Int(trim(CashReg->GetMagNum()));
		    // “ÂÒÚËÓ‚‡ÌËÂ ÓÍÛ„ÂÌËˇ. ŒÚÍÎ˛˜ÂÌÓ
//		    if ((mag==77) || (mag==30))
//		    {
//                // ÕÓ‚˚Â Ô‡‚ËÎ‡ ÓÍÛ„ÎÂÌËˇ Ò ŒÍÚˇ·ˇ 2019„:
//                // - ÂÒÎË ÌËÍ‡ÍËı ·ÓÌÛÒÓ‚ ‚ ˜ÂÍÂ ÌÂÚ, ÚÓ Õ≈ ÓÍÛ„ÎˇÂÏ ‚ÓÓ·˘Â
//                // - ÂÒÎË ÂÒÚ¸ ·ÓÌÛÒ˚, ÚÓ ÓÍÛ„ÎˇÂÏ ‰Ó Û·Îˇ ‚ ÏÂÌ¸¯Û˛ ÒÚÓÓÌÛ (Á‡ c˜ÂÚ ÔÂ‰ÓÒÚ‡‚ÎˇÂÏ˚ı ·ÓÌÛÒÓ‚)
//;;Log("=D1=");
//                if ( isBonusCard
//                    && (CurCheque->GetBonusAddSum()>=FiscalCheque::trunc)
//                    && (CurCheque->GetSum()>=20)
//                   )
//                {
//                    ;;Log("=D2=");
//                    CurCheque->tsum = CurCheque->GetSum() - (FiscalCheque::trunc) * floor((CurCheque->GetSum() + .005) / (FiscalCheque::trunc));
//                }
//                else
//                {
//                    ;;Log("=D3=");
//                    CurCheque->tsum = 0;
//                    //;;Log("œÂÂÒ˜ÂÚ ·ÂÁ  Œœ≈≈ ");
//                }
//		    }
//		    else
		    {
                if (CurCheque->GetSum()>=20)
                {
                    // ÕÓ‚˚Â Ô‡‚ËÎ‡ ÓÍÛ„ÎÂÌËˇ Ò —ÂÌÚˇ·ˇ 2016„:
                    // - ÂÒÎË ÌËÍ‡ÍËı ÒÍË‰ÓÍ ‚ ˜ÂÍÂ ÌÂÚ, ÚÓ ÓÍÛ„ÎˇÂÏ ‰Ó Û·Îˇ ÏÂÌ¸¯Û˛ ÒÚÓÓÌÛ (Á‡ Ò˜ÂÚ ÔÂ‰ÔËˇÚËˇ)
                    // - ÂÒÎË ÂÒÚ¸ ÒÍË‰ÍË, ÚÓ ÓÍÛ„ÎˇÂÏ ‰Ó Û·Îˇ ‚ ·ÓÎ¸¯Û˛ ÒÚÓÓÌÛ (Á‡ c˜ÂÚ ÔÂ‰ÓÒÚ‡‚ÎˇÂÏ˚ı ÒÍË‰ÓÍ)
                    // ƒÓ·‡‚ÎÂÌÓ »˛Ì¸ 2017„.
                    // ƒÎˇ ·ÓÌÛÒÌ˚ı Í‡Ú ÒÍË‰ÍÛ ÓÍÛ„ÎˇÂÏ ‚ ÏÂÌ¸¯Û˛ ÒÚÓÓÌÛ. œË ˝ÚÓÏ ”ÏÂÌ¸¯‡ÂÏ ÒÛÏÏÛ
                    // Ì‡˜ËÒÎÂÌÌ˚ı ·ÓÌÛÒÓ‚ Ì‡ –‡ÁÏÂ ÒÍË‰ÍË-ÓÍÛ„ÎÂÌËˇ
                    if ((!isBonusCard)
                        && (CurCheque->GetDiscountSum_NotAction9()>=FiscalCheque::trunc)
                        && (CurrentCustomer > 0LL))
              {
                        CurCheque->tsum = CurCheque->GetSum() - (FiscalCheque::trunc) * ceil((CurCheque->GetSum() + .005) / (FiscalCheque::trunc));
#ifndef BONUS_LOG_SKIDKA
        ;;Log("Okruglenie v bolshui storonu=" + Double2Str(CurCheque->tsum));
#endif
              }
                        //CurCheque->tsum = CurCheque->GetSum() - ceil(CurCheque->GetSum());
                    else
              {
                        CurCheque->tsum = CurCheque->GetSum() - (FiscalCheque::trunc) * floor((CurCheque->GetSum() + .005) / (FiscalCheque::trunc));

#ifndef BONUS_LOG_SKIDKA
        ;;Log("Okruglenie v menshui storonu=" + Double2Str(CurCheque->tsum));
#endif


              }
                }
                else
                {
                    //ÂÒÎË ÒÛÏÏ‡ ˜ÂÍ‡ ÏÂÌ¸¯Â 20 Û·ÎÂÈ, ÚÓ ÓÍÛ„ÎˇÂÏ ‰Ó 10 ÍÓÔ. ‚ ÏÂÌ¸¯Û˛ ÒÚÓÓÌÛ
                    CurCheque->tsum = CurCheque->GetSum() - (0.1) * floor((CurCheque->GetSum() + .005) / (0.1));
                }
		    }
		    //else
		    //{
            //    CurCheque->tsum = CurCheque->GetSum() - (FiscalCheque::trunc) * floor((CurCheque->GetSum() + .005) / (FiscalCheque::trunc));
            //}

			CurCheque->tsum = RoundToNearest(CurCheque->tsum,0.01);
		}
		else
		{
		    CurCheque->tsum = 0;
		    //;;Log("œÂÂÒ˜ÂÚ ·ÂÁ  Œœ≈≈ ");
		}


        // ƒÎˇ ·ÓÌÛÒÌ˚ı Í‡Ú ÒÍË‰ÍÛ ÓÍÛ„ÎˇÂÏ ‚ ÏÂÌ¸¯Û˛ ÒÚÓÓÌÛ.
        // œË ˝ÚÓÏ ”ÏÂÌ¸¯‡ÂÏ ÒÛÏÏÛ Ì‡˜ËÒÎÂÌÌ˚ı ·ÓÌÛÒÓ‚ Ì‡ –‡ÁÏÂ ÒÍË‰ÍË-ÓÍÛ„ÎÂÌËˇ
        if (isBonusCard)
        {
            double crGoodsTSum=0;
            double crTSum=CurCheque->tsum;

            for (int i=0;(i<CurCheque->GetCount()) && (crTSum>0);i++)
            {
                GoodsInfo crGoods = (*CurCheque)[i];

                if (crGoods.ItemFlag == SL)
                {
#ifndef BONUS_LOG_SKIDKA
                    ;;Log("CrgoodsItemBonusAdd = " + Double2Str(crGoods.ItemBonusAdd));
                    ;;Log("crTsum = " + Double2Str(crTSum));
#endif

                    if (crGoods.ItemBonusAdd > crTSum)
                    {
                        crGoods.ItemBonusAdd	-= crTSum;
                        crTSum	=0;
                    }
                    else
                    {
                        crTSum	-= crGoods.ItemBonusAdd;
                        crGoods.ItemBonusAdd	 = 0;
                    }
                    CurCheque->SetAt(i,crGoods);
                }
            }

           // CurCheque->tsum = crTSum;

        }


/*
		double crGoodsTSum=0;
		double crTSum=CurCheque->tsum;
		for (int i=0;(i<CurCheque->GetCount()) && (crTSum>0);i++)
		{
			GoodsInfo crGoods = (*CurCheque)[i];
			if (crGoods.ItemFlag == SL)
			{
				//crGoodsTSum = RoundToNearest(crGoods.ItemCalcSum*CurCheque->tsum/CurCheque->GetCalcSum(),0.01);
				crGoodsTSum = RoundToNearest(crGoods.ItemSum*CurCheque->tsum/CurCheque->GetSum(),0.01);

				crGoods.ItemFullDiscSum	-= crGoodsTSum;

				if (crGoods.ItemSum > crGoodsTSum)
				{
					crGoods.ItemSum	-= crGoodsTSum;
					crTSum		-= crGoodsTSum;
				}
				else
				{
					crGoods.ItemSum	 = 0;
					crTSum	-= crGoods.ItemSum;
				}
				CurCheque->SetAt(i,crGoods);
			}
		}
		if (fabs(crTSum)>epsilon)
		{
			int i=CurCheque->GetCount()-1;

			GoodsInfo crGoods = (*CurCheque)[i];
			while((i>=0) && (crGoods.ItemFlag!=SL) || (crGoods.ItemSum<=0))
			{
				i--;
				crGoods = (*CurCheque)[i];
			}
			if (crGoods.ItemFlag == SL)
			{
			    crGoods.ItemFullDiscSum	-= crTSum;
				if (crGoods.ItemSum > crTSum)
				{
					crGoods.ItemSum	-= crTSum;
					crTSum		-= crTSum;
				}
				else
				{
					crGoods.ItemSum	 = 0;
					crTSum	-= crGoods.ItemSum;
				}
			}
			CurCheque->SetAt(i,crGoods);
		}
//*/
//*
        // “≈—“ –¿«Œ¬Œ - ”¡–¿“‹ — »ƒ ”-Œ –”√À≈Õ»≈
#ifndef BONUS_LOG_SKIDKA
		;;Log("tsum do obnulenia=" + Double2Str(CurCheque->tsum));
        CurCheque->tsum = 0;
		;;Log("Summa cheks = " + Double2Str(CurCheque->GetSum()));
#endif
        // “≈—“ –¿«Œ¬Œ - ”¡–¿“‹ — »ƒ ”-Œ –”√À≈Õ»≈

        //! —ÔËÒ‡ÌËÂ ÒÛÏÏ˚ ÓÍÛ„ÎÂÌËˇ ÚÓÎ¸ÍÓ Ò ÓÍÛ„ÎˇÂÏ˚ı ÔÓÁËˆËÈ
		double crGoodsTSum=0;
		double crTSum=CurCheque->tsum;

		double crSum=0;

        bool minus = (CurCheque->tsum < 0); // ÔËÁÌ‡Í ÓÚËˆ‡ÚÂÎ¸ÌÓÈ ÒÍË‰ÍË-ÓÍÛ„ÎÂÌËˇ

        if (minus)
        {
            for (int i=0;(i<CurCheque->GetCount()) && (crTSum<0);i++)
            {
                GoodsInfo crGoods = (*CurCheque)[i];

                crSum = crGoods.ItemCalcSum - crGoods.ItemSum; // ‚˚‰ÂÎËÏ ÒÍË‰ÍÛ

                if ( (crGoods.ItemFlag == SL) && (crSum>0.001) && (crGoods.ItemName.substr(0,1)!="*") && (crGoods.ItemName.substr(0,1)!="@") ) // ÓÚËˆ‡ÚÂÎ¸Ì‡ˇ ÒÍË‰Í‡ ÌÂ ÏÓÊÂÚ Û‚ÂÎË˜Ë‚‡Ú¸ ‡ÍˆËÓÌÌ˚È ÚÓ‚‡
                {
                    //crGoodsTSum = RoundToNearest(crGoods.ItemCalcSum*CurCheque->tsum/CurCheque->GetCalcSum(),0.01);
                    crGoodsTSum = RoundToNearest(max(-crSum, crTSum),0.01);

                    crGoods.ItemFullDiscSum	-= crGoodsTSum;

                    crGoods.ItemSum	-= crGoodsTSum;
                    crTSum		-= crGoodsTSum;

                    CurCheque->SetAt(i,crGoods);
                }
            }
        }
        else
        {
            for (int i=0;(i<CurCheque->GetCount()) && (crTSum>0);i++)
            {
                GoodsInfo crGoods = (*CurCheque)[i];

                crSum = (crGoods.ItemSum*10 - (int)(crGoods.ItemSum*10))/10; // ‚˚‰ÂÎËÏ ÍÓÔÂÈÍË

                if ((crGoods.ItemFlag == SL) && (crSum>0.001))
                {
                    //crGoodsTSum = RoundToNearest(crGoods.ItemCalcSum*CurCheque->tsum/CurCheque->GetCalcSum(),0.01);
                    crGoodsTSum = RoundToNearest(min(crSum, crTSum),0.01);

                    crGoods.ItemFullDiscSum	-= crGoodsTSum;   

                    if (crGoods.ItemSum > crGoodsTSum)
                    {
                        crGoods.ItemSum	-= crGoodsTSum;
                        crTSum		-= crGoodsTSum;
                    }
                    else
                    {
                        crGoods.ItemSum	 = 0;
                        crTSum	-= crGoods.ItemSum;
                    }
                    CurCheque->SetAt(i,crGoods);
                }
            }
        }
		
		if (fabs(crTSum)>epsilon)
		{
			int i=CurCheque->GetCount()-1;

			GoodsInfo crGoods = (*CurCheque)[i];
			
#ifndef BONUS_LOG_SKIDKA
            ;;Log("crGoodsItemSum=" + Double2Str(crGoods.ItemSum));
#endif
			
			while((i>=0) && (crGoods.ItemFlag!=SL) || (crGoods.ItemSum<=0))
			{
				i--;
				crGoods = (*CurCheque)[i];
			}
			if ((crGoods.ItemFlag == SL)
                && (!minus || ((crGoods.ItemName.substr(0,1)!="*") && (crGoods.ItemName.substr(0,1)!="@")))
               )
			{
			    crGoods.ItemFullDiscSum	-= crTSum;
				if (crGoods.ItemSum > crTSum)
				{
					crGoods.ItemSum	-= crTSum;
					crTSum		-= crTSum;
				}
				else
				{
					crGoods.ItemSum	 = 0;
					crTSum	-= crGoods.ItemSum;
				}
			}

			CurCheque->SetAt(i,crGoods);
		}

#ifndef BONUS_LOG_SKIDKA
        ;;Log("***************************************");
        ;;Log("CurCheque->tsum =" + Double2Str(CurCheque->tsum));
        ;;Log("Summa cheks = " + Double2Str(CurCheque->GetSum()));
        ;;Log("*****************************************************");
#endif
		
		
//*/

//  ====== ¿ÍˆËË ÔÓ ·ÓÌÛÒ‡Ï ======
//        ExecBonusAction(CurCheque); //ÓÚÍÎ˛˜ËÚ¸
//  =======

// + dms ====================/
		//‡ÒÔÂ‰ÂÎˇÂÏ ÓÔÎ‡ÚÛ ÒÂÚËÙËÍ‡Ú‡ÏË ÔÓ ‚ÒÂÏÛ ˜ÂÍÛ (¿¬¿Õ—)
		BaseDiscountSum  = CurCheque->PrePayCertificateSumm;
		BaseCheckSum     = CurCheque->GetSum();
		AllocDiscountSum = 0;
		AllocCheckSum    = 0;
		CurDiscount      = 0;

		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo crGoods = (*CurCheque)[i];

            if (((crGoods.ItemFlag!=SL) && (crGoods.ItemFlag!=RT)) || (crGoods.ItemCode==TRUNC) || (crGoods.ItemCode==EXCESS_PREPAY)) continue;

            if (BaseCheckSum - AllocCheckSum > 0)
                CurDiscount = RoundToNearest((BaseDiscountSum - AllocDiscountSum)/(BaseCheckSum - AllocCheckSum)*crGoods.ItemSum, 0.01);
            else
                CurDiscount = 0;

            crGoods.ItemSumToPay = crGoods.ItemSum;

            AllocCheckSum += crGoods.ItemSum;

            if (crGoods.ItemSumToPay > CurDiscount)
                crGoods.ItemSumToPay -= CurDiscount;
            else
            {
                CurDiscount = crGoods.ItemSumToPay;
                crGoods.ItemSumToPay	= 0;
            }

            AllocDiscountSum += CurDiscount;

			CurCheque->SetAt(i,crGoods);
		}
// - dms ====================/

		//Ó·ÌÓ‚ÎˇÂÏ ËÌÙÓÏ‡ˆË˛ Ì‡ ˝Í‡ÌÂ
		QListViewItem *CurItem=ChequeList->firstChild();
		if(CurItem)
		for (int i=0;i<CurCheque->GetCount();i++)
		{
			GoodsInfo g=(*CurCheque)[i];
			if (g.ItemFlag==SL)
			{
			    //CurItem-> TextColor = g.ActionGoods?Qt::blue:Qt::black;
			    CurItem->setText(ListName,W2U(g.ItemName));
				CurItem->setText(ListPrice,GetRounded(g.ItemPrice,0.01).c_str());
				CurItem->setText(ListSum,GetRounded(g.ItemSum,0.01).c_str());
				CurItem->setText(ListDscnt,GetRounded(g.ItemCalcSum-g.ItemSum,0.01).c_str());
				
				#ifndef BONUS_LOG_SKIDKA
					;;Log("g.ItemName = " + g.ItemName);
					;;Log("Price = " + Double2Str(g.ItemPrice));
					;;Log("Sum = " + Double2Str(g.ItemSum));
					;;Log("Delta = " + Double2Str(g.ItemCalcSum-g.ItemSum));
				#endif

				if (CurItem->itemBelow()!=NULL)
					CurItem=CurItem->itemBelow();
			}
		}
		CashReg->ClearCurrentCheck();

		CashReg->WriteChequeIntoTable(CurCheque,CashReg->GetCurTime());

		//ShowGoodsInfo();
		SaveSet();
		
#ifndef BONUS_LOG_SKIDKA
        ;;Log("All Tovar checks=" + Double2Str(CurCheque->GetSum()));
		;;Log("GetFullSumm=" + Double2Str(CurCheque->GetFullSum()));
		;;Log("GetCalcSum=" + Double2Str(CurCheque->GetCalcSum()));
		;;Log("GetDiscountSum();=" + Double2Str(CurCheque->GetDiscountSum()));
		;;Log("tsum=" + Double2Str(CurCheque->tsum));
		;;Log("trunc=" + Double2Str(CurCheque->trunc));
		;;Log("GetSumNotAction=" + Double2Str(CurCheque->GetSumNotAction()));
		//;;Log("GetCalcSum_Action9=" + Double2Str(GetCalcSum_Action9()));
		;;Log("GetCalcSum_NotAction9=" + Double2Str(CurCheque->GetCalcSum_NotAction9()));
		;;Log("GetDiscountSum_NotAction9=" + Double2Str(CurCheque->GetDiscountSum_NotAction9()));	
#endif

//		;;Log("[Func] ProcessDiscount [End]");

 	}
	catch(cash_error& er)
	{
		CashReg->LoggingError(er);
		return;
	}
}

void WorkPlace::SetBankDSum(void)
{
    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return;

    //ÒÓı‡ÌÂÌËÂ ÒÛÏÏ˚ ÔÂÂ‰ ÔÂ‰ÓÒÚ‡‚ÎÂÌËÂÏ ÒÍË‰ÍË ÔÓ ·‡ÌÍÓ‚ÒÍÓÈ Í‡ÚÂ
    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];
        g.ItemBankDiscSum=g.ItemFullDiscSum;

        CurCheque->SetAt(i,g);
    }
}

bool WorkPlace::AppendRecord2Check(void)
{
	if (PriceChecker!=NULL)
	{
		StartPriceChecker(41480);

		return false;
	}
    if (FreeSum!=NULL)
    {
        FreeSum->NameEdit->setText(W2U(CurrentGoods->ItemName));
        FreeSum->PriceEdit->setText(W2U(Double2Str(CurrentGoods->ItemPrice)));
        FreeSum->CountEdit->setText(W2U(Double2Str(CurrentGoods->ItemCount)));

        FreeSum->InfoLabel->setText(W2U("“Ó‚‡ ÂÒÚ¸ ‚ ·‡ÁÂ!"));
        return false;
    }

	{
		try
		{

/*
                // ¬ÂÏÂÌÌ‡ˇ ‰Îˇ Ï‡„ 100 Ì‡ ÔÂÂıÓ‰Ì˚È ÔÂËÓ‰
                // ÕÂ ÔÂÂÏÂ˘ÂÌÌ˚È ¿ÎÍÓ„ÓÎ¸ ÏÓÊÌÓ ÔÓ‰‡‚‡Ú¸ ÚÓÎ¸ÍÓ Ì‡ 11È Í‡ÒÒÂ
                // Õ‡ ÚÓ‚‡ ÛÒÚ‡ÌÓ‚ÎÂÌ ÔËÁÌ‡Í 31 (‡ÎÍÓ„ÓÎ¸ „‡ÒÚÓÌÓÏ)
                // “Ó‚‡˚ ‰ÓÏ‡¯ÌÂ„Ó „‡ÒÚÓÌÓÏ‡ ÓÚ·Ë‚‡Ú¸ Ì‡ 11È Í‡ÒÒÂ ÌÂÎ¸Áˇ

                int mag = Str2Int(trim(CashReg->GetMagNum()));
                if (mag==100)
                {
                    string str= CurrentGoods->Lock;
                    bool res = CashReg->GoodsLock(str, GL_GastronomOnly) == GL_GastronomOnly;

                        if (
                        (CashReg->GetCashRegisterNum()==11) || (CashReg->GetCashRegisterNum()==9)
                        || (CashReg->GetCashRegisterNum()==2) || (CashReg->GetCashRegisterNum()==10)
                        )
                        {
                            if (!res) ShowMessage("“Ó‚‡ ÌÂ ÏÓÊÂÚ ·˚Ú¸ ÔÓ‰‡Ì Ì‡ ˝ÚÓÈ Í‡ÒÒÂ!");
                        }
                        else
                        {
                            if (res) ShowMessage("“Ó‚‡ ÌÂ ÏÓÊÂÚ ·˚Ú¸ ÔÓ‰‡Ì Ì‡ ˝ÚÓÈ Í‡ÒÒÂ! “ÓÎ¸ÍÓ Ì‡ Í‡ÒÒ‡ı 11, 9");
                        }

                }
*/

		    // ¿ÍˆËˇ 3+1 - Í‡Ê‰˚È ˜ÂÚ‚ÂÚ˚È ÚÓ‚‡ ‚ ÔÓ‰‡ÓÍ ( ÒÍË‰ÍÓÈ 25%)
		    string str= CurrentGoods->Lock;
		    bool action3_1 = CashReg->GoodsLock(str, GL_Action3_1) == GL_Action3_1;

		    if (action3_1)
		    {
                //ShowMessage("“Œ¬¿– ”◊¿—“¬”≈“ ¬ ¿ ÷»» 3+1\nœ–≈ƒÀŒ∆»“‹ œŒ ”œ¿“≈Àﬁ œŒÀ”◊»“‹ 4-… “Œ¬¿– ¬ œŒƒ¿–Œ ");

                // ShowMessage("œË ÔÓÍÛÔÍÂ ‰‡ÌÌÓ„Ó ÔË‚‡ Í‡ÚÌÓÂ 4,5 Î\n ‚˚‰‡ÂÚÒˇ ÔÓ‰‡ÓÍ:\n\n          5 Ô‡˜ÂÍ ‡‡ıËÒ‡.\n\n ( Á‡ 9 Î - 10 Ô‡˜ÂÍ Ë Ú.‰.)");
		    }

		    //if (CurrentGoods->ItemCode==48297)
		    //{
		    //     ShowMessage("¬˚‰‡Ú¸ œŒƒ¿–Œ  ÍÌË„Û \"¬ÂÎËÍËÂ ÔÓ˝Ú˚. »‚‡Ì ¡ÛÌËÌ\"");

            //    ShowMessage("¬˚‰‡Ú¸ œŒƒ¿–Œ  ÍÌË„Û \"ÃÛÁÂË ÏË‡\"");

                // ShowMessage("œË ÔÓÍÛÔÍÂ ‰‡ÌÌÓ„Ó ÔË‚‡ Í‡ÚÌÓÂ 4,5 Î\n ‚˚‰‡ÂÚÒˇ ÔÓ‰‡ÓÍ:\n\n          5 Ô‡˜ÂÍ ‡‡ıËÒ‡.\n\n ( Á‡ 9 Î - 10 Ô‡˜ÂÍ Ë Ú.‰.)");
		    //}

		    bool IsGood18 = CashReg->GoodsLock(str, GL_Goods18) == GL_Goods18;


			CurrentGoods = Cheque->Insert(*CurrentGoods);

			QListViewItem *lastItem=ChequeList->firstChild();//update check's list

			if (lastItem!=NULL)
				for(;;)
					if (lastItem->itemBelow()!=NULL)

						lastItem=lastItem->itemBelow();
					else
						break;

//			QListViewItem *item=new QListViewItem(ChequeList,lastItem);//add goods to the cheque list

            QColor color = Qt::black;

            if ((CurrentGoods->ItemAlco) || IsGood18)
                color = Qt::darkMagenta;
            else
                if (CurrentGoods->ItemCode==FreeSumCode)
                    color = Qt::darkMagenta;
                else
                    if (action3_1 || CashReg->GoodInAction(CurrentGoods))
                        color = Qt::darkBlue;

            ColorListViewItem *item=new ColorListViewItem(ChequeList, lastItem, color);//add goods to the cheque list

			item->setText(ListNo,Int2Str(Cheque->GetSize()).c_str());
            // + dms === 2010-03-30 =====\ ÒÔÂˆ. ÍÓ‰ ÌÂ ‚˚‚Ó‰ËÏ
			item->setText(ListCode, CurrentGoods->ItemCode==FreeSumCode? "" : Int2Str(CurrentGoods->ItemCode).c_str());

            if (CurrentGoods->ItemAlco)
                item->setText(ListName,W2U("~"+CurrentGoods->ItemName));
            else
                item->setText(ListName,W2U(CurrentGoods->ItemName));

			item->setText(ListPrice,GetRounded(CurrentGoods->ItemPrice,0.01).c_str());
			item->setText(ListCount,GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
			item->setText(ListSum,GetRounded(CurrentGoods->ItemSum,0.01).c_str());
			item->setText(ListDscnt,GetRounded(CurrentGoods->ItemCalcSum-CurrentGoods->ItemSum,0.01).c_str());

			ChequeList->ensureItemVisible(item);

			ChequeList->setSelected(item,true);
			ChequeList->setCurrentItem(item);

			//
			if(CurrentGoods->ItemSum < .01){
				ShowMessage(CurGoods.ItemCount < .001 ? "¬‚Â‰ËÚÂ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡!" : "ÕÂ‚ÂÌ‡ˇ ÒÛÏÏ‡ ÔÓÍÛÔÍË!");
				return false;
			}
			ShowGoodsInfo();

            //+ dms ==== 2014-12-23 ==== —ÓÓ·˘ÂÌËˇ ÔË Ò˜ËÚ˚‚‡ÌËË ÚÓ‚‡‡ ‚ ˜ÂÍÂ =====

            // 120-121È Á‡ÔÂÚ
		    // 20-21È »ƒ ‰Îˇ ÒÓÓ·˘ÂÌËˇ ÔË ‰Ó·‡‚ÎÂÌËË ÚÓ‚‡‡ ‚ ˜ÂÍ

		    str = CurrentGoods->Lock;
            for (unsigned short k=20;k<=21;k++)
            {
                if (CashReg->GoodsLock(str, GL_NoLock + k) == GL_NoLock + k)
                {
                    string msg = CashReg->GetMessageInfo(k);
                    if (msg!="") ShowMessage(msg);

                }
            }

            //- dms ==== 2014-12-23 ==== —ÓÓ·˘ÂÌËˇ ÔË Ò˜ËÚ˚‚‡ÌËË ÚÓ‚‡‡ ‚ ˜ÂÍÂ =====

			return true;
		}
		catch(int &er)
		{
			CashReg->WriteChequeIntoTable(Cheque,CashReg->GetCurTime());

			ErrorHandler(er);
			return false;


		}
		catch(cash_error &er)
		{
			CashReg->DbfMutex->unlock();
			CashReg->LoggingError(er);
			return false;
		}
	}
	return false;
}

void WorkPlace::ErrorHandler(int er)
{
	if (er!=0)
	{
		CashReg->ShowErrorCode(er);

		if ((FiscalReg->RestorePaperBreak())&&(FiscalReg->IsPaperOut(er)))
		{
			int error_code;
			for(;;)
			{
				error_code=FiscalReg->ResetReg();
				if (error_code==0)
					return;
				if (FiscalReg->IsPaperOut(er))
					ShowMessage("¬ÒÚ‡‚¸ÚÂ ·ÛÏ‡„Û Ë Ì‡ÊÏËÚÂ OK!");
				else
					ErrorHandler(er);
			}
		}

		if (Cheque->GetCount()>0)    //check guard id
		{
			int GuardRes=NotCorrect;
			if (!CashReg->CurrentSaleman->Annul)
			do
			{
				GuardRes=CheckBarcode(Guard);

				if (GuardRes==NotCorrect)
					ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È Ô‡ÓÎ¸ —œœ!");

				if (GuardRes==NoPasswd)
					ShowMessage("¬‚Â‰ËÚÂ Ô‡ÓÎ¸!");
			}
			while((GuardRes==NotCorrect)||(GuardRes==NoPasswd));

			CashReg->TryToCancelCheck();//anull current check

			if (FiscalReg->IsPaperOut(er))
				ShowMessage("ÕÂ Á‡·Û‰¸ÚÂ ÒÌÓ‚‡ ÔÓ·ËÚ¸ ˜ÂÍ!");

			CashReg->AnnulCheck(Cheque,GuardRes);

			IsChequeInProgress=false;
			InitWorkPlace();
		}
	}
}


bool WorkPlace::WhoIsCert(int Who)
{
    return Who == CD_CERT100
        || Who == CD_CERT250
        || Who == CD_CERT500
        || Who == CD_CERT1000
        || Who == CD_CERT1500
        || Who == CD_CERT2000
        || Who == CD_CERT3000
        || Who == CD_CERT5000;
}

long long WorkPlace::CheckBarcode(int Who, string msg)
{
    //;;Log("[FUNC] CheckBarcode [START]");
    if (msg=="") BarcodeCard=new GuardForm(this, PrefixSeq, PostfixSeq);
	else BarcodeCard=new GuardForm(this, PrefixSeq, PostfixSeq, msg);
	if(!CashReg->CurrentSaleman->ZReport)
		BarcodeCard->EditLine->setReadOnly(true);
	long long res=NotCorrect;
	string Barcode;
    string BarcodeL; // Int64

	try
	{
		vector<string> prefices;

		for(unsigned int i=0;i<BarcodeID.size();i++)
		{
			string s = BarcodeID[i]->CodeName;
			if ( s=="EAN13" || s == "EAN8")
				prefices.insert(prefices.end(),BarcodeID[i]->CodeID);
		}


		if (BarcodeCard->exec()==QDialog::Accepted)
		{
			Barcode=U2W(BarcodeCard->EditLine->text().upper());//load barcode and cut off prefix
			if (!Barcode.empty())
				for (unsigned int i=0;i<prefices.size();i++)
				{
					string prefix=prefices[i];
					if (Barcode.substr(0,prefix.length())==prefix)
					{
						Barcode=Barcode.substr(prefix.length());
						BarcodeL=Barcode.substr(1);
					}
				};


			if (Barcode.substr(0,2)!=CardPrefix && Barcode.substr(0,3)!=CardPrefixN && Who != Guard && Who != Manager && !WhoIsCert(Who))
			{
				res = NotCorrect;
				if(Barcode.length() < 13)
				{
					int CardNumber = atoi(Barcode.substr(0,7).c_str());// + 9000000;
					//  Ó‰ Í‡Ú˚ Int64
					long long CardNumberL = atoll(BarcodeL.substr(0,12).c_str());// + 9000000;

#ifdef _OLD_VARIANT_  // Ó·˙ˇ‚ÎˇÂÚÒˇ ‚ utils.h

// test, find error customers range (9930008...)
					//if((CardNumber>=800000) && (CardNumber<900000))
					//{
                     //   ;;cash_error* _err = new cash_error(11,0, BarcodeL);
                     //   ;;CashReg->LoggingError(*_err);
                     //   ;;delete _err;
					//}


					if((CardNumberL>=993000700000LL) && (CardNumberL<993000800000LL))
					{
						CardNumber+=100000;
						CardNumberL+=100000;
					}

#endif
					//CashReg->FindCustomer(&res,CardNumber);
					CashReg->FindCustomer(&res,CardNumberL);

					delete BarcodeCard;
					BarcodeCard=NULL;
					return res;
				}
			}

			res=NotCorrect;

			int CardNumber;
			long long CardNumberL;

			switch(Who)
			{
			    case Flayer:
                    if(Barcode.substr(0,3) == GastronomPrefix)
                    {
                        CardNumber=atoi(Barcode.substr(6,6).c_str());
						// Customer code Int64
						CardNumberL=atoll(Barcode.substr(0,12).c_str());

#ifdef _OLD_VARIANT_
						if((CardNumberL>=993000700000LL) && (CardNumberL<993000800000LL))
						{
							CardNumber+=100000;
							CardNumberL+=100000;
						}
#endif
                        CardInfoStruct CardInfo;
                        if (CashReg->FindCardInRangeTable(&CardInfo,CardNumberL))
                        {
                           if(CardInfo.CardType==CD_FLAYER)
                           {
                               res = CardInfo.CardNumber;
                               break;
                           }
                        };
                    }
				case Guard://if card's owner is guard then we have to find his ID
					if(Barcode.substr(0,3) != SPPPrefix)
						break;//res = NotCorrect;
					CashReg->FindStaff((int*)&res,Barcode);
					break;
                case CD_CERT100:
                case CD_CERT250:
                case CD_CERT500:
                case CD_CERT1000:
                case CD_CERT1500:
                case CD_CERT2000:
                case CD_CERT3000:
                case CD_CERT5000:

					if(Barcode.substr(0,3) == SPPPrefix)
						break;//res = NotCorrect;
					if(Barcode.substr(0,3) == GastronomPrefix)
					{
						CardNumber=atoi(Barcode.substr(3,9).c_str());
						// Customer code Int64
						CardNumberL=atoll(Barcode.substr(0,12).c_str());

#ifdef _OLD_VARIANT_

						if((CardNumberL>=993000700000LL) && (CardNumberL<993000800000LL))
						{
							CardNumber+=100000;
							CardNumberL+=100000;
						}
#endif
                        CardInfoStruct CardInfo;
                        if (CashReg->FindCardInRangeTable(&CardInfo,CardNumberL))
                        {
                           if((CardInfo.CardType==CD_CERTIFICATE)
                           || (CardInfo.CardType==CD_PREPAY_CERTIFICATE))
                           {
                               ;;char log_str[100];
                               ;;sprintf(log_str, " = SaleCertificate #%lld was found (nominal=%0.2f)", CardInfo.CardNumber, CardInfo.CardSumma);
                               ;;Log(log_str);
                               if (CardInfo.CardSumma==Who)
                               {
                                    Log(" SUCCESS");
                                    res = CardInfo.CardNumber;
                               }
                               else
                               {
                                    Log(" ERROR (Wrong nominal)");
                                    res = NoPasswd;
                               }
                               break;
                           }
                        }

					}
                    break;
                case Manager:

                    if(Barcode.length()<12)
                        break;//res = NotCorrect;
					if(Barcode.substr(0,3) == SPPPrefix)
						break;//res = NotCorrect;
					if(Barcode.substr(0,3) == ManagerPrefix)
					{
						CardNumber=atoi(Barcode.substr(6,6).c_str());
						// Customer code Int64
						CardNumberL=atoll(Barcode.substr(0,12).c_str());

                       res = CardNumberL;

                       ;;char log_str[100];
                       ;;sprintf(log_str, " Manager #%lld ", res);
                       ;;Log(log_str);

					}else{
                        Log(" ERROR (Wrong Manager barcode)");
                        res = NoPasswd;
					}
                    break;
				case Customer://if card's owner is customer then we have to find his ID
				case Certificate:

					if(Barcode.substr(0,3) == SPPPrefix)
						break;//res = NotCorrect;
					if(Barcode.substr(0,3) == GastronomPrefix)
					{
						CardNumber=atoi(Barcode.substr(3,9).c_str());
						// Customer code Int64
						CardNumberL=atoll(Barcode.substr(0,12).c_str());

#ifdef _OLD_VARIANT_
						if((CardNumberL>=993000700000LL) && (CardNumberL<993000800000LL))
						{
						    Log("Update old card number: "+LLong2Str(CardNumberL));
							CardNumber+=100000;
							CardNumberL+=100000;
							Log("to "+LLong2Str(CardNumberL));
						}
#endif
                        if ((Who != Certificate) && IsCertificate(CardNumberL))
						{
						    ShowMessage("ÕÂ‚ÓÁÏÓÊÌÓ ËÒÔÓÎ¸ÁÓ‚‡Ú¸ ÔÓ‰‡Ó˜ÌÛ˛ Í‡ÚÛ ‚ Í‡˜ÂÒÚ‚Â ‰ËÒÍÓÌÚÌÓÈ !");

                            delete BarcodeCard;
                            BarcodeCard=NULL;

						    res=NoPasswd;
						    return res;
                        }
					}
					else
					{
						CardNumber=atoi(Barcode.substr(6,6).c_str());
                        // Customer code Int64
						CardNumberL=atoll(Barcode.substr(0,12).c_str());
					}
					//CashReg->FindCustomer(&res,CardNumber);
					CashReg->FindCustomer(&res,CardNumberL);

					break;
				default:break;
			}

		}
		else
		{
            if(Who==Manager) res = PressEscape;
            else res=NoPasswd;
		}
	}
	catch(cash_error& er)
	{
		CashReg->DbfMutex->unlock();
		CashReg->LoggingError(er);
	}

	delete BarcodeCard;
	BarcodeCard=NULL;

    //;;Log("[FUNC] CheckBarcode [END]");

//                       ;;char log_str[100];
//                       ;;sprintf(log_str, " Manager_1 #%lld ", res);
//                       ;;Log(log_str);

	return res;
}

bool WorkPlace::CheckGuardCode(int& code)
{
    //;;Log("[FUNC] CheckGuardCode [START]");
	int GuardRes=CheckBarcode(Guard);
	if (GuardRes==NotCorrect)
	{
		ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È Ô‡ÓÎ¸ —œœ");
		return false;
	}
	if (GuardRes==NoPasswd)
		return false;
	code=GuardRes;
	//;;Log("[FUNC] CheckGuardCode [END]");
	return true;
}

long long WorkPlace::ScanBarcode()
{

	long long Res=-1;

	while ((Res==NotCorrect) || (Res==NoPasswd))
	{
        Res = CheckBarcode(Flayer);
	}

	return Res;
}

#include <qapplication.h>
#include <qsemimodal.h>
#include <qevent.h>
#include <qcursor.h>
#include <qstatusbar.h>
#include <qbutton.h>
#include <qvariant.h>
#include <signal.h>


bool WorkPlace::LookingForBarcode(void)
{
    ;;Log("[FUNC] LookingForBarcode [START]");

	QString tmpID;

    QString OrgBarcode= EditLine->text();
    QString CurBarcode= EditLine->text().upper();

    ;;Log("250322 OrgBarcode="+OrgBarcode+" ("+Int2Str(OrgBarcode.length())+")");
    ;;Log("250322 CurBarcode="+CurBarcode+" ("+Int2Str(CurBarcode.length())+")");

	if(PriceChecker!=NULL) CurBarcode=PriceChecker->SearchEdit->text().upper();
	if(FreeSum!=NULL)      CurBarcode=FreeSum->BarcodeEdit->text().upper();

	unsigned int i,k;

	wbarcode=0;

	if(CurBarcode.left(2) == "KG")
	{

        QString KGBarcode= EditLine->text();

        EditLine->clear();

        QString hash = KGBarcode.mid(15);

        bool resCheck=false;

        int pos = hash.find("|", 0);

        if (pos>0) {
            QString DateTimeStr = hash.mid(pos+1);
            hash = hash.left(pos);

            // ÔÓ‚ÂÍ‡ ıÂ¯‡ Í‡Ú˚
           string cardhash;
           if (b64decode((char*)hash.ascii(), &cardhash))
           {

               string comphash = CurBarcode.mid(2,12).ascii();

               if (GetSHA1(comphash+"CARD") == cardhash)
               {
                // ’Â¯ ‚ÂÌ˚È, ÔÓ‚ÂÍ‡ Ì‡ ‡ÍÚÛ‡Î¸ÌÓÒÚ¸ ¯ÚËıÍÓ‰‡
                // œÓ‚ÂÍ‡ ‰‡Ú‡/‚ÂÏˇ
                   string dtcard;
                   if (b64decode((char*)DateTimeStr.ascii(), &dtcard))
                   {

                        // œÓÎÛ˜ËÏ ‰‡ÚÛ Ë ‚ÂÏˇ, ‰Ó ÍÓÚÓÓ„Ó ‰ÂÈÒÚ‚ÛÂÚ Í‡Ú‡
                        long long llres= 0;
                        sscanf((const char*)(dtcard.c_str()), "%lld", &llres);

                        // ƒ‡Ú‡/‚ÂÏˇ ‰ÂÈÒÚ‚Ëˇ Í‡Ú˚
                        QDateTime QDTCard;
                        QDTCard.setTime_t((unsigned int)(llres/1000));
                        ;;Log("¬ÂÏˇ Í‡Ú˚: "+QDTCard.toString());

                        QDateTime QDTCardToCheck = QDTCard.addSecs(2*60*60)
                        ;;Log("¬ÂÏˇ Í‡Ú˚ (+2): "+QDTCardToCheck.toString());

                        // “ÂÍÛ˘ÂÂ ‰‡Ú‡/‚ÂÏˇ
                        QDateTime QDTCurrent = QDateTime::currentDateTime();
                        ;;Log("“ÂÍÛ˘ÂÂ ‚ÂÏˇ: "+QDTCurrent.toString());


                        if (QDTCard>=QDTCurrent)
                        {
                            // ÿÚËıÍÓ‰ ‡ÍÚÛ‡ÎÂÌ, ÔÂÂ‰‡ÂÏ Í‡ÚÛ ‚ ˜ÂÍ
                            CurBarcode = "F"+CurBarcode.mid(2,12);
                            resCheck=true;
                        }
                        else
                        {
                            ShowMessage("—ÓÍ ‰ÂÈÒÚ‚Ëˇ ¯ÚËıÍÓ‰‡ ËÒÚÂÍ!");
                            Log("—ÓÍ ‰ÂÈÒÚ‚Ëˇ ¯ÚËıÍÓ‰‡ ËÒÚÂÍ!");
                        }
                   }
                   else
                   {
                        ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÙÓÏ‡Ú ¯ÚËıÍÓ‰‡!");
                        Log("Œ¯Ë·Í‡ ‡Ò¯ËÙÓ‚ÍË ‰‡Ú˚ ‰ÂÈÒÚ‚Ëˇ!");
                   }
               }
               else
               {
                    ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÙÓÏ‡Ú ¯ÚËıÍÓ‰‡!");
                    Log("ÕÂÔ‡‚ËÎ¸Ì˚È ıÂ¯ Í‡Ú˚!");
               }
           }
           else
           {
               ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÙÓÏ‡Ú ¯ÚËıÍÓ‰‡!");
               Log("Œ¯Ë·Í‡ ˜ÚÂÌËˇ ıÂ¯‡ Í‡Ú˚");
           }
        }
        else
        {
           ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÙÓÏ‡Ú ¯ÚËıÍÓ‰‡!");
           Log("ÌÂ Ì‡È‰ÂÌ‡ ÔÓÁËˆËˇ |");
        }

        if (!resCheck)
        {
            return false;
        }

	}
///œÂ‰˜ÂÍ
	if(CurBarcode.left(2) == "PC")
	{
		IsCurrentGoodsEmpty = true;
		if(!ShowQuestion(string("œÂ˜ÂÍ ")+CurBarcode.mid(2).ascii(),true))
			return false;
		QSemiModal sm(NULL,NULL,true,Qt::WStyle_NoBorderEx);
		QLabel msg(&sm);//, NULL, Qt::WType_TopLevel);
		sm.setFixedSize(250,100);
		msg.setFixedSize(250,100);
		msg.setAlignment( QLabel::AlignCenter );
		msg.setText(W2U("œÓËÒÍ ÔÂ˜ÂÍ‡..."));
		sm.show();
		//thisApp->processEvents();

		int NumPrecheck = CurBarcode.mid(2).toInt(NULL);

		bool ret = CashReg->SQLServer->GetPreCheck(NumPrecheck, Cheque, CurrentCustomer);
		if(!ret)
		{
			EditLine->clear();
		}
		UpdateList();
		return ret;
	}


	CurGoods.InputType = FindInDB?IN_DBRSCAN:HandBarcode?IN_RSCAN:IN_SCAN;

    ;;Log("[FUNC] LookingForBarcode [1]");
	
#ifndef PIVO_BOTTLE
    ;;Log("[DEBUG] CurBarcode.length=" + Int2Str(CurBarcode.length()));
#endif

#ifdef BIODOBAVKA
    ;;Log("[DEBUG] CurBarcode.length=" + Int2Str(CurBarcode.length()));
#endif
	
//;;Log("Barcodefilter=" + Int2Str(BarcodeFilter));
    if (CurBarcode.length() == 29)
    {
        // DataMatrix cigarette
		Log("DataMatrix Cigarette");
        return LookingForGoods(BarcodeFilter);//find by barcode
    }
		else if ((CurBarcode.length()==30) || (CurBarcode.length()==37) || (CurBarcode.length() == 32))
    {
	
///d.gusakov
	Log("DataMatrix milk or water");
///d.gusakov
		
        MilkActsiz = OrgBarcode.local8Bit();
        return LookingForGoods(BarcodeFilter);//find by barcode
    }

#ifdef ALCO_VES
        else if (CurBarcode.length()==44)
        {
            Log("œË‚Ó ‡ÁÎË‚ ‚ıÓ‰");
            AlcoVesActsiz = OrgBarcode.local8Bit();
            return LookingForGoods(BarcodeFilter);
        }
#endif

#ifdef BLOCK_CIGAR
    else if ((CurBarcode.length()==52) ||(CurBarcode.length()==41) || (CurBarcode.length()==55) )
    {
        Log("¡ÎÓÍ ÒË„‡ÂÚ ‚ıÓ‰");
        BlockCigarActsiz = OrgBarcode.local8Bit();
        return LookingForGoods(BarcodeFilter);
    }
#endif

#ifdef PIVO_BOTTLE
    else if ( (CurBarcode.length()==31))
    {
        Log("œË‚Ó ‚ ·ÛÚ˚ÎÍÂ ËÎË ·‡ÌÍÂ");
        MilkActsiz = OrgBarcode.local8Bit();
        return LookingForGoods(BarcodeFilter);
    }
#endif

#ifdef BIODOBAVKA
    else if ( (CurBarcode.length()==83) )
    {
        Log("¡ËÓ‰Ó·‡‚Í‡");
        MilkActsiz = OrgBarcode.local8Bit();
        return LookingForGoods(BarcodeFilter);
    }
#endif

    /* slair+ */
    string GS1DM_barcode = "";
    MilkActsiz = "";

#ifdef ALCO_VES
    AlcoVesActsiz = "";
#endif

#ifdef BLOCK_CIGAR
    BlockCigarActsiz = "";
#endif

    if (OrgBarcode.left(3) == "010")
    { // GS1-DataMatrix ÏÓÎÓ˜Í‡
        ;;Log("250322 OrgBarcode="+OrgBarcode+" Ï‡ÍËÓ‚Í‡ "+Int2Str(OrgBarcode.length()));
        GS1DM_barcode = OrgBarcode.mid(3, 13).local8Bit();
        CurBarcode = OrgBarcode.mid(3, 13).local8Bit();
        ;;Log("250322 GS1DM_barcode="+GS1DM_barcode);

        // ÏÓÎÓ˜Ì˚È ‡ÍˆËÁ
        if ((OrgBarcode.length()==30) || (OrgBarcode.length()==32) || (OrgBarcode.length()==37) || (OrgBarcode.length()==44)) {
           // ƒÓ·‡‚ÎˇÂÏ ÒÔÂˆÒËÏ‚ÓÎ
           ;;Log("Origin Actsiz DataMatrix="+OrgBarcode);
           char spec = 0x1D;
//           MilkActsiz = OrgBarcode.mid(0, 24).local8Bit() + spec + OrgBarcode.mid(24, 6).local8Bit();
           MilkActsiz = OrgBarcode.local8Bit();
           ;;Log("250322 MilkActsiz="+MilkActsiz+" Á‡ÔÓÏÌËÎË");
        }

#ifdef BLOCK_CIGAR
        if (OrgBarcode.length()==52 || OrgBarcode.length()==41 || OrgBarcode.length()==55 )
        {
            // ƒÓ·‡‚ÎˇÂÏ ÒÔÂˆÒËÏ‚ÓÎ
            ;;Log("Origin Actsiz DataMatrix="+OrgBarcode);
            char spec = 0x1D;
            BlockCigarActsiz = OrgBarcode.local8Bit();
            ;;Log("250322 MilkActsiz="+BlockCigarActsiz+" Á‡ÔÓÏÌËÎË");
        }
#endif

    }
	
    if (CurBarcode.left(4) == "F010")
    { // GS1-DataBar ‚ÂÒÓ‚ÓÈ ÚÓ‚‡
        ;;Log("230322 CurBarcode="+CurBarcode+" ‚ÂÒÓ‚ÓÈ "+Int2Str(CurBarcode.length()));
//        ShowMessage("¬ÂÒÓ‚ÓÈ ÚÓ‚‡");

        int GS1DB_weight;
        string GS1DB_barcode;
        int GS1DB_code;

        bool bad_barcode = false;

//        ShowMessage("CurBarcode.mid(2, 2)=="+CurBarcode.mid(2, 2));
//        if (CurBarcode.mid(2, 2) != "01") {
//            bad_barcode = false;
//        }
//        ShowMessage("CurBarcode.mid(4+13, 4)=="+CurBarcode.mid(4+13, 4));

        if (CurBarcode.mid(4+13, 4) != "3103") {
            

			bad_barcode = true;
        }

        if (! bad_barcode) {
            GS1DB_barcode = CurBarcode.mid(4, 13).ascii();
            GS1DB_weight = CurBarcode.mid(4+13+4, 6).toInt();

            bool loc=CashReg->GoodsTable->Locate("BARCODE", GS1DB_barcode.c_str());
            if (!loc) {
                ShowMessage("ÿÚËı ÍÓ‰ " + GS1DB_barcode + " ÌÂ Ì‡È‰ÂÌ ‚ ·‡ÁÂ ÚÓ‚‡Ó‚!");
    //            ;;Log("ÿÚËıÍÓ‰ " + GS1DB_barcode + " ÌÂ Ì‡È‰ÂÌ ‚ ·‡ÁÂ ÚÓ‚‡Ó‚!");
                return false; // fixme: ÌÂ Á‡·Û‰¸ ‚ÍÎ˛˜ËÚ¸, ˜ÚÓ·˚ ÌÂ ·˚ÎÓ ÔÓ‰ÏÂÌ˚ ÚÓ‚‡‡
//                GS1DB_code = 121548;   // fixme: find CODE by BARCODE
            } else {
                GS1DB_code = CashReg->GoodsTable->GetLongField("CODE");
                loc = true;
            }
			
            ;;Log((char* )(
                      " >> ¬ÂÒÓ‚ÓÈ ÚÓ‚‡. œÂÙËÍÒ: 010 ÿÚËıÍÓ‰: " + GS1DB_barcode
                      + "  Ó‰: " + Int2Str(GS1DB_code)
                      + " ¬ÂÒ: " + Int2Str(GS1DB_weight)
                      ).c_str());

            if (GS1DB_weight<=0) {
                ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓÂ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡!");
                return false;
            }
            try {
                if(!Cheque->GetSize())
                    CashReg->GetNewGoods();

                if (CashReg->IsInload()) {
                    ShowMessage("—ÔËÒÓÍ ÚÓ‚‡Ó‚ ÌÂ‰ÓÒÚÛÔÂÌ!\n"
                                "ƒÓÊ‰ËÚÂÒ¸ ÓÍÓÌ˜‡ÌËˇ Á‡„ÛÁÍË ÚÓ‚‡Ó‚ Ë\n"
                                "—˜ËÚ‡ÈÚÂ ¯ÚËıÍÓ‰ Â˘Â ‡Á!");
                    return false;
                }

    //            loc=CashReg->GoodsTable->Locate("BARCODE", GS1DB_barcode.c_str());
                string gtype;
                loc = CashReg->FindGoodsByCode(GS1DB_code);
                if (loc) {
                    gtype = CashReg->GoodsTable->GetStringField("GTYPE");
                    ;;Log("TOKAS->GTYPE==" + gtype);
                    if (gtype!="F") {
                        ;;Log("CurGoods:: ¿ ‚ ·‡ÁÂ Û Ì‡Ò ÓÌ ÌÂ ‚ÂÒÓ‚ÓÈ. œ˚Ú‡ÂÏÒˇ ËÒÔ‡‚ËÚ¸.");
                        CurGoods.ItemCount = 1;
                    } else { // if (gtype!="F") Ú‡ÍË ‚ÂÒÓ‚ÓÈ
                        CurGoods.ItemCount = GS1DB_weight*0.001;
                    }
                } else {
                    ShowMessage("“Ó‚‡ ÌÂ Ì‡È‰ÂÌ!");
                    return false;
                }


                if ((loc)&&(AddGoods(GS1DB_code))) {
                    CurrentGoods->ItemBarcode = U2W(CurBarcode);
                    if (gtype!="F") {
                        ;;Log("CurrentGoods:: ¿ ‚ ·‡ÁÂ Û Ì‡Ò ÓÌ ÌÂ ‚ÂÒÓ‚ÓÈ. œ˚Ú‡ÂÏÒˇ ËÒÔ‡‚ËÚ¸.");
                        CurrentGoods->ItemCount = 1;
                    } else { // if (gtype!="F") Ú‡ÍË ‚ÂÒÓ‚ÓÈ
                        CurrentGoods->ItemCount=RoundToNearest(
                            GS1DB_weight*0.001,CurrentGoods->ItemPrecision);
                    }
                    CalcCountPrice();
                    CurrentGoods->CalcSum();
                            
							ShowGoodsInfo();

                    CashReg->LogAddGoods(CurrentGoods);

                    if(CurrentGoods->ItemCount < CurrentGoods->ItemPrecision) {
                        ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓÂ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡");
//                        return false;
                    }

                    if((PriceChecker==NULL)&&(FreeSum==NULL)) {
                        QListViewItem *item = ChequeList->firstChild();
                        if(item)
                            while(item->itemBelow())
                                item = item->itemBelow();
                        if(item) {
                            item->setText(ListNo,Int2Str(Cheque->GetSize()).c_str());
                            item->setText(ListCode,Int2Str(CurrentGoods->ItemCode).c_str());
                                item->setText(ListName,W2U(CurrentGoods->ItemName));
                            item->setText(ListPrice,GetRounded(CurrentGoods->ItemPrice,0.01).c_str());
                            item->setText(ListCount,GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
                                item->setText(ListSum,GetRounded(CurrentGoods->ItemSum,0.01).c_str());
                            item->setText(ListDscnt,GetRounded(CurrentGoods->ItemCalcSum-CurrentGoods->ItemSum,0.01).c_str());
                        }
                    }
                    return true;
                } else {
                    ShowMessage("“Ó‚‡ ÌÂ Ì‡È‰ÂÌ!");
                    return false;
                }
            } // try {
            catch(cash_error& er) {
                CashReg->DbfMutex->unlock();
                CashReg->LoggingError(er);
                return false;
            } // catch(cash_error& er) {
        } // if (! bad_barcode) {
    }
    else if (CurBarcode.left(4) == "F011")
    { // GS1-DataBar ¯ÚÛ˜Ì˚È ÚÓ‚‡
        ;;Log("230322 CurBarcode="+CurBarcode+" ¯ÚÛ˜Ì˚È");
//        ShowMessage("ÿÚÛ˜Ì˚È ÚÓ‚‡");
//        return false;
    } // GS1-DataBar ¯ÚÛ˜Ì˚È ÚÓ‚‡
    /* slair- */

	for (i=0;i<BarcodeID.size();i++)
	//for (i=BarcodeID.size()-1;i>=0;i--)
	{

        tmpID=W2U(BarcodeID[i]->CodeID);//first of all we have to find barcode prefix
///d.gusakov
		//;;Log(BarcodeID[i]->CodeID + " "+BarcodeID[i]->CodeName+" === "+CurBarcode.ascii());
		//Log("Test1=" + CurBarcode.left(tmpID.length()));
        //Log("Test2=" + tmpID);
///d.gusakov
		if (CurBarcode.left(tmpID.length())==tmpID)
		{
	
			Log("Test=" + CurBarcode);
			
            long long CardNumberL;
			QString TempBarcode = CurBarcode;
            // ÍÓ‰ Í‡Ú˚ Int64 (8 ·‡ÈÚ)
			CardNumberL = atoll(U2W(CurBarcode).substr(1,12).c_str());

			CurBarcode.remove(0,tmpID.length());

			if(PriceChecker!=NULL) PriceChecker->SearchEdit->setText(CurBarcode);
			else if (FreeSum!=NULL) FreeSum->BarcodeEdit->setText(CurBarcode);
                 else EditLine->setText(CurBarcode);


            if (BarcodeID[i]->CodeName=="EMPLOYEE")
            {
                ;;Log((char*)(" <!> "+U2W(TempBarcode)).c_str());
                if ((!IsCurrentGoodsEmpty)
                &&(
                    (CurrentGoods->ItemSecondBarcode.empty())
                    || (W2U(CurrentGoods->ItemSecondBarcode).left(tmpID.length())==tmpID)
                 )
                )
                {
                   TempBarcode.remove(0,1);
                   CurrentGoods->ItemSecondBarcode = U2W(TempBarcode);

                   CashReg->LogEditGoods(CurrentGoods);
                }
                EditLine->clear();
                //UpdateList();
                ShowGoodsInfo();
                return true;
            }

			if (((BarcodeID[i]->CodeName=="DISCOUNTCARD") || (BarcodeID[i]->CodeName=="GASTRONOMCARD")) && (PriceChecker==NULL))
			{
				EditLine->setText("");

			    if(FreeSum!=NULL)
			    {
			        FreeSum->BarcodeEdit->setText("");
			        ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ¯ÚËı-ÍÓ‰ ÚÓ‚‡‡!");

			        return false;
			    }

				int CardNumber;

				CardNumber = atoi(U2W(CurBarcode).substr(0,9).c_str());
				if((BarcodeID[i]->CodeName=="GASTRONOMCARD"))
				{
#ifdef _OLD_VARIANT_

// test, find error customers range (9930008...)
					//if((CardNumber>=800000) && (CardNumber<900000))
					//{
                        //;;cash_error* _err = new cash_error(11,0, LLong2Str(CardNumberL));
                        //;;CashReg->LoggingError(*_err);
                        //;;delete _err;
					//}

					if((CardNumberL>=993000700000LL) && (CardNumberL<993000800000LL))
					{
						CardNumber+=100000;
						CardNumberL+=100000; //  Ó‰ Í‡Ú˚ Int64
					}
#endif

#ifndef CERTIFICATES
                    Log("-------------------------------------------------");
                    Log("ÕÓÏÂ ÒÂÚËÙËÍ‡Ú‡=" + Int2Str(IsCertificate(CardNumberL)));
                    Log("---------------------------------------------------");
#endif

					//Á‡ÔÂ˘‡ÂÏ ËÒÔÓÎ¸ÁÓ‚‡Ú¸ ÒÂÚËÙËÍ‡Ú Í‡Í ‰ËÒÍÓÌÚÌÛ˛ Í‡ÚÛ
                if(IsCertificate(CardNumberL))
//					(
//						(CardNumber>=810000) && (CardNumber<=810099)
//						||
//						(CardNumber>=811000) && (CardNumber<=811099)
//						||
//						(CardNumber>=812000) && (CardNumber<=812049)
//						||
//						(CardNumber>=813000) && (CardNumber<=813049)
//					)
					{
                        //bool loc=CashReg->FindGoodsByCode(tempCode);

						ShowMessage("ÕÂ‚ÓÁÏÓÊÌÓ ËÒÔÓÎ¸ÁÓ‚‡Ú¸ ÔÓ‰‡Ó˜ÌÛ˛ Í‡ÚÛ ‚ Í‡˜ÂÒÚ‚Â ‰ËÒÍÓÌÚÌÓÈ !");
						return false;
                    }

				}

				string discount;
//				if (SearchDiscount(FindFromScaner,&discount,&CardNumber)==1)
				if (SearchDiscount(FindFromScaner,&discount,&CardNumberL)==1)
				{
					CurrentCustomer=0;
					NeedCert=0;

					CashReg->DbfMutex->lock();
					DiscountType = (CashReg->CustomersTable->Locate("ID",0)) ? CashReg->CustomersTable->GetField("DISCOUNTS") : DefaultDiscountType;
					CashReg->DbfMutex->unlock();
				}

				ShowGoodsInfo();
				return true;
			}

			if (BarcodeID[i]->CodeName=="EAN13")
			{ //if it is EAN13 then one checks weight prefix

				for (k=0;k<WeightPrefices.size();k++)
				{
					if ((CurBarcode.left(2).toInt()!=WeightPrefices[k])||(WeightPrefices[k]==0))
						continue;

					int CurWeight,tempCode;//decode weigth barcode and find a goods
					tempCode=CurBarcode.mid(2,W_Code_Length).toInt(NULL);
					if (tempCode<=0)
					{

						ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÍÓ‰ ÚÓ‚‡‡!");
						return false;
					}



					CurWeight=CurBarcode.mid(2+W_Code_Length,10-W_Code_Length).toInt(NULL);
					;;Log((char*)(" >> ¬ÂÒÓ‚ÓÈ ÚÓ‚‡. œÂÙËÍÒ: "+Int2Str(WeightPrefices[k])+"  Ó‰: "+Int2Str(tempCode)+" ¬ÂÒ: "+Int2Str(CurWeight)).c_str());

					if (CurWeight<=0 )
					{
						
						ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓÂ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡!");
						return false;
					}

					try
					{
						if(!Cheque->GetSize())
							CashReg->GetNewGoods();

                        // + dms ==== 2019-09-03 ===== ∆‰ÂÏ Á‡„ÛÁÍË ÚÓ‚‡Ó‚ =====
                        if (CashReg->IsInload()){
                            ShowMessage("—ÔËÒÓÍ ÚÓ‚‡Ó‚ ÌÂ‰ÓÒÚÛÔÂÌ!\nƒÓÊ‰ËÚÂÒ¸ ÓÍÓÌ˜‡ÌËˇ Á‡„ÛÁÍË ÚÓ‚‡Ó‚ Ë\n—˜ËÚ‡ÈÚÂ ¯ÚËıÍÓ‰ Â˘Â ‡Á!");
                            return false;
                        }
                        //WaitForLoadGoods();
                        // - dms ==== 2019-09-03 =====

						bool loc=CashReg->FindGoodsByCode(tempCode);

						CurGoods.ItemCount = CurWeight*0.001;

						if ((loc)&&(AddGoods(tempCode)))
						{
					
                            CurrentGoods->ItemBarcode = U2W(CurBarcode);
							CurrentGoods->ItemCount=RoundToNearest(
								CurWeight*0.001,CurrentGoods->ItemPrecision);					
								
							CalcCountPrice();
							CurrentGoods->CalcSum();

						ShowGoodsInfo();
	

							CashReg->LogAddGoods(CurrentGoods);

							if(CurrentGoods->ItemCount < CurrentGoods->ItemPrecision)
							{
								
								
								ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓÂ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡");
							}

							if((PriceChecker==NULL)&&(FreeSum==NULL))
							{
								QListViewItem *item = ChequeList->firstChild();
								if(item)
									while(item->itemBelow())
										item = item->itemBelow();
								if(item)
								{
									item->setText(ListNo,Int2Str(Cheque->GetSize()).c_str());
									item->setText(ListCode,Int2Str(CurrentGoods->ItemCode).c_str());
		    							item->setText(ListName,W2U(CurrentGoods->ItemName));
									item->setText(ListPrice,GetRounded(CurrentGoods->ItemPrice,0.01).c_str());
									item->setText(ListCount,GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
					    				item->setText(ListSum,GetRounded(CurrentGoods->ItemSum,0.01).c_str());
									item->setText(ListDscnt,GetRounded(CurrentGoods->ItemCalcSum-CurrentGoods->ItemSum,0.01).c_str());
								}
							}

							return true;
						}
						else
						{
							ShowMessage("“Ó‚‡ ÌÂ Ì‡È‰ÂÌ!");
							return false;
						}
					}
					catch(cash_error& er)
					{
						CashReg->DbfMutex->unlock();
						CashReg->LoggingError(er);
						return false;
					}
				}
            }
			
			return LookingForGoods(BarcodeFilter);//find by barcode
		}
//        ;;Log("230322 i=="+Int2Str(i));
//        ;;Log("230322 BarcodeID[i]->CodeName=="+BarcodeID[i]->CodeName);
//        ;;Log("230322 BarcodeID[i]->CodeID=="+BarcodeID[i]->CodeID);
    }
	ShowMessage("ŒÚÒÛÚÒÚ‚ÛÂÚ ËÌÙÓÏ‡ˆËˇ Ó ÚËÔÂ ¯ÚËı-ÍÓ‰‡");
	return false;
}

double WorkPlace::GetDoubleNum(bool* err)//auxililary function
{
	QString GoodsPrice=EditLine->text();
	for (unsigned int i=0;i<GoodsPrice.length();i++)
		if (GoodsPrice.at(i)==',')
			GoodsPrice=GoodsPrice.replace(i,1,".");

	return GoodsPrice.toDouble(err);
}

bool WorkPlace::LookingForGoods
(
	 int Tag
	,QString GoodsCode
	,QString GoodsBarcode
	,QString GoodsName
	,QString GoodsPrice
	,bool LookInsideStatus
)
//in accordance with filter looking for barcode
{
    ;;Log("[FUNC] LookingForGoods [START]");
    if(!Cheque->GetSize()){
///d.gusakov
Log("GetNewGoods====STEP1====TEST");
///d.gusakov
		CashReg->GetNewGoods();
}

#ifdef ALCO_VES
    string testStringAlcoVes=EditLine->text();
#endif

#ifdef BLOCK_CIGAR
    string testString=EditLine->text();
///TestStroka	
//	testString=testString.substr(3,13);
//	Log("testString=" + testString);
///TestStroka
#endif

	QString QBarcode = EditLine->text();
	
#ifdef PIVO_BOTTLE
    ;;Log("QBarcode Test=" + QBarcode);
#endif
	
/*Log("QBarCode=" + QBarcode);
QBarcode = testString;
Log("QBarcode obrabotka=" + QBarcode);
*/	
	if (PriceChecker!=NULL) QBarcode = PriceChecker->SearchEdit->text();
	if (FreeSum!=NULL) QBarcode = FreeSum->BarcodeEdit->text();

    // + dms ==== 2019-09-03 ===== ∆‰ÂÏ Á‡„ÛÁÍË ÚÓ‚‡Ó‚ =====
    if (CashReg->IsInload()){
        ShowMessage("—ÔËÒÓÍ ÚÓ‚‡Ó‚ ÌÂ‰ÓÒÚÛÔÂÌ!\nƒÓÊ‰ËÚÂÒ¸ ÓÍÓÌ˜‡ÌËˇ Á‡„ÛÁÍË ÚÓ‚‡Ó‚ Ë\n—˜ËÚ‡ÈÚÂ ¯ÚËıÍÓ‰ Â˘Â ‡Á!");
//        return false;
    }
    //WaitForLoadGoods();
    // - dms ==== 2019-09-03 =====

	int res=-1;

	if (FindInDB)
	{  // Ë˘ÂÏ ‚ ¡ƒ Ì‡ ÒÂ‚ÂÂ
        ;;Log("[FUNC] LookingForGoods [FindInDB]");
        res = CashReg->LookingForGoodsDB(
                Tag
                ,U2W(QBarcode)
                ,&CurGoods
                ,((PriceChecker==NULL)&&(FreeSum==NULL))
                ,GoodsCode
                ,GoodsBarcode
                ,GoodsName
                ,GoodsPrice
                ,LookInsideStatus);

	}
	else
	{   // Ë˘ÂÏ ‚ dbf Ì‡ Í‡ÒÒÂ
        ;;Log("[FUNC] LookingForGoods [Find In Local DBF]");
	    res = CashReg->LookingForGoods(
			Tag
			,U2W(QBarcode)
			,&CurGoods
			,((PriceChecker==NULL)&&(FreeSum==NULL))
			,GoodsCode
			,GoodsBarcode
			,GoodsName
			,GoodsPrice
			,LookInsideStatus);
    }
#ifndef ZAPRET_ALCO
    QString strDate="";
    strDate=QDateTime::currentDateTime().toString("dd.MM");
    if (strDate == "16.06") res=101;
    Log("Date=" + strDate);

#endif


//;;Log("[FUNC] LookingForGoods [res]");
//Log("res=" + Int2Str(res));
	
	switch (res)
	{
		case 0:
			{
		try
		{

		    int Avans = 0;

            long long CertNumber = 0;
		    int cardbarcode = GetCertNominal(CurGoods.ItemBarcode);

		    if ((cardbarcode == CD_CERT100)
                || (cardbarcode == CD_CERT250)
                || (cardbarcode == CD_CERT500)
                || (cardbarcode == CD_CERT1000)
                || (cardbarcode == CD_CERT1500)
                || (cardbarcode == CD_CERT2000)
                || (cardbarcode == CD_CERT3000)
                || (cardbarcode == CD_CERT5000)
                )
            { // ÔÓ‰‡Ê‡ ÒÂÚËÙËÍ‡ÚÓ‚
              CertNumber = CheckBarcode(cardbarcode, "œÓ‰‡Ê‡ ÔÓ‰‡Ó˜ÌÓÈ Í‡Ú˚ ("+CurGoods.ItemBarcode+")!\n\n¬‚Â‰ËÚÂ ÌÓÏÂ ÒÂÚËÙËÍ‡Ú‡:");
              if (CertNumber==NotCorrect)
                {
                    ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÌÓÏÂ ÒÂÚËÙËÍ‡Ú‡!");
                    return false;
                }

              if (CertNumber==NoPasswd)
                {
                    ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÕŒÃ»Õ¿À ÒÂÚËÙËÍ‡Ú‡!");
                    return false;
                }

            // + dms ==== 2020-09-23 =====  Avans
                CardInfoStruct CardInfo;
                if (CashReg->FindCardInRangeTable(&CardInfo, CertNumber))
                {
                    if ( CardInfo.CardType == CD_PREPAY_CERTIFICATE)
                    {
                        Avans = 1;
                    }
                }
            // - dms ==== 2020-09-23 =====  Avans

            }

            string strLock = CurGoods.Lock;
		    if (CashReg->GoodsLock(strLock, GL_Manager) == GL_Manager)
            { // ÔÓ‰‡Ê‡ Ò Á‡ÔÓÒÓÏ ÿ  ÏÂÌÂ‰ÊÂ‡

              CertNumber = NotCorrect;
              do{
                CertNumber = CheckBarcode(Manager, "œÓ‰‡Ê‡ ÚÓ‚‡‡ Ò ÍÓ‰ÓÏ ÏÂÌÂ‰ÊÂ‡ \n\n"+Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName+"\n\n¬‚Â‰ËÚÂ ÿ  ÏÂÌÂ‰ÊÂ‡!");
//                if ((CertNumber==NotCorrect) || (CertNumber==NoPasswd))
//                {
//                    ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ¯ÚËıÍÓ‰ ÏÂÌÂ‰ÊÂ‡!");
//                }

                  ;;Log("CertNumber="+LLong2Str(CertNumber));

                  if (CertNumber==PressEscape) {
                      ;;Log("ŒÚÏÂÌ‡ ‚‚Ó‰‡ ÿ  ÏÂÌÂ‰ÊÂ‡");
                      return false;
                  }

              }
              while ((CertNumber==NotCorrect) || (CertNumber==NoPasswd));
            }

            string resCheckSugar = "";
			if(CheckSugar(&resCheckSugar, CurGoods.ItemCode, CurGoods.ItemCount))
			{
                bool oldscanersuspend = Scanner->suspend;
                Scanner->suspend = true;
			    ShowMessage("“Œ¬¿– Õ≈ ƒŒ¡¿¬À≈Õ\n\n"+resCheckSugar);
			    Scanner->suspend = oldscanersuspend;
			    return false;
            }

            // + EGAIS
            int TextileCnt = 0;
            int MilkCnt = 0;
            int CigarCnt = 0;

#ifdef ALCO_VES
            int PivoRazlivCnt = 0;
#endif

            int AlcoCnt = 0;
            string ActsizBarcode = "";
            strLock = CurGoods.Lock;

            vector<string> ListActsizBarcodes;

// ¬ÓÁÏÓÊÌÓÒÚ¸ ÓÚ·ËÚËˇ ·ÂÁ ‡ÍˆËÁ‡ ‚‚Ó‰ËÎ‡Ò¸ Ì‡ ÔÂÂıÓ‰Ì˚È ÔÂËÓ‰
// —ÂÈ˜‡Ò ‚ÒÂ ‡ÎÍÓ-ÚÓ‚‡˚ ÔÓıÓ‰ˇÚ ÔÓ ≈√¿»— ÒÓ Ò˜ËÚ˚‚‡ÂÏ ‡ÍˆËÁ‡
// œÓ‚ÂÍÛ ÓÚÍÎ˛˜‡˛
//            if (CashReg->EgaisSettings.ModePrintQRCode>-1)
            {
                if (CashReg->GoodsLock(strLock, GL_AlcoEGAIS) == GL_AlcoEGAIS)
                { // œÓ‰‡Ê‡ ‡ÎÍÓ„ÓÎ¸ÌÓÈ ÔÓ‰ÛÍˆËË

                    int errAct=0;
                    AlcoCnt = (CurGoods.ItemAlco>0)?CurGoods.ItemAlco:1;

                    for (int j=0;j<AlcoCnt;j++)
                    {
                      errAct=0;

                      ActsizBarcode = "";

                      errAct = CashReg->CheckActsizBarcode(&ActsizBarcode, "œÓÁËˆËˇ # "+Int2Str(j+1)+" ËÁ "+Int2Str(AlcoCnt)+" \n\n"+ Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque, ListActsizBarcodes);

                      if (errAct) return false;

                      ListActsizBarcodes.insert(ListActsizBarcodes.end(), ActsizBarcode);

                    }

                    //int errAct = CashReg->CheckActsizBarcode(&ActsizBarcode, Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque);
                    //
                }
                else

#ifdef ALCO_VES
                    //–‡ÁÎË‚ÌÓÂ ÔË‚Ó
                            //if (QBarcode.length()==44)
                    if (CashReg->GoodsLock(strLock, GL_BeerEGAIS) == GL_BeerEGAIS)
                    {
						
						 Log("TestPIVOPIVOPIVO");
						
                        ActsizBarcode = "";

                        Scanner->allsymbols = true;
                        int errAct = CashReg->CheckActsizBarcodeDataMatrix(&ActsizBarcode, "œÓÁËˆËˇ # 1 ËÁ 1 \n\n"+ Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque, ListActsizBarcodes, AT_PIVO_RAZLIV);
                        Scanner->allsymbols = false;

                        if (errAct) return false;

                        ListActsizBarcodes.insert(ListActsizBarcodes.end(), ActsizBarcode);

                        PivoRazlivCnt = 1;
					}

                    else

#endif


                // + CIGAR
                // “‡·‡˜Ì‡ˇ ÔÓ‰ÛÍˆËˇ
                    if (CashReg->GoodsLock(strLock, GL_CigarEGAIS) == GL_CigarEGAIS)
                    {
                        CigarCnt = 1;
											
                        if ((QBarcode.length()==29) || (QBarcode.length()==52) ||
                                (QBarcode.length()==41) || (QBarcode.length()==55)){

                            int errAct = CashReg->CheckCigarBarcode(U2W(QBarcode), Cheque);
                            if (errAct) return false;
							
							;;Log("CigarActsiz=" + QBarcode);
							
                            QBarcode = testString;
                            ListActsizBarcodes.insert(ListActsizBarcodes.end(), U2W(QBarcode));

							
#ifdef BLOCK_CIGAR
                            if (QBarcode.length()==52)
                            {
                               char spec = 0x1D;

                               testString=testString.substr(0,25)+spec+
                                       testString.substr(25,10)+spec+
                                       testString.substr(35,6)+spec+
                                       testString.substr(41,11);
                               QBarcode = testString;
                               ListActsizBarcodes.insert(ListActsizBarcodes.end(), U2W(QBarcode));

                            }

                            else if (QBarcode.length()==41)
                            {
                                char spec = 0x1D;
                                testString=testString.substr(0,25)+spec+
                                    testString.substr(25,10)+spec+
                                    testString.substr(35,6);
                                QBarcode = testString;
                                ListActsizBarcodes.insert(ListActsizBarcodes.end(), U2W(QBarcode));
                            }

                            else if(QBarcode.length()==55)
                            {
                                char spec = 0x1D;
                                testString=testString.substr(0,25)+spec+
                                    testString.substr(25,10)+spec+
                                    testString.substr(35,6)+spec+
                                    testString.substr(41,14);
                                QBarcode = testString;
                                ListActsizBarcodes.insert(ListActsizBarcodes.end(), U2W(QBarcode));
                            }
#endif

                        } else {
                            if (CashReg->GoodsLock(strLock, GL_CigarLock) == GL_CigarLock)
                            {
                                // — 2020-07-01 ƒÂÈÒÚ‚ÛÂÚ «‡ÔÂÚ ÔÓ‰‡ÊË ÒË„‡ÂÚ ·ÂÁ ‡ÍˆËÁ‡
                                // ŒÒÚ‡Î¸Ì‡ˇ Ú‡·‡˜Ì‡ˇ ÔÓ‰ÛÍˆËˇ Ò 2021-07-01 (˜ÂÂÁ „Ó‰)
                                return false;
                            }
                        }

#ifdef BLOCK_CIGAR
                        // œÓ‚ÂÍ‡ Ì‡ ÔÓ‚ÚÓ
                        bool isOk=true;
                        if (isOk)
                        {
                            FiscalCheque* CurCheque = Cheque;
                            if (!CurCheque)
                            {
                                return -1;
                            }
                            for (int i=0;i<CurCheque->GetCount();i++)
                            {
                                 GoodsInfo g=(*CurCheque)[i];

                                 if ((g.ItemFlag==SL) || (g.ItemFlag==RT))
                                 {
                                     for (int j=0;j<g.Actsiz.size();j++)
                                        if(testString==g.Actsiz[j])
                                        {
                                            isOk=false;
                                            break;
                                        }
                                 }
                                  if (!isOk)
                                  {
                                          break;
                                  }
                            }
                        }

                        if (isOk)
                        {

                        }
                        else
                        {
                            EditLine->clear();
                            return false;
                        }


#endif

                    }
                    else
                    {
                        // — 2021-01-01 ƒÂÈÒÚ‚ÛÂÚ «‡ÔÂÚ ÔÓ‰‡ÊË ÚÓ‚‡Ó‚ ÎÂ„ÍÓÈ ÔÓÏ˚¯ÎÂÌÌÓÒÚË ·ÂÁ ‡ÍˆËÁ‡

                        if (CashReg->GoodsLock(strLock, GL_TextileEGAIS) == GL_TextileEGAIS)
                        {

                              ActsizBarcode = "";

                              Scanner->allsymbols = true;
                              int errAct = CashReg->CheckActsizBarcodeDataMatrix(&ActsizBarcode, "œÓÁËˆËˇ # 1 ËÁ 1 \n\n"+ Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName, Cheque, ListActsizBarcodes, AT_TEXTILE);
                              Scanner->allsymbols = false;

                              if (errAct) return false;

                              ListActsizBarcodes.insert(ListActsizBarcodes.end(), ActsizBarcode);

                              TextileCnt = 1;

                        }
                        else
                        {

                            // — 2021-01-01 ƒÂÈÒÚ‚ÛÂÚ «‡ÔÂÚ ÔÓ‰‡ÊË ÚÓ‚‡Ó‚ ÎÂ„ÍÓÈ ÔÓÏ˚¯ÎÂÌÌÓÒÚË ·ÂÁ ‡ÍˆËÁ‡

                            if (CashReg->GoodsLock(strLock, GL_MilkEGAIS) == GL_MilkEGAIS)
                            {
                                if (MilkActsiz!="") {
                                    ;;Log("MilkActsiz = " + MilkActsiz);
#ifdef PIVO_BOTTLE
		;;Log("markirovka=" + QBarcode);
#endif
                                    char spec = 0x1D;
                                    if (MilkActsiz.length()==30) {
                                        // ƒÓ·‡‚ÎˇÂÏ ÒÔÂˆÒËÏ‚ÓÎ
                                        ;;Log("Origin MilkActsiz DataMatrix (30)="+MilkActsiz);
                                        //char spec = 0x1D;
                                        ActsizBarcode = MilkActsiz.substr(0, 24) + spec
                                                + MilkActsiz.substr(24, 6);
                                    } else if (MilkActsiz.length()==32) {
                                        // ƒÓ·‡‚ÎˇÂÏ ÒÔÂˆÒËÏ‚ÓÎ
                                        ;;Log("Origin MilkActsiz DataMatrix (32)="+MilkActsiz);
                                        //char spec = 0x1D;
                                        ActsizBarcode = MilkActsiz.substr(0, 26) + spec
                                                + MilkActsiz.substr(26, 6);
                                    } else if (MilkActsiz.length()==37) {
                                        ActsizBarcode = MilkActsiz.substr(0, 31) + spec
                                                + MilkActsiz.substr(31, 6);
                                    } else if (MilkActsiz.length()==38) {
                                        if (MilkActsiz[31]!=spec) {
                                            // ƒÓ·‡‚ÎˇÂÏ ÒÔÂˆÒËÏ‚ÓÎ
                                            ;;Log("Origin MilkActsiz DataMatrix (38)="+MilkActsiz);
                                            //char spec = 0x1D;
                                            ActsizBarcode = MilkActsiz.substr(0, 32) + spec
                                                    + MilkActsiz.substr(32, 6);
                                        } else

                                        {
                                            ActsizBarcode = MilkActsiz;
                                        }
                                    } else
										
#ifdef PIVO_BOTTLE
                                        if ((QBarcode.length()==31) /*|| (QBarcode[25]==spec)*/)
                                        {
                                            Log("œÓÎÛ˜‡ÂÏ ‡ÍˆËÁÌÛ˛ Ï‡ÍÛ ÔË‚‡ ‚ Ú‡Â");
											                                    ///œÓ‚ÂˇÂÏ Ì‡ ÒËÏ‚ÓÎ ‡Á‰ÂÎËÚÂÎˇ
											if (MilkActsiz==MARKINGACTSIZ)
											{
												;;Log("MARKINGACTSIZ=111111111111111111111111111111");
												ActsizBarcode = "";
												//ResMatch = 2;
											}
                                            // ƒÓ·‡‚ÎˇÂÏ ÒÔÂˆÒËÏ‚ÓÎ
                                            else if (MilkActsiz[25]!=spec)
                                            { 
                                                ActsizBarcode = MilkActsiz.substr(0, 25) + spec
                                                        + MilkActsiz.substr(25, 6);
												;;Log("œË‚Ó ‚ ·ÛÚ˚ÎÍÂ ËÎË ·‡ÌÍÂ - Origin Actsiz DataMatrix (31)=" + ActsizBarcode);
                                            }
                                            else Log("œË‚Ó ‚ ·ÛÚ˚ÎÍÂ ËÎË ·‡ÌÍÂ - Origin Actsiz DataMatrix (32)=" + ActsizBarcode);
                                        }
                                    else
#endif

#ifdef BIODOBAVKA
                                            if (QBarcode.length()==83)
                                            {
                                                Log("œÓÎÛ˜‡ÂÏ ‡ÍˆËÁÌÛ˛ Ï‡ÍÛ ·ËÓ‰Ó·‡‚ÍË");
                                                // ƒÓ·‡‚ÎˇÂÏ ÒÔÂˆÒËÏ‚ÓÎ
                                                ;;Log("Origin MilkActsiz DataMatrix (83)="+MilkActsiz);
                                                ActsizBarcode = MilkActsiz.substr(0, 31) + spec
                                                        + MilkActsiz.substr(31, 6) + spec + MilkActsiz.substr(37, 46);
                                                Log("¿ÍˆËÁ ¡ËÓ‰Ó·‡‚ÍË = " + MilkActsiz);
                                            }
                                        else
#endif

#ifndef ALCO_VES
                                            if (QBarcode.length()==46)
                                            {
                                                Log("œÓÎÛ˜‡ÂÏ ‡ÍˆËÁÌÛ˛ Ï‡ÍÛ –‡ÁÎË‚ÌÓ„Ó ÔË‚‡");
                                               /* char spec = 0x1D;
                                                testStringAlcoVes=testStringAlcoVes.substr(0,25)+spec+
                                                          testStringAlcoVes.substr(25,6);
                                                QBarcode = testStringAlcoVes;
                                                ListActsizBarcodes.insert(ListActsizBarcodes.end(), U2W(QBarcode));*/
                                                Log("¿ÍÚˆËÁ ÔË‚‡ = " + MilkActsiz);
                                            }
                                    else
#endif

                                    {
                                        ;;Log("ERROR MilkActsiz DataMatrix length ("
                                              + Int2Str(MilkActsiz.length()) + ")");
                                    }
                                    // œÓ‚ÂÍ‡ Ì‡ ÔÓ‚ÚÓ
                                    bool isOk=true;

                                    // œÓ‚ÂÍ‡ Ì‡ ÔÓ‚ÚÓ ‚ ÚÂÍÛ˘ÂÏ Ì‡·ÓÂ
                                    if (ListActsizBarcodes.size()>0)
                                    {

                                        for (int j=0;j<ListActsizBarcodes.size();j++)
                                           if(ActsizBarcode==ListActsizBarcodes[j]){

                                               isOk=false;
                                                break;
                                           }
                                    }

                                    // œÓ‚ÂÍ‡ Ì‡ ÔÓ‚ÚÓ ‚ ÚÂÍÛ˘ÂÏ ˜ÂÍÂ
                                    if (isOk)
                                    {
                                        FiscalCheque* CurCheque = Cheque;
                                        if (!CurCheque)
                                            return -1;
                                        for (int i=0;i<CurCheque->GetCount();i++)
                                        {

                                            GoodsInfo g=(*CurCheque)[i];

                                            if ((g.ItemFlag==SL) || (g.ItemFlag==RT))
                                            {
                                                for (int j=0;j<g.Actsiz.size();j++)
                                                   if(ActsizBarcode==g.Actsiz[j]){

                                                       isOk=false;
                                                        break;
                                                   }
                                            }
#ifdef PIVO_BOTTLE
							if(ActsizBarcode == MARKINGACTSIZ) isOk=true;
#endif
                                            if (!isOk)
                                                break;
                                        }
                                    }

                                    if (isOk)
                                    {

                                    }
                                    else
                                    {
                                        // ›ÚÓ ÌÂ ‡ÍˆËÁ, ÔÓ‰ÓÎÊ‡ÂÏ Ò˜ËÚ˚‚‡ÌËÂ

                                        EditLine->clear();
                                        return false;
                                    }
                                } else {
                                    ActsizBarcode = "";
#ifdef PIVO_BOTTLE
                                MilkActsiz = "";
#endif

                                    Scanner->allsymbols = true;
                                    int errAct = CashReg->CheckActsizBarcodeDataMatrix(
                                                &ActsizBarcode,
                                                "œÓÁËˆËˇ # 1 ËÁ 1 \n\n"
                                                + Int2Str(CurGoods.ItemCode)+" "+ CurGoods.ItemName,
                                                Cheque, ListActsizBarcodes, AT_MILK
                                                );
                                    Scanner->allsymbols = false;

                                    if (errAct) return false;
                                }

                                if (ActsizBarcode!=SERVICE_EAN_MILK) {
                                    ListActsizBarcodes.insert(ListActsizBarcodes.end(), ActsizBarcode);
                                    MilkCnt = 1;
                                } else {
                                    if (CashReg->GoodsLock(strLock, GL_CigarLock) == GL_CigarLock) {
                                        ShowMessage("Ã‡ÍËÓ‚Í‡ DataMatrix Ó·ˇÁ‡ÚÂÎ¸Ì‡!");
                                        return false;
                                    }
                                }

                            }
                        }
                    }
                // - CIGAR
            }
            // - EGAIS

            CurrentGoods=&CurGoods;
			CurrentGoods->ItemSecondBarcode = CertNumber>0?LLong2Str(CertNumber):"";
			CurrentGoods->ItemDepartment	=CashReg->ConfigTable->GetLongField("DEPARTMENT");
			CurrentGoods->ItemNumber=Cheque->GetSize()+1;
	    		CurrentGoods->ItemFlag=SL;
			CurrentGoods->GuardCode=-1;
			CurrentGoods->PaymentType=CashPayment;
			time(&(CurrentGoods->tTime));

			CurrentGoods->KKMNo=0;
			CurrentGoods->KKMSmena=0;
			CurrentGoods->KKMTime=0;

            // + EGAIS
			//CurrentGoods->ItemAlco = isAlco;
			//CurrentGoods->ItemActsizBarcode = ActsizBarcode;

            CurrentGoods->ItemCigar = CigarCnt;
            CurrentGoods->ItemAlco = AlcoCnt;
            CurrentGoods->ItemTextile = TextileCnt;
            CurrentGoods->ItemMilk = MilkCnt;
#ifdef ALCO_VES
            CurrentGoods->ItemPivoRazliv = PivoRazlivCnt;
#endif

#ifdef PIVO_BOTTLE
                                MilkActsiz = "";
#endif
            CurrentGoods->ItemMask = IsMask(CurrentGoods->ItemCode);

            CurrentGoods->Actsiz.clear();
            for (int j=0;j<ListActsizBarcodes.size();j++)
                CurrentGoods->Actsiz.insert(CurrentGoods->Actsiz.end(), ListActsizBarcodes[j]);

			CurrentGoods->ItemQRBarcode = "";
            // - EGAIS

            CurrentGoods->Avans = Avans;

            if (FindInDB && CurrentGoods->InputType==IN_SCAN)
                    CurrentGoods->InputType=IN_DBRSCAN;
			else if (HandBarcode && CurrentGoods->InputType==IN_SCAN)
                    CurrentGoods->InputType=IN_RSCAN;

			if(!Cheque->GetCount())
				CashReg->m_vem.StartDoc(1, CashReg->GetLastCheckNum()+1);

			if ((PriceChecker==NULL)&&(FreeSum==NULL))
				IsCurrentGoodsEmpty=false;

            AppendRecord2Check();

			CashReg->m_vem.AddGoods(CurrentGoods->ItemNumber,CurrentGoods,Cheque->GetCalcSum(),CurGoods.InputType);

            CashReg->LogAddGoods(CurrentGoods);


			return true;
		}
		catch(cash_error& er)
		{
			CashReg->LoggingError(er);
			return false;
		}
				ShowGoodsInfo();
				return true;
			}
		case 1:
			{
				ShowMessage("ÕÂÔ‡‚ËÎ¸Ì‡ˇ ˆÂÌ‡!");
				return false;
			}
		case 2:
			{
				ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌÓÈ ˆÂÌÓÈ ÌÂ Ì‡È‰ÂÌ!");
				return false;
			}
		case 3:
			{
				ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÌÓÏÂ „ÛÔÔ˚!");
				return false;
			}
		case 4:
			{
				ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌÓÈ „ÛÔÔÓÈ ÌÂ Ì‡È‰ÂÌ!");
				return false;
			}
		case 5:
			{

				string Barcode = U2W(EditLine->text());
                if (FreeSum!=NULL)
                {
                    Barcode = U2W(FreeSum->BarcodeEdit->text());
                    if (!CashReg->isGuard(Barcode))
                    {
                        FreeSum->InfoLabel->setText("");
                        FreeSum->valid = true;
                    }
                    else
                    {
                        FreeSum->BarcodeEdit->setText("");
                        ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ¯ÚËı-ÍÓ‰ ÚÓ‚‡‡!");
                        FreeSum->valid = false;
                    }

                }
                else
                {
                    if (PriceChecker!=NULL)
                    {
                       Barcode = U2W(PriceChecker->SearchEdit->text());
                    }
                    else
                    {
                        CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,
                            WRONG_BARCODE, 0, CashReg->CurrentSaleman->Id, -1, Barcode.c_str());
                    }
                }

				EditLine->clear();
                if (FreeSum==NULL) ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌ˚Ï ¯ÚËı-ÍÓ‰ÓÏ ÌÂ Ì‡È‰ÂÌ! ("
                                               + QBarcode + ")");
				return false;
			}
		case 6:
			{
				ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÍÓ‰ ÚÓ‚‡‡!");
				return false;
			}
		case 7:
			{
				ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌ˚Ï ÍÓ‰ÓÏ ÌÂ Ì‡È‰ÂÌ! (7)");
				return false;
			}
		case 8:
			{
				switch (Tag)
				{
					case BarcodeFilter:
						ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌ˚Ï ¯ÚËı-ÍÓ‰ÓÏ ÌÂ Ì‡È‰ÂÌ! (8)");
						break;
					case PriceFilter:
						ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌÓÈ ˆÂÌÓÈ ÌÂ Ì‡È‰ÂÌ! (8)");
						break;
					case GroupFilter:
						ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌÓÈ „ÛÔÔÓÈ ÌÂ Ì‡È‰ÂÌ! (8)");
						break;
					case CodeFilter:
						ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌ˚Ï ÍÓ‰ÓÏ ÌÂ Ì‡È‰ÂÌ! (8)");
						break;
					case PropertiesFilter:
						ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌ˚ÏË Ò‚ÓÈÒÚ‚‡ÏË ÌÂ Ì‡È‰ÂÌ! (8)");
						break;
				}
				return false;
			}
		case 9:
			{
			    ShowMessage("ÕÂÔ‡‚ËÎ¸Ì‡ˇ ˆÂÌ‡ ÚÓ‚‡‡! —ÓÓ·˘ËÚÂ ÚÓ‚‡Ó‚Â‰Û! (9)");
				return false;
			}
		case 10:
			{
				ShowMessage("ÕÂÔ‡‚ËÎ¸Ì‡ˇ ˆÂÌ‡ ÚÓ‚‡‡! —ÓÓ·˘ËÚÂ ÚÓ‚‡Ó‚Â‰Û!");
				return false;
			}
		case 11: {
                CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CANCELCIGARETTE, 0, CashReg->CurrentSaleman->Id, -1, (const char *)(U2W(QBarcode).c_str()));
                return false;
            }
		case 12:
			{
				return false;
			}
		case 13:
			{
                ShowMessage("«‡ÔÂ˘ÂÌ‡ ÔÓ‰‡Ê‡ ÒË„‡ÂÚ ·ÂÁ ‡ÍˆËÁ‡!\n—˜ËÚ‡ÈÚÂ ‡ÍˆËÁ.");
				return false;
			}
		case GL_TimeLock:
			{
			    ShowMessage("œÓ‰‡Ê‡ ÚÓ‚‡‡ Á‡ÔÂ˘ÂÌ‡");
				return false;
			}
		case GL_FindByCode:
			{
			    ShowMessage("ÕÂ‰ÓÒÚ‡ÚÓ˜ÌÓ Ô‡‚ (CD)");
				return false;
			}
		case GL_FindByPrice:
			{
			    ShowMessage("ÕÂ‰ÓÒÚ‡ÚÓ˜ÌÓ Ô‡‚ (PR)");
				return false;
			}
		case GL_FindByName:
			{
			    ShowMessage("ÕÂ‰ÓÒÚ‡ÚÓ˜ÌÓ Ô‡‚ (NM)");
				return false;
			}
        case GL_Lock:
            {
                ShowMessage("Lock");
                return false;
            }
        //default: ShowMessage((char*)Int2Str(res).c_str());

	};
}

bool WorkPlace::CompareKey(int Key,string Pattern,string* ptrKeyName)//try to understand the type of the operation
{

	return CashReg->CompareKey(Key,Pattern,ptrKeyName);
}

void WorkPlace::closeEvent(QCloseEvent* e)//close saleman's workplace
{
	InitWorkPlace();
/*
	if(Cheque->GetCount()>0){
		ShowMessage("ƒÎˇ Á‡‚Â¯ÂÌËˇ ‡·ÓÚ˚ ‡ÌÌÛÎËÛÈÚÂ ˜ÂÍ.");
		return;
	}
*/
	if (ShowQuestion("«‡‚Â¯ËÚ¸ ‡·ÓÚÛ Í‡ÒÒË‡?",false)==true)
	{
		CloseWorkPlace();
		QDialog::closeEvent(e);
	}
}

void WorkPlace::keyPressEvent(QKeyEvent* e)//analogously
{
    ;;Log("#keyPressEvent="+Int2Str(e->key()));

	InitWorkPlace();
	if ((e->key()==Qt::Key_Escape))
	{
	    QCloseEvent ev = QCloseEvent();
		closeEvent(&ev);
/*
		if (ShowQuestion("«‡‚Â¯ËÚ¸ ‡·ÓÚÛ Í‡ÒÒË‡?",false)==true)
		{
			CloseWorkPlace();
			QDialog::keyPressEvent(e);
		}
*/
	}
	else{
		if(ShiftButton & e->state())
			PaymentType = ShiftDown;
		//ShowMessage("keyPressEvent");

		QDialog::keyPressEvent(e);
	}
}

void WorkPlace::ProcessKey(int Key)//proccess command key
{

    //;;Log("#ProcessKey="+Int2Str(Key));

    AltFinal=false;
    RestartTimerSS(true);

	InitWorkPlace();

	if (Key==0)
		return;

    ;;Log("#ProcessKey="+Int2Str(Key));

	//if up or down arrows were pressed we send them to cheque form
	if ((Key==Key_Up)||(Key==Key_Down)||(Key==Key_PageUp)||(Key==Key_PageDown))
		thisApp->sendEvent(ChequeList,new QKeyEvent(QEvent::KeyPress,Key,0,0));

	try
	{
		string KeyName;

		if (CompareKey(Key,INFO))
		{
		    if(EditLine->ctrl)
		    {
                Log("PressKey>> INFO");
                EditLine->clear();
                if (CurrentCustomer==0LL) return;

                bPriceCheck=true;
                PriceChecker = new PriceCheck(this);
                PriceChecker->SearchEdit->setText(W2U(LLong2Str(CurrentCustomer)));
                PriceChecker->ProcessKey(12345); // ¿‚ÚÓÔÓËÒÍ
                //PriceChecker->ProcessKey(4148); // F5
                (PriceChecker->exec()==QDialog::Accepted);
                bPriceCheck=false;
                delete PriceChecker;
                PriceChecker=NULL;
		    }
		    else
		    {
                Log("PressKey>> INFO");
                EditLine->clear();
                if (!EditLineCheck(""))
                    return;
                if (ShowQuestion("ŒÚÍ˚Ú¸ ÓÍÌÓ ËÌÙÓÏ‡ˆËË Ó ÚÓ‚‡Â?",false))
                {
                    bPriceCheck=true;
                    PriceChecker = new PriceCheck(this);
                    (PriceChecker->exec()==QDialog::Accepted);
                    bPriceCheck=false;
                    delete PriceChecker;
                    PriceChecker=NULL;
                }
		    }
		}

		if (CompareKey(Key,SEARCHBYCODE,&KeyName))//looking for goods by code
		{
            FindInDB = EditLine->ctrl;
		    string msg = "PressKey>> SEARCH BY CODE ";
            msg += (FindInDB?"IN BASE ":"");
		    msg += "("+U2W(EditLine->text())+")";
	        Log((char*)msg.c_str());

			if(EditLine->text().isEmpty())
				EditLine->setText(KeyName.substr(strlen(SEARCHBYCODE),KeyName.length()-strlen(SEARCHBYCODE)).c_str());
			if (!EditLineCheck("¬‚Â‰ËÚÂ ÍÓ‰ ÚÓ‚‡‡!"))
			{
			    FindInDB = false;
				return;
			}

			if (LookingForGoods(CodeFilter))//show all goods with the entered code
				EditLine->clear();
            FindInDB = false;

			return;
		}

		if (CompareKey(Key,SEARCHBYPRICE))//looking for goods by price
		{
            FindInDB = EditLine->ctrl;
		    string msg = "PressKey>> SEARCH BY PRICE ";
            msg += (FindInDB?"IN BASE ":"");
		    msg += "("+U2W(EditLine->text())+")";
	        Log((char*)msg.c_str());

			if (!EditLineCheck("¬‚Â‰ËÚÂ ˆÂÌÛ ÚÓ‚‡‡!"))
			{
                FindInDB = false;
				return;
			}

			if (LookingForGoods(PriceFilter))//show all goods with the entered price
				EditLine->clear();

            FindInDB = false;
			return;
		}

		if (CompareKey(Key,SEARCHBYGROUP))//looking for goods by group code
		{
		    Log("PressKey>> SEARCH BY GROUP");
			if (!EditLineCheck(""))
				return;

			if (!EditLine->text().isEmpty())
			{
				//show all goods with the selected group
				if (LookingForGoods(GroupFilter))
					EditLine->clear();
			}
			else
			{

				int SelPos;  //show list of groups
				vector<int> GrCodes;
				vector<string> S_Names;

				CashReg->GetGroup(&GrCodes,&S_Names);

				SectionSelForm *dlg = new SectionSelForm(this);
				dlg->SelRow=&SelPos;
				dlg->ShowSectionList(GrCodes,S_Names);
				if (dlg->exec()==QDialog::Accepted)
					EditLine->setText(Int2Str(GrCodes[SelPos]).c_str());
				delete dlg;

			}
			return;
		}

		if (CompareKey(Key,SEARCHBYPROPERTIES))//advanced goods search
		{
		    Log("PressKey>> SEARCH BY PROPERTIES");
			EditLine->clear();
			if (!EditLineCheck(""))
				return;

			SearchForm *dlg = new SearchForm(this);
			QString GoodsCode,GoodsBarcode,GoodsName,GoodsPrice;
			bool LookInsideStatus=false;
			for(;;)
			{
				dlg->CodeEdit->setText(GoodsCode);
				dlg->BarcodeEdit->setText(GoodsBarcode);
				dlg->NameEdit->setText(GoodsName);
				dlg->PriceEdit->setText(GoodsPrice);
				dlg->LookInside->setChecked(LookInsideStatus);
				if (dlg->exec()==QDialog::Accepted)
				{
					GoodsCode	= dlg->CodeEdit->text();
					GoodsBarcode	= dlg->BarcodeEdit->text();
					GoodsName	= dlg->NameEdit->text();
					LookInsideStatus= dlg->LookInside->isChecked();
					GoodsPrice	= dlg->PriceEdit->text();

					bool checknum;

					if (!GoodsCode.isEmpty())
					{
						GoodsCode.toInt(&checknum);
						if (!checknum)
						{
							ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÍÓ‰ ÚÓ‚‡‡!");
							continue;
						}
					}

					if (!GoodsPrice.isEmpty())
					{
						GoodsPrice.toDouble(&checknum);
						if (!checknum)

						{

							ShowMessage("ÕÂÔ‡‚ËÎ¸Ì‡ˇ ˆÂÌ‡ ÚÓ‚‡‡!");
							continue;
						}
					}
					try
					{
						thisApp->setOverrideCursor(waitCursor);
						InfoMessage->setText(W2U("œÓËÒÍ ÚÓ‚‡‡"));

						LookingForGoods(PropertiesFilter,GoodsCode,GoodsBarcode,GoodsName,GoodsPrice,LookInsideStatus);

						InfoMessage->clear();
						thisApp->restoreOverrideCursor();
					}
					catch(cash_error& er)
					{
						CashReg->LoggingError(er);
					}
				}
				break;
			}

			delete dlg;
			return;
		}

		if (CompareKey(Key,SEARCHBYBARCODE))//looking for goods by barcode
		{

            FindInDB = EditLine->ctrl;
		    string msg = "PressKey>> SEARCH BY BARCODE ";
            msg += (FindInDB?"IN BASE ":"");
		    msg += "("+U2W(EditLine->text())+")";
	        Log((char*)msg.c_str());

            if (!EditLineCheck("¬‚Â‰ËÚÂ ¯ÚËı-ÍÓ‰ ÚÓ‚‡‡!"))
            {
                FindInDB = false;
                return;
            }

                if (EditLine->text().left(3)=="993") // Û˜ÌÓÈ ‚‚Ó‰ Í‡Ú˚
                {
                    //if(!CashReg->BonusMode(lcard))
                        return ;

/*
                    ;;cash_error* _err = new cash_error(11,0, "Barcode (F5): "+U2W(EditLine->text()));
                    ;;CashReg->LoggingError(*_err);
                    ;;delete _err;
*/
                }


                HandBarcode = true;

                ProcessBarcode();

                HandBarcode = false;
                FindInDB = false;

			return;
		}

		if (CompareKey(Key,SCALEGOODS)) //scaling
		{
		    Log("PressKey>> SCALEGOODS");
			if (!EditLineCheck(""))
				return;

			int w=0;

			if (Scales->GetWeight(w))
				EditLine->setText(GetRounded(w*0.001,0.001).c_str());
			else
				ShowMessage("ÕÂ ÏÓ„Û ÓÔÂ‰ÂÎËÚ¸ ‚ÂÒ ÚÓ‚‡‡!");

			return;
		}
		if (CompareKey(Key,ENTERERROR))//delete current goods
		{
		    Log("PressKey>> ENTERERROR");
			QListViewItem *item = ChequeList->firstChild();
			if(item){
				while(item->itemBelow())
					item = item->itemBelow();
				ChequeList->setSelected(item,true);
			}
		}
		if (CompareKey(Key,DELETEFROMCHECK) || CompareKey(Key,ENTERERROR))//remove goods from check
		{
		    Log("PressKey>> DELETEFROMCHECK");
			if (!EditLineCheck(""))
				return;

			if(!ChequeList->selectedItem()){
				ShowMessage("ÕÂ ‚˚·‡Ì‡ ÔÓÁËˆËˇ.");
				return;
			}

			if (Cheque->GetSize()>0)
			{
				if (ShowQuestion("”‰‡ÎËÚ¸ ÔÓÍÛÔÍÛ ËÁ ˜ÂÍ‡",false))
				{
					int GuardRes=NotCorrect;
					if ((!CashReg->CurrentSaleman->Storno)&&(!CheckGuardCode(GuardRes)))
						return;

					//screen form of the cheque doesn't show storno goods
					int ChequePos;//so we have to find internal index of the selected goods
					int ChequeCount=0;

					for (ChequePos=0;ChequePos<Cheque->GetCount();ChequePos++)
					{
						if ((*Cheque)[ChequePos].ItemFlag!=ST)
							ChequeCount++;
						if (ChequeCount==ChequeList->selectedItem()->text(ListNo).toInt())
							break;
					}

					if (ChequePos==Cheque->GetCount())
						return;

					//try to make 'storno' operation
					CashReg->ProcessRegError(FiscalReg->Storno((*Cheque)[ChequePos].ItemName.c_str(),
						(*Cheque)[ChequePos].ItemFullPrice,(*Cheque)[ChequePos].ItemCount,(*Cheque)[ChequePos].ItemDepartment));

					GoodsInfo g=(*Cheque)[ChequePos];

					g.ItemFlag=ST;
					g.GuardCode=GuardRes;

//					CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,ST,
//						g.ItemSum,CashReg->CurrentSaleman->Id,GuardRes);

					Cheque->SetAt(ChequePos,g);

					if (ChequeList->selectedItem()!=NULL)
						delete ChequeList->selectedItem();

					if(Cheque->GetSize()==0)
					{
						ShowMessage("◊ÂÍ ÔÛÒÚ Ë ·Û‰ÂÚ ‡ÌÌÛÎËÓ‚‡Ì!");
						CurrentCustomer = 0;
						NeedCert=0;
						CurrentCertificate=0;
						CashReg->LoadDiscountTypeFromDB(0,&DiscountType);
						CashReg->ProcessRegError(FiscalReg->Cancel());//annul cheque
						IsChequeInProgress=false;
						CashReg->AnnulCheck(Cheque,GuardRes);
						IsChequeInProgress=false;
						InitWorkPlace();
						AutoRestoreKeepedCheque();
					}
					ProcessDiscount(Cheque);

					CashReg->m_vem.DeleteGoods(-1, &g, Cheque->GetCalcSum());

					CashReg->LogDelGoods(&g);

					QListViewItem *lastItem=ChequeList->firstChild();

					if (lastItem!=NULL)//highlight the goods in the check
					{
						for(int i=1;;i++)
						{
							lastItem->setText(ListNo,Int2Str(i).c_str());

							if (ChequeCount==i)
							{
								ChequeList->setSelected(lastItem,true);
								ChequeList->setCurrentItem(lastItem);
							}

							if (lastItem->itemBelow()!=NULL)
								lastItem=lastItem->itemBelow();
							else
								break;
						}

						if (ChequeCount>ChequeList->childCount())
						{
							ChequeList->setSelected(lastItem,true);
							ChequeList->setCurrentItem(lastItem);
						}
					}

					if (!IsCurrentGoodsEmpty){
						IsCurrentGoodsEmpty = true;
						CurGoods.init();
						CurrentGoods = &CurGoods;
					}

//					CashReg->ClearCurrentCheck();
//					CashReg->WriteChequeIntoTable(CashReg->CurrentCheckTable,Cheque,CashReg->GetCurTime());

					ShowGoodsInfo();
				}
			}
			else
				ShowMessage("œÛÒÚÓÈ ˜ÂÍ!");
			return;
		}

		if (CompareKey(Key,CALCULATOR))//show calculator
		{
		    Log("PressKey>> CALCULATOR");
			CalcForm *dlg = new CalcForm(this);

			dlg->exec();
			delete dlg;
			return;
		}

		if (CompareKey(Key,LASTCHECK))//ÔÓÒÎÂ‰ÌËÈ ˜ÂÍ
		{
		    Log("PressKey>> LASTCHECK");
			if(!ShowQuestion("œÓ‚ÚÓËÚ¸ ˜ÂÍ?",false))
				return;
			if(Cheque->GetCount()){
				ShowMessage("“ÂÍÛ˘ËÈ ˜ÂÍ ÌÂ ÔÛÒÚ.");
				return;
			}
			RestoreSet(false, true);
			UpdateList();
			return;
		}

		if (CompareKey(Key,KEEP))//ÓÚÎÓÊÂÌÌ˚È ˜ÂÍ
		{
		    Log("PressKey>> KEEP");
			keepstate=fopen("tmp/keepstate.dat","r");
			if(!keepstate)
			{
				if (!Cheque->GetSize())
				{//˜ÂÍË ÔÛÒÚ˚
					ShowMessage("“ÂÍÛ˘ËÈ Ë ÓÚÎÓÊÂÌÌ˚È ˜ÂÍË ÔÛÒÚ˚!!!");
					KeepCheckInfo->setProperty( "text","");
					return;
				}
				else
				{//ÓÚÎÓÊËÚ¸
					if(!ShowQuestion("ŒÚÎÓÊËÚ¸ ÚÂÍÛ˘ËÈ ˜ÂÍ?",false))
						return;
					if (rename("tmp/state.dat","tmp/keepstate.dat")){
						ShowMessage("Œ¯Ë·Í‡ ÓÚÍÎ‡‰˚‚‡ÌËˇ ˜ÂÍ‡!\n—ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!");
						return;
					}

					CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,19,Cheque->GetSum(),CashReg->CurrentSaleman->Id,-1);

                    // –Â‚ÂÒ cÔËÒ‡ÌËˇ ·‡ÎÎÓ‚
                    if ((CashReg->WPCX!=NULL) && (Cheque->BankBonusSumm>0))
                    {// Cancel bank bonus discounts
                        ;;Log(" Cancel bank bonus discounts (KEEP)");
                        ProcessBankBonusDiscountReverse(CashReg->WPCX->PCX_Result.card, CashReg->WPCX->PCX_Result.sha1, true);
                    }

                    // –Â‚ÂÒ cÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚
                    if ((CashReg->BNS!=NULL) && (Cheque->BonusSumm>0))
                    {// Cancel bonus discounts
                        ;;Log(" Cancel bonus discounts (KEEP)");

                        ProcessBonusDiscountReverse(true);
                    }

					keepstate=fopen("tmp/keepstate.dat","a");
					fprintf(keepstate, "KCHNUM=%d\n",CashReg->GetLastCheckNum()+1);
					fprintf(keepstate, "KCHTIME=");
					fputs(CashReg->GetCurDate().c_str(), keepstate);
					fputs("/",keepstate);
					fputs(CashReg->GetCurTime().c_str(), keepstate);
					fputs("\n",keepstate);
					fclose(keepstate);

					storenum = fopen("./tmp/storenum.dat","r");
					if (storenum){
						int storechecknum;
						fscanf(storenum,"%d",&storechecknum);
						fclose(storenum);
						remove("./tmp/storenum.dat");
						if ((storechecknum-CashReg->GetLastCheckNum())>100 || (CashReg->GetLastCheckNum()-storechecknum)>100 || storechecknum>1000000000 || CashReg->GetLastCheckNum()>1000000000){
							char tmpstr[128];//="Œ¯Ë·Í‡ ÌÛÏÂ‡ˆËË ˜ÂÍÓ‚. “ÂÍÛ˘ËÈ ˜ÂÍ: "+CashReg->GetLastCheckNum()+". ŒÚÎÓÊÂÌÌ˚È ˜ÂÍ: "+storechecknum+".\n —ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!!!"
							sprintf(tmpstr,"Œ¯Ë·Í‡ ÌÛÏÂ‡ˆËË ˜ÂÍÓ‚. “ÂÍÛ˘ËÈ ˜ÂÍ: %d.\n —ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!!!",storechecknum);
							ShowMessage((string)tmpstr);
						}
						CashReg->SetLastCheckNum(storechecknum-1);
					}
					else
						CashReg->SetLastCheckNum(CashReg->GetLastCheckNum()+1);

					CurrentCustomer = 0;
					NeedCert=0;
					CurrentAddonCustomer = 0;
					CurrentBonusBalans=0;
					CashReg->LoadDiscountTypeFromDB(CurrentCustomer,&DiscountType);

					Cheque->Clear();
					CashReg->ClearCurrentCheck();//
					ChequeList->clear();
					KeepCheckInfo->setProperty( "text",W2U("O.◊."));
					remove("./tmp/storenum.dat");
					CashReg->ClearPayment();

                    IsCurrentGoodsEmpty=true;
                    InitWorkPlace(true);



					ShowMessage("“ÂÍÛ˘ËÈ ˜ÂÍ ÓÚÎÓÊÂÌ!");

					return;
				}
			}
			else
			{
				fclose(keepstate);
				if (!Cheque->GetSize())
				{//‚ÓÒÒÚ‡ÌÓ‚ËÚ¸
					if(!ShowQuestion("¬ÓÒÒÚ‡ÌÓ‚ËÚ¸ ÓÚÎÓÊÂÌÌ˚È ˜ÂÍ?",false))
						return;
					RestoreKeepedCheque();
					//painter.end();
					return;
				}
				else
				{//ÓÚÎÓÊËÚ¸ Ë ‚ÓÒÒÚ‡ÌÓ‚ËÚ¸
					if(!ShowQuestion("ŒÚÎÓÊËÚ¸ ÚÂÍÛ˘ËÈ Ë ‚ÓÒÒÚ‡ÌÓ‚ËÚ¸ ÓÚÎÓÊÂÌÌ˚È ˜ÂÍË?",false))
						return;

					keepstate = fopen("./tmp/keepstate.dat","r");
					int storechecknum;
					if (keepstate){
						char buf[256];
						while(!feof(keepstate)){
							fscanf(keepstate,"%s",buf);
							sscanf(buf,"KCHNUM=%d", &storechecknum);
						}
						fclose(keepstate);
						storenum = fopen("./tmp/storenum.dat","w");
						fprintf(storenum,"%d",CashReg->GetLastCheckNum()+2);
						fclose(storenum);
					}
					if (rename("tmp/state.dat","tmp/tmpstate.dat") ||
						rename("tmp/keepstate.dat","tmp/state.dat") ||
						rename("tmp/tmpstate.dat","tmp/keepstate.dat")) {
						ShowMessage("Œ¯Ë·Í‡ ÒÏÂÌ˚ ˜ÂÍÓ‚!\n—ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!");
						return;
					}
					CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,19,Cheque->GetSum(),CashReg->CurrentSaleman->Id,-1);
					keepstate=fopen("tmp/keepstate.dat","a");
					if (keepstate){
						fprintf(keepstate, "KCHNUM=%d\n",CashReg->GetLastCheckNum()+1);
						fprintf(keepstate, "KCHTIME=");
						fputs(CashReg->GetCurDate().c_str(), keepstate);
						fputs("/",keepstate);
						fputs(CashReg->GetCurTime().c_str(), keepstate);
						fputs("\n",keepstate);
						fclose(keepstate);
					}
					CashReg->SetLastCheckNum(storechecknum-1);

					Cheque->Clear();
					EditLine->clear();
					CashReg->ClearPayment();

					RestoreSet();
					UpdateList();

					KeepCheckInfo->setProperty( "text",W2U("O.◊."));
					//KeepCheckInfo_font.setStrikeOut(true);
					ShowMessage("ŒÚÎÓÊÂÌÌ˚È ‚ÓÒÒÚ‡ÌÓ‚ÎÂÌ Ë ÚÂÍÛ˘ËÈ ÓÚÎÓÊÂÌ!");
					return;
				}
			}
		}

		if (CompareKey(Key,ENTERERROR))//delete current goods
		{
		    Log("PressKey>> ENTERERROR_2");
			if (!EditLineCheck(""))
				return;

			if (IsCurrentGoodsEmpty)
			{
				ShowMessage("ÕÂ˜Â„Ó Û‰‡ÎˇÚ¸!");
				return;
			}

			if (ShowQuestion("”‰‡ÎËÚ¸ ÔÓÍÛÔÍÛ?",false))
			{
				int GuardRes=NotCorrect;
				if ((!CashReg->CurrentSaleman->CurrentGoods)&&(!CheckGuardCode(GuardRes)))
					return;

				if (Cheque->GetCount()>0)//clear current goods info
				{
					IsCurrentGoodsEmpty=true;
					ShowGoodsInfo();
				}
				else
				{
					IsChequeInProgress=false;
					InitWorkPlace();
				}

				CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CURRENTGOODS,
					CurrentGoods->ItemSum,CashReg->CurrentSaleman->Id,GuardRes);
			}

			return;
		}

		if (CompareKey(Key,AMOUNT))//change the goods quantity
		{
		    ;;Log((char*)("PressKey>> AMOUNT ("+U2W(EditLine->text())+")").c_str());
			//if(bPriceCheck)
			//	ShowMessage("search by enter");
			if (!EditLineCheck(""))
				return;

			if (!IsCurrentGoodsEmpty)
			{//change the goods amount by taking into account saleman's limits


                // + dms === 2020-10-13 ==== Õ‡ ‚ÂÏˇ ‡ÍˆËË ¬ËÒÍË+—ÓÍ =====
                if (CurrentGoods->ItemCode==24979)
                {
                    return;
                }
                // - dms


                if (CurrentGoods->ItemAlco)
				{
					//ShowMessage("ÕÂÎ¸Áˇ ËÁÏÂÌˇÚ¸ ÍÓÎË˜ÂÒÚ‚Ó ‡ÎÍÓ„ÓÎ¸ÌÓÈ ÔÓ‰ÛÍˆËË");
					return;
				}

                if (CurrentGoods->ItemCigar)
				{
					//ShowMessage("ÕÂÎ¸Áˇ ËÁÏÂÌˇÚ¸ ÍÓÎË˜ÂÒÚ‚Ó ‡ÎÍÓ„ÓÎ¸ÌÓÈ ÔÓ‰ÛÍˆËË");
					return;
				}

			    string str = CurrentGoods->Lock;

                if (CashReg->GoodsLock(str, GL_AmountLockAnyway) == GL_AmountLockAnyway)
				{
					//ShowMessage("ÕÂÎ¸Áˇ ËÁÏÂÌˇÚ¸ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡");
					return;
				}

                if (CashReg->GoodsLock(str, GL_MilkEGAIS) == GL_MilkEGAIS)
                {
                    //ShowMessage("ÕÂÎ¸Áˇ ËÁÏÂÌˇÚ¸ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡");
                    return;
                }

                if (CashReg->GoodsLock(str, GL_TextileEGAIS) == GL_TextileEGAIS)
                {
                    //ShowMessage("ÕÂÎ¸Áˇ ËÁÏÂÌˇÚ¸ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡");
                    return;
                }

                int Res=NotCorrect;
                if ((CashReg->GoodsLock(str, GL_AmountLock) == GL_AmountLock)
                   &&(!CheckGuardCode(Res)))
				{
					//ShowMessage("ÕÂÎ¸Áˇ ËÁÏÂÌˇÚ¸ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡");
					return;
				}


				bool err;
				double GoodsCount=GetDoubleNum(&err);
				if ((!err)||(GoodsCount<epsilon))
				{
					ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓÂ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡");
					return;
				}

				if (fabs(CurrentGoods->ItemPrecision-1)<epsilon)
					if (GoodsCount!=floor(GoodsCount))
					{
						ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓÂ ÍÓÎË˜ÂÒÚ‚Ó ¯ÚÛ˜ÌÓ„Ó ÚÓ‚‡‡");
						return;
					}

				if ((MaxAmount>epsilon)&&(GoodsCount>=MaxAmount))
				{
					ShowMessage("—ÎË¯ÍÓÏ ·ÓÎ¸¯ÓÂ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡!");
					return;
				}


				if ((MaxSum>epsilon)&&(GoodsCount*CurrentGoods->ItemPrice>=MaxSum))
				{
					ShowMessage("—ÎË¯ÍÓÏ ·ÓÎ¸¯‡ˇ ÒÛÏÏ‡ ÚÓ‚‡‡!");
					return;
				}

				if ((RoundToNearest(GoodsCount*CurrentGoods->ItemPrice,0.01)<epsilon) && (!CurrentGoods->ActionGoods))
				{
					ShowMessage("—ÎË¯ÍÓÏ Ï‡Î‡ ÒÛÏÏ‡ ÚÓ‚‡‡!");
					return;
				}

				int	GuardRes=NotCorrect;
				if ((GoodsCount<CurrentGoods->ItemCount)&&(fabs(CurrentGoods->ItemPrecision-1)<epsilon)//Á‡ÍÓÏÏÂÌÚ-Á‡ÔÂÚ ÛÏÂÌ¸¯ÂÌËˇ ‚ÂÒÓ‚Ó„Ó ÚÓ‚‡‡ ()
							&&(!CashReg->CurrentSaleman->Quantity)&&(!CheckGuardCode(GuardRes)))
					return;

				if ((GoodsCount<CurrentGoods->ItemCount)&&(fabs(CurrentGoods->ItemPrecision-1)>epsilon)	// ‚ÂÒÓ‚ÓÈ ÚÓ‚‡
							&&(!CashReg->CurrentSaleman->Weight)&&(!CheckGuardCode(GuardRes)))			//
					return;


            string resCheckSugar = "";
			if(CheckSugar(&resCheckSugar, CurrentGoods->ItemCode, GoodsCount-CurrentGoods->ItemCount))
			{
			    ShowMessage(resCheckSugar);
			    return;
            }
//

				if (GoodsCount<CurrentGoods->ItemCount)
					CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,QUANTITY,
						CurrentGoods->ItemSum,CashReg->CurrentSaleman->Id,GuardRes);

				CurrentGoods->ItemCount = RoundToNearest(GoodsCount,CurrentGoods->ItemPrecision);
				CalcCountPrice();
				CurrentGoods->CalcSum();

                bool divide;//ÙÎ‡„ ‰ÂÎËÏÓÒÚË
				double quant = -1.0;
				for (int i = 0; ;i++)//ÔÓ‚ÂÍ‡ ÔÓÎÂÈ Q
				{
					char fname[64];
					sprintf(fname, "Q%d", i);
					if(CashReg->GoodsTable->GetFieldNo(fname) == -1 || CashReg->GoodsTable->GetDoubleField(fname) < .001)
						break;
					quant = CashReg->GoodsTable->GetDoubleField(fname);
				}

				if (CashReg->GoodsTable->GetFieldNo("MULT") != -1
						&& quant != -1.0 //Ï‡ÍÒËÏ‡Î¸ÌÓÂ ËÁ ÔÓÎÂÈ Q
						//&& GoodsCount > 0
						&& fmod(GoodsCount,quant) != 0.0 //ÓÒÚ‡ÚÓÍ ÓÚ ‰ÂÎÂÌËˇ
						&& quant > CashReg->GoodsTable->GetDoubleField("MULT")//ÍÓÎË˜ÂÒÚ‚Ó ÓÚ ÍÓÚÓÓ„Ó Ì‡˜ËÌ‡ÂÚÒˇ ÒÍË‰Í‡
						&& quant < GoodsCount)
				{
					double tmpGoodsCount = GoodsCount;
					GoodsCount = tmpGoodsCount - fmod(GoodsCount,quant);
					CurrentGoods->ItemCount = RoundToNearest(GoodsCount,CurrentGoods->ItemPrecision);
					CalcCountPrice();
					CurrentGoods->CalcSum();
					QListViewItem *item = ChequeList->firstChild();
					while(item->itemBelow())
						item = item->itemBelow();
					item->setText(ListNo,Int2Str(Cheque->GetSize()).c_str());
		            // + dms === 2010-03-30 =====\ ÒÔÂˆ. ÍÓ‰ ÌÂ ‚˚‚Ó‰ËÏ
                    item->setText(ListCode, CurrentGoods->ItemCode==FreeSumCode? "" : Int2Str(CurrentGoods->ItemCode).c_str());
                    // - dms === /
					item->setText(ListName,W2U(CurrentGoods->ItemName));
					item->setText(ListPrice,GetRounded(CurrentGoods->ItemPrice,0.01).c_str());
					item->setText(ListCount,GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
					item->setText(ListSum,GetRounded(CurrentGoods->ItemSum,0.01).c_str());
					item->setText(ListDscnt,GetRounded(CurrentGoods->ItemCalcSum-CurrentGoods->ItemSum,0.01).c_str());
					GoodsCount = fmod(tmpGoodsCount,quant);
					AddGoods();
					divide = true;
				}
				else
				{
					divide = false;
				}

				CurrentGoods->ItemCount = RoundToNearest(GoodsCount,CurrentGoods->ItemPrecision);
				CalcCountPrice();
				CurrentGoods->CalcSum();

				ProcessDiscount(Cheque);

				QListViewItem *item = ChequeList->firstChild();
				while(item->itemBelow())
					item = item->itemBelow();
				item->setText(ListNo,Int2Str(Cheque->GetSize()).c_str());
                // + dms === 2010-03-30 =====\ ÒÔÂˆ. ÍÓ‰ ÌÂ ‚˚‚Ó‰ËÏ
                item->setText(ListCode, CurrentGoods->ItemCode==FreeSumCode? "" : Int2Str(CurrentGoods->ItemCode).c_str());
                // - dms === /
				item->setText(ListName,W2U(CurrentGoods->ItemName));
				item->setText(ListPrice,GetRounded(CurrentGoods->ItemPrice,0.01).c_str());
				item->setText(ListCount,GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
				item->setText(ListSum,GetRounded(CurrentGoods->ItemSum,0.01).c_str());
				item->setText(ListDscnt,GetRounded(CurrentGoods->ItemCalcSum-CurrentGoods->ItemSum,0.01).c_str());

				CashReg->m_vem.EditGoods(-1, CurrentGoods, Cheque->GetCalcSum());

				CashReg->LogEditGoods(CurrentGoods);

				ShowGoodsInfo();
				EditLine->clear();
			}
			return;
		}


        if (CompareKey(Key,ALTFINALIZE) && EditLine->ctrl)//alternative cashless complete current sale
        {
            Log("PressKey>> ALTFINALIZE");
            AltFinal = (PaymentKeyPress==0);
        }

		if (CompareKey(Key,FINALIZE) || AltFinal)//complete current sale
		{
            NeedChangeCard2VIP=false;
            NeedChangeCard2SuperVIP=false;

		    if (!AltFinal)
                Log((char*)("PressKey>> FINALIZE ("+U2W(EditLine->text())+")").c_str());

			if ((IsCurrentGoodsEmpty)&&(Cheque->GetSize()==0))//bool IsCurrentGoodsEmpty;//various flags &&
			{
				ShowMessage("ŒÚÒÛÚÒÚ‚ÛÂÚ ÚÓ‚‡ ‚ ˜ÂÍÂ!");
				return;
			}
			//{
			if (Cheque->GetSum() < 0)
			{
				ShowMessage("ÕÂ‰ÓÔÛÒÚËÏ‡ˇ ÒÛÏÏ‡ ‚ ˜ÂÍÂ!");
				return;
			}
			//}

            // ¿ÍˆËˇ ‚˚‰‡˜Ë Í‡Ú˚ "ƒÓ·˚Â ÒÓÒÂ‰Ë" ÔË ÔÂ‰˙ˇ‚ÎÂÌËË ÙÎ‡Â‡
//            if (InActionDobryeSosedy(CurrentCustomer, AddAddonDiscount))
//            {
//                 ShowMessageAndLogInfo("ÕÂÓ·ıÓ‰ËÏÓ Ò˜ËÚ‡Ú¸ Í‡ÚÛ \"ƒÓ·˚Â ÒÓÒÂ‰Ë\" Ë ÙÎ‡Â!");
//                 return;
//            }
            //==============


			if(GoodsLock(Cheque))
			{
			    return;
            }

			if(!GoodsWeightChecked && CheckWeightGoods(Cheque))
			{
			    return;
            }

			if(Cheque->Lock)
			{
			    ShowMessage("œÓ‰‡Ê‡ ÚÓ‚‡Ó‚ Á‡ÔÂ˘ÂÌ‡!");
			    return;
            }


            string resCheckSugar = "";
			if(CheckSugar(&resCheckSugar))
			{
                ShowMessage(resCheckSugar);
			    return;
            }



/*			if(Check100_11())
			{
			    ShowMessage("œÓ‰‡Ê‡ ‰‡ÌÌ˚ı ÚÓ‚‡Ó‚ Ì‡ ˝ÚÓÈ Í‡ÒÒÂ Á‡ÔÂ˘ÂÌ‡!");
			    return;
            }
*/

/* ÔÓ‚ÂÍ‡ Ì‡ ‡ÍÚË‚ÌÓÒÚ¸ ÒÂÚËÙËÍ‡ÚÓ‚
			if()
			{
			    ShowMessage("");
			    return;
            }
//*/

/*/
// ¿ ÷»ﬂ «¿¬≈–ÿ≈Õ¿
// ¿ÍˆËˇ ÀË·ÂÓ: Á‡ Í‡Ê‰˚Â 2 ÚÓ‚‡‡ ÀË·ÂÓ ‚˚‰‡ÂÚÒˇ ÔÓ‰‡ÓÍ
            int CntPresent = CheckLibero();
			if(CntPresent)
			{

                string msg = "¬˚‰‡Ú¸ Ïˇ„ÍÛ˛ Ë„Û¯ÍÛ Ì‡ ÛÍÛ ("+Int2Str(CntPresent)+" ¯Ú.)";
                CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CARDINFO,0,CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL, (char*)msg.c_str());

                int lKeyPressed = -1;
                while (lKeyPressed !=0)
                {
                    lKeyPressed = QMessageBox::information
                    ( NULL, "APM KACCA", W2U(msg)
                    ,W2U("¬€ƒ¿“‹ œŒƒ¿–Œ "),W2U("’") ,""
                    , 1, -1);
                }

            }
//*/

/*/
// ¿ ÷»ﬂ «¿¬≈–ÿ≈Õ¿
// ¿ÍˆËˇ œË‚Ó Redhop: Á‡ Í‡Ê‰˚Â 3 ÚÓ‚‡‡ ÔË‚‡ Redhop ‚˚‰‡ÂÚÒˇ ÔÓ‰‡ÓÍ - ÛÔ‡ÍÓ‚Í‡ ÍÓÎ·‡ÒÓÍ "œËÍÓÎËÌË"
            CntPresent = 0;
            CntPresent = CheckRedhop();
			if(CntPresent)
			{
                string msg = "«‡ ÔÓÍÛÔÍÛ ÔË‚‡ “Ã Redhop ‚Û˜‡ÂÏ ÛÔ‡ÍÓ‚ÍÛ ÍÓÎ·‡ÒÓÍ œËÍÓÎËÌË ("+Int2Str(CntPresent)+" ¯Ú.)";
                CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CARDINFO,0,CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL, (char*)msg.c_str());

                int lKeyPressed = -1;
                while (lKeyPressed !=0)
                {
                    lKeyPressed = QMessageBox::information
                    ( NULL, "APM KACCA", W2U(msg)
                    ,W2U("¬€ƒ¿“‹ œŒƒ¿–Œ "),W2U("’") ,""
                    , 1, -1);
                }

            }
//*/

/*/
// ¿ ÷»ﬂ «¿¬≈–ÿ≈Õ¿
// ¿ÍˆËˇ  ËÏ·ÂÎË: ÔË ÔÓÍÛÔÍÂ ÚÓ‚‡Ó‚  ËÏ·ÂÎË Ì‡ 750 Û·. ‚˚‰‡ÂÚÒˇ ÔÓ‰‡ÓÍ
            int CntPresentKimberly = CheckKimberly();
			if(CntPresentKimberly)
			{

                string msg = "¬˚‰‡Ú¸ Ïˇ„ÍÛ˛ Ë„Û¯ÍÛ  ËÏ·ÂÎË ("+Int2Str(CntPresentKimberly)+" ¯Ú.)";
                CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CARDINFO,0,CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL, (char*)msg.c_str());

                int lKeyPressed = -1;
                while (lKeyPressed !=0)
                {
                    lKeyPressed = QMessageBox::information
                    ( NULL, "APM KACCA", W2U(msg)
                    ,W2U("¬€ƒ¿“‹ œŒƒ¿–Œ "),W2U("’") ,""
                    , 1, -1);
                }

            }

//*/
/*
// ¿ ÷»ﬂ «¿¬≈–ÿ≈Õ¿
//
            int CntPresentBeerCup = CheckBeerCup();
			if(CntPresentBeerCup)
			{

                string msg = "¬˚‰‡Ú¸ ¡Œ ¿À ‚ œŒƒ¿–Œ ";
                CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CARDINFO,0,CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL, (char*)msg.c_str());

                int lKeyPressed = -1;
                while (lKeyPressed !=0)
                {
                    lKeyPressed = QMessageBox::information
                    ( NULL, "APM KACCA", W2U(msg)
                    ,W2U("¬€ƒ¿“‹ œŒƒ¿–Œ "),W2U("’") ,""
                    , 1, -1);
                }

            }
//*/

/*
// ¿ ÷»ﬂ «¿¬≈–ÿ≈Õ¿
           int CntPresentMonster = CheckMonster();
		   if(CntPresentMonster)
			{

                string msg = "¬˚‰‡Ú¸ ÒÍÂÚ˜-Í‡ÚÛ ‚ œŒƒ¿–Œ !";
                CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CARDINFO,0,CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL, (char*)msg.c_str());

                int lKeyPressed = -1;
                while (lKeyPressed !=0)
                {
                    lKeyPressed = QMessageBox::information
                    ( NULL, "APM KACCA", W2U(msg)
                    ,W2U("¬€ƒ¿“‹ œŒƒ¿–Œ "),W2U("’") ,""
                    , 1, -1);
                }

            }
//*/



// ¿ ÷»ﬂ
// ¿ÍˆËˇ Frigovere: ÔË ÔÓÍÛÔÍÂ ÓÔÂ‰ÂÎÂÌÌ˚ı ÚÓ‚‡Ó‚ Ì‡ 1500 Û·. ‚˚‰‡ÂÚÒˇ ÔÓ‰‡ÓÍ -  ÓÌÚÂÈÌÂ
            int CntPresentFrigovere = CheckFrigovere();
			if(CntPresentFrigovere)
			{

                string msg = "¬˚‰‡Ú¸ œŒƒ¿–Œ \n\n ÓÌÚÂÈÌÂ FRIGOVERE FUN  Û„Î˚È 800ÏÎ. ("+Int2Str(CntPresentFrigovere)+" ¯Ú.)";
                CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CARDINFO,0,CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL, (char*)msg.c_str());

                int lKeyPressed = -1;
                while (lKeyPressed !=0)
                {
                    lKeyPressed = QMessageBox::information
                    ( NULL, "APM KACCA", W2U(msg)
                    ,W2U("¬€ƒ¿“‹ œŒƒ¿–Œ "),W2U("’") ,""
                    , 1, -1);
                }

            }
//

// ¿ ÷»ﬂ «¿¬≈–ÿ≈Õ¿
/*
// ¿ ÷»ﬂ
// ¿ÍˆËˇ : ÔË ÔÓÍÛÔÍÂ Ò˚‡ -  ‰Îˇ ÍÓÎÍË Ò˚‡ ‚ ÔÓ‰‡ÓÍ
            int CntPresentCheese = CheckCheeseAction();
			if(CntPresentCheese)
			{

                string msg = "¬˚‰‡Ú¸ œŒƒ¿–Œ \n\nÕÓÊ ‰Îˇ ÍÓÎÍË Ò˚‡";
                CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CARDINFO,0,CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL, (char*)msg.c_str());

                int lKeyPressed = -1;
                while (lKeyPressed !=0)
                {
                    lKeyPressed = QMessageBox::information
                    ( NULL, "APM KACCA", W2U(msg)
                    ,W2U("¬€ƒ¿“‹ œŒƒ¿–Œ "),W2U("’") ,""
                    , 1, -1);
                }

            }
//*/


			FiscalReg->GetSmenaNumber(&(CashReg->KKMNo),&(CashReg->KKMSmena),&(CashReg->KKMTime));

			Cheque->Reduction(CashReg->KKMNo,CashReg->KKMSmena,CashReg->KKMTime,false,false);

    		if ((!IsCurrentGoodsEmpty)&&(PaymentKeyPress==0))
			{
				
                Log("= œŒƒ√Œ“Œ¬ ¿ ◊≈ ¿   Œ“¡»“»ﬁ (—∆¿“»≈, œ≈–≈—◊≈“ — »ƒŒ ) =");
				IsCurrentGoodsEmpty = true;
				CurGoods.init();
                CurrentGoods = &CurGoods;
                ActionShowMsg=true;
                //œÂÂÒ˜ÂÚ ÒÍË‰ÓÍ (ÔÓˆÂ‰Û‡ ProcessDiscount) ÂÒÚ¸ ‚ ShowGoodsInfo
				//ProcessDiscount(Cheque);

                //œÓˆÂ‰Û‡ ShowGoodsInfo ÂÒÚ¸ ‚ UpdateList
				//ShowGoodsInfo();

                
				UpdateList();
				return;
				/*
				if (AppendRecord2Check())//add last goods to cheque
    				ProcessDiscount(Cheque);
				return;
				*/
			}
			UpdateList();

            Log("= Œ“¡»“»≈ ◊≈ ¿ = ");


            // —Ú‡ÚÛÒ EGAIS
            // -1 - ÌÂ ·˚ÎÓ ÔÓ‚ÂÍË
            // 0 - ÔÓ‚ÂÍ‡ ÔÓÈ‰ÂÌ‡ ÛÒÔÂ¯ÌÓ, ÔÓÎÛ˜ÂÌ ÒÎËÔ
            // 1 - ÔÓ‚ÂÍ‡ ÔÓ¯Î‡ Ò Ó¯Ë·ÍÓÈ, ÎË·Ó ÌÂ ÔÓÎÛ˜ÂÌ ÓÚ‚ÂÚ, ÔÂ˜‡Ú¸ ˜ÂÍ‡ ÌÂ‚ÓÁÏÓÊÌ‡
            int StatusEGAIS = -1;

			//if (PaymentKeyPress==0)
			{
				//if (EditLine->text().isEmpty())
				{//·ÂÁ Ò‰‡˜Ë
					int res;
					bool oldscanersuspend = Scanner->suspend;
					Scanner->suspend = true;
					if (CashReg->Cashless)//CashReg->CurrentSaleman->Cashless)
					{
					
						if(PaymentType == ShiftDown || EditLine->shift || AltFinal)
						{
							PaymentTypeForm *dlg = new PaymentTypeForm(this);
							res=dlg->exec();

							PaymentType=dlg->PaymentType;
							delete dlg;
						}
						else
						{
							PaymentType = CashPayment;
							res=QDialog::Accepted;
						}
					}
					else
					{					
						res=QDialog::Accepted;
						PaymentType=CashPayment;
					}

					if (res==QDialog::Accepted)//ask for the type of payment
					{
						if (PaymentType==CertificatePayment)
						{
							if (!CashReg->CurrentSaleman->Discounts)
							{
								ShowMessage("ŒÚÒÛÚÒÚ‚Û˛Ú Ô‡‚‡ Ì‡ ÔÂ‰ÓÒÚ‡‚ÎÂÌËÂ ÒÍË‰ÍË!");
								return;
							}

							Log("Payment type is Certificate");
							PaymentForm *dlg = new PaymentForm(this);
							res=dlg->exec();

							delete dlg;
							Log("–‡Ò˜ËÚ˚‚‡ÂÏ ÒÍË‰ÍË");
							ProcessDiscount(Cheque);
							ShowGoodsInfo();

                            Scanner->suspend = false;

							return;

						}

//						if (PaymentType==CashPayment)
//						{
//							FiscalReg->OpenDrawer();//close check
//						}

						if (PaymentType==BankBonusPayment)
						{

						    ProcessBonusDiscount(CurrentCustomer);

                            Scanner->suspend = false;
//===== 2015-11-20 ======= «‡‚Â¯‡ÂÏ ÔÓ„‡ÏÏÛ —Ô‡ÒË·Ó ÓÚ 22.11.2015 ========
/*
//                            if (OnlyCashlessMode)
//                            {
//                            //ÂÒÎË ˜ÂÍ ‚ÓÒÒÚ‡ÌÓ‚ÎÂÌ Ò ·ÓÌÛÒ‡ÏË, ÚÓ ÔÓ‚ÚÓÌÓ ÒÔËÒ˚‚‡Ú¸ ÌÂ ‰‡ÂÏ
//                               EditLine->ctrl=true;
//                               ProcessKey(4100);
//                               return
//                            }

                            //! +ÚÂÒÚ


//                        // + œÓ‚ÚÓÌÓÂ ÒÌˇÚËÂ ·ÓÌÛÒÓ‚
//                        SumForm *dlg = new SumForm(this);//show simple dialog and get check's number
//                        dlg->FormCaption->setText(W2U("ÕÓÏÂ ˜ÂÍ‡"));
//
//                        int res=dlg->exec();
//
//                        QString s = dlg->LineEdit->text();
//                        string LogStr = " = œŒ¬“Œ–ÕŒ≈ —œ»—¿Õ»≈ ¡ŒÕ”—Œ¬ —¡≈–¡¿Õ ¿ ◊≈  # "+U2W(s)+ " =";
//
//                        Log((char*)LogStr.c_str());
//
//                        delete dlg;
//
//                        int depart;
//
//                        int retcheck = s.toInt();
//                        // - œÓ‚ÚÓÌÓÂ ÒÌˇÚËÂ ·ÓÌÛÒÓ‚
//                        if (retcheck)
//                        {
//                            string StrCard="000"; // "<ÌÓÏÂ Í‡Ú˚>";
//                            string CardSHA1 = "E6188F13ED6A057C1692D75C1403D85C86CE7947"; //"<ıÂ¯ Í‡Ú˚>";
//                            ProcessBankBonusDiscount(StrCard, CardSHA1);
//                        }
//                        else
//                        {
                            //! + ŒË„ËÌ‡Î
                            CashReg->pCR->BankBonusDiscount();
                            //! - ŒË„ËÌ‡Î
//                        }
                              //  ;;double val=155;
                              //;;CashReg->AddPayment(11,"TEST",&val);
                            //!- ÚÂÒÚ

                             ShowGoodsInfo();
*/
//===== 2015-11-20 ======= «‡‚Â¯‡ÂÏ ÔÓ„‡ÏÏÛ —Ô‡ÒË·Ó ÓÚ 22.11.2015 ========

                           return;
						}

                        //«‡ÔÓÏÌËÏ ÒÛÏÏÛ ˜ÂÍ‡ ‰Ó ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚
                        double OldSum = Cheque->GetSumToPay();

                        // ¡ŒÕ”—€. »ÌËˆË‡ÎËÁ‡ˆËˇ Ë ÒÔËÒ‡ÌËÂ (ÓÔˆËÓÌ‡Î¸ÌÓ)
                        ProcessBonusDiscount(CurrentCustomer);
                        //
                        bool PaymentType_CashlessPayment = (PaymentType == CashlessPayment);

#ifndef _WS_WIN_
						if(PaymentType == CashlessPayment)
						{

                            FiscalCheque::PayBank = true;
//;;Log("+ ShowGoodsInfo #1 ");
                            ShowGoodsInfo();
//;;Log("- ShowGoodsInfo #1 ");
                            FiscalCheque::PayBank = false;

							//CardTypeDialog
							QStringList l, al;
							l += W2U("¡ÂÁ ÓÔÎ‡Ú˚");
							al += W2U("¡ÂÁ ÓÔÎ‡Ú˚");
							//int t[] = {0,1,2,3,9,10,11,-1};
							int t[] = {CL_NOPAY,CL_VISA,CL_MASTERCARD,CL_MAESTRO,CL_SBERCARD,CL_VISA_GZ,CL_MASTERCARD_GZ,CL_CITYCARD};
							int at[] = {CL_NOPAY,CL_VISA,CL_MASTERCARD,CL_MAESTRO,CL_SBERCARD,CL_VISA_GZ,CL_MASTERCARD_GZ,CL_CITYCARD};
							int set = 1;
							if(CashReg->CardReaderType & VFCR || CashReg->CardReaderType & VFUP){//
								al += "Visa";
								al += "Eurocard/Mastercard";
								al += "Cirrus/Maestro";
								al += W2U("—¡≈– ¿–“");

								//set = 2;

                                //*
								l += W2U("—·Â·‡ÌÍ");
								//l += W2U(" -> —¡≈– ¿–“");

                                //t[l.count()-1] = CL_SBERCARD;
								t[l.count()-1] = CL_SBERBANK;

                                //*/
                                /*
                                //! ÔÓÎÌ˚È ÒÔËÒÓÍ Í‡Ú
								l += "Visa";
								l += "Eurocard/Mastercard";
								l += "Cirrus/Maestro";
								l += W2U("—¡≈– ¿–“");
                                //*/
							}
							if(CashReg->CardReaderType & EGCR){//
								al += W2U("Visa (√‡ÁÔÓÏ·‡ÌÍ)");
								al += W2U("Mastercard / Maestro (√‡ÁÔÓÏ·‡ÌÍ)");
								//set += 1;
								at[al.count()-1] = CL_MASTERCARD_GZ;
								at[al.count()-2] = CL_VISA_GZ;

								l += W2U("√‡ÁÔÓÏ·‡ÌÍ");
								t[l.count()-1] = CL_GAZPROMBANK;
							}
							if(CashReg->CardReaderType & CCCR){
                                al += "CityCard/IzhCard";
                                at[al.count()-1] = CL_CITYCARD;

								l += "CityCard/IzhCard";
								t[l.count()-1] = CL_CITYCARD;
								//if(!(CashReg->CardReaderType & VFCR || CashReg->CardReaderType & VFUP || CashReg->CardReaderType & EGCR))
									//t[1] = -1;
							}
							if(CashReg->CardReaderType & VTBCR){
								al += W2U("Visa (¬“¡24)");
								al += W2U("Mastercard (¬“¡24)");
								al += W2U("Maestro (¬“¡24)");
								//set += 1;
								at[al.count()-1] = CL_MAESTRO_VTB;
								at[al.count()-2] = CL_MASTERCARD_VTB;
								at[al.count()-3] = CL_VISA_VTB;

								l += W2U("¬“¡24");
								t[l.count()-1] = CL_VTB24;
								//if(!(CashReg->CardReaderType & VFCR || CashReg->CardReaderType & VFUP || CashReg->CardReaderType & EGCR))
									//t[1] = -1;

                                // œÓ ÛÏÓÎ˜‡ÌË˛ ¬“¡
//								set = l.count()-1;

                                // œÓ ÛÏÓÎ˜‡ÌË˛ —·Â·‡ÌÍ
								set = 1;
							}

							//t[l.count()] = -1;

							bool ok;//
							QString s = QInputDialog::getItem("APM KACCA",
								W2U("¬˚·ÂËÚÂ ÚËÔ Í‡Ú˚"),l,set,false,&ok);
							if (!ok) //
                            {

                                ShowGoodsInfo();
                                Scanner->suspend = false;

								return;//
                            }
							int i = l.findIndex(s);
							if(i == -1){

								ShowGoodsInfo();
								Scanner->suspend = false;

								return;
							}

                            Log("¬˚·Ó ·‡ÌÍÓ‚ÒÍÓÈ Í‡Ú˚: "+U2W(s)+" /"+Int2Str(t[i])+"/ ");



							if(!i){
							    // ¡ÂÁ ÓÔÎ‡Ú˚
								if(!ShowQuestion("¬˚ Û‚ÂÂÌÌ˚, ˜ÚÓ ÓÔÎ‡Ú‡ ÛÊÂ ÔÓËÁ‚Â‰ÂÌ‡?", false)){// , ÚÓ "¡ÂÁ ÓÔÎ‡Ú˚"
									ShowGoodsInfo();
									Scanner->suspend = false;
									return;
								}

								Log(">> œÓ‰‡Ê‡ ¡≈« ÓÔÎ‡Ú˚....");

								int GuardRes = NotCorrect;//{
								Scanner->suspend = false;
								while(!CheckGuardCode(GuardRes));
								Scanner->suspend = true;//}
								l[0] = W2U("ŒÚÏÂÌ‡");
								al[0] = W2U("ŒÚÏÂÌ‡");
								s = QInputDialog::getItem("APM KACCA",
									W2U("¬˚·ÂËÚÂ ÚËÔ Í‡Ú˚, ÍÓÚÓ˚Ï ÔÓËÁ‚Â‰ÂÌ‡ ÓÔÎ‡Ú‡."),al,set,false,&ok);
								if (!ok) //
								{
								    ShowGoodsInfo();
								    Scanner->suspend = false;
									return;//
								}
								int ii = al.findIndex(s);
								if(!ii)
								{
								    ShowGoodsInfo();
								    Scanner->suspend = false;
									return;
								}
								PaymentType = at[ii];
								// ◊ÂÍ ·ÂÁ ÓÔÎ‡Ú˚ (‚ ÎÓ„)
								CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CL_AGAIN,Cheque->GetSum(),CashReg->CurrentSaleman->Id,-1);

                                // œÂÂÒ˜ÂÚ ÒÍË‰ÓÍ ·ÂÁ ÓÍÛ„ÎÂÌËˇ ÍÓÔÂÂÍ
								FiscalCheque::PayBank = true;
								ShowGoodsInfo();
								FiscalCheque::PayBank = false;
							} // ¡ÂÁ ÓÔÎ‡Ú˚
							else
							{   // + dms ==== 2009-10-21 ==== ÚÂÒÚ Ò‚ˇÁË Ò ÒÂ‚ÂÓÏ ·‡ÌÍ‡
							    if ((CashReg->TryBankConnect)
							    &&(t[i] > 0)
							    &&(t[i]!=CL_GAZPROMBANK)) // ÂÒÎË ÌÛÊÌÓ ÔÓ‚ÂˇÚ¸ Ë ˝ÚÓ ÌÂ CityCard
							    {
							        Log("Test bank connection ...");
                                    CashReg->TestBankConnection(0, 1);
                                    if (!CashReg->StatusBankConnection)
                                    {
                                        ShowMessage("ÕÂÚ Ò‚ˇÁË Ò ·‡ÌÍÓÏ: ŒÔÎ‡Ú‡ ·ÂÁÌ‡ÎË˜Ì˚Ï ‡Ò˜ÂÚÓÏ ÌÂ‚ÓÁÏÓÊÌ‡!");

                                        // ŒÚÏÂÌ‡ ·ÓÌÛÒÓ‚
                                        ProcessBonusDiscountReverse();

                                        ShowGoodsInfo();

                                        Scanner->suspend = false;
                                        return;
                                    }
                                }
                                // - dms
                                Log(">> Cashless Pay....");
                                PaymentType = t[i];

                                if (StatusEGAIS==-1){
                                    Log("= œ–Œ¬≈– ¿ ≈√¿»— (¡ÂÁÌ‡Î) = ");
                                    StatusEGAIS = CashReg->CheckEGAIS(Cheque);
                                    if (StatusEGAIS)
                                    {
                                        ShowMessage("Œ¯Ë·Í‡ ÔÓ‚ÂÍË ˜ÂÍ‡ ‚ ≈√¿»—!");

                                        // ŒÚÏÂÌ‡ ·ÓÌÛÒÓ‚
                                        ProcessBonusDiscountReverse();
                                        // ÔÂÂÒ˜ÂÚ ÒÍË‰ÓÍ
                                        ShowGoodsInfo();

                                        Scanner->suspend = false;
                                        return;
                                    }
                                }

                                if(CashReg->pCR->Pay(Double2Int(Cheque->GetSumToPay() * 100), PaymentType, CashReg->GetLastCheckNum()+1))
                                {
                                    // Ó¯Ë·Í‡ ·ÂÁÌ‡ÎË˜ÌÓ„Ó ‡Ò˜ÂÚ‡

                                    Log("   ....ERROR");


                                    // ŒÚÏÂÌ‡ ÔÓÒÎÂ‰ÌÂÈ ÓÔÂ‡ˆËË ÔÓ‚ÂÍË ≈√¿»—
                                    CashReg->CheckEGAIS(Cheque, true, true);
                                    StatusEGAIS=-1; // Ó·ÌÛÎˇÂÏ ÙÎ‡„ ÔÓ‚ÂÍË, Ú.Í. ÌÛÊÌ‡ ÔÓ‚ÚÓÌ‡ˇ ÔÓ‚ÂÍ‡ ≈√¿»—
                                    //

                                    // ŒÚÏÂÌ‡ ·ÓÌÛÒÓ‚
                                    ProcessBonusDiscountReverse();
                                    //
                                    ShowGoodsInfo(); // ÔÂÂÒ˜ÂÚ ÒÍË‰ÓÍ

                                    Scanner->suspend = false;
                                    return;
                                }

                                Log("   ....SUCCESS");
							}
						}//CashLess

#endif

                        // + EGAIS
                        if (StatusEGAIS==-1){
                            Log("œ–Œ¬≈– ¿ ≈√¿»— (Ì‡ÎË˜Ì˚Â)");
                            StatusEGAIS = CashReg->CheckEGAIS(Cheque);
                            if (StatusEGAIS)
                            {
                                ShowMessage("Œ¯Ë·Í‡ ÔÓ‚ÂÍË ˜ÂÍ‡ ‚ ≈√¿»—!");

                                // ŒÚÏÂÌ‡ ·ÓÌÛÒÓ‚
                                ProcessBonusDiscountReverse();
                                // ÔÂÂÒ˜ÂÚ ÒÍË‰ÓÍ
                                ShowGoodsInfo();

                                Scanner->suspend = false;
                                return;
                            }
                        }
                        // - EGAIS
                        FullSum=0;
                        double RestSum=-1;

                        if(!PaymentType_CashlessPayment)
                        { // ŒÔÎ‡Ú‡ Ì‡ÎË˜Ì˚ÏË
                          // ¡ÓÌÛÒ˚ ÛÊÂ ÒÔËÒ‡Ì˚, ˜ÂÍ ÔÂÂÒ˜ËÚ‡Ì, ÌÛÊÌÓ ÔÓÒÚÓ ÔÓÍ‡Á‡Ú¸ ÌÓ‚Û˛ ÒÛÏÏÛ Ë ÓÍÌÓ ‚‚Ó‰‡ Ì‡ÎË˜Ì˚ı

                            Log("= ŒœÀ¿“¿ Õ¿À»◊Õ€Ã» = ");
                            {
                                // ≈ÒÎË ÒÛÏÏ‡ ˜ÂÍ‡ ËÁÏÂÌËÎ‡Ò¸ (ÒÔËÒ‡Ì˚ ·ÓÌÛÒ˚"
                                // ÚÓ ÌÛÊÌÓ Á‡ÌÓ‚Ó ‚‚ÂÒÚË ÒÛÏÏÛ Ì‡ÎË˜Ì˚ı

                                Log("—ÛÏÏ‡ ˜ÂÍ‡ ("+Double2Str(RoundToNearest(Cheque->GetSum(),0.01))+")");
                                if (FiscalCheque::PrePayCertificateSumm > 0)
                                {
                                    Log("—ÛÏÏ‡ ˜ÂÍ‡ Í ÓÔÎ‡ÚÂ("+Double2Str(RoundToNearest(Cheque->GetSumToPay(),0.01))+")");
                                }
                                Log("¬‚Â‰ÂÌ‡ ÒÛÏÏ‡ Í ÓÔÎ‡ÚÂ ("+U2W(EditLine->text())+")");

                                bool NeedEnterPaySum=false;

                                if (EditLine->text()!="")
                                {
                                    bool err;
                                    FullSum = EditLine->text().toDouble(&err);

                                    if ((!err) || (FullSum>10000000))  //calculate change
                                    {
                                        ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓ ÛÍ‡Á‡Ì‡ ÔÓÎÛ˜ÂÌÌ‡ˇ ÒÛÏÏ‡!");
                                        EditLine->setText("");
                                        NeedEnterPaySum=true;

                                        FullSum=0; RestSum=-1;
                                    }
                                    else
                                        if (FullSum>0)
                                        {
                                            // ‚‚Â‰ÂÌ‡ ÒÛÏÏ‡ Ì‡ÎË˜Ì˚ı
                                            RestSum=RoundToNearest(FullSum-Cheque->GetSumToPay(),0.01);

                                            if (RestSum<-0.0015)
                                            {
                                                ShowMessage("œÓÎÛ˜ÂÌÌ‡ˇ ÒÛÏÏ‡ ÒÎË¯ÍÓÏ Ï‡Î‡!");
                                                NeedEnterPaySum=true;

                                                FullSum=0; RestSum=-1;
                                            }

                                         }
                                }

                                if (OldSum - Cheque->GetSumToPay() > 1){
                                    NeedEnterPaySum=true;
                                }

                                if (NeedEnterPaySum)
                                {

                                    Log("ÕÛÊÌÓ ‚‚ÂÒÚË ÒÛÏÏÛ Ì‡ÎË˜Ì˚ı ÔÓ‚ÚÓÌÓ");

                                    SumForm *dlg = new SumForm(this);
                                    dlg->FormCaption->setText(W2U("¬‚Â‰ËÚÂ ÒÛÏÏÛ Ì‡ÎË˜Ì˚ı"));

                                    dlg->LineEdit->setText(EditLine->text());

                                    for(;;)
                                    {
                                        ;;Log(" -> ƒË‡ÎÓ„ ‚‚Ó‰‡ ÒÛÏÏ˚ <- ");
                                        if (dlg->exec() == QDialog::Accepted)
                                        {

                                            Log(" -> ¬‚Â‰ÂÌ‡ ÒÛÏÏ‡ ("+U2W(EditLine->text())+")");

                                            if (dlg->LineEdit->text()=="")
                                            {
                                                Log("¬‚Â‰ÂÌ ÌÓÎ¸ Í ÓÔÎ‡ÚÂ");
                                                FullSum=0;  RestSum=-1;

                                                break;
                                            }

                                            bool err;
                                            FullSum = dlg->LineEdit->text().toDouble(&err);

                                            if ((!err) || (FullSum>10000000))  //calculate change
                                            {
                                                ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓ ÛÍ‡Á‡Ì‡ ÔÓÎÛ˜ÂÌÌ‡ˇ ÒÛÏÏ‡!");
                                                continue;
                                            }

                                            if (FullSum>0)
                                            {
                                                // ‚‚Â‰ÂÌ‡ ÒÛÏÏ‡ Ì‡ÎË˜Ì˚ı
                                                RestSum=RoundToNearest(FullSum-Cheque->GetSumToPay(),0.01);

                                                if (RestSum<-0.0015)
                                                {
                                                    ShowMessage("œÓÎÛ˜ÂÌÌ‡ˇ ÒÛÏÏ‡ ÒÎË¯ÍÓÏ Ï‡Î‡!");
                                                    continue;
                                                }

                                             }
                                        }
                                        else
                                        {
                                            Log("Õ‡Ê‡Ú‡ ÍÌÓÔÍ‡ ÓÚÍ‡Á‡ ÓÚ ‚‚Ó‰‡ ÔÓÎÛ˜ÂÌÌÓÈ ÒÛÏÏ˚ Ì‡ÎË˜Ì˚ı");
                                            FullSum=0;
                                            RestSum=-1;
                                        }

                                        ;;Log(" -> ¬˚ıÓ‰ <- ");
                                        break;
                                    }

                                    delete dlg;
                                }


                                if ((FullSum>0) && (RestSum>=0))
                                {
                                    ;;Log("= —ƒ¿◊¿ = ");

;;Log("FullSum="+Double2Str(FullSum));
;;Log("RestSum="+Double2Str(RestSum));

                                   // ÓÚÓ·‡ÁËÏ Ò‰‡˜Û Ì‡ ˝Í‡ÌÂ
                                    CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,PAY,FullSum,CashReg->CurrentSaleman->Id,-1);

                                    CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,PAYBACK,RestSum,CashReg->CurrentSaleman->Id,-1);

                                    MTotalChange->setText(GetRounded(RestSum,0.01).c_str());

                                    lbTotalChange->show();
                                    MTotalChange->show();

                                    lbTotalSum->hide();
                                    MTotalSum->hide();

                                    MTotalChange->repaint();
                                    MTotalSum->repaint();

                                    ShowMessage("");
                                    //thisApp->processEvents();

                                    CustomerDisplay->DisplayLines("",("—‰‡˜‡ "+GetRounded(RestSum,0.01)).c_str());
                                    PaymentKeyPress=1;
                                    PaymentType=CashPayment;
                                    EditLine->clear();


                                }


                            }
                        } // Ì‡ÎË˜Ì˚ÏË (ÒÓ Ò‰‡˜ÂÈ ËÎË ·ÂÁ)

                        /* slair+ */

#ifndef PRINTPAPPER
                        dont_print_paper_check = true;
#else
                        dont_print_paper_check = false;
#endif

                        char no_print;
                        if (dont_print_paper_check) {
                            ;;Log("!= ·ÂÁ ÔÂ˜‡ÚË ·ÛÏ‡ÊÌÓ„Ó ˜ÂÍ‡");
                            no_print=1;
                            FiscalReg->SetTable(17,1,7,&(no_print=1),1,false);
                        } else {
                            ;;Log("!= Ò ÔÂ˜‡Ú¸˛ ·ÛÏ‡ÊÌÓ„Ó ˜ÂÍ‡");
                            no_print=0;
                            FiscalReg->SetTable(17,1,7,&(no_print=0),1,false);
                        }
                        /* slair- */

                        Log("= «¿ –€“»≈ ◊≈ ¿ = ");

                        if (PaymentType==CashPayment)
                            FiscalReg->OpenDrawer();//close check with the change

;;Log("=> Õ‡˜‡ÎÓ ÓÚ·ËÚËˇ ˜ÂÍ‡ #"+Int2Str(CashReg->GetLastCheckNum()+1));


        CashReg->DeletePrepayExcess(Cheque);
        CashReg->AddPrepayExcess(Cheque);


						CashReg->m_vem.Calc(Cheque->GetCalcSum(),Cheque->GetDiscountSum(), PaymentType ? 2 : 1);

						CashReg->AddSalesToReg(Cheque);
						CashReg->AddPaymentToReg();
						//Saleman *CurSaleman;


						CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,STARTCHECK,Cheque->GetSum(),CashReg->GetCashmanCode(),0);//


                        ;;Log(" ===> Õ‡˜‡ÎÓ GetCheckHeader");
                        string strCheckHeader = CashReg->GetCheckHeader();
                        ;;Log(" ===>  ÓÌÂˆ GetCheckHeader");

                        ;;Log(" ===> Õ‡˜‡ÎÓ GetCheckEgaisHeader");
                        string strCheckEGAIS = CashReg->GetCheckEgaisHeader();
                        ;;Log(" ===>  ÓÌÂˆ GetCheckEgaisHeader");

                        CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,STARTPRINTCHECK,Cheque->GetSum(),CashReg->CurrentSaleman->Id,0);//
                        ;;Log(" ===> Õ‡˜‡ÎÓ ÔÂ˜‡ÚË ˜ÂÍ‡");
						int er = FiscalReg->Close(
							 Cheque->GetSum()
							,(FullSum>epsilon) ? FullSum : Cheque->GetSumToPay()
							,Cheque->GetDiscountSum()
							,!frSound ? CashReg->GetCashRegisterNum() : -1*CashReg->GetCashRegisterNum()
							,CashReg->GetLastCheckNum()+1
							,PaymentType
							,Cheque->GetCustomerCode()
							,CashReg->CurrentSaleman->Name
							,strCheckHeader
							,CashReg->GetCheckFutter(Cheque->GetSum())
							,IsHandDiscounts()
							,strCheckEGAIS
                            ,Cheque->egais_url
                            ,Cheque->egais_sign
                            ,CashReg->EgaisSettings.ModePrintQRCode
							);
                        ;;Log(" ===>  ÓÌÂˆ ÔÂ˜‡ÚË ˜ÂÍ‡");
                        CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,FINISHCHECK,Cheque->GetSum(),CashReg->CurrentSaleman->Id,0,"",(char*)Int2Str(er).c_str(),"",(char*)FiscalReg->GetErrorStr(er,0).c_str());//

                        if(er==0x6B) // ÕÂÚ ˜ÂÍÓ‚ÓÈ ÎÂÌÚ˚
                        {
                            Log("ERROR: Õ≈“ ◊≈ Œ¬Œ… À≈Õ“€!");
                           // ŒÚÏÂÌ‡ ÔÓÒÎÂ‰ÌÂÈ ÓÔÂ‡ˆËË ÔÓ‚ÂÍË ≈√¿»—
                            CashReg->CheckEGAIS(Cheque, true, true);
                            StatusEGAIS=-1; // Ó·ÌÛÎˇÂÏ ÙÎ‡„ ÔÓ‚ÂÍË, Ú.Í. ÌÛÊÌ‡ ÔÓ‚ÚÓÌ‡ˇ ÔÓ‚ÂÍ‡ ≈√¿»—
                            //
                        }

                        ;;Log(" ===> Õ‡˜‡ÎÓ ÙËÍÒ‡ˆËË ·ÓÌÛÒÓ‚");
                        // ‘ËÍÒ‡ˆËˇ ÔÓÍÛÔÍË ‚ œ÷ ·ÓÌÛÒÓ‚
//                        clock_t start, end;
//                        start = clock();
//                        time_t start, end;
//                        time(&start);
                        struct timeval start, end;
                        gettimeofday(&start, NULL);
                        ProcessBonusFix(CurrentCustomer);
//                        end = clock();
//                        double duration_sec = double(end-start)/CLOCKS_PER_SEC;
//                        time(&end);
//                        double duration_sec = difftime(end, start);
                        gettimeofday(&end, NULL);
                        double duration_sec = ((end.tv_sec * 1000000 + end.tv_usec) -
                                               (start.tv_sec * 1000000 + start.tv_usec))/1000000.0;
                        Log("ProcessBonusFixDuration: " + Double2Str(duration_sec) + " sec.");
                        ;;Log(" ===>  ÓÌÂˆ ÙËÍÒ‡ˆËË ·ÓÌÛÒÓ‚");

                        ;;Log("=>  ÓÌÂˆ ÓÚ·ËÚËˇ ˜ÂÍ‡ #"+Int2Str(CashReg->GetLastCheckNum()+1));

						CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,SELL,Cheque->GetSum(),CashReg->CurrentSaleman->Id,-1);

						CashReg->m_vem.Sell(Cheque->GetCalcSum(),Cheque->GetDiscountSum(), PaymentType ? 2 : 1);
						CashReg->m_vem.Pay(Cheque->GetCalcSum(),Cheque->GetDiscountSum(), PaymentType ? 2 : 1, Cheque->GetSum(),0);

						Scanner->suspend = false;

						if (er!=0)
						{
							FullSum=0;
							PaymentKeyPress=1;
						}

						CashReg->ProcessRegError(er);

						SetPaymentType(Cheque,PaymentType);

						CashReg->FixCheque(Cheque);
						CashReg->SavePaymentFromReg();

						IsChequeInProgress=false;

//! «‡ÏÂÌ‡ Í‡Ú
                        CashReg->ChangeBonusCard(CurrentCustomer);
//! «‡ÏÂÌ‡ Í‡Ú

//! «‡ÏÂÌ‡ Í‡Ú Ì‡ VIP
                        if(NeedChangeCard2SuperVIP)
                        {
                            CashReg->ChangeBonusCard2Vip(CurrentCustomer, CD_SUPER_VIP);
                        }
                        else
                        {
                            if(NeedChangeCard2VIP)
                            {
                                CashReg->ChangeBonusCard2Vip(CurrentCustomer, CD_VIP);
                            }
                        }

//! «‡ÏÂÌ‡ Í‡Ú Ì‡ VIP

						//!!!InitWorkPlace();
						RestartTimerSS(true);
                        InfoMessage->setText(W2U("*"));
                        InfoCLPay->setText(W2U("ŒƒŒ¡–≈ÕŒ"));

						PaymentKeyPress=0;
						AutoRestoreKeepedCheque();

						FiscalReg->GetSmenaNumber(&(CashReg->KKMNo),&(CashReg->KKMSmena),&(CashReg->KKMTime));

					} // Accepted

//					Scanner->suspend = false;
//					return;
				}
			
                Scanner->suspend = false;
                return;

/*
				//ÒÓ Ò‰‡˜ÂÈ
				bool err;

				FullSum=EditLine->text().toDouble(&err);

				if (!err)   //calculate change
				{
					ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓ ÛÍ‡Á‡Ì‡ ÔÓÎÛ˜ÂÌÌ‡ˇ ÒÛÏÏ‡!");
					PaymentKeyPress=0;
					return;
				}

				double RestSum=FullSum-Cheque->GetSum();

				if (RestSum>=0)
				{

                    CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,PAY,FullSum,CashReg->CurrentSaleman->Id,-1);

					CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,PAYBACK,RestSum,CashReg->CurrentSaleman->Id,-1);

					MTotalChange->setText(GetRounded(RestSum,0.01).c_str());

					lbTotalSum->hide();
					MTotalSum->hide();

					lbTotalChange->show();
					MTotalChange->show();

					CustomerDisplay->DisplayLines("",("—‰‡˜‡ "+GetRounded(RestSum,0.01)).c_str());
					PaymentKeyPress=1;
					PaymentType=CashPayment;
					EditLine->clear();

					return;
				}
				ShowMessage("œÓÎÛ˜ÂÌÌ‡ˇ ÒÛÏÏ‡ ÒÎË¯ÍÓÏ Ï‡Î‡!");
				PaymentKeyPress=0;
				return;
*/

			} // PaymentKeyPress==0

			if (false && PaymentKeyPress==1)
			{
// «‡Í˚‚‡ÂÏ ˝ÚÛ ‚ÂÚÍÛ Í‡Í ÌÂÌÛÊÌÛ˛

        ;;Log("POINT_ PaymentKeyPress==1 ");


               // + EGAIS
                if (StatusEGAIS==-1){
                    StatusEGAIS = CashReg->CheckEGAIS(Cheque);
                    if (StatusEGAIS)
                    {
                        ShowMessage("Œ¯Ë·Í‡ ÔÓ‚ÂÍË ˜ÂÍ‡ ‚ ≈√¿»—!");
                        return;
                    }
                }

			    CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,SELL,Cheque->GetSum(),CashReg->CurrentSaleman->Id,-1);

				if (PaymentType==CashPayment)
					FiscalReg->OpenDrawer();//close check with the change
				CashReg->m_vem.Calc(Cheque->GetCalcSum(),Cheque->GetDiscountSum(), PaymentType ? 2 : 1);
				CashReg->AddSalesToReg(Cheque);
				CashReg->AddPaymentToReg();

				CashReg->ProcessRegError(
					FiscalReg->Close(
                        Cheque->GetSum()
						,(FullSum>epsilon) ? FullSum : Cheque->GetSumToPay()
						,Cheque->GetDiscountSum()
						,!frSound ? CashReg->GetCashRegisterNum() : (-1*CashReg->GetCashRegisterNum())
						,CashReg->GetLastCheckNum()+1
						,PaymentType
						,Cheque->GetCustomerCode()
						,CashReg->CurrentSaleman->Name
						,CashReg->GetCheckHeader()
						,CashReg->GetCheckFutter(Cheque->GetSum())
						,IsHandDiscounts()
						,CashReg->GetCheckEgaisHeader()
						,Cheque->egais_url
                        ,Cheque->egais_sign
                        ,CashReg->EgaisSettings.ModePrintQRCode
					)
				);

                // Õ‡˜ËÒÎÂÌËÂ ·ÓÌÛÒÓ‚

				ProcessBonusFix(CurrentCustomer);


				CashReg->m_vem.Sell(
					Cheque->GetCalcSum()
					,Cheque->GetDiscountSum()
					,PaymentType ? 2 : 1
				);
				CashReg->m_vem.Pay(
					Cheque->GetCalcSum()
					,Cheque->GetDiscountSum()
					,PaymentType ? 2 : 1
					,FullSum
					,FullSum-Cheque->GetSum()
				);

				SetPaymentType(Cheque,PaymentType);

				CashReg->FixCheque(Cheque);
				CashReg->SavePaymentFromReg();

				IsChequeInProgress=false;
				PaymentKeyPress=0;
				//!!!InitWorkPlace();
				RestartTimerSS(true);
				InfoMessage->setText(W2U("*"));

				AutoRestoreKeepedCheque();

				return;
			}
		}//if (CompareKey(Key,FINALIZE))

		if (CompareKey(Key,ANNUL))//annul opened check
		{
		    Log("PressKey>> ANNUL");
			if (!EditLineCheck(""))
				return;

			if (ShowQuestion("¿ÌÌÛÎËÓ‚‡Ú¸ ˜ÂÍ?",false))
			{
				int GuardRes=NotCorrect;   //check guard id
				if ((!CashReg->CurrentSaleman->Annul)&&(!CheckGuardCode(GuardRes)))
					return;

				CashReg->ProcessRegError(FiscalReg->Cancel());//annul cheque
				IsChequeInProgress=false;
				CashReg->AnnulCheck(Cheque,GuardRes);
				IsChequeInProgress=false;
				InitWorkPlace();
				AutoRestoreKeepedCheque();

				FiscalReg->GetSmenaNumber(&(CashReg->KKMNo),&(CashReg->KKMSmena),&(CashReg->KKMTime));
			}
			return;
		}

		if (CompareKey(Key,GROUPCODE))//process key attached to some goods group
		{
			CashReg->DbfMutex->lock();
			string code=CashReg->KeyboardTable->GetStringField("NAME");
			CashReg->DbfMutex->unlock();
			EditLine->setText(code.substr(strlen(GROUPCODE),code.length()-strlen(GROUPCODE)).c_str());
			LookingForGoods(GroupFilter);
			EditLine->clear();
		}

		if (CompareKey(Key,OPENDRAWER)){
		    Log("PressKey>> OPENDRAWER");
			//CashReg->LoggingAction(0,CASHBOX,0,CashReg->CurrentSaleman->Id,-1);
			CashReg->m_vem.OpenMoney();
			FiscalReg->OpenDrawer();
		}

		if (CompareKey(Key,MESSAGE))
		{
		    Log("PressKey>> MESSAGE");
            RunMessager();
		}

		if (CompareKey(Key,CHANGEBONUSCARD))
		{
		    Log("PressKey>> CHANGEBONUSCARD");
            CashReg->ChangeBonusCard(-1);
		}


		if (CompareKey(Key,SEARCHBYPHONE))
		{
		    Log("PressKey>> SEARCHBYPHONE");
			int SearchDiscountMode;
			string discount;

            string phone = U2W(EditLine->text());

;;Log("œÓËÒÍ Í‡Ú˚. ¬‚Â‰ÂÌ ÌÓÏÂ:"+phone);

            if ((phone.length()==10) && (phone.substr(0,1)=="9")) phone = "7"+phone;
            if (phone.substr(0,1)=="8") phone = "7"+phone.substr(1);
            if (phone.length()!=11)
            {
			    ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓ ‚Â‰ÂÌ ÌÓÏÂ ÚÂÎÂÙÓÌ‡! ¬‚Â‰ËÚÂ ÌÓÏÂ ‚ ÙÓÏ‡ÚÂ 89’’’’’’’’’");
                return;
            }

			long long number=0LL;

			int res = CashReg->GetBonusCardByPhone(phone, &number);


			if (res==1)
			{
			    ShowMessage(" ‡Ú‡ ÌÂ Ì‡È‰ÂÌ‡!");
                return;
			}
			else
			{
                if (res==0) CustomerByPhone=true;
			}


//            EditLine->setText(W2U(LLong2Str(number)));
            SearchDiscountMode=FindFromScaner;

            int resDisc = SearchDiscount(SearchDiscountMode,&discount,&number);
            ;;Log("œÓËÒÍ Í‡Ú˚.  Ó‰ ÓÚ‚ÂÚ‡:"+Int2Str(resDisc));
			if (resDisc==1)
			{
				CurrentCustomer=0;
				CashReg->DbfMutex->lock();
				DiscountType = (CashReg->CustomersTable->Locate("ID",0)) ? CashReg->CustomersTable->GetField("DISCOUNTS") : DefaultDiscountType;
				CashReg->DbfMutex->unlock();
			}

            EditLine->setText(W2U(""));

			ShowGoodsInfo();
			return;

		}

		if (CompareKey(Key,DISCOUNT) || CompareKey(Key,CERTIFICATE))
		{
		    Log("PressKey>> DISCOUNT");
			int SearchDiscountMode;
			string discount;
			long long number=0;

			if (CompareKey(Key,DISCOUNT))    SearchDiscountMode=FindDiscnt;
			if (CompareKey(Key,CERTIFICATE)) SearchDiscountMode=FindCertificate;

			if (SearchDiscount(SearchDiscountMode,&discount,&number)==1)
			{
				if(CompareKey(Key,DISCOUNT))    CurrentCustomer=0;
				if(CompareKey(Key,CERTIFICATE)) CurrentCertificate=0;

				CashReg->DbfMutex->lock();
				DiscountType = (CashReg->CustomersTable->Locate("ID",0)) ? CashReg->CustomersTable->GetField("DISCOUNTS") : DefaultDiscountType;
				CashReg->DbfMutex->unlock();
			}

			ShowGoodsInfo();
			return;
		}

		if (CompareKey(Key,PRECHECK))
		{
		    Log("PressKey>> PRECHECK");
			if (!EditLineCheck("¬‚Â‰ËÚÂ ÍÓ‰ ÔÂ˜ÂÍ‡!"))
				return;
			EditLine->setText("PC" + EditLine->text().upper());
			if(LookingForBarcode())
                EditLine->clear();
			return;
		}

        // +dms ==== 2011-05-17 ===== ÔÂÂ‰‡˜‡ ˜ÂÍ‡ Ì‡ ‰Û„Û˛ Í‡ÒÒÛ
        if (CompareKey(Key,SEND))//send check to other cashdesk
        {
            Log("PressKey>> SEND");
            if (IsCurrentGoodsEmpty&&(Cheque->GetSize()==0))
            {// ÓÚÍÓÂÏ ÔÂÂ‰‡Ì˚È ˜ÂÍ

                try
                {
                    FILE * sendfile = fopen(sendstatefn,"r");
                    if (sendfile)
                    {
                        fclose(sendfile);
                        if (!ShowQuestion("ŒÚÍ˚Ú¸ ÔÂÂ‰‡ÌÌ˚È Ò ‰Û„ÓÈ Í‡ÒÒ˚ ˜ÂÍ?",false))
                            return;

                        if (rename(sendstatefn, statefn))
                        {
                            ShowMessage("Œ¯Ë·Í‡ ÓÚÍ˚ÚËˇ ˜ÂÍ‡!\n—ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!");
                            return;
                        }

                        Cheque->Clear();
                        EditLine->clear();
                        RestoreSet();
                        UpdateList();
                        painter.end();
                        CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,SENDCHECK_GET,Cheque->GetSum(),CashReg->CurrentSaleman->Id,-1);
                        ShowMessage("◊ÂÍ ‚ÓÒÒÚ‡ÌÓ‚ÎÂÌ!");
                    }
                }
                catch(cash_error &er)
                {
                    CashReg->LoggingError(er);
                }

            }
            else
            {// ÔÂÂ‰‡‰ËÏ ˜ÂÍ Ì‡ ‰Û„Û˛ Í‡ÒÒÛ
                if (!ShowQuestion("œÂÂ‰‡Ú¸ ˜ÂÍ Ì‡ ‰Û„Û˛ Í‡ÒÒÛ?",false))
                    return;

                bool ok;
                QString addr = QInputDialog::getText("APM-KACCA", W2U(" ¬‚Â‰ËÚÂ ‡‰ÂÒ Í‡ÒÒ˚ "), QLineEdit::Normal, tr("apm-kacca1"), &ok, this );
                if ( ok && !addr.isEmpty() )
                {  // Ô˚Ú‡ÂÏÒˇ ÓÚÔ‡‚ËÚ¸

                    Log(" ===> SEND CHECK ....");

                    QFile curfile;
                    curfile.setName("/Kacca/tmp/state.dat");
                    if (!curfile.exists())
                    {
                        Log(" ERROR (file not exists)");
                        ShowMessage("‘‡ÈÎ ˜ÂÍ‡ ÌÂ Ì‡È‰ÂÌ!");
                        return;
                    }

                    string host = U2W(addr);

                    Log((char*)("    send check to host "+host).c_str());

                    char cmd[256];
                    sprintf( cmd, "./sendcheck %s", host.c_str());
//;;Log(cmd);
                    system(cmd);

//                QFtp ftp;
//                ftp.connectToHost(addr);
//                ftp.login();
//                ftp.cd("/topsecret/csv");
//                ftp.put(("price-list.csv", &curfile);
//                ftp.close();

                    CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,SENDCHECK_POST,Cheque->GetSum(),CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL,(char*)("◊ÂÍ ÔÂÂ‰‡Ì Ò "+Int2Str(CashReg->GetCashRegisterNum())+" Ì‡ "+host).c_str());

                    string message = "MESSAGE: œÂÂ‰‡Ì ˜ÂÍ Ò Í‡ÒÒ˚ π"+Int2Str(CashReg->GetCashRegisterNum());

                    CashReg->Socket->SendMessage(host.c_str(), message.c_str());

                    Log(" SUCCESS");
                }
            }

            return;
        }

        // +dms ==== 2010-03-29 ===== ÒËÒÚÂÏ‡ ‚‚Ó‰‡ "Ò‚Ó·Ó‰ÌÓÈ ÒÛÏÏ˚"
		if (CompareKey(Key,FREESUMMA) && EditLine->ctrl)  // ‚‚Ó‰ "Ò‚Ó·Ó‰ÌÓÈ ÒÛÏÏ˚"
		{
            Log("PressKey>> FREESUMMA");
			if (!ShowQuestion("ƒÓ·‡‚ËÚ¸ ÚÓ‚‡?",false))
                return;

            int GuardRes=NotCorrect;
			if ((!CashReg->CurrentSaleman->FreeSum)&&(!CheckGuardCode(GuardRes)))
						return;

			EditLine->clear();
			if (!EditLineCheck(""))
				return;

			bFreeSum=true;
			FreeSum = new FreeSumForm(this);

			QString GoodsName,GoodsPrice,GoodsCount,GoodBarcode;
			bool NoDiscount=false;
			bool GType = false;

			for(;;)
			{
				FreeSum->NameEdit->setText(GoodsName);
				FreeSum->PriceEdit->setText(GoodsPrice);
				FreeSum->CountEdit->setText(GoodsCount);
				FreeSum->NoDiscount->setChecked(NoDiscount);
				FreeSum->GType->setChecked(GType);


				if (FreeSum->exec()==QDialog::Accepted)
				{
					GoodsName	= FreeSum->NameEdit->text();
					GoodBarcode = FreeSum->BarcodeEdit->text();
					GoodsCount	= FreeSum->CountEdit->text();
					GoodsPrice	= FreeSum->PriceEdit->text();
					NoDiscount  = FreeSum->NoDiscount->isChecked();
					GType       = FreeSum->GType->isChecked();

					double val;
                    // ÔÓ‚ÂÍ‡ Ì‡ËÏÂÌÓ‚‡ÌËˇ
					if (GoodsName.isEmpty())
					{
						ShowMessage("ÕÂ Á‡‰‡ÌÓ Ì‡ËÏÂÌÓ‚‡ÌËÂ!");
						continue;
					}

                    // ÔÓ‚ÂÍ‡ ÍÓÎË˜ÂÒÚ‚‡
                    val = 0;
					if (!GoodsCount.isEmpty())
					{
						val = GoodsCount.toDouble();
					}

                    if (val<=0)
                    {
                        ShowMessage("ÕÂÔ‡‚ËÎ¸ÌÓÂ ÍÓÎË˜ÂÒÚ‚Ó ÚÓ‚‡‡!");
                        continue;
                    }

                    // ÔÓ‚ÂÍ‡ ˆÂÌ˚
                    val = 0;
					if (!GoodsPrice.isEmpty())
					{
						val = GoodsPrice.toDouble();
					}

                    if (val<=0)
                    {
                        ShowMessage("ÕÂÔ‡‚ËÎ¸Ì‡ˇ ˆÂÌ‡ ÚÓ‚‡‡!");
                        continue;
                    }


                    if (!FreeSum->valid)
                    {
                        ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ¯ÚËı-ÍÓ‰: "+U2W(FreeSum->InfoLabel->text()));
                        continue;
                    }


                    bFreeSum=false;
                    delete FreeSum;
                    FreeSum=NULL;

                    // ƒÓ·‡‚ÎˇÂÏ ÒÔÂˆË‡Î¸ÌÛ˛ ÔÓÁËˆË˛ ÚÓ‚‡‡
                    try
                    {
                        char tmpstr[1024];
                        sprintf(tmpstr, " =FreeSum= BC=%s, N=%s, C=%s, P=%s, Wt=%c, NoD=%c",
                                U2W(GoodBarcode).c_str(), U2W(GoodsName).c_str(),
                                U2W(GoodsCount).c_str(), U2W(GoodsPrice).c_str(),
                                GType?'t':'f', NoDiscount?'t':'f');
                        Log(tmpstr);

                        CurrentGoods=&CurGoods;
                        CurrentGoods->ItemCode		  = FreeSumCode;
                        CurrentGoods->ItemBarcode	  = U2W(GoodBarcode);
                        CurrentGoods->ItemName		  = U2W(GoodsName);
                        CurrentGoods->ItemDBPos		  = 0;

                        if (!GType) // ÚËÔ ÚÓ‚‡‡
                        {
                            CurrentGoods->ItemPrecision = 1; // ¯ÚÛ˜Ì˚È
                        }
                        else
                        {
                            CurrentGoods->ItemPrecision = 0.001; // ‚ÂÒÓ‚ÓÈ ÚÓ‚‡
                        }

                        CurrentGoods->ItemCount       = RoundToNearest( GoodsCount.toDouble(), CurrentGoods->ItemPrecision );
                        CurrentGoods->ItemFullPrice	  = CurrentGoods->ItemPrice = RoundToNearest( GoodsPrice.toDouble(), 0.01 );
                        CurrentGoods->ItemCalcPrice	  = CurrentGoods->ItemFullPrice;
                        CurrentGoods->ItemExcessPrice = CurrentGoods->ItemFullPrice;
                        CurrentGoods->ItemFixedPrice  = CurrentGoods->ItemFullPrice;

                        CurrentGoods->NDS             = 0;

                        // ‡Ò˜ÂÚ ÒÛÏÏ˚
                        CurrentGoods->CalcSum();

                        if(!NoDiscount)
                        {
                            CurrentGoods->ItemDiscountsDesc = DefaultDiscountType;
                        }
                        else
                        {
                            string ZDiscountType;
                            for(int i=0;i<MAXDISCOUNTLEN;i++) ZDiscountType+="Z";
                            CurrentGoods->ItemDiscountsDesc = ZDiscountType;
                        }

                        CurrentGoods->ItemDepartment	= CashReg->ConfigTable->GetLongField("DEPARTMENT");
                        CurrentGoods->ItemNumber        = Cheque->GetSize()+1;

                        CurrentGoods->InputType   = IN_FREE;

                        CurrentGoods->ItemFlag    = SL;
                        CurrentGoods->GuardCode   = -1;
                        CurrentGoods->PaymentType = CashPayment;
                        time(&(CurrentGoods->tTime));

                        CurrentGoods->KKMNo     = 0;
                        CurrentGoods->KKMSmena  = 0;
                        CurrentGoods->KKMTime   = 0;

                        if(!Cheque->GetCount())
                            CashReg->m_vem.StartDoc(1, CashReg->GetLastCheckNum()+1);

                        // ‰Ó·‡‚ÎˇÂÏ ‚ ˜ÂÍ
                        AppendRecord2Check();

                        CashReg->m_vem.AddGoods(CurrentGoods->ItemNumber,CurrentGoods,Cheque->GetCalcSum(),CurGoods.InputType);

                        CashReg->LogAddGoods(CurrentGoods);

                        if (PriceChecker==NULL)
                            IsCurrentGoodsEmpty=false;

                    }
                    catch(cash_error& er)
                    {
                        CashReg->LoggingError(er);
                    }

                    //ShowGoodsInfo();

				}
				break;
			}

            if (FreeSum!=NULL)
            {
                bFreeSum=false;
                delete FreeSum;
                FreeSum=NULL;
            }

			return;
		} // if (CompareKey(Key,FREESUMMA))  // ‚‚Ó‰ "Ò‚Ó·Ó‰ÌÓÈ ÒÛÏÏ˚"

        // +dms ==== 2010-05-17 ===== ÒÍËÌÒÂÈ‚Â
		if (CompareKey(Key,SCREENSAVER) && EditLine->ctrl)  // ÒÍËÌÒÂÈ‚Â
		{
		    Log("PressKey>> SCREENSAVER");
		    ShowScreenSaver = true;
            StartScreenSaver();
		} // if (CompareKey(Key,SCREENSAVER))  // svreensaver

	}
	catch(int er)
	{
		ErrorHandler(er);
	}
	catch(cash_error& er)
	{
		CashReg->DbfMutex->unlock();
		CashReg->LoggingError(er);
	}
}

void WorkPlace::ProcessBarcode(void)
{
    ;;Log("[FUNC] ProcessBarcode [START]");
    if (ScreenSaver!=NULL)
        ScreenSaver->close();

    RestartTimerSS(true);

	InitWorkPlace();
	try
	{
	    // + dms =====\ ŒÔÂ‰ÂÎˇÂÏ „‰Â ËÒÔÓÎ¸ÁÓ‚‡Ú¸ Ò˜ËÚ˚‚‡ÂÏ˚È ¯ÚËı-ÍÓ‰
		QString bcode = EditLine->text();
//bcode = Ò˜ËÚ˚‚‡ÂÏ˚È ¯ÚËı ÍÓ‰ ÒÍ‡ÌÂÓÏ
		// + dms ========= ¿ÍˆËˇ —·Â·‡ÌÍ - ÔË Ò˜ËÚ˚‚‡ÌËËË ÓÔÂ‰ÂÎÂÌÌ˚ı ÍÓ‰Ó‚  ˜ÂÍ ‰Ó·‡‚ÎˇÂÚÒˇ ÒÔÂˆ. ÚÓ‚‡ ===========
        // if (AddActionGoods(U2W(bcode))) return;
        // - dms ======================== /

		if (PriceChecker!=NULL) //œÓ‚ÂÍ‡ Ì‡ proceChecker ‡ÁÓ·‡Ú¸Òˇ ˜ÚÓ ˝ÚÓ Ú‡ÍÓÂ
		{
		    bcode = PriceChecker->SearchEdit->text();	
			
		    if(bcode.left(3)=="993")
		    {
		        AppendRecord2Check();
		        //;;Log("[FUNC] ProcessBarcode - PriceChecker [END]");
		        return;
		    }
		}
		
//”ÒÎÓ‚ËÂ Ò priceChecker ÔÓÔÛÒÍ‡ÂÚÒˇ, Ò˜ËÚ˚‚‡Î ÍÓ‰ ÔÓ‰‡ÌÌÓÈ ÒÏÂÚ‡Ì˚
		
        if (FreeSum!=NULL)
        {
            bcode = FreeSum->BarcodeEdit->text();
            FreeSum->valid = false;
        }
		// + dms =====/

		if (PriceChecker!=NULL)
			PriceChecker->Clear();

		for(int i = 0; i < bcode.length(); i++){ //ƒÓ·‡‚ÎÂÌËÂ ‚ÒÂı ÚÓ‚‡Ó‚ Ò Ï‡ÍËÓ‚Í‡ÏË, Ì‡˜‡ÎÓ ÒÓÁ‰‡ÌËˇ ÒÔËÒÍ‡
			if(!bcode[i].isNumber()){
				if (LookingForBarcode())
                    EditLine->clear();           
			//;;Log("[FUNC] ProcessBarcode - LookingForBarcode-1 [END]");
			return; //«‡Í‡Ì˜Ë‚‡ÂÏ ÒÔËÒÓÍ Ï‡ÍËÓ‚‡ÌÌ˚ı ÚÓ‚‡Ó‚
			}
		}
		
		CashReg->DbfMutex->lock();
		if (CashReg->BarInfoTable->Locate("CODENAME","EAN13"))
			bcode=W2U(CashReg->BarInfoTable->GetStringField("CODEID"))+bcode;
		CashReg->DbfMutex->unlock();

        if (PriceChecker!=NULL) PriceChecker->SearchEdit->setText(bcode);
        else if (FreeSum!=NULL) FreeSum->BarcodeEdit->setText(bcode);
             else EditLine->setText(bcode);
		//PriceChecker==NULL? EditLine->setText(bcode) : PriceChecker->SearchEdit->setText(bcode);

		if (LookingForBarcode())
                    EditLine->clear();

        //;;Log("[FUNC] ProcessBarcode - LookingForBarcode-2 [END]");
        return;
    }

	catch(int er)
	{
		ErrorHandler(er);
	}
	catch(cash_error& er)
	{
		CashReg->DbfMutex->unlock();
		CashReg->LoggingError(er);
	}
	//;;Log("[FUNC] ProcessBarcode [END]");
}

bool WorkPlace::EditLineCheck(string msg)//check edit line status
{
	if (PaymentKeyPress>0)
	{
		ShowMessage("◊ÂÍ ÌÂ Á‡Í˚Ú! Õ‡ÊÏËÚÂ ÍÎ‡‚Ë¯Û –¿—◊≈“!");
		return false;
	}

	if ((EditLine->text().isEmpty())&&(!msg.empty()))
	{
		ShowMessage(msg);
		return false;
	}

	return true;
}

void WorkPlace::SetPaymentType(FiscalCheque *CurCheque,int payment_type)
{
	CurCheque->SetPaymentType(payment_type);
	/*
	for (unsigned int i=0;i<CurCheque->GetSize();i++)
	{
		GoodsInfo tmpGoods=(*CurCheque)[i];
		tmpGoods.PaymentType=payment_type;
		CurCheque->SetAt(i,tmpGoods);
	}
	*/
}


/*
int WorkPlace::StoreRec2Check()
{

}
*/

void WorkPlace::UpdateList()
{
;;Log("[Func] UpdateList [START]");
Log("Kollichestvo=" + Double2Str(GoodsInfo().ItemCount));
	ChequeList->clear();
	int iNum=0;
	
	for(int i = 0; i < Cheque->GetCount(); i++){
		if((*Cheque)[i].ItemFlag == SL){
			QListViewItem *lastItem=ChequeList->firstChild();//update check's list

			if (lastItem!=NULL){
				for(;;){
					if (lastItem->itemBelow()!=NULL)
						lastItem=lastItem->itemBelow();
					else
						break;
				}
			}

//			QListViewItem *item=new QListViewItem(ChequeList,lastItem);//add goods to the cheque list

            GoodsInfo g = (*Cheque)[i];
            QColor color = Qt::black;

            if ((*Cheque)[i].ItemCode==FreeSumCode)
                color = Qt::darkMagenta;
            else
                if (CashReg->GoodInAction(&g))
                    color = Qt::darkBlue;

            if ((*Cheque)[i].DoubleWeightGoods)
                color = Qt::darkRed;
            ColorListViewItem *item=new ColorListViewItem(ChequeList, lastItem, color);//add goods to the cheque list
			item->setText(ListNo,Int2Str(++iNum).c_str());
            // + dms === 2010-03-30 =====\ ÒÔÂˆ. ÍÓ‰ ÌÂ ‚˚‚Ó‰ËÏ
            item->setText(ListCode, (*Cheque)[i].ItemCode==FreeSumCode? "" : Int2Str((*Cheque)[i].ItemCode).c_str());
            // - dms ===/
			item->setText(ListName,W2U((*Cheque)[i].ItemName));
			item->setText(ListPrice,GetRounded((*Cheque)[i].ItemPrice,0.01).c_str());
			item->setText(ListCount,GetRounded((*Cheque)[i].ItemCount,(*Cheque)[i].ItemPrecision).c_str());
			item->setText(ListSum,GetRounded((*Cheque)[i].ItemSum,0.01).c_str());
			item->setText(ListDscnt,GetRounded((*Cheque)[i].ItemCalcSum-(*Cheque)[i].ItemSum,0.01).c_str());
			ChequeList->setSelected(item,true);
		}
	}

    // œÂÂÒ˜ÂÚ ÒÍË‰ÓÍ ÂÒÚ¸ ‚ÌÛÚË ÔÓˆÂ‰Û˚ ShowGoodsInfo
	//ProcessDiscount(Cheque);

    // + dms
    ShowGoodsInfo();
    // - dms
//;;Log("[Func] UpdateList [End]");
}

//static char * statefn = "tmp/state.dat";
//static char * sendstatefn = "tmp/sendstate.dat";

int WorkPlace::SaveSet()
{
	int checklen = Cheque->GetCount();
	if(!checklen)
		return 0;

	FILE * f = fopen( statefn, "w");
	if(!f)
		return 1;
	fprintf(f, "Customer=%lld\n", CurrentCustomer);
	fprintf(f, "ByPhone=%d\n", CustomerByPhone?1:0);
	fprintf(f, "AddonCustomer=%lld\n", CurrentAddonCustomer);
	fprintf(f, "tsum=%.2f\n", Cheque->tsum);
	fprintf(f, "trunc=%.2f\n", Cheque->trunc);
	//fprintf(f, "DiscountSumm=%.2f\n", Cheque->DiscountSumm);
	fprintf(f, "DiscountSumm=%.2f\n", 0);
	fprintf(f, "CertificateSumm=%.2f\n", Cheque->CertificateSumm);
	fprintf(f, "BankBonusSumm=%.2f\n", Cheque->BankBonusSumm);
	fprintf(f, "count=%d\n", checklen);
	for(int i = 0; i < checklen; i++){
		fputs((*Cheque)[i].ItemName.c_str(), f);
		fputs("\n",f);
		fputs((*Cheque)[i].ItemBarcode.c_str(), f);
		fputs("\n",f);
		fputs((*Cheque)[i].ItemSecondBarcode.c_str(), f);
		fputs("\n",f);
		fputs((*Cheque)[i].ItemDiscountsDesc.c_str(), f);
		fputs("\n",f);
		fprintf(f, "ItemCode=%d\n", (*Cheque)[i].ItemCode);
		fprintf(f, "ItemNumber=%d\n", (*Cheque)[i].ItemNumber);
		fprintf(f, "ItemDBPos=%d\n", (*Cheque)[i].ItemDBPos);
		fprintf(f, "ItemDepartment=%d\n", (*Cheque)[i].ItemDepartment);
		fprintf(f, "ItemFlag=%d\n", (*Cheque)[i].ItemFlag);
		fprintf(f, "PaymentType=%d\n", (*Cheque)[i].PaymentType);
		fprintf(f, "GuardCode=%d\n", (*Cheque)[i].GuardCode);
		fprintf(f, "CustomerCode=%lld\n", (*Cheque)[i].CustomerCode[0]);
		fprintf(f, "AddonCustomerCode=%lld\n", (*Cheque)[i].CustomerCode[1]);
		fprintf(f, "InputType=%d\n", (*Cheque)[i].InputType);
		fprintf(f, "DiscFlag=%d\n", (*Cheque)[i].DiscFlag);
		fprintf(f, "ItemPrice=%.3f\n", (*Cheque)[i].ItemPrice);
		fprintf(f, "ItemFullPrice=%.3f\n", (*Cheque)[i].ItemFullPrice);
		fprintf(f, "ItemMinimumPrice=%.3f\n", (*Cheque)[i].ItemMinimumPrice);
		fprintf(f, "ItemCalcPrice=%.3f\n", (*Cheque)[i].ItemCalcPrice);
		fprintf(f, "ItemFixedPrice=%.3f\n", (*Cheque)[i].ItemFixedPrice);
		fprintf(f, "ItemSum=%.3f\n", (*Cheque)[i].ItemSum);
        fprintf(f, "ItemSumToPay=%.3f\n", (*Cheque)[i].ItemSumToPay);
		fprintf(f, "ItemFullSum=%.3f\n", (*Cheque)[i].ItemFullSum);
		fprintf(f, "ItemFullDiscSum=%.3f\n", (*Cheque)[i].ItemFullDiscSum);
        fprintf(f, "ItemBankDiscSum=%.3f\n", (*Cheque)[i].ItemBankDiscSum);
		fprintf(f, "ItemCalcSum=%.3f\n", (*Cheque)[i].ItemCalcSum);
		fprintf(f, "ItemDiscount=%.3f\n", (*Cheque)[i].ItemDiscount);
		fprintf(f, "ItemDSum=%.3f\n", (*Cheque)[i].ItemDSum);
		fprintf(f, "ItemPrecision=%.3f\n", (*Cheque)[i].ItemPrecision);
		fprintf(f, "ItemCount=%.3f\n", (*Cheque)[i].ItemCount);
		fprintf(f, "tTime=%d\n", (*Cheque)[i].tTime);
		fprintf(f, "NDS=%.2f\n", (*Cheque)[i].NDS);
		fputs((*Cheque)[i].Lock.c_str(), f);
		fputs("\n",f);
		fprintf(f, "LockCode=%d\n", (*Cheque)[i].LockCode);
		fprintf(f, "Avans=%d\n", (*Cheque)[i].Avans);
		fprintf(f, "ItemMask=%d\n", (*Cheque)[i].ItemMask);
		fprintf(f, "ItemTextile=%d\n", (*Cheque)[i].ItemTextile);
		fprintf(f, "ItemMilk=%d\n", (*Cheque)[i].ItemMilk);
		fprintf(f, "ItemCigar=%d\n", (*Cheque)[i].ItemCigar);
        fprintf(f, "ItemAlco=%d\n", (*Cheque)[i].ItemAlco);

        int AlcoCnt = (*Cheque)[i].Actsiz.size();
        fprintf(f, "AlcoCnt=%d\n", AlcoCnt);

        for (int j=0;j<AlcoCnt;j++)
        {
            fputs((*Cheque)[i].Actsiz[j].c_str(), f);
            fputs("\n",f);
        }


		//fprintf(f, "Section=%d\n", (*Cheque)[i].Section);
	}
	fclose(f);
	return 0;
}

inline void fgets(char* buf, FILE * f)
{
	char * nl;
	fgets(buf, 1024, f);
	nl = strrchr(buf, 0x0d);//'\n');
	if(nl) *nl = '\0';
	nl = strrchr(buf, 0x0a);//'\n');
	if(nl) *nl = '\0';
}

int WorkPlace::RestoreSet(bool UseDisc, bool NoActsiz)
{
	FILE * f = fopen( statefn, "r");
	if(!f)
		return 1;
	fscanf(f, "Customer=%lld\n", &CurrentCustomer);
	int t=0;
	fscanf(f, "ByPhone=%d\n", &t);
	CustomerByPhone = (t==1);
	fscanf(f, "AddonCustomer=%lld\n", &CurrentAddonCustomer);
	fscanf(f, "tsum=%lf\n", &(Cheque->tsum));
	fscanf(f, "trunc=%lf\n", &(Cheque->trunc));
	fscanf(f, "DiscountSumm=%lf\n", &(Cheque->DiscountSumm));
	Cheque->DiscountSumm=0;
	Cheque->DiscountSummNotAction=0;
	fscanf(f, "CertificateSumm=%lf\n", &(Cheque->CertificateSumm));
	fscanf(f, "BankBonusSumm=%lf\n", &SumRestoreBankBonus);
	int checklen;
	fscanf(f, "count=%d\n", &checklen);

	int NoAlcoCnt = 0;

	for(int i = 0; i < checklen; i++){
		GoodsInfo g;
		char buf[1024];

		fgets(buf, f);
		g.ItemName = buf;

		fgets(buf, f);
		g.ItemBarcode = buf;

		fgets(buf, f);
		g.ItemSecondBarcode = buf;

		fgets(buf, f);
		g.ItemDiscountsDesc = buf;

		fscanf(f, "ItemCode=%d\n", &(g.ItemCode));
		fscanf(f, "ItemNumber=%d\n", &(g.ItemNumber));
		fscanf(f, "ItemDBPos=%d\n", &(g.ItemDBPos));
		fscanf(f, "ItemDepartment=%d\n", &(g.ItemDepartment));
		fscanf(f, "ItemFlag=%d\n", &(g.ItemFlag));
		fscanf(f, "PaymentType=%d\n", &(g.PaymentType));
		fscanf(f, "GuardCode=%d\n", &(g.GuardCode));
		fscanf(f, "CustomerCode=%lld\n", &(g.CustomerCode[0]));
		fscanf(f, "AddonCustomerCode=%lld\n", &(g.CustomerCode[1]));
		fscanf(f, "InputType=%d\n", &(g.InputType));
		fscanf(f, "DiscFlag=%d\n", &(g.DiscFlag));
		fscanf(f, "ItemPrice=%lf\n", &(g.ItemPrice));
		fscanf(f, "ItemFullPrice=%lf\n", &(g.ItemFullPrice));
		fscanf(f, "ItemMinimumPrice=%lf\n", &(g.ItemMinimumPrice));
		fscanf(f, "ItemCalcPrice=%lf\n", &(g.ItemCalcPrice));
		fscanf(f, "ItemFixedPrice=%lf\n", &(g.ItemFixedPrice));
		fscanf(f, "ItemSum=%lf\n", &(g.ItemSum));
		fscanf(f, "ItemSumToPay=%lf\n", &(g.ItemSumToPay));
		fscanf(f, "ItemFullSum=%lf\n", &(g.ItemFullSum));
		fscanf(f, "ItemFullDiscSum=%lf\n", &(g.ItemFullDiscSum));
		fscanf(f, "ItemBankDiscSum=%lf\n", &(g.ItemBankDiscSum));
		fscanf(f, "ItemCalcSum=%lf\n", &(g.ItemCalcSum));
		fscanf(f, "ItemDiscount=%lf\n", &(g.ItemDiscount));
		fscanf(f, "ItemDSum=%lf\n", &(g.ItemDSum));
		fscanf(f, "ItemPrecision=%lf\n", &(g.ItemPrecision));
		fscanf(f, "ItemCount=%lf\n", &(g.ItemCount));
		fscanf(f, "tTime=%d\n", &(g.tTime));
		time(&(g.tTime));
		fscanf(f, "NDS=%lf\n", &(g.NDS));
		fgets(buf, f);
		g.Lock = buf;
		fscanf(f, "LockCode=%d\n", &(g.LockCode));
		//fscanf(f, "Section=%d\n", &(g.Section));
		fscanf(f, "Avans=%d\n", &(g.Avans));
		fscanf(f, "ItemMask=%d\n", &(g.ItemMask));

short ItemTextile=0;
		fscanf(f, "ItemTextile=%d\n", &ItemTextile);
g.ItemTextile = ItemTextile;
short ItemMilk=0;
		fscanf(f, "ItemMilk=%d\n", &ItemMilk);
g.ItemMilk = ItemMilk;

		fscanf(f, "ItemCigar=%d\n", &(g.ItemCigar));
		fscanf(f, "ItemAlco=%d\n", &(g.ItemAlco));
        int AlcoCnt;
        fscanf(f, "AlcoCnt=%d\n", &AlcoCnt);
        int NoActsizCntCur=0;

        string tmpStr="";
        for (int j=0;j<AlcoCnt;j++)
        {
            fgets(buf, f);
            tmpStr=buf;
            if (!NoActsiz){
                g.Actsiz.insert(g.Actsiz.end(), tmpStr);
            }
            else
            {
                NoAlcoCnt++;
                NoActsizCntCur++;
            }
        }

		if (!UseDisc) g.ItemDiscount=0;
		if (!NoActsizCntCur) Cheque->Insert(g);
	}
    if (NoAlcoCnt)
        ShowMessage("¿ÎÍÓ„ÓÎ¸Ì˚Â ÚÓ‚‡˚ Õ≈ ‚ÓÒÒÚ‡ÌÓ‚ÎÂÌ˚!\n\n¿ÎÍÓ„ÓÎ¸ Ò˜ËÚ‡ÈÚÂ Á‡ÌÓ‚Ó!");

    if (!UseDisc)
    {
        CurrentAddonCustomer=0;
    }
	long long number = CurrentCustomer;

	CashReg->DbfMutex->lock();
	DiscountType = (CashReg->CustomersTable->Locate("ID",0)) ? CashReg->CustomersTable->GetField("DISCOUNTS") : DefaultDiscountType;
	CashReg->DbfMutex->unlock();
    string DefDiscount = DiscountType;
	string discount;
	if (SearchDiscount(FindAuto,&discount,&number)==1)
	{
		CurrentCustomer=0;
		NeedCert=0;
		DiscountType = DefDiscount;
	}
	return 0;
}

int WorkPlace::CalcCountPrice()
{
	if(PriceChecker!=NULL)
		return 0;

	return CashReg->CalcCountPrice(CurrentGoods);
}

int WorkPlace::CheckUncorrectEnd()
{
    Log("[FUNC] CheckUncorrectEnd [START]");
	FILE *uce;
	b_uncorrectend = true;
	uce = fopen("./tmp/uncorrectend", "r");
	if(!uce) {
		b_uncorrectend = false;
		Log("[FUNC] CheckUncorrectEnd - NO UNCORRECTED [END]");
		return 0;
	}

	string date;
	char cdate[18];
	fscanf(uce, "%s", cdate);
	fclose(uce);
	date = cdate;
	int GuardRes = NotCorrect;
	RestoreSet();

	UpdateList();
	b_uncorrectend = false;
	remove("./tmp/uncorrectend");
	if (ShowQuestion(" ‡ÒÒ‡ ·˚Î‡ ‚˚ÍÎ˛˜ÂÌ‡ Ò ÓÚÍ˚Ú˚Ï "+date+" ˜ÂÍÓÏ!!! ¿ÌÌÛÎËÓ‚‡Ú¸ ˜ÂÍ?",false))
	{
		int GuardRes=NotCorrect;   //check guard id
		if ((!CashReg->CurrentSaleman->Annul)&&(!CheckGuardCode(GuardRes)))
			return 1;
		CashReg->ProcessRegError(FiscalReg->Cancel());//annul cheque
		IsChequeInProgress=false;
		CashReg->AnnulCheck(Cheque,GuardRes);
		IsChequeInProgress=false;
		InitWorkPlace();
		AutoRestoreKeepedCheque();
	}
	else
	{

	    if (SumRestoreBankBonus)
	    {

	        //ShowMessage("¡ Œ Õ ” — €: "+Double2Str(SumRestoreBankBonus));

            OnlyCashlessMode = true;

            CashReg->AddPayment(11,"UNCORRECT",&SumRestoreBankBonus);

            CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,RESTOREBONUS,SumRestoreBankBonus,CashReg->CurrentSaleman->Id,-1);

            ShowGoodsInfo();

            EditLine->ctrl=true;
            ProcessKey(4100);

	    }

    }
/*	else
	do{
	}while(!CheckGuardCode(GuardRes));
*/
    Log("[FUNC] CheckUncorrectEnd [END]");
	return 1;
}

int WorkPlace::RestoreKeepedCheque()
{
	try
	{
		keepstate = fopen("./tmp/keepstate.dat","r");
		if (keepstate)
		{
			int storechecknum;
			char buf[256];
			while(!feof(keepstate))
			{
				fscanf(keepstate,"%s",buf);
				sscanf(buf,"KCHNUM=%d", &storechecknum);
			}
			fclose(keepstate);
			storenum = fopen("./tmp/storenum.dat","w");
			fprintf(storenum,"%d",CashReg->GetLastCheckNum()+1);
			fclose(storenum);
			if ((storechecknum-CashReg->GetLastCheckNum())>100 || (CashReg->GetLastCheckNum()-storechecknum)>100 || storechecknum>1000000000 || CashReg->GetLastCheckNum()>1000000000){
				char tmpstr[128];//="Œ¯Ë·Í‡ ÌÛÏÂ‡ˆËË ˜ÂÍÓ‚. “ÂÍÛ˘ËÈ ˜ÂÍ: "+CashReg->GetLastCheckNum()+". ŒÚÎÓÊÂÌÌ˚È ˜ÂÍ: "+storechecknum+".\n —ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!!!"
				//sprintf(tmpstr,"Œ¯Ë·Í‡ ÌÛÏÂ‡ˆËË ˜ÂÍÓ‚. “ÂÍÛ˘ËÈ ˜ÂÍ: %d. ŒÚÎÓÊÂÌÌ˚È ˜ÂÍ: %d.\n —ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ",CashReg->GetLastCheckNum(),storechecknum);
				sprintf(tmpstr,"Œ¯Ë·Í‡ ÌÛÏÂ‡ˆËË ˜ÂÍÓ‚. “ÂÍÛ˘ËÈ ˜ÂÍ: %d. ŒÚÎÓÊÂÌÌ˚È ˜ÂÍ: %d.\n —ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!%d!%d!",CashReg->GetLastCheckNum(),storechecknum,CashReg->GetLastCheckNum()-storechecknum,storechecknum-CashReg->GetLastCheckNum());
				ShowMessage((string)tmpstr);
			}
			CashReg->SetLastCheckNum(storechecknum-1);

			if (rename("tmp/keepstate.dat","tmp/state.dat")){
				ShowMessage("Œ¯Ë·Í‡ ‚ÓÒÒÚ‡ÌÓ‚ÎÂÌËˇ ˜ÂÍ‡!\n—ÓÓ·˘ËÚÂ ‡‰ÏËÌËÒÚ‡ÚÓÛ!");
				return -1;
			}
			Cheque->Clear();
			EditLine->clear();
			RestoreSet();
			IsCurrentGoodsEmpty=true;
			UpdateList();
			KeepCheckInfo->setProperty( "text","");
			painter.end();
			ShowMessage("ŒÚÎÓÊÂÌÌ˚È ˜ÂÍ ‚ÓÒÒÚ‡ÌÓ‚ÎÂÌ!");
			return 1;
		}
		else return 0;
	}
	catch(cash_error &er)
	{
		CashReg->DbfMutex->unlock();
		CashReg->LoggingError(er);
	}
}

int WorkPlace::AutoRestoreKeepedCheque()
{
	if(keepstate=fopen("tmp/keepstate.dat","r"))
	{//
		fclose(keepstate);
		ShowMessage("¬ÓÒÒÚ‡ÌÓ‚ÎÂÌËÂ ÓÚÎÓÊÂÌÌÓ„Ó ˜ÂÍ‡!");
		InitWorkPlace();
		RestoreKeepedCheque();
		return 1;
	}
	return 0;
}

void WorkPlace::CheckCheque(void)
{
    Log("[FUNC] CheckCheque [START]");
//	CheckUncorrectEnd();
	if(!CheckUncorrectEnd())
		AutoRestoreKeepedCheque();
	CashReg->KeepCheckInfo->setText("");
	//return 1;
	Log("[FUNC] CheckCheque [END]");
}

void WorkPlace::InitWPSlot()
{
	InitWorkPlace();
}

// #include <stdlib.h>
#include<malloc.h>
int WorkPlace::StartPriceChecker(int key)
{
	//
	char* kodstr=NULL;
	kodstr = (char*)malloc(20*sizeof(char));
	if (!kodstr){
		ShowMessage("ÕÂ‰ÓÒÚ‡ÚÓ˜ÌÓ Ô‡ÏˇÚË!");
		return 0;
	}
	pthread_t thread1;
	string strost;
	int pid1 = (int)getpid();
	int result;
	//
	PriceChecker->Clear();
//	PriceChecker->NameLine->setText(W2U(CurrentGoods->ItemName)+"*");
//	PriceChecker->CodeLine->setText(Int2Str(CurrentGoods->ItemCode).c_str());
//	PriceChecker->QuantLine->setText(GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
//	PriceChecker->SummLine->setText(GetRounded(CurrentGoods->ItemSum,0.01).c_str());
	FiscalCheque FoundPrices;
	GoodsInfo GoodsPrices;
	FoundPrices.Clear();
	DiscInfo.clear();
	DiscountInfo tmpDscInf;
	string upcbarcode="";
	try
	{
		thisApp->setOverrideCursor(waitCursor);
		InfoMessage->setText(W2U("œÓËÒÍ ÚÓ‚‡‡"));

		if((key==4148||key==41480||key==12345))
		{
		    if(!PriceChecker->SearchEdit->text().isEmpty())
		    {
                QString EnterText = PriceChecker->SearchEdit->text();
                if(EnterText.left(3)=="993")
                {// ›ÚÓ ·ÓÌÛÒÌ‡ˇ  ‡Ú‡
                    if(key!=12345) return 0;

                    string CardNumberStr = U2W(EnterText).substr(0,12);
                    long long CardNumberL = atoll(CardNumberStr.c_str());
                    long long res=NotCorrect;
                    CashReg->FindCustomer(&res, CardNumberL);
                    if (res == NotCorrect) return 0;


                    CashReg->DbfMutex->lock();

                    int isBonusCard=0;
                    string curDiscountType="";
                    string strCardType="";

                    if(CashReg->CustomersTable->GetLLongField("ID")==CardNumberL)
                    {
                        curDiscountType=CashReg->CustomersTable->GetField("DISCOUNTS");
                        isBonusCard=CashReg->CustomersTable->GetLongField("NEEDCERT");
                    }
                    else
                    {
                        curDiscountType=CashReg->CustRangeTable->GetField("DISCOUNTS");
                        isBonusCard=CashReg->CustRangeTable->GetLongField("BONUSCARD");

                    }

                    if (CashReg->CustRangeTable->GetFirstRecord())
                    {// Ë˘ÂÏ ÒÍË‰ÍÛ ‚ Ú‡·ÎËˆÂ ‰Ë‡Ô‡ÁÓÌÓ‚
                        do{
                            if(CashReg->CustRangeTable->GetLLongField("IDFIRST") <= CardNumberL &&
                            CashReg->CustRangeTable->GetLLongField("IDLAST") >= CardNumberL)
                            {
                                int intCardType=CashReg->CustRangeTable->GetLongField("CUSTTYPE");
                                switch(intCardType)
                                {
                                    case 0:strCardType="œ‡ÚÌÂ˚";break;
                                    case 1:strCardType="VIP";break;
                                    case 5:strCardType="Super-VIP";break;
                                    case 2:
                                    case 4:strCardType="5%";break;
                                    case 3:strCardType="2%";break;
                                }
                                break;
                            }
                        }
                        while(CashReg->CustRangeTable->GetNextRecord());
                    }


                    string isBonusCardStr = isBonusCard?"¡ÓÌÛÒÌ‡ˇ":"ƒËÒÍÓÌÚÌ‡ˇ";

                    // ÒÍË‰ÍË
                    string tmpDiscountsDesc="";
                    for(int i=0; i<MAXDISCOUNTLEN; i++) tmpDiscountsDesc+="-";
                    for(int c=0;c<curDiscountType.length();c++) tmpDiscountsDesc[c]='-';

                    CashReg->DiscountsTable->GetFirstRecord();
                    do{
                        int type=tmpDscInf.type=CashReg->DiscountsTable->GetLongField("DISCTYPE");
                        if(type != 0 && type <= curDiscountType.length())
                        {
                            tmpDscInf.description=CashReg->DiscountsTable->GetField("DESCRIPT");
                            tmpDscInf.percent=CashReg->DiscountsTable->GetDoubleField("PERCENT");
                            tmpDscInf.fullpercent=CashReg->DiscountsTable->GetField("FPERCENT");
                            tmpDscInf.mode=CashReg->DiscountsTable->GetLongField("MODE");
                            DiscInfo.insert(DiscInfo.end(),tmpDscInf);
                        }
                    }while(CashReg->DiscountsTable->GetNextRecord());

                    CashReg->DbfMutex->unlock();


                    if (!isBonusCard)
                    {
                        CardInfoStruct CardInfo;
                        if (CashReg->FindCardInRangeTable(&CardInfo, CardNumberL))
                        {
                            if (CardInfo.BonusCard==1) isBonusCard = 1;
                        }
                    }
                    double BonusBalans=0;

                    PriceChecker->NameLine->setText(W2U(isBonusCardStr));
                    PriceChecker->SummLine->setText(GetRounded(BonusBalans,0.01).c_str());

                    GoodsPrices.ItemName=isBonusCardStr;
                    GoodsPrices.ItemBarcode= "“ËÔ Í‡Ú˚";
                    GoodsPrices.ItemSecondBarcode= isBonusCardStr;
                    GoodsPrices.ItemDiscountsDesc=curDiscountType;
                    FoundPrices.Insert(GoodsPrices);

                    GoodsPrices.ItemName=isBonusCardStr;
                    GoodsPrices.ItemBarcode= "¬Ë‰ Í‡Ú˚";
                    GoodsPrices.ItemSecondBarcode= strCardType;
                    GoodsPrices.ItemDiscountsDesc=curDiscountType;
                    FoundPrices.Insert(GoodsPrices);

                    string DTypeStr = "—Ú‡Ì‰‡ÚÌ˚Â";
                    if ((curDiscountType.length()>6) && (curDiscountType[6]=='Z'))
                        DTypeStr = "Õ‡ÒÚÓÂÌÌ˚Â";

                    GoodsPrices.ItemBarcode= "“ËÔ ÒÍË‰ÍË";
                    GoodsPrices.ItemSecondBarcode= DTypeStr;
                    FoundPrices.Insert(GoodsPrices);

                    if (isBonusCard)
                    {
                        // »ÌÙÓÏ‡ˆËˇ ÔÓ Í‡ÚÂ
                        ;;Log("+ GetCardInfo +");
                        BNS_RET* retInf = CashReg->BNS->exec("inf", CardNumberStr, "");
                        ;;Log("- GetCardInfo -");
                        if (!retInf->ReturnCode)
                        {
                            BonusBalans = retInf->ActiveBonuses;

                            GoodsPrices.ItemName=isBonusCardStr;
                            GoodsPrices.ItemBarcode= "—ÓÂ‰ËÌÂÌËÂ";
                            GoodsPrices.ItemSecondBarcode= "Online";
                            GoodsPrices.ItemDiscountsDesc=curDiscountType;
                            FoundPrices.Insert(GoodsPrices);

                            GoodsPrices.ItemName=isBonusCardStr;
                            GoodsPrices.ItemBarcode= "¿ÍÚË‚Ì˚Â ·ÓÌÛÒ˚";
                            GoodsPrices.ItemSecondBarcode= GetRounded(retInf->ActiveBonuses,0.01);
                            GoodsPrices.ItemDiscountsDesc=curDiscountType;
                            FoundPrices.Insert(GoodsPrices);

                            //! ”·‡Ú¸ Û‰ÂÊ‡ÌÌ˚Â ·ÓÌÛÒ˚
                            //GoodsPrices.ItemBarcode= "”‰ÂÊ‡ÌÌ˚Â ·ÓÌÛÒ˚";
                            //GoodsPrices.ItemSecondBarcode= GetRounded(retInf->HoldedBonuses,0.01);
                            //FoundPrices.Insert(GoodsPrices);

                            GoodsPrices.ItemBarcode= "—Ú‡ÚÛÒ";
                            string CurSt = retInf->status;

                            if (CurSt=="1") CurSt="¿ÍÚË‚ËÓ‚‡Ì‡";
                            else if (CurSt=="2") CurSt="œÓ‰ÓÁËÚÂÎ¸Ì‡ˇ";
                            else if (CurSt=="3") CurSt="œÓ‚ÂÂÌ‡";
                            else if (CurSt=="4") CurSt="ÕÂ ‡ÍÚË‚ËÓ‚‡Ì‡";
                            else if (CurSt=="255") CurSt="«‡·ÎÓÍËÓ‚‡Ì‡";

                            GoodsPrices.ItemSecondBarcode= CurSt;
                            FoundPrices.Insert(GoodsPrices);

                            PriceChecker->SummLine->setText(GetRounded(BonusBalans,0.01).c_str());

                        }
                        else
                        {
                            GoodsPrices.ItemBarcode= "—ÓÂ‰ËÌÂÌËÂ";
                            GoodsPrices.ItemSecondBarcode= "Off-line";
                            FoundPrices.Insert(GoodsPrices);

                            PriceChecker->SummLine->setText("Offline");

                        }

                    }

                    InfoMessage->clear();
                    thisApp->restoreOverrideCursor();
                    if (FoundPrices.GetCount()==0){
                        PriceChecker->Clear();
                        EditLine->clear();
                        if (key==47)
                            ShowMessage(" ‡Ú‡ ÌÂ Ì‡È‰ÂÌ‡.");
                    }
                    else{
                        PriceChecker->ShowBonusList(&FoundPrices);////
                        FoundPrices.Clear();
                    }

                    return 0;

                }
           }
        }

        // ==== »ÌÙÓÏ‡ˆËˇ ÔÓ ·ÓÌÛÒ‡Ï ====


		if (key==4148)
			ProcessBarcode();
		if (key!=47)
		{
			upcbarcode ="0";
			upcbarcode+= PriceChecker->SearchEdit->text().ascii();
		}
		PriceChecker->NameLine->setText(W2U(CurrentGoods->ItemName)+"*");
		PriceChecker->CodeLine->setText(Int2Str(CurrentGoods->ItemCode).c_str());
	//	PriceChecker->QuantLine->setText(GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
	//	PriceChecker->SummLine->setText(GetRounded(CurrentGoods->ItemSum,0.01).c_str());
		//char *kod; sprintf(kod,"%i",CurrentGoods->ItemCode);
		//sprintf(kodstr,"%i",CurrentGoods->ItemCode);//kod=Int2Str(CurrentGoods->ItemCode);
		//char buffer[16];int value=CurrentGoods->ItemCode;
		//int i=itoa(value,kod,10);
		//CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,
		//					20/*PRICECHECK*/,CurrentGoods->ItemPrice,
		//					CashReg->CurrentSaleman->Id,-1,CashReg->GoodsTable->GetStringField("BARCODE").c_str(),
		//					kodstr);
							//Int2Str(CurrentGoods->ItemCode).c_str());
		CashReg->DbfMutex->lock();
		//bool first=false;
		if (CashReg->GoodsTable->GetFirstRecord())
			do{
				if( ( (key==4148||key==41480) && !PriceChecker->SearchEdit->text().isEmpty() && (U2W(PriceChecker->SearchEdit->text())==CashReg->GoodsTable->GetStringField("BARCODE") || upcbarcode==CashReg->GoodsTable->GetStringField("BARCODE")) && wbarcode==0)
				||( (key==4148||key==41480) && !PriceChecker->SearchEdit->text().isEmpty() && wbarcode!=0 && wbarcode==CashReg->GoodsTable->GetLongField("CODE") )//
				||( key==47	&& !PriceChecker->SearchEdit->text().isEmpty() && PriceChecker->SearchEdit->text().toInt()==CashReg->GoodsTable->GetLongField("CODE")  ) )
				{
					GoodsPrices.ItemName=CashReg->GoodsTable->GetStringField("NAME");
					GoodsPrices.ItemCode=CashReg->GoodsTable->GetLongField("CODE");
					GoodsPrices.ItemBarcode=CashReg->GoodsTable->GetStringField("BARCODE");
					GoodsPrices.ItemDiscountsDesc=CashReg->GoodsTable->GetStringField("SKIDKA");
					GoodsPrices.ItemCount=CashReg->GoodsTable->GetDoubleField("MULT");
					GoodsPrices.ItemPrice=CashReg->GoodsTable->GetDoubleField("PRICE");
					GoodsPrices.ItemFixedPrice=CashReg->GoodsTable->GetDoubleField("FIXEDPRICE");
					/*if (first){
						sprintf(kodstr,"%i",GoodsPrices->ItemCode);
						CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,
							20,GoodsPrices->ItemPrice,
							CashReg->CurrentSaleman->Id,-1,GoodsPrices.ItemBarcode.c_str(),kodstr);
					}*/
					if (FoundPrices.GetCount()==0)
					{
						sprintf(kodstr,"%i",GoodsPrices.ItemCode);
						CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,
							20/*PRICECHECK*/,GoodsPrices.ItemPrice,
							CashReg->CurrentSaleman->Id,-1,GoodsPrices.ItemBarcode.c_str(),kodstr);
						if(wbarcode!=0){
							PriceChecker->QuantLine->setText(GetRounded(CurrentGoods->ItemCount,CurrentGoods->ItemPrecision).c_str());
							PriceChecker->SummLine->setText(GetRounded(CurrentGoods->ItemSum,0.01).c_str());
						}else{
							PriceChecker->QuantLine->setText(GetRounded(GoodsPrices.ItemCount,CurrentGoods->ItemPrecision).c_str());
							PriceChecker->SummLine->setText(GetRounded(GoodsPrices.ItemPrice,0.01).c_str());
						}
						CashReg->DiscountsTable->GetFirstRecord();
						// + dms
						string tmpDiscountsDesc="";
						for(int i=0; i<MAXDISCOUNTLEN; i++) tmpDiscountsDesc+="-";
						// - dms
						for(int c=0;c<GoodsPrices.ItemDiscountsDesc.length();c++)
							tmpDiscountsDesc[c]='-';
						//memset( tmpDiscountsDesc, '-', GoodsPrices.ItemDiscountsDesc.size());



						do{
							int type=tmpDscInf.type=CashReg->DiscountsTable->GetLongField("DISCTYPE");

							int allgoodssign=CashReg->DiscountsTable->GetLongField("ALLGOODS");
							if(type != 0 && type <= GoodsPrices.ItemDiscountsDesc.length()){
								tmpDscInf.description=CashReg->DiscountsTable->GetField("DESCRIPT");
								switch (GoodsPrices.ItemDiscountsDesc[type-1])
								{
								case '.':allgoodssign==1 ? tmpDiscountsDesc[type-1]='.':tmpDiscountsDesc[type-1]='X';break;
								case 'X':allgoodssign==1 ? tmpDiscountsDesc[type-1]='X':tmpDiscountsDesc[type-1]='Z';break;
								case 'Z':allgoodssign==1 ? tmpDiscountsDesc[type-1]='Z':tmpDiscountsDesc[type-1]='Z';break;
								default :tmpDiscountsDesc[type-1]='-';
								}
							DiscInfo.insert(DiscInfo.end(),tmpDscInf);
							}
						}while(CashReg->DiscountsTable->GetNextRecord());
						GoodsPrices.ItemDiscountsDesc=tmpDiscountsDesc;
					}

					FoundPrices.Insert(GoodsPrices);
					int c=0;
					/*for(int c=0;;c++)*/
					while(1){
						char fname[64];
						sprintf(fname, "Q%d", c);
						if(CashReg->GoodsTable->GetFieldNo(fname) == -1 || CashReg->GoodsTable->GetDoubleField(fname) < .001)
							break;
						GoodsPrices.ItemCount = CashReg->GoodsTable->GetDoubleField(fname);
						sprintf(fname, "P%d", c);
						if(CashReg->GoodsTable->GetFieldNo(fname) == -1)
							break;
						GoodsPrices.ItemPrice = CashReg->GoodsTable->GetDoubleField(fname);
						GoodsPrices.ItemBarcode="";//CashReg->GoodsTable->GetStringField("BARCODE");
						GoodsPrices.ItemFixedPrice=0.0;//CashReg->GoodsTable->GetDoubleField("FIXEDPRICE");
						FoundPrices.Insert(GoodsPrices);
						c++;
						/*if (CashReg->GoodsTable->GetDoubleField("Q0")>0.001 || CashReg->GoodsTable->GetDoubleField("P0")>0.001){
							GoodsPrices.ItemCount=CashReg->GoodsTable->GetDoubleField("Q0");
							GoodsPrices.ItemPrice=CashReg->GoodsTable->GetDoubleField("P0");
							FoundPrices.Insert(GoodsPrices);
						}*/
					}
				}
			}
			while(CashReg->GoodsTable->GetNextRecord());

		CashReg->DbfMutex->unlock();

		InfoMessage->clear();
		thisApp->restoreOverrideCursor();
		if (FoundPrices.GetCount()==0){
			PriceChecker->Clear();
			EditLine->clear();
			if (key==47)
				ShowMessage("“Ó‚‡ Ò ÛÍ‡Á‡ÌÌ˚Ï ÍÓ‰ÓÏ ÌÂ Ì‡È‰ÂÌ.");
		}
		else{
			PriceChecker->ShowPriceList(&FoundPrices);////
			FoundPrices.Clear();
		}
			//PriceChecker->showEvent();
			//SQLThread->start();
			//delete SQLOst;
			//SQLOst = new SQLThread(CashReg);
			//SQLServer->InitInstance();
	//	if(!CashReg->SQLServer->running())
	//		CashReg->SQLServer->start();
			//ÚÛÚ ÓÚ‰ÂÎ¸Ì˚Ï ÔÓÚÓÍÓÏ ‡Ò˜ÂÚ ÓÒÚ‡ÚÍÓ‚
			//select sum(kol) from mggetosttov('+NomenDMod.NomenQKodNom.AsString+',''today'', ''today'')
			//bool ok;
			//unsigned long lCode=PriceChecker->CodeLine->text().toULong(&ok, 10);
			//if (ok){
				//ShowMessage(Double2Str(CashReg->SQLServer->GetOstTov(lCode)));
				//result = pthread_create(&thread1, NULL, Empty/*PriceChecker->GetOstTov(lCode)*/, &pid1);
				//if (result != 0)
					//ShowMessage("thread error");
				//else
					//ShowMessage(strost);
				//PriceChecker->RestLine->setText(GetRounded(CashReg->SQLServer->GetOstTov(lCode),0.001).c_str());

			//}else
				//PriceChecker->RestLine->setText("ERRCODE");
	}
	catch(cash_error& er)
	{
		CashReg->DbfMutex->unlock();
		CashReg->LoggingError(er);
		FoundPrices.Clear();
	}
}

int WorkPlace::SearchDiscount(int SearchDiscountMode,string *discount,long long *number)
{
#ifdef ZAPRETBONUS
	bool isDiscount,isCertificate,isMoney,isFlyer;
	isDiscount=false;
	isCertificate=false;
	isMoney=false;
	isFlyer=false;
	long long GuardRes=NotCorrect;
    long long CurSert = 0LL;
    long long OldCustomer = CurrentCustomer;
    long long OldAddonCustomer = CurrentAddonCustomer;

    CustomerByPhone=false;

	if (SearchDiscountMode == FindAuto)		isDiscount	= true;
	if (SearchDiscountMode == FindFromScaner)	isDiscount	= true;
	if (SearchDiscountMode == FindDiscnt)		isDiscount	= true;
	if (SearchDiscountMode == FindCertificate)	isCertificate	= true;
	if (SearchDiscountMode == FindMoney)		isMoney		= true;

	{
		char tmpstr[1024];
		sprintf(tmpstr,"SearchDiscount number = %lld",*number);
		Log(tmpstr);
	}

	if (SearchDiscountMode != FindAuto)
	{
		if (!EditLineCheck(""))
			return -1;

		if (!CashReg->CurrentSaleman->Discounts)
		{
			ShowMessage("ŒÚÒÛÚÒÚ‚Û˛Ú Ô‡‚‡ Ì‡ ÔÂ‰ÓÒÚ‡‚ÎÂÌËÂ ÒÍË‰ÍË!");
			return -1;
		}

		if (CurrentCertificate && isCertificate)
		{
			ShowMessage("—ÂÚËÙËÍ‡Ú ÛÊÂ ‚˚·‡Ì!");
			return -1;
		}

		if(SearchDiscountMode != FindFromScaner)
		{
			GuardRes=CheckBarcode(Customer);//check customer's id
		}
		else
		{
			long long res=NotCorrect;
			CashReg->FindCustomer(&res,*number);
			GuardRes=res;
		}

        isFlyer = CashReg->IsFlyer(GuardRes);

        // ¿ÍˆËˇ ‚˚‰‡˜Ë Í‡Ú˚ "ƒÓ·˚Â ÒÓÒÂ‰Ë" ÔË ÔÂ‰˙ˇ‚ÎÂÌËË ÙÎ‡Â‡
        if ((isFlyer) && (InActionDobryeSosedy(CurrentCustomer, GuardRes)))
        {
             return ShowMessageAndLogInfo(Card2Str(*number)+"\n —Ì‡˜‡Î‡ Ò˜ËÚ‡ÈÚÂ Í‡ÚÛ \"ƒÓ·˚Â ÒÓÒÂ‰Ë\" \n «‡ÚÂÏ Ò˜ËÚ‡ÈÚÂ ÙÎ‡Â!");
        }
        //==============

		if (!isFlyer && CurrentCustomer && isDiscount)
		{

			//ShowMessage("œÓÎ¸ÁÓ‚‡ÚÂÎ¸ ÒÍË‰ÍË ÛÊÂ ‚˚·‡Ì!");
            //return -1;

            if (!ShowQuestion("«‡ÏÂÌËÚ¸ ÚÂÍÛ˘Û˛ ‰ËÒÍÓÌÚÌÛ˛ Í‡ÚÛ?",true))
            {
                return -1;
            }
		}

		if ((GuardRes==NotCorrect) && isDiscount)
		{
			return ShowMessageAndLogInfo(Card2Str(*number)+" ÕÂÔ‡‚ËÎ¸Ì˚È Ô‡ÓÎ¸ ÔÓÍÛÔ‡ÚÂÎˇ");
		}

		if ((GuardRes==NotCorrect) && isCertificate)
		{
    		return ShowMessageAndLogInfo(Card2Str(*number)+" ÕÂÔ‡‚ËÎ¸Ì˚È ÌÓÏÂ ÒÂÚËÙËÍ‡Ú‡");
		}

		if ((GuardRes==NotCorrect) && isMoney)
		{
    		return ShowMessageAndLogInfo(Card2Str(*number)+" ÕÂÔ‡‚ËÎ¸Ì˚È ÌÓÏÂ ÒÂÚËÙËÍ‡Ú‡");
		}

		if (GuardRes==NoPasswd)
			return -1;

		if (isDiscount)
            if (isFlyer) CurrentAddonCustomer = GuardRes;
            else CurrentCustomer=GuardRes;
		if (isCertificate)	CurrentCertificate=GuardRes;
        if (isMoney)        CurSert = GuardRes;


	}
	else
	{
	    long long res=NotCorrect;
        CashReg->FindCustomer(&res,*number);
		GuardRes = *number;

		isFlyer = CashReg->IsFlyer(GuardRes);
	}

	bool TimeLimit;
	bool FromRange=false;
    string TextInfo = "";

	CashReg->DbfMutex->lock();

	if (CashReg->CustomersTable->GetLLongField("ID")==GuardRes)
	{
	    TextInfo = CashReg->CustomersTable->GetField("INFO");
	    TextInfo = trim(TextInfo);
    }

	if (CashReg->CustomersTable->GetLLongField("ID")==GuardRes)
		TimeLimit=xbDate().JulianDays()<xbDate(CashReg->CustomersTable->GetField("ISSUE").c_str()).JulianDays();
	else
		TimeLimit=xbDate().JulianDays()<xbDate(CashReg->CustRangeTable->GetField("ISSUE").c_str()).JulianDays();
	CashReg->DbfMutex->unlock();

    if (!TextInfo.empty())
    {
        TextInfo = "»ÌÙÓÏ‡ˆËˇ ÔÓ Í‡ÚÂ N "+
        Card2Str(CashReg->CustomersTable->GetLLongField("ID"))
        +":\n\n"+TextInfo;

        ShowMessage(TextInfo);
    }

    if (
    (GuardRes>=992000498000LL && GuardRes<=992000499199LL) //	¬ÂÚÂ‡Ì
    ||
    (GuardRes>=992000470752LL && GuardRes<=992000485751LL) //	¬ÂÚÂ‡Ì
    ||
    (GuardRes>=992000425752LL && GuardRes<=992000455751LL) //	¬ÂÚÂ‡Ì
    ||
    (GuardRes>=992000621200LL && GuardRes<=992000721199LL) //	¬ÂÚÂ‡Ì
    ||
    (GuardRes>=992000399752LL && GuardRes<=992000419751LL) //	¬ÂÚÂ‡Ì
    ||
    (GuardRes>=922000425752LL && GuardRes<=922000455751LL) //	¬ÂÚÂ‡Ì
    ||
    (GuardRes>=992001468819LL && GuardRes<=992001574168LL) //	¬ÂÚÂ‡Ì ¿ÈÍ‡È
    ||
    (GuardRes>=992001051800LL && GuardRes<=992001151188LL) //	¬ÂÚÂ‡Ì ¿ÈÍ‡È
    ||
    (GuardRes>=993000840000LL && GuardRes<=993000844999LL) //	¬ÂÚÂ‡Ì √‡ÒÚÓÌÓÏ
    ||
    (GuardRes>=992000000001LL && GuardRes<=992000010000LL) //	ÕÂËÁ‚ÂÒÚÌ˚È ‰Ë‡Ô‡ÁÓÌ 2-5%
    ||
    (GuardRes>=993000500100LL && GuardRes<=993000502999LL) //	ŒÍÂ‡Ì ‰ÂÚÒÚ‚‡
    ||
    (GuardRes>=993000500000LL && GuardRes<=993000500099LL) //	ŒÍÂ‡Ì ‰ÂÚÒÚ‚‡ VIP
    ||
    (GuardRes>=993000900001LL && GuardRes<=993000901000LL) //	ŒÍÂ‡Ì ÏÂÎÓ˜ÂÈ
    )
    {
        //TextInfo = "«¿Ã≈Õ»“‹  ¿–“” # "+ LLong2Str(GuardRes) +"\n\n¬˚‰‡Ú¸ ‚Á‡ÏÂÌ Í‡ÚÛ À˛·ËÏÓ„Ó ÍÎËÂÌÚ‡ √‡ÒÚÓÌÓÏ";
        TextInfo = "«¿Ã≈Õ»“‹  ¿–“” # "+ Card2Str(GuardRes) +"\n\n¬˚‰‡Ú¸ ‚Á‡ÏÂÌ Í‡ÚÛ À˛·ËÏÓ„Ó ÍÎËÂÌÚ‡ √‡ÒÚÓÌÓÏ";

        ShowMessage(TextInfo);
    }

    if (GuardRes>=444000012001LL && GuardRes<=444000037200LL) {
        TextInfo = "«¿Ã≈Õ»“‹  ¿–“”\n\n¬˚‰‡Ú¸ Í‡ÚÛ √‡ÒÚÓÌÓÏ ƒËÌ‡ÏÓ";
        ShowMessage(TextInfo);
    }

	if (TimeLimit && isDiscount)
	{
		CurrentCustomer = OldCustomer;
		CurrentAddonCustomer = OldAddonCustomer;
   		return ShowMessageAndLogInfo(Card2Str(*number)+" —ÓÍ ‰ÂÈÒÚ‚Ëˇ Í‡Ú˚ Â˘Â ÌÂ Ì‡ÒÚÛÔËÎ!");
	}

	if (TimeLimit && isCertificate)
	{
   		return ShowMessageAndLogInfo(Card2Str(*number)+" —ÓÍ ‰ÂÈÒÚ‚Ëˇ ÒÂÚËÙËÍ‡Ú‡ Â˘Â ÌÂ Ì‡ÒÚÛÔËÎ!");
	}

	if (TimeLimit && isMoney)
	{
   		return ShowMessageAndLogInfo(Card2Str(*number)+" —ÓÍ ‰ÂÈÒÚ‚Ëˇ ÒÂÚËÙËÍ‡Ú‡ Â˘Â ÌÂ Ì‡ÒÚÛÔËÎ!");
	}

	CashReg->DbfMutex->lock();
	if (CashReg->CustomersTable->GetLLongField("ID")==GuardRes)
		TimeLimit=xbDate().JulianDays()>xbDate(CashReg->CustomersTable->GetField("EXPIRE").c_str()).JulianDays();
	else
	{
		TimeLimit=xbDate().JulianDays()>xbDate(CashReg->CustRangeTable->GetField("EXPIRE").c_str()).JulianDays();
		FromRange=true;
	}
	CashReg->DbfMutex->unlock();


	CashReg->DbfMutex->lock();
	string CardAttr;
	if(isDiscount)    CardAttr=" ‡Ú‡ N ";

	if(isCertificate) CardAttr="—ÂÚËÙËÍ‡Ú N ";

	//CardAttr+=LLong2Str(FromRange?CurrentCustomer:CashReg->CustomersTable->GetLLongField("ID"));
    //if(isFlyer) CardAttr = " ‡Ú‡-ÙÎ‡Â N "+LLong2Str(CurrentAddonCustomer);
    //if(isMoney) CardAttr = "—ÂÚËÙËÍ‡Ú N "+LLong2Str(FromRange?CurSert:CashReg->CustomersTable->GetLLongField("ID"));

	CardAttr+=Card2Str(FromRange?CurrentCustomer:CashReg->CustomersTable->GetLLongField("ID"));

    if(isFlyer) CardAttr = " ‡Ú‡-ÙÎ‡Â N "+Card2Str(CurrentAddonCustomer);
    if(isMoney) CardAttr = "—ÂÚËÙËÍ‡Ú N "+Card2Str(FromRange?CurSert:CashReg->CustomersTable->GetLLongField("ID"));

    CashReg->DbfMutex->unlock();


//!+ «‡ÏÂÌ‡ Í‡Ú ‘‡Ï‡ÍÓÌ Ë Ô. Ì‡ Í‡Ú˚ √‡ÒÚÓÌÓÏ
    if (CurrentCustomer < 993000000000LL)
    {
        CardInfoStruct CardInfoExp;
        if (CashReg->FindCardInRangeTable(&CardInfoExp, CurrentCustomer))
        {
            if(CardInfoExp.isExpire) {
                CurrentCustomer = OldCustomer;
                CurrentAddonCustomer = OldAddonCustomer;
                return ShowMessageAndLogInfo(CardAttr+"\n\n ¿–“¿ «¿¡ÀŒ »–Œ¬¿Õ¿!\n\nÕ≈Œ¡’Œƒ»ÃŒ «¿Ã≈Õ»“‹  ¿–“” Õ¿  ¿–“” √¿—“–ŒÕŒÃ 2%!");
            }
        }
    }
//!- «‡ÏÂÌ‡ Í‡Ú ‘‡Ï‡ÍÓÌ Ë Ô. Ì‡ Í‡Ú˚ √‡ÒÚÓÌÓÏ

	if (TimeLimit && isDiscount)
	{
		//ShowMessage(CardAttr+"\n ‡Ú‡ Á‡·ÎÓÍËÓ‚‡Ì‡ ËÎË ÒÓÍ ‰ÂÈÒÚ‚Ëˇ ËÒÚÂÍ!");
		CurrentCustomer = OldCustomer;
		CurrentAddonCustomer = OldAddonCustomer;
		return ShowMessageAndLogInfo(CardAttr+"\n ‡Ú‡ Á‡·ÎÓÍËÓ‚‡Ì‡ ËÎË ÒÓÍ ‰ÂÈÒÚ‚Ëˇ ËÒÚÂÍ!");
	}

	if (TimeLimit && isCertificate)
	{
		return ShowMessageAndLogInfo(CardAttr+"\n—ÂÚËÙËÍ‡Ú Á‡·ÎÓÍËÓ‚‡Ì!");
	}
	if (TimeLimit && isMoney)
	{
		return ShowMessageAndLogInfo(CardAttr+"\n—ÂÚËÙËÍ‡Ú Á‡·ÎÓÍËÓ‚‡Ì!");
	}

	bool goNext;
	goNext = false;

	goNext = (SearchDiscountMode == FindAuto);
	if(!goNext)
	{
	    if(goNext = ShowQuestion(CardAttr,true))
	    {

	        //////
            long long res=NotCorrect;
            CashReg->FindCustomer(&res,GuardRes);
            /////

            *number = GuardRes;
	    }
	    else
	    {   if (isFlyer) CurrentAddonCustomer = OldAddonCustomer;

            if (OldCustomer)
            {
                CurrentCustomer = OldCustomer;
                *number = OldCustomer;
                return -1;
            }
	    }
	}

	if (goNext)//check discount's and customer's params
	{
		CashReg->DbfMutex->lock();

		NeedCert=0;

		int recno;
		if(!FromRange)
		{
			DiscountType_T=CashReg->CustomersTable->GetField("DISCOUNTS");
			NeedCert=CashReg->CustomersTable->GetLongField("NEEDCERT");
		}
		else
		{
			DiscountType_T=CashReg->CustRangeTable->GetField("DISCOUNTS");
		}

		CashReg->DbfMutex->unlock();

		*discount = DiscountType_T;

        /*
        if (DiscountType_T[1]=='.')
                ShowMessage(CardAttr+"\n\n    ¬ÌËÏ‡ÌËÂ!!!\
                \n    ƒÎˇ Û˜‡ÒÚËˇ ‚ ÕÓ‚Ó„Ó‰ÌÂÈ ‡ÍˆËË ÌÛÊÌÓ Á‡ÔÓÎÌËÚ¸ \
                \n‡ÌÍÂÚÌ˚Â ‰‡ÌÌ˚Â.");
        */

        if (CashReg->FindCustomerInfo(CurrentCustomer))
        {
            CashReg->DbfMutex->lock();
            double disc_summ = CashReg->CustomersValueTable->GetDoubleField("DISCSUMMA");
            double total_summ = CashReg->CustomersValueTable->GetDoubleField("SUMMA");
            CashReg->DbfMutex->unlock();

            CashReg->ShowLevelDiscountMessage(disc_summ, total_summ);
		}


        if (!isMoney) // ÒÍË‰ÍË ÏÂÌˇÂÏ ÚÓÎ¸ÍÓ ÂÒÎË ÌÂ ÓÔÎ‡Ú‡
        {

          if(!isFlyer)
          {
            DiscountType="";
            CashReg->LoadDiscountTypeFromDB(0LL,&DiscountType);

            for (int ii = 0; ii < MAXDISCOUNTLEN; ii++)
            {
                if (DiscountType.length()<(ii+1))
                    DiscountType+='X';
//!!!!!!!!!!!
//                if (DiscountType_T[ii] == '.')
//                    DiscountType[ii] = '.';//
//!!!!!!!!!!!

                string sk = "0123456789Z";

                if (DiscountType_T[ii] == '.')
                    DiscountType[ii] = '.';
                else
                  {
					if( sk.find(DiscountType_T[ii]) != string::npos)
                    DiscountType[ii] = DiscountType_T[ii];
                  }

            }
          }

          AddAddonDiscount(CurrentAddonCustomer);

        }

		ProcessDiscount(Cheque);
		double dsum = Cheque->GetDiscountSum();
		CashReg->m_vem.Discount(Cheque->GetCalcSum(),3,GuardRes, dsum);

		char str[1024];
		sprintf(str, "DiscountType = %s; DSum = %f", DiscountType.c_str(), dsum);
		Log(str);

        // ===BONUS===

        CurrentActiveBonus=0;
        StatusBonusCard ="";
        CurrentBonusBalans=0;

        if (!NeedCert)
        {
            CardInfoStruct CardInfo;
            if (CashReg->FindCardInRangeTable(&CardInfo, CurrentCustomer))
            {
                if (CardInfo.BonusCard==1) NeedCert = 1;
            }
        }

/*
        if (NeedCert)
        {
            string card = LLong2Str(CurrentCustomer);
            string strCheck = Int2Str(CashReg->GetLastCheckNum()+1);

            // »ÌÙÓÏ‡ˆËˇ ÔÓ Í‡ÚÂ
            ;;Log("+ GetCardInfo +");
            BNS_RET* retInf = CashReg->BNS->exec("inf", card, strCheck);
            ;;Log("- GetCardInfo -");
            if (!retInf->ReturnCode)
            {
                CurrentBonusBalans = retInf->ActiveBonuses;
            }

        }
*/
        // ===BONUS===

		return 0;
	}
	return 1;
#endif
} //SearchDiscount


// ÔÓ‚ÂÍ‡ Ì‡ ‰Ë‡Ô‡ÁÓÌ ÔÓ‰‡Ó˜Ì˚ı ÒÂÚËÙËÍ‡ÚÓ‚
int WorkPlace::IsCertificate(long long CardNum)
{
//        if
//        (
//            (CardNum>=993000810000LL) && (CardNum<=993000810299LL)
//            ||
//            (CardNum>=993000811000LL) && (CardNum<=993000811149LL)
//            ||
//            (CardNum>=993000812000LL) && (CardNum<=993000812099LL)
//            ||
//            (CardNum>=993000813000LL) && (CardNum<=993000813049LL)
//        )
//        {
//        // ˝ÚÓ ÒÂÚËÙËÍ‡Ú
//        return 1;
//        }

   //
//   return 0;

	long long GuardRes=NotCorrect;
    string DiscountStr;

/*
	try
	{
		DbfMutex->lock();
		if (CustomersTable->Locate("ID",CardNumber))
		{
			*res = CardNumber;
		}
		else
		{
			if (CustRangeTable->GetFirstRecord())
			{// Ë˘ÂÏ ÒÍË‰ÍÛ ‚ Ú‡·ÎËˆÂ ‰Ë‡Ô‡ÁÓÌÓ‚
				do{
					if(CustRangeTable->GetLLongField("IDFIRST") <= CardNumber &&
					CustRangeTable->GetLLongField("IDLAST") >= CardNumber)
					{
						*res=CardNumber;
						break;
					}
				}
				while(CustRangeTable->GetNextRecord());
			}
		}
		DbfMutex->unlock();

	}
	catch(cash_error& er)
	{
		DbfMutex->unlock();
		LoggingError(er);
	}
//*/

	try
	{
		CashReg->DbfMutex->lock();

		if (CashReg->CustomersTable->Locate("ID",CardNum))
		{
            GuardRes=CardNum;
            DiscountStr = CashReg->CustomersTable->GetField("DISCOUNTS");


#ifdef CERTIFICATES
                    Log("-------------------------------------------------");
                    Log("—ÍË‰Í‡=" + DiscountStr);
                    Log("›ÚÓ ÒÂÚËÙËÍ‡Ú");
                    Log("---------------------------------------------------");
#endif

        }
        else
        {

#ifdef CERTIFICATES
                    Log("****************************************************");
                    Log("—ÍË‰Í‡=" + DiscountStr);
                    Log("›ÚÓ ÒÂÚËÙËÍ‡Ú");
                    Log("****************************************************");
#endif

            if (CashReg->CustRangeTable->GetFirstRecord())
            {// Ë˘ÂÏ ÒÍË‰ÍÛ ‚ Ú‡·ÎËˆÂ ‰Ë‡Ô‡ÁÓÌÓ‚
                do{
                    if(CashReg->CustRangeTable->GetLLongField("IDFIRST") <= CardNum &&
                    CashReg->CustRangeTable->GetLLongField("IDLAST") >= CardNum)
                    {
                        GuardRes=CardNum;
                        DiscountStr = CashReg->CustRangeTable->GetField("DISCOUNTS");
                        break;
                    }
                }
                while(CashReg->CustRangeTable->GetNextRecord());
            }
        }
		CashReg->DbfMutex->unlock();

	}
	catch(cash_error& er)
	{
		CashReg->DbfMutex->unlock();
		CashReg->LoggingError(er);
	}

	//CashReg->FindCustomer(&GuardRes, CardNum);

    if (GuardRes==NotCorrect)
    {
        //ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÌÓÏÂ ÒÂÚËÙËÍ‡Ú‡.");
        return 0;
    }

    if (GuardRes==NoPasswd)
        return -1;

    int recno;

    bool IsRealCert = false;

	try
	{
		CashReg->DbfMutex->lock();

		// ÔÓ‚ÂˇÂÏ Ì‡ ÒÂÚËÙËÍ‡Ú
		CashReg->DiscountsTable->GetFirstRecord();

		do
		{
			int type=CashReg->DiscountsTable->GetLongField("DISCTYPE");
			int mode=CashReg->DiscountsTable->GetLongField("MODE");

			if( (mode==3)
             && (DiscountStr.size()>=type)
             && (DiscountStr[type-1]=='.') )
                    // ÓÌ, Ó‰ËÏ˚È
                    IsRealCert = true;

		}while(!IsRealCert && CashReg->DiscountsTable->GetNextRecord());

        CashReg->DbfMutex->unlock();

	}
	catch(cash_error& er)
	{
		CashReg->DbfMutex->unlock();
	}

    return IsRealCert?1:0;

} //IsCertificate


int WorkPlace::IsCertificate(int CardNum)
{
    return IsCertificate(993000000000LL + (long long) CardNum);
}


int WorkPlace::SearchCertificate(int SearchDiscountMode,string *discount,long long *number, double *summa)
{
	bool isCertificate,isMoney;
	isCertificate=false;
	isMoney=false;
	long long GuardRes=NotCorrect;
    long long CurSert = 0LL;

	if (SearchDiscountMode == FindAuto)		    isCertificate = true;
	if (SearchDiscountMode == FindFromScaner)	isCertificate = true;
	if (SearchDiscountMode == FindCertificate)	isCertificate = true;
	if (SearchDiscountMode == FindMoney)		isMoney		= true;


	if (SearchDiscountMode != FindAuto)
	{

		if (!CashReg->CurrentSaleman->Discounts)
		{
			ShowMessage("ŒÚÒÛÚÒÚ‚Û˛Ú Ô‡‚‡ Ì‡ ÔÂ‰ÓÒÚ‡‚ÎÂÌËÂ ÒÍË‰ÍË!");
			return -1;
		}

		if(SearchDiscountMode != FindFromScaner)
		{
			GuardRes=CheckBarcode(Certificate, "¬‚Â‰ËÚÂ ¯ÚËı-ÍÓ‰ ÒÂÚËÙËÍ‡Ú‡");//check customer's id
		}
		else
		{
			long long res=NotCorrect;
			CashReg->FindCustomer(&res,*number);
			GuardRes=res;
		}

		if (GuardRes==NotCorrect)
		{
            return ShowMessageAndLogInfo(LLong2Str(*number)+" ÕÂÔ‡‚ËÎ¸Ì˚È ÌÓÏÂ ÒÂÚËÙËÍ‡Ú‡");
		}

		if (GuardRes==NoPasswd)
			return -1;

		if (isCertificate)	CurrentCertificate=GuardRes;
        if (isMoney)        CurSert = GuardRes;

	}
	else
	{
	    long long res=NotCorrect;
        CashReg->FindCustomer(&res,*number);
		GuardRes = *number;
	}

	bool TimeLimit;
	bool FromRange=false;

	CashReg->DbfMutex->lock();
	if (CashReg->CustomersTable->GetLLongField("ID")==GuardRes)
		TimeLimit=xbDate().JulianDays()<xbDate(CashReg->CustomersTable->GetField("ISSUE").c_str()).JulianDays();
	else
		TimeLimit=xbDate().JulianDays()<xbDate(CashReg->CustRangeTable->GetField("ISSUE").c_str()).JulianDays();
	CashReg->DbfMutex->unlock();


	if ((TimeLimit)
	&& (!NeedActionVTB))
	{
        return ShowMessageAndLogInfo(LLong2Str(*number)+" —ÓÍ ‰ÂÈÒÚ‚Ëˇ ÒÂÚËÙËÍ‡Ú‡ Â˘Â ÌÂ Ì‡ÒÚÛÔËÎ!");
	}


	CashReg->DbfMutex->lock();
	if (CashReg->CustomersTable->GetLLongField("ID")==GuardRes)
		TimeLimit=xbDate().JulianDays()>xbDate(CashReg->CustomersTable->GetField("EXPIRE").c_str()).JulianDays();
	else
	{
		TimeLimit=xbDate().JulianDays()>xbDate(CashReg->CustRangeTable->GetField("EXPIRE").c_str()).JulianDays();
		FromRange=true;
	}
	CashReg->DbfMutex->unlock();

	if (TimeLimit)
	{
        return ShowMessageAndLogInfo(LLong2Str(*number)+" —ÂÚËÙËÍ‡Ú Á‡·ÎÓÍËÓ‚‡Ì!");
	}

	CashReg->DbfMutex->lock();
	string CardAttr;

	CardAttr="—ÂÚËÙËÍ‡Ú N ";
	CardAttr+=LLong2Str(FromRange?GuardRes:CashReg->CustomersTable->GetLLongField("ID"));
	CashReg->DbfMutex->unlock();

	{
		char tmpstr[1024];
		sprintf(tmpstr,"Search sertificate number = %lld",GuardRes);
		Log(tmpstr);
	}


//	goNext = (SearchDiscountMode == FindAuto);

//	if (goNext)//check discount's and customer's params
	{
		CashReg->DbfMutex->lock();
		int recno;
		string DiscountStr;

		if(!FromRange)
		{
			DiscountStr=CashReg->CustomersTable->GetField("DISCOUNTS");
		}
		else
		{
			DiscountStr=CashReg->CustRangeTable->GetField("DISCOUNTS");
		}

		CashReg->DbfMutex->unlock();

        *discount = DiscountStr;

        try
        {
            CashReg->DbfMutex->lock();

            //Ë˘ÂÏ ÒÛÏÏÛ ÒÂÚËÙËÍ‡Ú‡
            CashReg->DiscountsTable->GetFirstRecord();
            time_t cur_time=time(NULL);
            tm *l_time=localtime(&cur_time);
            int Seconds=l_time->tm_hour*3600+l_time->tm_min*60+l_time->tm_sec;
            int Days=xbDate().JulianDays();

            double Charge=0,WholeCharge=0;

            bool IsRealCert = false;

            do
            {
                int type=CashReg->DiscountsTable->GetLongField("DISCTYPE");
                int mode=CashReg->DiscountsTable->GetLongField("MODE");

                if(mode != 3) continue;


                if(
                    (DiscountStr.size()<type)
                    ||
                    (DiscountStr[type-1]!='.')
                )
                    continue;


                double tmpCharge;

                if (mode==3)
                {
                    tmpCharge=CashReg->DiscountsTable->GetDoubleField("CHARGE");//recalculate goods price
                    IsRealCert = true;
                }

                if (tmpCharge>Charge) Charge=tmpCharge;

            }while(CashReg->DiscountsTable->GetNextRecord());

            CashReg->DbfMutex->unlock();

            //‰ÓÔÛÒÍ‡˛ÚÒˇ ÚÓÎ¸ÍÓ ÒÂÚËÙËÍ‡Ú˚
            if (!IsRealCert)
            {
                *number = 0;
                summa = 0;

                return ShowMessageAndLogInfo(LLong2Str(GuardRes)+" ÌÂ ˇ‚ÎˇÂÚÒˇ ÔÓ‰‡Ó˜Ì˚Ï ÒÂÚËÙËÍ‡ÚÓÏ!");
            }

            *summa=Charge;

            string CardAttr;
            CardAttr = "—ÂÚËÙËÍ‡Ú N ";
            CardAttr+=LLong2Str(GuardRes);

            if(ShowQuestion(CardAttr,true))
                *number = GuardRes;
            else return 1;

        }
        catch(cash_error& er)
        {
            CashReg->DbfMutex->unlock();
            *number = 0;
            summa = 0;
            //LoggingError(er);
            return -1;
        }

        char str[1024];
        sprintf(str, "Discount = %s; Summa = %f", DiscountType.c_str(), *summa);
        Log(str);

        return 0;
	}

	return 1;

} // SearchCertificate

void WorkPlace::UpdateBankStatus(void)
{
	QFont tmpFont=BankInfo->font();
	tmpFont.setStrikeOut(!CashReg->StatusBankConnection);
	BankInfo->setFont(tmpFont);
	BankInfo->repaint();
}

void WorkPlace::TimerBankAction(void)
{
    if (CashReg->TryBankConnect) CashReg->TestBankConnection(0, 1);
}

//!bool WorkPlace::GoodsLock(FiscalCheque* CurCheque, bool ShowMsg = true)
bool WorkPlace::GoodsLock(FiscalCheque* CurCheque, bool ShowMsg)
{
    if (!CurCheque) CurCheque = Cheque;
	if (!CurCheque) return false;

    try
    {
        for (int i=0;i<CurCheque->GetCount();i++)
        {
            if ((*CurCheque)[i].ItemFlag == SL)
            {
              string str = (*CurCheque)[i].Lock;
              if (CashReg->GoodsLock(str, GL_TimeLock) == GL_TimeLock)
              {
                  if (ShowMsg) ShowMessage("œÓ‰‡Ê‡ ÚÓ‚‡‡ Ò ÍÓ‰ÓÏ "+Int2Str((*CurCheque)[i].ItemCode)+" Á‡ÔÂ˘ÂÌ‡!");
                  return true;
              }
            }
        }
    }
	catch(cash_error& er)
	{
		CashReg->LoggingError(er);
	}

	return false;
}


void WorkPlace::StartScreenSaver(void)
{
    if (ScreenSaver!=NULL)
        return;

    if (!ShowScreenSaver)
        return;

    if (Cheque->GetCount()!=0)
        return;

    if (CurrentCustomer!=0)
        return;

    if (!EditLine->text().isEmpty())
        return;

    ScreenSaver = new ScreenSaverForm(this);

    ScreenSaver->path = W2U(CashReg->DBPicturePath)+"/";
    ScreenSaver->filename = "pic.jpg";
    ScreenSaver->WSize = CashReg->size();

    ScreenSaver->exec();

    delete ScreenSaver;
    ScreenSaver=NULL;

    return;
}


void WorkPlace::RestartTimerSS(bool start)
{
    if (TimerScreenSaver->isActive())
         TimerScreenSaver->stop();

    if (start && ShowScreenSaver)
    {
        TimerScreenSaver->start(WAITTIMESS);
    }

}


void WorkPlace::RunMessager(string MessageStr)
{

    const char *msgfile = "./tmp/history.msg";

    if (Messager!=NULL)
    {
        Messager->FillHistory(msgfile);
        return;
    }
    else
    {
        if (MessageStr!="")
        {
             int ret = QMessageBox::information
                    ( NULL, "APM KACCA", W2U(MessageStr)
                    ,W2U("«‡Í˚Ú¸"), W2U("ŒÚ‚ÂÚËÚ¸"),QString::null , 0, -1);
             if(ret!=1) return ;
        }
    }

    //if (Messager==NULL)
    Messager = new MsgForm(this, CashReg->LastMessageItem);

    for(;;)
    {
        Messager->EditLine->setText(CashReg->LastMessageText);
        Messager->NumberBox->setCurrentItem(CashReg->LastMessageItem);
        Messager->SaveHistory->setChecked(CashReg->SaveMessageHistory);
        Messager->FillHistory(msgfile);

        if (Messager->exec()==QDialog::Accepted)
        {
            if (!Messager->EditLine->text().isEmpty())
            {
                string header = " ‡ÒÒ‡ π"+Int2Str(CashReg->GetCashRegisterNum())+":  "+CashReg->CurrentSaleman->Name+"\n";

                string addr ="apm-kacca", body,message = header+U2W(Messager->EditLine->text());

                //addr+=Int2Str((Messager->NumberBox->currentItem()+1));

                addr=U2W(Messager->NumberBox->currentText());

                body="MESSAGE:"+message;
                if ((!addr.empty())&&(!body.empty()))
                    CashReg->Socket->SendMessage(addr.c_str(),body.c_str());

                LogMessage("<<", message);

                Messager->EditLine->clear();

                CashReg->LastMessageText = Messager->EditLine->text();
                CashReg->LastMessageItem = Messager->NumberBox->currentItem();
                CashReg->SaveMessageHistory = Messager->SaveHistory->isChecked();

            }
        }
        else
        {
            break;
        }

    }
    CashReg->LastMessageText = Messager->EditLine->text();
    CashReg->LastMessageItem = Messager->NumberBox->currentItem();
    CashReg->SaveMessageHistory = Messager->SaveHistory->isChecked();

    if (!CashReg->SaveMessageHistory)
    {
        FILE *f = fopen(msgfile, "w");
        if(f)
        {
            fprintf(f,"\n");
            fclose(f);
        }
    }

    delete Messager;
    Messager = NULL;
}



int WorkPlace::AddAddonDiscount(long long number)
{
    if (!number) return 1;

	{
		char tmpstr[1024];
		sprintf(tmpstr," -> SearchAddonDiscount number = %lld", number);
		Log(tmpstr);
	}

    long long GuardRes=NotCorrect;
	long long res=NotCorrect;
	CashReg->FindCustomer(&res,number);
	GuardRes=number;

    if (GuardRes==NotCorrect)
    {
        //ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È Ô‡ÓÎ¸ ÔÓÍÛÔ‡ÚÂÎˇ");
        return -1;
    }

	if (GuardRes==NoPasswd)
		return -1;


	CashReg->DbfMutex->lock();
	if (CashReg->CustomersTable->GetLLongField("ID")==GuardRes)
	{
		DiscountType_T=CashReg->CustomersTable->GetField("DISCOUNTS");
	}
	else
	{
        DiscountType_T =CashReg->CustRangeTable->GetField("DISCOUNTS");
    }
	CashReg->DbfMutex->unlock();


		char str[1024];
		sprintf(str, "AddonDiscount = %s", DiscountType_T.c_str());
		Log(str);

    for (int ii = 0; ii < MAXDISCOUNTLEN; ii++)
    {
        if (DiscountType.length()<(ii+1))
            DiscountType+='X';

        string sk = "0123456789";

        bool isValue   = (sk.find(DiscountType[ii])!=string::npos);
        bool isValue_T = (sk.find(DiscountType_T[ii])!=string::npos);

        bool isDot     = (DiscountType[ii] == '.');
        bool isDot_T   = (DiscountType_T[ii] == '.');

        bool isZ     = (DiscountType[ii] == 'Z');
        bool isZ_T   = (DiscountType_T[ii] == 'Z');

        bool isX     = (DiscountType[ii] == 'X');
        bool isX_T   = (DiscountType_T[ii] == 'X');

        bool isR     = (DiscountType[ii] == 'R');
        bool isR_T   = (DiscountType_T[ii] == 'R');

//Log("$= 1 =$");
        if (isR_T)
        {
            DiscountType[ii] = 'Z';
            //Log((char*)Int2Str(ii).c_str());
           // Log("$= 1=1=1 =$");
        }
        else if (!isZ && isDot_T && !isValue)
        {
            DiscountType[ii] = '.';
           // Log((char*)Int2Str(ii).c_str());
          //  Log("$= 2 =$");
        }
        else
          {
            if (
                !isZ
                &&
                isValue_T
                &&
                (!isValue || (DiscountType[ii] < DiscountType_T[ii]))
               )
            {
                DiscountType[ii] = DiscountType_T[ii];
               // Log((char*)Int2Str(ii).c_str());
               // Log("$= 3 =$");
            }
          }
//Log("$= 4 =$");
    }

    return 0;

} //AddAddonDiscount





int WorkPlace::ProcessBankDiscounts(const char *card)
{

    string disc = "";
    long idcust =0;

    FiscalCheque::PayBank = true;

    int Result = CashReg->ProcessBankDiscounts(card, &disc, &idcust);

    if (!Result)
    {
        if(DiscountType.size() == 0)
        {
            CurrentCustomer = idcust;
            DiscountType    = disc;
        }
        else
        {
            for(int i = 0; i < DiscountType.size(); i++)
            {
                if((DiscountType[i] == '.')||(DiscountType[i] == 'Z'))   continue;
                if(disc[i] == '.')  DiscountType[i] = '.';
            }
        }

       // QMessageBox::information( NULL, "APM KACCA3", CashReg->CurrentWorkPlace->DiscountType.c_str(), "Ok");

        double a_sum = Cheque->GetSum(); // ÒÛÏÏ‡ ˜ÂÍ‡ ‰Ó ÔÂÂÒ˜ÂÚ‡

        //ProcessDiscount();
        SetBankDSum();
        ShowGoodsInfo(); // ÔÂÂÒ˜ÂÚ ÒÍË‰ÓÍ ÂÒÚ¸ ‚ÌÛÚË ÔÓˆÂ‰Û˚

        double b_sum = Cheque->GetSum(); // ÒÛÏÏ‡ ˜ÂÍ‡ ÔÓÒÎÂ ÔÂÂÒ˜ÂÚ‡

        string LogStr= card;
        LogStr = ">>> Bank discounts #"+LogStr.substr(0,8)+"# ="+Double2Str(a_sum-b_sum)+"\n"+disc;
        Log((char*)LogStr.c_str());
    }
    else
    {
      ShowGoodsInfo(); // ÔÂÂÒ˜ÂÚ ÒÍË‰ÓÍ ÂÒÚ¸ ‚ÌÛÚË ÔÓˆÂ‰Û˚
    }

    FiscalCheque::PayBank = false;

    return Result;
}


// ÔÓ‚ÂÍ‡ Ì‡ ÔÓ‚ÚÓÌ˚È ‚‚Ó‰ ‚ÂÒÓ‚˚ı ÚÓ‚‡Ó‚
bool WorkPlace::CheckWeightGoods(FiscalCheque* CurCheque)
{
    if (!CurCheque) CurCheque = Cheque;
	if (!CurCheque) return false;

    bool ShowAllert=false;

    try
    {
        for (int i=0;i<CurCheque->GetCount();i++)
        {
            int code = (*CurCheque)[i].ItemCode;
            double count = (*CurCheque)[i].ItemCount;

            if
            (
            ((*CurCheque)[i].ItemFlag == SL)
            &&
            ((*CurCheque)[i].ItemPrecision != 1) // ‚ÂÒÓ‚ÓÈ ÚÓ‚‡
            &&
            ((*CurCheque)[i].ItemCount*10 - int((*CurCheque)[i].ItemCount*10) > .0001)
//            &&
//            (!(*CurCheque)[i].DoubleWeightGoods) // ÌÂ ÓÚÏÂ˜ÂÌ
            )
            {

                for (int j=i+1;j<CurCheque->GetCount();j++)
                {
                    if
                    (
                    ((*CurCheque)[j].ItemFlag == SL)
                    &&
                    ((*CurCheque)[j].ItemPrecision != 1)
                    &&
                    ((*CurCheque)[j].ItemCode == code)
                    &&
                    ((*CurCheque)[j].ItemCount == count)
                    )
                    {
                        GoodsInfo g=(*CurCheque)[j];
                        g.DoubleWeightGoods = true;
                        CurCheque->SetAt(j,g);

                        ShowAllert = true;
                    }// if
                }//for j
            }// if
        } //for i
    }
	catch(cash_error& er)
	{
		CashReg->LoggingError(er);
	}

      if (ShowAllert)
      {
          UpdateList();

          GoodsWeightChecked=ShowQuestion("¬ÌËÏ‡ÌËÂ!\n¬ ˜ÂÍÂ ÔËÒÛÚÒÚ‚Û˛Ú ‚ÂÒÓ‚˚Â ÚÓ‚‡˚ Ò Ó‰ËÌ‡ÍÓ‚˚Ï ÍÓÎË˜ÂÒÚ‚ÓÏ!\n\n¬ÒÂ ‡‚ÌÓ ÓÚ·ËÚ¸ ˜ÂÍ?",false);;
          return !GoodsWeightChecked;
      }

	return false;
}

bool WorkPlace::EnterBarcode(int Tag, string msg, string errmsg)
{

	int Res=CheckBarcode(Tag, msg);

	if ((Res==NotCorrect)
	|| (Res==NoPasswd))
	{
		if (errmsg!="") ShowMessage(errmsg);
		return false;
	}

	return true;

}

int WorkPlace::GetCertNominal(string barcode)
{
  int res =0;
  if (barcode== "100") res=100;
  else if (barcode== "250") res=250;
  else if (barcode== "500") res=500;
  else if (barcode== "1000")res=1000;
  else if (barcode== "1500")res=1500;
  else if (barcode== "2000")res=2000;
  else if (barcode== "3000")res=3000;
  else if (barcode== "5000")res=5000;

  return res;
}

int WorkPlace::ShowMessageAndLogInfo(string msg)
{
    CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,CARDINFO,0,CashReg->CurrentSaleman->Id,-1,NULL,NULL,NULL, (char*)msg.c_str());
    ShowMessage(msg);
    return -1;
}


bool WorkPlace::IsHandDiscounts()
{
 bool res = true;
 for(short i=5;i<=7;i++) if (DiscountType[i]!='Z') res=false;
 return res;
}





int WorkPlace::ProcessBankBonusDiscount(string card, string sha1, bool uselimit)
{

//long WorkPlace::ProcessBankBonusPay(const char *card, string st, double bns, double a_bns, string info_text)

    if (Cheque->GetBankBonusSum()>0)
    {// ‰ÂÎ‡ÂÏ Â‚ÂÒ
        if (!ShowQuestion("¬ÌËÏ‡ÌËÂ! ¡ÓÌÛÒ˚ ÛÊÂ ÔËÏÂÌÂÌ˚! \nŒÚÏÂÌËÚ¸ ÚÂÍÛ˘Û˛ ÒÍË‰ÍÛ ÔÓ ·ÓÌÛÒ‡Ï Ë Á‡‰‡Ú¸ ÌÓ‚ÓÂ ÁÌ‡˜ÂÌËÂ ÒÍË‰ÍË?",true))
        {
            return -1;
        }

        ProcessBankBonusDiscountReverse(card, sha1);
    }

//;;Log("+ ProcessBankBonusDiscount +");
    string disc = "";
    long idcust =0;

    long Result = 0;

    double chSumma = Cheque->GetSum()-1;

    if (chSumma<=0)
    {
        Log("¡ŒÕ”—€:  —ÎË¯ÍÓÏ Ï‡ÎÂÌ¸Í‡ˇ ÒÛÏÏ‡ ˜ÂÍ‡! (ƒÓÎÊÂÌ ·˚Ú¸ > 1Û·.)");
        return -1;
    }

// + dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========
// ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚ "—Ô‡ÒË·Ó" ÌÂ ‰ÓÎÊÌ‡ ·˚Ú¸ ÏÂÌ¸¯Â 300 ·‡ÎÎÓ‚
// —ÓÓÚ‚ÂÚÒÚ‚ÂÌÌÓ ÒÛÏÏ‡ ˜ÂÍ‡ ‰ÓÎÊÌ‡ ·˚Ú¸ ·ÓÎ¸¯Â 300 Û·ÎÂÈ
    if (chSumma<BANKBONUS_MINIMUM_LIMIT)
    {
        Log("¡ŒÕ”—€:  —ÎË¯ÍÓÏ Ï‡ÎÂÌ¸Í‡ˇ ÒÛÏÏ‡ ˜ÂÍ‡ (ÏÂÌÂÂ 301 Û·.)! ");
        return -1;
    }
// - dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========

;;Log("+ GetCardInfo +");

    //LProc* LPCX = new LProc();

    //LPCX ->Init();
    PCX_RET* ret = CashReg->WPCX->exec("inf", card, sha1, Cheque);
;;Log("- GetCardInfo -");



//        CashReg->LoggingAction(,ERRORBONUSRETDISC,sum*.01,,0, card, NULL, NULL, NULL, SberbankCard);// *

    CashReg->AddBankBonusOperation(ret);
//;;Log("- Step 1 -");
    if (ret->ReturnCode>=0)
    {
    //==================================================================================

	//setlocale( LC_ALL, "ru_RU->koi8-r");



//;;Log("- Step 2 -");


            double all_bns = Str2Double(ret->BNS_S) + Str2Double(ret->BNS_DELAY_S);
            double active_bns = Str2Double(ret->AB_S);


// + dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========
//ŒÍÌÓ ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚ ÔÓÍ‡Á˚‚‡ÂÏ ÚÓÎ¸ÍÓ ÂÒÎË ÍÓÎ-‚Ó ·ÓÌÛÒÓ‚ >= 300
            if (active_bns<BANKBONUS_MINIMUM_LIMIT)
            {
                Log("¡ŒÕ”—€:  —ÎË¯ÍÓÏ Ï‡ÎÓ ·ÓÌÛÒÓ‚ (ÏÂÌÂÂ 300)! ");
                return -1;
            }

// ¡˚ÎÓ ‰Ó 01.03.2015
            //+ dms === 2014-05-08 === Œ„‡ÌË˜ÂÌËÂ Ì‡ ÔÓÍ‡Á ÓÍÌ‡ ·ÓÌÛÒÓ‚ ÔË ÓÔÎ‡ÚÂ ÔÓ ·ÂÁÌ‡ÎÛ
            // ÓÍÌÓ ÔÓÍ‡Á˚‚‡ÂÏ ÚÓÎ¸ÍÓ ÂÒÎË ÍÓÎ-‚Ó ·ÓÌÛÒÓ‚ > 20
//            if ((uselimit) && (active_bns<=BANKBONUS_MINIMUM_LIMIT))
//            {
//                Log("¡ŒÕ”—€:  —ÎË¯ÍÓÏ Ï‡ÎÓ ·ÓÌÛÒÓ‚ (<20)! ");
//                return -1;
//            }
            //- dms === 2014-05-08 === /

// - dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========

;;Log("¬˚‚Â‰ÂÌ Ì‡ ˝Í‡Ì ‰Ë‡ÎÓ„ ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚");

            BankBonus = new BankBonusForm(this);

			QString BonusCard = CashReg->WPCX->GetPwdCardNumber(card);
//;;Log("- Step 3 -");
			QString BonusEvalCount, BonusSumma, BonusStatus, BonusPromoText;

            QString BonusAllCount = W2U(Double2Str(RoundToNearest(all_bns, 0.001)));
            BonusEvalCount = W2U(Double2Str(RoundToNearest(active_bns , 0.001)));

            string st=trim(ret->CS_S);
            QRegExp rn("\\n");
            QRegExp sn("\\s");
            BonusStatus = W2U(st).replace(rn, "");
            BonusStatus = W2U(BonusStatus).replace(sn, "");

            string status = U2W(BonusStatus);
            BonusPromoText = W2U(ret->info);
//;;Log("- Step 4 -");
			for(;;)
			{
				BankBonus->CardEdit->setText(BonusCard);
				BankBonus->EvalCountEdit->setText(GetRounded(active_bns,0.01).c_str());
				BankBonus->AllCountEdit->setText(GetRounded(all_bns,0.01).c_str());
				BankBonus->StatusEdit->setText(BonusStatus);
                //BankBonus->InfoLabel->setText(BonusPromoText);

			if (BankBonus->exec()==QDialog::Accepted)
				{
                   if(status!="A")
                    {
                        ShowMessage(" ‡Ú‡ ÌÂ‡ÍÚË‚Ì‡, ÒÔËÒ‡ÌËÂ ·‡ÎÎÓ‚ ÌÂ‚ÓÁÏÓÊÌÓ !");
                        continue;
                    }

					double val;

					BonusSumma	= BankBonus->SummaEdit->text();

                    // ÔÓ‚ÂÍ‡ ÍÓÎË˜ÂÒÚ‚‡
                    val = 0;
					if (!BonusSumma.isEmpty())
					{
						val = BonusSumma.toDouble();
					}

                    if (val>0)
                    {

                       if(val>active_bns)
                        {
                            ShowMessage("¬‚Â‰ÂÌÌ‡ˇ ÒÛÏÏ‡ ÔÂ‚˚¯‡ÂÚ ÒÛÏÏÛ ‡ÍÚË‚Ì˚ı ·‡ÎÎÓ‚!");
                            continue;
                        }

                       if(val>chSumma)
                        {
                            ShowMessage("CÛÏÏ‡ ·‡ÎÎÓ‚ ‰ÓÎÊÌ‡ ·˚Ú¸ ÏÂÌ¸¯Â ÒÛÏÏ˚ ˜ÂÍ‡!");
                            continue;
                        }

                       if(val<.01)
                        {
                            ShowMessage("—ÎË¯ÍÓÏ Ï‡ÎÂÌ¸Í‡ˇ ÒÛÏÏ‡ ·‡ÎÎÓ‚!");
                            continue;
                        }

// + dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========
// Ò 01.03.2015 ‰ÂÈÒÚ‚ÛÂÚ ÌÓ‚‡ˇ ·ÓÌÛÒÌ‡ˇ ÔÓ„‡ÏÏ‡:  ÒÛÏÏ‡ ËÒÔÓÎ¸ÁÓ‚‡ÌËˇ ·ÓÌÛÒÓ‚ >= 300 ·ÓÌÛÒÓ‚
                       if(val<300)
                        {
                            ShowMessage("—ÛÏÏ‡ ·ÓÌÛÒÓ‚ ‰ÓÎÊÌ‡ ·˚Ú¸ ÌÂ ÏÂÌ¸¯Â 300!");
                            continue;
                        }
// - dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========

//                        Log("3");
//                        Log((char*)Double2Str(val).c_str());
/*
                        CashReg->AddPayment(10,BonusCard.latin1(),&val);
                        Cheque->CertificateSumm = val;
                        ShowGoodsInfo();
*/
        //;;Log("- Step 5 -");
                        PCX_RET* ret1 = CashReg->WPCX->exec("disc", card, sha1, Cheque, val);
        //;;Log("- Step 6 -");

                        CashReg->AddBankBonusOperation( ret1 ) ;
        //;;Log("- Step 7 -");
                        if (ret1->ReturnCode>=0)
                        {

                            FiscalReg->PrintPCheck("/Kacca/pcx/p", false);

                            //;;Log("+ ProcessBankBonusDiscount +");
                                string BonusCard = card;

                                double a_sum = Cheque->GetSum(); // ÒÛÏÏ‡ ˜ÂÍ‡ ‰Ó ÔÂÂÒ˜ÂÚ‡

                                CashReg->AddPayment(11,BonusCard,&val);

                                ShowGoodsInfo();

                                double b_sum = Cheque->GetSum(); // ÒÛÏÏ‡ ˜ÂÍ‡ ÔÓÒÎÂ ÔÂÂÒ˜ÂÚ‡

                                string LogStr= card;
                                LogStr = ">>> Bank BONUS discounts #"+/* LogStr.substr(0,8)+"# ="+*/Double2Str(a_sum-b_sum);
                                Log((char*)LogStr.c_str());

                                //;;Log("- ProcessBankBonusDiscount -");
                                return 0;

                                Result = Double2Int(val*100);

                                LogStr= card;
                                LogStr = ">>> Bank BONUS Summ Enter #"+LogStr.substr(0,8)+"# ="+Double2Str(val);
                                Log((char*)LogStr.c_str());
                        }
                        else
                        {
                            ShowMessage(ret1->info);
                        }
                    }
                    else
                    {
                        ;;Log(" => ¬˚·‡ÌÓ 0 ·‡ÎÎÓ‚ (ŒÚÏÂÌ‡)");
                    }

				}
                else
                {
                    ;;Log(" => ¬˚·‡Ì‡ Œ“Ã≈Õ¿");
                }

				break;
			}

            if (BankBonus!=NULL)
            {
                delete BankBonus;
                BankBonus=NULL;
            }

    }
    else
    {
        if (ret->info!="")
           ShowMessage(ret->info);
    }

    //;;Log("- ProcessBankBonusDisc -");
    return Result;

}


int WorkPlace::ProcessBankBonusPay(string card, string sha1, double sum)
{
   ;;Log("+ ProcessBankBonusPay +");
   PCX_RET* ret = CashReg->WPCX->exec("pay", card, sha1, Cheque, sum);

  ;;Log("    PrintPCheck(/Kacca/pcx/p) +");
   FiscalReg->PrintPCheck("/Kacca/pcx/p", false);

    CashReg->AddBankBonusOperation( ret );
   ;;Log("- ProcessBankBonusPay -");
}


int WorkPlace::ProcessBankBonusDiscountReverse(string card, string sha1, bool isAnnul)
{
    //;;Log("+ProcessBankBonusDiscountReverse+");

    double sum = Cheque->BankBonusSumm;

    PCX_RET* ret = CashReg->WPCX->exec("rev", card, sha1, Cheque, sum);

    if(isAnnul)
       ret->action = BB_REVERSE_ANNUL;

    CashReg->AddBankBonusOperation( ret ) ;

    FiscalReg->PrintPCheck("/Kacca/pcx/p", false);

    //if (WPCX->PCX_Result.ReturnCode>=0)
    {
        ;;Log("+ REVERSE OK +");
        string BonusCard = card;

        CashReg->DeletePayment(11,BonusCard,true);

        ShowGoodsInfo();
    }

    //;;Log("-ProcessBankBonusDiscountReverse-");
    return 0;
}

bool WorkPlace::InActionDobryeSosedy(long long pCust, long long pAddonCust)
{
  return (
     (CashReg->GetMagNum()=="    44")
        && ((pAddonCust>=993000650000LL) && (pAddonCust<=993000660001LL))
        && (!CashReg->IsDobryeSosedy(pCust)));
}


int WorkPlace::ProccessBankCardNumber(const char *card)
{

    string disc = "";
    long idcust =0;


    string ActionBarcode="27084397"; // "27081914";
    string ActionCode="775373";


    string CardStr = card;
    string Bin = CardStr.substr(0,6);

    if (
        (Bin =="427601") // 42760149
        ||
        (Bin =="427901") // 42790149
        ||
        (Bin =="546901") // 54690149
        ||
        (Bin =="548401") //54840149
        ||
        (Bin =="485463") //485463 ñ Visa CREDIT momentum
        ||
        (Bin =="531310") //531310 ñ MC CREDIT momentum
//////////////////////////////////////
//        ||
//      (Bin =="42768680")

        )
{
    EditLine->setText(ActionBarcode);

    ProcessBarcode();

    ShowGoodsInfo(); // ÔÂÂÒ˜ÂÚ ÒÍË‰ÓÍ ÂÒÚ¸ ‚ÌÛÚË ÔÓˆÂ‰Û˚

    string LogStr= card;
    LogStr = ">>> Add action good 5% Senks from Sberbank #"+LogStr.substr(0,8)+"# ="+ActionBarcode+"\n"+disc;
    Log((char*)LogStr.c_str());
}

    return 1;
}

bool WorkPlace::AddActionGoods(string card)
{

    bool InAction=false;

    string disc = "";
    long idcust =0;

    string ActionBarcode="";
    string ActionCode="";

// 779473 4% (27089477)
// 779474 6% (27089484)

    if (
    ( (card.length()==8) && (card.substr(0,2)=="12") )
    ||
    ( (card.length()==9) && (card.substr(0,3)=="F12") )
    ||
    ( (card.length()==10) && (card.substr(0,4)=="FF12") )
    )
    {
        ActionBarcode="27089477";
        ActionCode="779473";

        InAction=true;
    }

    if (
    ( (card.length()==8) && (card.substr(0,2)=="18") )
    ||
    ( (card.length()==9) && (card.substr(0,3)=="F18") )
    ||
    ( (card.length()==10) && (card.substr(0,4)=="FF18") )
    )
    {
        ActionBarcode="27089484";
        ActionCode="779474";

        InAction=true;
    }


    if (InAction)
    {
        bool test = true;
//;;ShowMessage("“ÂÒÚ!");
		//ÔÓ‚ÂËÏ, ÂÒÎË ÎË ÛÊÂ ÒÔÂˆ ÍÓ‰ ‰Îˇ Ì‡˜ËÒÎÂÌËˇ ‰ÓÔ. ·‡ÎÎÓ‚ —Ô‡ÒË·Ó
		for (int i=0;i<Cheque->GetCount();i++)
		{
			GoodsInfo g=(*Cheque)[i];
            if (
                (g.ItemFlag==SL)
                &&
                (
                (g.ItemCode==779473)
                ||
                (g.ItemCode==779474)
                )
               )
            {
                test=false;
                break;
            }
		}

        if (test)
        {
            EditLine->setText(ActionBarcode);

            ProcessBarcode();

            ShowGoodsInfo(); // ÔÂÂÒ˜ÂÚ ÒÍË‰ÓÍ ÂÒÚ¸ ‚ÌÛÚË ÔÓˆÂ‰Û˚

            string LogStr= "";
            LogStr = ">>> Add action good 4-6% Senks from Sberbank ( CODE128 ) #"+card+"# ="+ActionBarcode+"\n"+disc;
            Log((char*)LogStr.c_str());
        }
        else
        {
            ShowMessage(" ÛÔÓÌ Ì‡ Ì‡˜ËÒÎÂÌËÂ ‰ÓÔ. ·‡ÎÎÓ‚ \"—Ô‡ÒË·Ó\" ÛÊÂ Ò˜ËÚ‡Ì ‚ ˜ÂÍÂ!");
        }
    }

    return InAction;
}


double WorkPlace::GetSumActionPG()
{
    double res=0;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
            string str= g.Lock;

           if (CashReg->GoodsLock(str, GL_ActionPG) == GL_ActionPG)
                res+=g.ItemFullSum;
        }
    }

    return res;
}


int WorkPlace::CheckKimberly()
{
    int res=0;
    int cnt=0;
    double actsum=0;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
            string str= g.Lock;

           if (CashReg->GoodsLock(str, GL_ActionKimberly) == GL_ActionKimberly)
                actsum+=g.ItemCount*g.ItemFullPrice;
        }
    }

    ;;Log("===Check Kimberly===");


    // ÛÒÎÓ‚ËÂ ‚˚‰‡˜Ë ÔÓ‰‡Í‡ ÔÓ ‡ÍˆËË
    if (actsum>=750){
        res=1;
        ;;Log((char*)("===Action Kimberly! ("+Double2Str(actsum)+")===").c_str());
    }


    // C 28/06/2016 ÔÓ‰‡ÓÍ ‚˚‰‡ÂÚÒˇ Á‡ Í‡Ê‰˚È ÚÓ‚‡ (·˚ÎÓ - Á‡ Í‡Ê‰˚Â 2¯Ú ÚÓ‚‡‡)
    //res = (int)(cnt/2);

    //res = cnt;

    return res;
}


int WorkPlace::CheckSugar(string* res_str, int check_code, double check_cnt)
{
    int LIMIT_cnt = 3;
    double LIMIT_cnt_ves = 3.5;

    *res_str = "";
    int res=0;
    int cnt=0;
    double cnt_ves=0;

    if (!filepath_exists("/Kacca/tmp/CheckSugar")) {
        return res;
    }

/*
    time_t ltime;
    time( &ltime );
    struct tm *now;
    now = localtime( &ltime );

    // œÂËÓ‰ ‡ÍˆËË - 12.07.19 - 14.07.19
    if (
           !(
            (now->tm_year+1900 == 2019)
            &&
            (now->tm_mon+1 == 7)
            &&
            ((now->tm_mday >= 12) && (now->tm_mday <= 14))
           )
       )
    {
        return res;
    }
*/

    switch (check_code)
    {
        case 103518: cnt += (int)check_cnt; break;
        case 991: cnt_ves += check_cnt; break;
        case 0: break;
        default: return res;
    }


    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
           if ((g.ItemCode==103518))
                cnt+=(int)g.ItemCount;

           if ((g.ItemCode==991))
                cnt_ves+=g.ItemCount;

        }
    }

    double tot_weight = cnt_ves + (double)cnt * 0.9;

    ;;Log("==Check CheckSugar== Cnt = " + Int2Str(cnt)
          + " Cnt_ves = " + Double2Str(cnt_ves)
          + " tot_weight = " + Double2Str(tot_weight));

    if (cnt > LIMIT_cnt)
    {
        *res_str += "\n«‡ÔÂ˘ÂÌ‡ ÔÓ‰‡Ê‡ Ò‡ı‡‡ (103518) ·ÓÎÂÂ "
                + Int2Str(LIMIT_cnt) + " ¯Ú ( ‚ ˜ÂÍÂ "
                + Int2Str(cnt) + " ¯Ú. )";
        res = 1;
        return res;
    }

    if (tot_weight > LIMIT_cnt_ves)
    {
        *res_str += "\n«‡ÔÂ˘ÂÌ‡ ÔÓ‰‡Ê‡ ‚ÂÒÓ‚Ó„Ó Ò‡ı‡‡ (991) ·ÓÎÂÂ "
                + Double2Str(LIMIT_cnt_ves) + " Í„ "
                "( ‚ ˜ÂÍÂ " + Double2Str(tot_weight)+" Í„. )";
        res = 1;
        return res;
    }


    return res;
}


int WorkPlace::CheckLibero()
{
    int res=0;
    int cnt=0;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
            string str= g.Lock;

           if (CashReg->GoodsLock(str, GL_ActionLibero) == GL_ActionLibero)
                cnt+=(int)g.ItemCount;
        }
    }

    //;;Log("==Check Libero==");
    //;;Log((char*)(Int2Str(cnt).c_str()));


    // C 28/06/2016 ÔÓ‰‡ÓÍ ‚˚‰‡ÂÚÒˇ Á‡ Í‡Ê‰˚È ÚÓ‚‡ (·˚ÎÓ - Á‡ Í‡Ê‰˚Â 2¯Ú ÚÓ‚‡‡)
    //res = (int)(cnt/2);

    res = cnt;

    return res;
}


int WorkPlace::CheckRedhop()
{
    int res=0;
    int cnt=0;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
           if ((g.ItemCode==822391) || (g.ItemCode==822392) || (g.ItemCode==822393))
                cnt+=(int)g.ItemCount;
        }
    }

    ;;Log("==Check CheckRedhop==");
    ;;Log((char*)(Int2Str(cnt).c_str()));

    // ÔÓ‰‡ÓÍ ‚˚‰‡ÂÚÒˇ Á‡ Í‡Ê‰˚Â 3¯Ú ÚÓ‚‡‡
    res = (int)(cnt/3);


    return res;
}

int WorkPlace::CheckBeerCup()
{
    int res=0;
    int cnt=0;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
           if ((g.ItemCode==1000205) || (g.ItemCode==18981))
                cnt+=(int)g.ItemCount;
        }
    }

    ;;Log("==Check CheckBeerCup==");
    ;;Log((char*)(Int2Str(cnt).c_str()));

    // ÔÓ‰‡ÓÍ ‚˚‰‡ÂÚÒˇ Á‡ Í‡Ê‰˚Â 3¯Ú ÚÓ‚‡‡
    res = (int)(cnt/3);


    return res;
}


int WorkPlace::CheckMonster()
{
    int res=0;
    int cnt=0;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
           if ((g.ItemCode==816710) || (g.ItemCode==816709) || (g.ItemCode==819837))
                cnt+=(int)g.ItemCount;
        }
    }

    ;;Log("==Check CheckMonster==");
    ;;Log((char*)(Int2Str(cnt).c_str()));

    // ÔÓ‰‡ÓÍ ‚˚‰‡ÂÚÒˇ Á‡ Î˛·˚Â 2¯Ú ÚÓ‚‡‡
    res = (int)(cnt/2);


    return res;
}




int WorkPlace::ProcessBonusDiscount(long long lcard, bool uselimit)
{

    if(!CashReg->BonusMode(lcard)) return -1;

    string card = LLong2Str(lcard);

    string disc = "";
    long idcust =0;

    long Result = 0;

    string strCheck = Int2Str(CashReg->GetLastCheckNum()+1);


    // ≈ÒÎË Ú‡ÌÁ‡ÍˆËˇ ‡ÍÚË‚Ì‡ - ÓÚÏÂÌËÏ ÂÂ
    ;;Log("+CHECK PAY ID+");
    ;;Log("bonus_pay_id = '"+bonus_pay_id+"'");
    ProcessBonusDiscountReverse();

// ¿ÍÚÛ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ˜ÂÍ‡
    double chSumma = Cheque->GetSum()-1;

// »ÌÙÓÏ‡ˆËˇ ÔÓ Í‡ÚÂ
;;Log("+ GetCardInfo +");
    BNS_RET* retInf = CashReg->BNS->exec("inf&reg", card, strCheck);
;;Log("- GetCardInfo -");
    CashReg->AddBonusOperation( retInf ) ;


    // «‡‰ÂÈÒÚ‚ÛÂÏ ÓÔÂ‡ˆË˛ ÔÓÎÛ˜ÂÌËˇ ·‡Î‡ÌÒ‡ Í‡Í
    // ÔÓ‚ÂÍÛ Ò‚ˇÁË c ÏËÌËÏ‡Î¸Ì˚Ï Ú‡ÈÏ‡ÛÚÓÏ
    // Õ‡ ÔÓÒÎÂ‰Û˛˘ËÂ ÓÔÂ‡ˆËË Ú‡ÈÏ‡ÛÚ ÒÚ‡‚ËÚÒˇ Ï‡ÍÒËÏ‡Î¸Ì˚È
    if (retInf->ReturnCode)
    {
         // ÂÒÎË Ó¯Ë·Í‡ ÔÓ‚ÂÍË Ò‚ˇÁË, ÚÓ ‰‡Î¸¯Â ÌÂ Ë‰ÂÏ
        CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,ERRORBONUSPAY,0,CashReg->GetCashmanCode(),0, card.c_str(), NULL, NULL, NULL);//
        ;;Log("ERROR INIT BONUS SALE");
        bonus_pay_id="";

        StatusBonusCard="-1";

        return -3;
    }

    CurrentActiveBonus = retInf->ActiveBonuses;

    int ReturnCodeInf = retInf->ReturnCode;
    double all_bns = retInf->ActiveBonuses; // + ret->HoldedBonuses;
    double active_bns = retInf->ActiveBonuses;

    string status = retInf->status;

    StatusBonusCard = retInf->status;

    //! ÕÓ‚‡ˇ Ú‡ÌÁ‡ÍˆËˇ ÔÓ‰‡ÊË
    // ¬ ÌÂÈ ·Û‰ÂÚ
    // 1) ÒÛÏÏ‡ Ì‡˜ËÒÎÂÌÌ˚ı ·ÓÌÛÒÓ‚ Ë
    // 2) ÒÛÏÏ‡ ÓÔÎ‡˜ÂÌÌ˚ı ·ÓÌÛÒÓ‚ (ÂÒÎË ·Û‰ÂÚ ÒÔËÒ‡ÌËÂ)

    // »ÌËˆË‡ÎËÁ‡ˆËˇ ÔÓÍÛÔÍË, ÔËÒ‚ÓÂÌËÂ ÌÓ‚Ó„Ó »ƒ
    BNS_RET* ret = CashReg->BNS->exec("sale&init", card, strCheck, Cheque, Cheque->GetDiscountSum());

    ;;Log((char*)Int2Str(ret->errorCode).c_str());
    ;;Log((char*)ret->id.c_str());

    CashReg->AddBonusOperation( ret ) ;

    bonus_pay_id = ret->id;

    // œÓÎÛ˜‡ÂÏ ÒÛÏÏÛ, ÍÓÚÓÛ˛ ÏÓÊÌÓ ÒÔËÒ‡Ú¸ ‚ ÍÓÌÍÂÚÌÓÏ ˜ÂÍÂ ÔÓ ‰‡ÌÌ˚Ï œ÷
    // ‚ ÌÂÈ ÏÓ„ÛÚ ÌÂ ·˚Ú¸ Û˜ÚÂÌ˚ ‡ÍˆËÓÌÌ˚Â ·ÓÌÛÒ˚
    // Õ‡ÔËÏÂ, ‡ÍˆËÓÌÌ˚Â ·ÓÌÛÒ˚, ÍÓÚÓ˚Â ÏÓÊÌÓ ÒÔËÒ‡Ú¸ ÚÓÎ¸ÍÓ ÓÚ ÒÛÏÏ˚ ˜ÂÍ‡ >500
    //ÚÓ„‰‡ ÔË ÒÛÏÏÂ ˜ÂÍ‡ <500 maxSumCanPay ‚ÂÌÂÚ ÒÛÏÏÛ ·ÂÁ ‡ÍˆËÓÌÌ˚ı ·ÓÌÛÒÓ‚
    double max_can_pay = ret->maxSumCanPay;

    if (ret->ReturnCode)
    {
        // ÂÒÎË Ó¯Ë·Í‡ ËÌËˆË‡ÎËÁ‡ˆËË ÔÓÍÛÔÍË, ÚÓ ‰‡Î¸¯Â ÌÂ Ë‰ÂÏ
        ;;Log("ERROR INIT BONUS SALE");
        bonus_pay_id="";

        StatusBonusCard="-1";

        return -2;

    }

    if(isEmptyBonusID(bonus_pay_id))
    {
        // ÂÒÎË Ó¯Ë·Í‡ ËÌËˆË‡ÎËÁ‡ˆËË ÔÓÍÛÔÍË, ÚÓ ‰‡Î¸¯Â ÌÂ Ë‰ÂÏ
        ;;Log("ERROR: EMPTY ID!");
        bonus_pay_id="";

        StatusBonusCard="-1";

        return -2;

    }


    //  ‡Ú‡ ‰Ó·‡‚ÎÂÌ‡ ÔÓ ÌÓÏÂÛ ÚÂÎÂÙÓÌ‡ => ÚÓÎ¸ÍÓ Ì‡˜ËÒÎÂÌËÂ
    if (CustomerByPhone)
    {
        Log(" ‡Ú‡ ‰Ó·‡‚ÎÂÌ‡ ÔÓ ÌÓÏÂÛ ÚÂÎÂÙÓÌ‡. ¬ÓÁÏÓÊÌÓ ÚÓÎ¸ÍÓ Ì‡˜ËÒÎÂÌËÂ ·ÓÌÛÒÓ‚");
        return -1;
    }


    Log("—Ú‡ÚÛÒ ·ÓÌÛÒÌÓÈ Í‡Ú˚: \""+status+"\"");

    //  ‡Ú‡ ‰Ó·‡‚ÎÂÌ‡ ÔÓ ÌÓÏÂÛ ÚÂÎÂÙÓÌ‡ => ÚÓÎ¸ÍÓ Ì‡˜ËÒÎÂÌËÂ
    if (status=="255")
    {
        Log("—Ú‡ÚÛÒ - «‡·ÎÓÍËÓ‚‡Ì‡!");
        return -1;
    }

    if ((status!="1") && (status!="2") && (status!="3"))
    {
        Log("—Ú‡ÚÛÒ - “ÓÎ¸ÍÓ Ì‡˜ËÒÎÂÌËÂ!");
        return -1;
    }


    // ƒ‡ÎÂÂ ‚˚‚Ó‰ËÏ ‰Ë‡ÎÓ„ ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚, ÂÒÎË ˝ÚÓ ÌÂÓ·ıÓ‰ËÏÓ
    if (chSumma<=0)
    {
        Log("¡ŒÕ”—€:  —ÎË¯ÍÓÏ Ï‡ÎÂÌ¸Í‡ˇ ÒÛÏÏ‡ ˜ÂÍ‡! (ƒÓÎÊÂÌ ·˚Ú¸ > 1Û·.)");
        return -1;
    }

// + dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========
// ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚ "—Ô‡ÒË·Ó" ÌÂ ‰ÓÎÊÌ‡ ·˚Ú¸ ÏÂÌ¸¯Â 300 ·‡ÎÎÓ‚
// —ÓÓÚ‚ÂÚÒÚ‚ÂÌÌÓ ÒÛÏÏ‡ ˜ÂÍ‡ ‰ÓÎÊÌ‡ ·˚Ú¸ ·ÓÎ¸¯Â 300 Û·ÎÂÈ
    if (chSumma<_BONUS_MINIMUM_LIMIT_)
    {
        char tmpstr[1024];
        sprintf(tmpstr, "¡ŒÕ”—€:  —ÎË¯ÍÓÏ Ï‡ÎÂÌ¸Í‡ˇ ÒÛÏÏ‡ ˜ÂÍ‡ (ÏÂÌÂÂ %d Û·.)! ",_BONUS_MINIMUM_LIMIT_);
        Log(tmpstr);

        return -1;
    }
// - dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========



//        CashReg->LoggingAction(,ERRORBONUSRETDISC,sum*.01,,0, card, NULL, NULL, NULL, SberbankCard);// *

    //CashReg->AddBankBonusOperation(ret);
//;;Log("- Step 1 -");
    if (!ReturnCodeInf)
    {
    //==================================================================================

	//setlocale( LC_ALL, "ru_RU->koi8-r");



//;;Log("- Step 2 -");


// + dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========
//ŒÍÌÓ ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚ ÔÓÍ‡Á˚‚‡ÂÏ ÚÓÎ¸ÍÓ ÂÒÎË ÍÓÎ-‚Ó ·ÓÌÛÒÓ‚ >= 300
            //if (active_bns<_BONUS_MINIMUM_LIMIT_)
            if (max_can_pay<_BONUS_MINIMUM_LIMIT_)
            {
                char tmpstr[1024];
                sprintf(tmpstr, "¡ŒÕ”—€:  —ÎË¯ÍÓÏ Ï‡ÎÓ ·ÓÌÛÒÓ‚ (ÏÂÌÂÂ %d )! ",_BONUS_MINIMUM_LIMIT_);
                Log(tmpstr);

                return -1;
            }

// ¡˚ÎÓ ‰Ó 01.03.2015
            //+ dms === 2014-05-08 === Œ„‡ÌË˜ÂÌËÂ Ì‡ ÔÓÍ‡Á ÓÍÌ‡ ·ÓÌÛÒÓ‚ ÔË ÓÔÎ‡ÚÂ ÔÓ ·ÂÁÌ‡ÎÛ
            // ÓÍÌÓ ÔÓÍ‡Á˚‚‡ÂÏ ÚÓÎ¸ÍÓ ÂÒÎË ÍÓÎ-‚Ó ·ÓÌÛÒÓ‚ > 20
//            if ((uselimit) && (active_bns<=BANKBONUS_MINIMUM_LIMIT))
//            {
//                Log("¡ŒÕ”—€:  —ÎË¯ÍÓÏ Ï‡ÎÓ ·ÓÌÛÒÓ‚ (<20)! ");
//                return -1;
//            }
            //- dms === 2014-05-08 === /



// - dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========


            double max_bns = GetMaxBonusToPay(Cheque);

            //double max_act_bns = min(max_bns, active_bns);
            double max_act_bns = min(max_bns, max_can_pay);

;;Log("¬˚‚Â‰ÂÌ Ì‡ ˝Í‡Ì ‰Ë‡ÎÓ„ ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚");

            BankBonus = new BankBonusForm(this);

			QString BonusCard = card;
//;;Log("- Step 3 -");
			QString BonusEvalCount, BonusSumma, BonusStatus, BonusPromoText;

            QString BonusAllCount = W2U(Double2Str(RoundToNearest(all_bns, 0.001)));
            BonusEvalCount = W2U(Double2Str(RoundToNearest(active_bns , 0.001)));

            //string st=trim(ret->CS_S);
            string st=StatusBonusCard;
            QRegExp rn("\\n");
            QRegExp sn("\\s");
            BonusStatus = W2U(st).replace(rn, "");
            BonusStatus = W2U(BonusStatus).replace(sn, "");

            string status = U2W(BonusStatus);
            BonusPromoText = "";
//;;Log("- Step 4 -");
			for(;;)
			{
				BankBonus->CardEdit->setText(BonusCard);
				//BankBonus->EvalCountEdit->setText(GetRounded(active_bns,0.01).c_str());
				//BankBonus->AllCountEdit->setText(GetRounded(all_bns,0.01).c_str());
				BankBonus->EvalCountEdit->setText(GetRounded(max_act_bns,0.01).c_str());
				BankBonus->AllCountEdit->setText(GetRounded(active_bns,0.01).c_str());

				BankBonus->StatusEdit->setText(BonusStatus);
                //BankBonus->InfoLabel->setText(BonusPromoText);

;;Log("—ÛÏÏ‡ ˜ÂÍ‡: "+Double2Str(chSumma));
;;Log("¬ÒÂ„Ó ‡ÍÚË‚Ì˚ı ·ÓÌÛÒÓ‚ Ì‡ Í‡ÚÂ: "+Double2Str(active_bns) );
;;Log("Ã‡ÍÒËÏ‡Î¸ÌÓ ‚ÓÁÏÓÊÌ‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ ·ÓÌÛÒÓ‚: "+Double2Str(max_bns));
;;Log("ƒÓÒÚÛÔÌÓ ‰Îˇ ÒÔËÒ‡ÌËˇ: "+Double2Str(max_act_bns) );


			if (BankBonus->exec()==QDialog::Accepted)
				{
                   if((status!="1") && (status!="3"))
                    {
                        ShowMessage(" ‡Ú‡ ÌÂ‡ÍÚË‚Ì‡, ÒÔËÒ‡ÌËÂ ·‡ÎÎÓ‚ ÌÂ‚ÓÁÏÓÊÌÓ !");
                        continue;
                    }

					double val;

					BonusSumma	= BankBonus->SummaEdit->text();

                    // ÔÓ‚ÂÍ‡ ÍÓÎË˜ÂÒÚ‚‡
                    val = 0;
					if (!BonusSumma.isEmpty())
					{
						val = BonusSumma.toDouble();
					}

;;Log((char*)("¬¬≈ƒ≈ÕŒ ¡ŒÕ”—Œ¬ ƒÀﬂ —œ»—¿Õ»ﬂ: "+Double2Str(val)).c_str() );

                    if (val>0)
                    {

                       if(val>max_act_bns)
                        {
                            ShowMessage("¬‚Â‰ÂÌÌ‡ˇ ÒÛÏÏ‡ ÔÂ‚˚¯‡ÂÚ ‰ÓÔÛÒÚËÏÛ˛ ÒÛÏÏÛ ‰Îˇ ÒÔËÒ‡ÌËˇ ·‡ÎÎÓ‚!");
                            continue;
                        }

                       if(val>active_bns)
                        {
                            ShowMessage("¬‚Â‰ÂÌÌ‡ˇ ÒÛÏÏ‡ ÔÂ‚˚¯‡ÂÚ ÒÛÏÏÛ ‡ÍÚË‚Ì˚ı ·‡ÎÎÓ‚!");
                            continue;
                        }

                       if(val>chSumma)
                        {
                            ShowMessage("CÛÏÏ‡ ·‡ÎÎÓ‚ ‰ÓÎÊÌ‡ ·˚Ú¸ ÏÂÌ¸¯Â ÒÛÏÏ˚ ˜ÂÍ‡!");
                            continue;
                        }

                       if(val<.01)
                        {
                            ShowMessage("—ÎË¯ÍÓÏ Ï‡ÎÂÌ¸Í‡ˇ ÒÛÏÏ‡ ·‡ÎÎÓ‚!");
                            continue;
                        }

// + dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========
// Ò 01.03.2015 ‰ÂÈÒÚ‚ÛÂÚ ÌÓ‚‡ˇ ·ÓÌÛÒÌ‡ˇ ÔÓ„‡ÏÏ‡:  ÒÛÏÏ‡ ËÒÔÓÎ¸ÁÓ‚‡ÌËˇ ·ÓÌÛÒÓ‚ >= 300 ·ÓÌÛÒÓ‚
/*
                       if(val<_BONUS_MINIMUM_LIMIT_)
                        {
                            ShowMessage("—ÛÏÏ‡ ·ÓÌÛÒÓ‚ ‰ÓÎÊÌ‡ ·˚Ú¸ ÌÂ ÏÂÌ¸¯Â "+Double2Str(_BONUS_MINIMUM_LIMIT_)+"!");
                            continue;
                        }
*/
                       if(val<1)
                        {
                            ShowMessage("—ÛÏÏ‡ ·ÓÌÛÒÓ‚ ‰ÓÎÊÌ‡ ·˚Ú¸ ÌÂ ÏÂÌ¸¯Â 1 !");
                            continue;
                        }

// - dms ===== 2015-03-01 ======= ÃËÌËÏ‡Î¸Ì‡ˇ ÒÛÏÏ‡ ÒÔËÒ‡ÌËˇ 300 ·ÓÌÛÒÓ‚ ========

//                        Log("3");
//                        Log((char*)Double2Str(val).c_str());
/*
                        CashReg->AddPayment(10,BonusCard.latin1(),&val);
                        Cheque->CertificateSumm = val;
                        ShowGoodsInfo();
*/
                        //ShowMessage(Double2Str(val));
                        //return 0;

// + dms ====== 2021-03-15 ======= œË ÒÔËÒ‡ÌËË ·ÓÎÂÂ 1000 ·ÓÌÛÒÓ‚ - Á‡Ô‡¯Ë‚‡ÂÏ ÔÓÒÎÂ‰ÌËÂ 4 ˆËÙ˚ ÌÓÏÂ‡ ÚÂÎÂÙÓÌ‡
// »ÌÙÓÏ‡ˆËˇ ÔÓ Í‡ÚÂ

/*
if (val>=1000)
{
*/
;;Log("+ GetCustomerInfo +");
    BNS_RET* retCustInf = CashReg->BNS->exec("custByCard", card, strCheck);
;;Log("- GetCustomerInfo -");

    if (retCustInf->ReturnCode)
    {
        Log(" -> Œ¯Ë·Í‡ ÔÓÎÛ˜ÂÌËˇ ÌÓÏÂ‡ ÚÂÎÂÙÓÌ‡ "+Int2Str(retCustInf->ReturnCode));
//        ShowMessage("ÕÂ Û‰‡ÎÓÒ¸ ÔÓÎÛ˜ËÚ¸ ÌÓÏÂ ÚÂÎÂÙÓÌ‡ ÍÎËÂÌÚ‡. œÓ‚ÚÓËÚÂ ÔÓÔ˚ÚÍÛ");
//        continue;
    }

    string enterVal = "";
    string last4dig = "";
    string mobileNumber = retCustInf->mobileNumber;
    if (mobileNumber.length()>5)
    {
        last4dig = mobileNumber.substr(mobileNumber.length() - 5, 4);
    }
    else
    {
        Log(" -> ÕÂÔ‡‚ËÎ¸Ì˚È ÌÓÏÂ ÚÂÎÂÙÓÌ‡ ÍÎËÂÌÚ‡ "+mobileNumber);
        CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,BN_ERRPHONE,val,CashReg->CurrentSaleman->Id,0, card.c_str(), NULL, NULL, mobileNumber.c_str());
//        ShowMessage("ÕÂÔ‡‚ËÎ¸Ì˚È ÌÓÏÂ ÚÂÎÂÙÓÌ‡ ÍÎËÂÌÚ‡. Œ·‡ÚËÚÂÒ¸ Í ‡‰ÏËÌËÒÚ‡ÚÓÛ");
//        continue;
    }

   // CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,BN_GETPHONE,val,CashReg->CurrentSaleman->Id,0, card.c_str(), NULL, NULL, last4dig.c_str());

    Log(" -> œÓÎÛ˜ÂÌ ÌÓÏÂ ÚÂÎÂÙÓÌ‡ ("+mobileNumber+") -> ("+last4dig+")");
/*
    SumForm *dlg = new SumForm(this);
    dlg->FormCaption->setText(W2U("¬‚Â‰ËÚÂ ÔÓÒÎÂ‰ÌËÂ 4 ˆËÙ˚ ÌÓÏÂ‡ ÚÂÎÂÙÓÌ‡"));

    dlg->LineEdit->setText(EditLine->text());

    ;;Log(" -> ƒË‡ÎÓ„ ‚‚Ó‰‡ ÚÂÎÂÙÓÌ‡ <- ");
    if (dlg->exec() == QDialog::Accepted)
    {
        enterVal = U2W(dlg->LineEdit->text());

        Log(" -> ¬‚Â‰ÂÌ˚ ˆËÙ˚ ("+enterVal+")");

        if (enterVal.length() != 4)
        {
            ShowMessage("ÕÂÍÓÂÍÚÌÓÂ ÁÌ‡˜ÂÌËÂ. ÕÛÊÌÓ ÛÍ‡Á‡Ú¸ ÔÓÒÎÂ‰ÌËÂ 4 ˆËÙ˚ ÌÓÏÂ‡ ÚÂÎÂÙÓÌ‡");
            continue;
        }

    } else {
        continue;
    }
*/
    CashReg->LoggingAction(CashReg->GetLastCheckNum()+1,BN_CHECKPHONE,val,CashReg->CurrentSaleman->Id,0, card.c_str(), (char*)(enterVal.c_str()), NULL, last4dig.c_str());
/*
    if(last4dig != enterVal)
    {
        ShowMessage("ÕÓÏÂ‡ ÚÂÎÂÙÓÌÓ‚ ÌÂ ÒÓ‚Ô‡‰‡˛Ú! Œ·‡ÚËÚÂÒ¸ Í ‡‰ÏËÌËÒÚ‡ÚÓÛ");
        continue;
    }
}
*/
// - dms ====== 2021-03-15 ======= œË ÒÔËÒ‡ÌËË ·ÓÎÂÂ 1000 ·ÓÌÛÒÓ‚ - Á‡Ô‡¯Ë‚‡ÂÏ ÔÓÒÎÂ‰ÌËÂ 4 ˆËÙ˚ ÌÓÏÂ‡ ÚÂÎÂÙÓÌ‡



        //;;Log("- Step 5 -");
                        string sha1="";
                        //PCX_RET* ret1 = CashReg->WPCX->exec("disc", card, sha1, Cheque, val);
                        BNS_RET* ret1 = CashReg->BNS->exec("sale&disc", card, strCheck, Cheque, 0, val, bonus_pay_id);
        //;;Log("- Step 6 -");

                        CashReg->AddBonusOperation( ret1 ) ;
        //;;Log("- Step 7 -");
                        if (!ret1->ReturnCode)
                        {

                            //!FiscalReg->PrintPCheck("/Kacca/pcx/p", false);

                            //;;Log("+ ProcessBankBonusDiscount +");
                                string BonusCard = card;

                                double a_sum = Cheque->GetSum(); // ÒÛÏÏ‡ ˜ÂÍ‡ ‰Ó ÔÂÂÒ˜ÂÚ‡

                                CashReg->AddPayment(12,BonusCard,&val);

                                ShowGoodsInfo();

                                double b_sum = Cheque->GetSum(); // ÒÛÏÏ‡ ˜ÂÍ‡ ÔÓÒÎÂ ÔÂÂÒ˜ÂÚ‡

                                string LogStr= card;
                                LogStr = ">>> BONUS discounts #"+/* LogStr.substr(0,8)+"# ="+*/Double2Str(a_sum-b_sum);
                                Log((char*)LogStr.c_str());

                                //;;Log("- ProcessBankBonusDiscount -");

                                //Result = Double2Int(val*100);

                                Result = Double2Int(val*100);

                                LogStr= card;
                                LogStr = ">>> BONUS Summ Enter #"+LogStr+"# ="+Double2Str(val);
                                Log((char*)LogStr.c_str());


                              // ShowMessage("ŒÚ·ËÚ¸ ˜ÂÍ?");


                        }
                        else
                        {
                            ShowMessage(ret1->errorDescription);
                        }
                    }
                    else
                    {
                        ;;Log(" => ¬˚·‡ÌÓ 0 ·‡ÎÎÓ‚ (ŒÚÏÂÌ‡)");
                    }

				}
                else
                {
                    ;;Log(" => ¬˚·‡Ì‡ Œ“Ã≈Õ¿");
                }

				break;
			}

            if (BankBonus!=NULL)
            {
                delete BankBonus;
                BankBonus=NULL;
            }

    }
    else
    {
        if (ret->errorDescription!="")
           ShowMessage(ret->errorDescription);
    }

    //;;Log("- ProcessBankBonusDisc -");
    return Result;

}


int WorkPlace::ProcessBonusDiscountReverse(bool isAnnul)
{
    //;;Log("+ProcessBankBonusDiscountReverse+");

    if(isEmptyBonusID(bonus_pay_id)) return -1;

    string strCheck = Int2Str(CashReg->GetLastCheckNum()+1);

    string card = LLong2Str(CurrentCustomer);

    double sum = Cheque->BonusSumm;

    BNS_RET* ret = CashReg->BNS->exec("sale&del", card, strCheck, Cheque, 0, 0, bonus_pay_id);

    if(isAnnul)
       ret->action = BB_REVERSE_ANNUL;

    CashReg->AddBonusOperation( ret ) ;

    //FiscalReg->PrintPCheck("/Kacca/pcx/p", false);

    //if (WPCX->PCX_Result.ReturnCode>=0)
    {
        ;;Log("+ REVERSE OK +");
        string BonusCard = card;

        CashReg->DeletePayment(12,BonusCard,true);

        ShowGoodsInfo();

        bonus_pay_id = "";

    }

    //;;Log("-ProcessBankBonusDiscountReverse-");
    return 0;
}



int WorkPlace::ProcessBonusFix(long long lcard)
{

;;Log("[FUNC] ProcessBonusFix [START]");

    if(!CashReg->BonusMode(lcard)) return -1;
    if(isEmptyBonusID(bonus_pay_id)) return -1;

    string card = LLong2Str(lcard);

    string disc = "";
    long idcust =0;

    long Result = 0;

    double chSumma = Cheque->GetSum()-1;

    string strCheck = Int2Str(CashReg->GetLastCheckNum()+1);


    QSemiModal sm(NULL,NULL,true,Qt::WStyle_NoBorderEx);
    QLabel msg(&sm);//, NULL, Qt::WType_TopLevel);
    sm.setFixedSize(250,100);
    msg.setFixedSize(250,100);
    msg.setAlignment( QLabel::AlignCenter );
    msg.setText(W2U("Œ·‡·ÓÚÍ‡ ·ÓÌÛÒÓ‚..."));
    sm.show();
    thisApp->processEvents();

    // ≈ÒÎË Ú‡ÌÁ‡ÍˆËˇ ‡ÍÚË‚Ì‡ - Á‡ÙËÍÒËÛÂÏ ÂÂ
    ;;Log((char*)("bonus_pay_id = '"+bonus_pay_id+"'").c_str());
    ;;Log("  sale&payment ---\\");
    BNS_RET* ret = CashReg->BNS->exec("sale&payment", card, strCheck, Cheque, Cheque->GetSum(), 0, bonus_pay_id);
    ;;Log("  sale&payment ---/");
    CashReg->AddBonusOperation( ret ) ;


    ;;Log("  sale&fix ----\\");
    ret = CashReg->BNS->exec("sale&fix", card, strCheck, Cheque, Cheque->GetSumBonusAdd(), Cheque->GetSumBonusDisc(), bonus_pay_id);
    ;;Log("  sale&fix ----/");
    CashReg->AddBonusOperation( ret ) ;

    ;;Log("  inf after fix ----\\");
    ret = CashReg->BNS->exec("inf", card, strCheck);
    ;;Log("  inf after fix ----/");
    CashReg->AddBonusOperation( ret ) ;

;;Log("[FUNC] ProcessBonusFix [END]");
}

double WorkPlace::GetMaxBonusToPay(FiscalCheque* CurCheque)
{

	if (!CurCheque)
		CurCheque = Cheque;
	if (!CurCheque) return 0;

    double max_bns = 0;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (((g.ItemFlag!=SL) && (g.ItemFlag!=RT)) || (g.ItemCode==TRUNC) || (g.ItemCode==EXCESS_PREPAY)) continue;

        string strLock = g.Lock;
        if (CashReg->GoodsLock(strLock, GL_NoBonus) == GL_NoBonus) continue;

        double cur_sum=0;

        if(g.ItemMinimumPrice>0)
        {

            double delta = g.ItemSum - g.ItemCount * g.ItemMinimumPrice;

            if(delta>0) cur_sum = delta;

        }
        else
        {
            cur_sum = g.ItemSum;
        }


        max_bns+= cur_sum;

    }

    return max_bns;

}


bool WorkPlace::Check100_11()
{
    bool res=false;

    // œÓ‚ÂÍ‡ ÚÓÎ¸ÍÓ ‰Îˇ Ï‡„‡ÁËÌ‡ π100
    int mag = Str2Int(trim(CashReg->GetMagNum()));
    if (mag!=100) return res;


    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;


    bool isGS = false;
    bool isDomGS = false;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
            string str= g.Lock;

           if (CashReg->GoodsLock(str, GL_GastronomOnly) == GL_GastronomOnly)
                isGS=true;
           else
                isDomGS=true;
        }
    }

   // ;;Log("==Check Check100_11==");

    if (
        (CashReg->GetCashRegisterNum()==11) || (CashReg->GetCashRegisterNum()==9)
        || (CashReg->GetCashRegisterNum()==2) || (CashReg->GetCashRegisterNum()==10)
    )
        res = isDomGS;
    else
        res = isGS;

    return res;
}


long long WorkPlace::ScanBonusCard()
{

	long long Res=-1;

	while ((Res==NotCorrect) || (Res==NoPasswd))
	{
        Res = CheckBarcode(Customer);
	}

	return Res;
}


void WorkPlace::ExecBonusAction(FiscalCheque* CurCheque)
{
//;;Log("[ExecBonusAction] START ");

    return; // ÓÚÍÎ˛˜ËÚ¸

    SummaBonusAction = 0;

	if (!CurCheque) return;

    // ¿ÍˆËˇ Ò 04.09.17 - 10.09.17 - ‰‚ÓÈÌ˚Â Ì‡˜ËÒÎÂÌËˇ ·ÓÌÛÒÓ‚ ‰Îˇ ÔÓÍÛÔÓÍ ÓÚ 1000.

    bool isBonusCard = CashReg->BonusMode(CurrentCustomer);
    if (!isBonusCard) return;

	time_t ltime = time(NULL);
	tm* now = localtime(&ltime);

    if (
    (now->tm_year + 1900 == 2017)
    &&
    (now->tm_mon + 1 == 9)
    &&
    ((now->tm_mday >= 4) && (now->tm_mday <= 10))
    )
    {

        if (CurCheque->GetSum()>=1000)
        {
//;;Log("[ExecBonusAction] IN ACTION");
            for (int i=0;i<CurCheque->GetCount();i++)
            {
                GoodsInfo crGoods = (*CurCheque)[i];

                if ((crGoods.ItemFlag==SL)||(crGoods.ItemFlag==RT))
                {
                  SummaBonusAction +=crGoods.ItemBonusAdd;
                  crGoods.ItemBonusAdd = crGoods.ItemBonusAdd*2;
                }

                CurCheque->SetAt(i,crGoods);

            }
        }
    }
}

bool WorkPlace::isEmptyBonusID(string str)
{
    return str.length()<=0;
}

void WorkPlace::WaitForLoadGoods()
{
	// + dms ==== 2019-09-03 ===== ∆‰ÂÏ Á‡„ÛÁÍË ÚÓ‚‡Ó‚ =====
    if (CashReg->IsInload())
    {
        ;;Log("[FUNC] Wait for goods loading [START]");

		QSemiModal sm(NULL,NULL,true,Qt::WStyle_NoBorderEx);
		QLabel msg(&sm);//, NULL, Qt::WType_TopLevel);
		sm.setFixedSize(250,100);
		msg.setFixedSize(250,100);
		msg.setAlignment( QLabel::AlignCenter );
		msg.setText(W2U("»‰ÂÚ Ó·‡·ÓÚÍ‡..."));
		sm.show();
		thisApp->processEvents();

/*        while(CashReg->IsInload())
        {
            //sleep(1);
            string i = "";if (CashReg->IsInload()) i = "true"; else i = "false";
            Log("IsInload = "+i);
        }
*/
        ;;Log("[FUNC] Wait for goods loading [FINISH]");
    }

    // - dms ==== 2019-09-03 ===== ∆‰ÂÏ Á‡„ÛÁÍË ÚÓ‚‡Ó‚ =====
}

bool WorkPlace::IsGoods18()
{
    bool res=false;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
            string str= g.Lock;

           if (CashReg->GoodsLock(str, GL_Goods18) == GL_Goods18)
           {
                res=true;
                break;
           }
        }
    }

    return res;
}


int WorkPlace::CheckFrigovere()
{
    int res=0;
    int cnt=0;
    double actsum=0;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
            string str= g.Lock;

           if (CashReg->GoodsLock(str, GL_ActionFrigovere) == GL_ActionFrigovere)
                actsum+=g.ItemCount*g.ItemFullPrice;
        }
    }

    ;;Log("===Check Frigovere===");


    // ÛÒÎÓ‚ËÂ ‚˚‰‡˜Ë ÔÓ‰‡Í‡ ÔÓ ‡ÍˆËË
    if (actsum>=1500){
        res=1;
        ;;Log((char*)("===Action Frigovere! ("+Double2Str(actsum)+")===").c_str());
    }


    // C 28/06/2016 ÔÓ‰‡ÓÍ ‚˚‰‡ÂÚÒˇ Á‡ Í‡Ê‰˚È ÚÓ‚‡ (·˚ÎÓ - Á‡ Í‡Ê‰˚Â 2¯Ú ÚÓ‚‡‡)
    //res = (int)(cnt/2);

    //res = cnt;

    return res;
}


int WorkPlace::IsMask(int GoodCode)
{
    int res = 0;
    //‚ÒÂ ‰‡ÌÌ˚Â Ï‡ÒÍË ÌËÊÂ ÏÌÓ„Ó‡ÁÓ‚˚Â ÿ  ÒÚ‡‚ËÏ 2400001323807
    //
    //865201 Ã‡ÒÍ‡ Á‡˘ËÚÌ‡ˇ ANNALIZA ÔˇÏ‡ˇ ,ıÎÓÔÓÍ 97%, ˝Î‡ÒÚ‡Ì 3%, ÂÁËÌÍ‡ ·ÂÎ‡ˇ 10ÏÏ –ÓÒÒËˇ
    //865202 Ã‡ÒÍ‡ Á‡˘ËÚÌ‡ˇ ANNALIZA ÔˇÏ‡ˇ, ÒÔ‡Ì·ÓÌ‰,ÂÁËÌÍ‡ 80ÏÏ ˜ÂÌ‡ˇ –ÓÒÒËˇ
    //865203 Ã‡ÒÍ‡ Á‡˘ËÚÌ‡ˇ ANNALIZA ÙË„ÛÌ‡ˇ, ıÎÓÔÓÍ 68%, Ô/˝ 27%, ‚ËÒÍÓÁ‡ 3%, ˝Î‡ÒÚ‡Ì 2%, ˜ÂÌ˚È,ÂÁËÌÍ‡ 10ÏÏ –
    //866188 Ã‡ÒÍ‡ ÎËˆÂ‚‡ˇ „Ë„ËÂÌË˜ÂÒÍ‡ˇ 5¯Ú –ÓÒÒËˇ
    //865946 Ã‡ÒÍ‡ ÎËˆÂ‚‡ˇ „Ë„ËÂÌË˜ÂÒÍ‡ˇ –ÓÒÒËˇ
    //863968 Ã‡ÒÍ‡ ÏÌÓ„Ó‡ÁÓ‚‡ˇ –ÓÒÒËˇ

    if (
    (GoodCode == 865201)
    ||
    (GoodCode == 865202)
    ||
    (GoodCode == 865203)
    ||
    (GoodCode == 866188)
    ||
    (GoodCode == 865946)
    ||
    (GoodCode == 863968)
    ) {
        res = 1;
    }

    return res;

}


int WorkPlace::CheckCheeseAction()
{
    int res=0;
    int cnt=0;
    double actsum=0;

    FiscalCheque* CurCheque = Cheque;
	if (!CurCheque) return res;

    for (int i=0;i<CurCheque->GetCount();i++)
    {
        GoodsInfo g=(*CurCheque)[i];

        if (g.ItemFlag==SL)
        {
           if (g.ItemCode == 826823) cnt++;
        }
    }

    ;;Log("===CheckCheeseAction===");


    // ÛÒÎÓ‚ËÂ ‚˚‰‡˜Ë ÔÓ‰‡Í‡ ÔÓ ‡ÍˆËË
    if (cnt>0){
        ;;Log("===Action CHEESE!====");
    }


    // C 28/06/2016 ÔÓ‰‡ÓÍ ‚˚‰‡ÂÚÒˇ Á‡ Í‡Ê‰˚È ÚÓ‚‡ (·˚ÎÓ - Á‡ Í‡Ê‰˚Â 2¯Ú ÚÓ‚‡‡)
    //res = (int)(cnt/2);

    res = cnt;

    return res;
}
